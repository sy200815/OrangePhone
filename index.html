<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>橙子机</title>
<style>

  /* ==========================================
   移动端跨浏览器兼容 & App化体验补丁
   ========================================== */
html, body {
  /* 彻底阻止浏览器的下拉刷新和橡皮筋回弹效果 */
  overscroll-behavior-y: none;
  /* 防止横屏或某些浏览器强行放大字体 */
  -webkit-text-size-adjust: 100%;
  /* 消除安卓/iOS点击元素时出现的蓝色/灰色高亮块 */
  -webkit-tap-highlight-color: transparent;
  /* 优先使用动态视口高度，解决底部工具栏遮挡问题 */
  height: 100%;
  height: 100dvh; 
}

/* 强制隐藏所有元素的滚动条，但保留滑动功能 (兼容所有浏览器) */
* {
  scrollbar-width: none; /* Firefox/雨见部分内核 */
  -ms-overflow-style: none; /* Edge/IE */
}
*::-webkit-scrollbar {
  display: none !important; /* Chrome/Safari/X浏览器 */
}

/* 抹平不同浏览器对输入框和按钮的默认丑陋样式 */
input, textarea, button, select {
  -webkit-appearance: none;
  appearance: none;
  font-family: inherit;
  outline: none;
}

/* 修复主容器高度，适配刘海屏和底部小黑条 */
.phone {
  /* 终极高度解决方案：兜底 -> JS计算 -> 现代CSS */
  height: 100vh; 
  height: calc(var(--vh, 1vh) * 100); 
  height: 100dvh; 
  /* 适配苹果/安卓的刘海屏和底部手势黑条 */
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}
/* ========================================== */

:root{
  --bg:#FFFFFF;--accent:#555555;--text:#1A1A1A;--text2:#888888;
  --card:#FFFFFF;--card2:#F7F7F7;--accent2:#E0E0E0;
}
.phone{background:var(--bg)}

/* 壁纸层 */
.wallpaper{position:absolute;inset:0;z-index:0;pointer-events:none}
.wallpaper img{width:100%;height:100%;object-fit:cover}

/* 桌面容器 */
.desktop-container{position:absolute;top:50px;left:0;right:0;bottom:0;z-index:1;display:flex;transition:transform .35s cubic-bezier(.4,0,.2,1);will-change:transform;overflow:hidden}
.desktop-container.dragging{transition:none}

/* 桌面图标区 */
.desktop{min-width:100%;width:100%;flex-shrink:0;padding:20px 24px 0;display:flex;flex-wrap:wrap;gap:28px 20px;align-content:flex-start;overflow:hidden;position:relative;min-height:100%}

/* 页面指示器 */
.page-dots{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);z-index:8;display:flex;gap:8px;padding:4px 12px;border-radius:12px;background:rgba(0,0,0,.1);backdrop-filter:blur(6px)}
.page-dot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.4);transition:all .25s;cursor:pointer}
.page-dot.active{background:rgba(255,255,255,.9);width:20px;border-radius:4px}

/* 跨页拖动幽灵 */
.drag-ghost{position:absolute;z-index:999;pointer-events:none;opacity:.85;transition:none;filter:drop-shadow(0 8px 20px rgba(0,0,0,.3))}
.drag-ghost .app-icon-img{animation:ghostPulse .6s ease-in-out infinite alternate}
@keyframes ghostPulse{0%{transform:scale(1)}100%{transform:scale(1.08)}}

/* 页面切换边缘提示 */
.page-edge-hint{position:absolute;top:0;bottom:0;width:40px;z-index:7;pointer-events:none;opacity:0;transition:opacity .2s}
.page-edge-hint.left{left:0;background:linear-gradient(90deg,rgba(255,255,255,.15),transparent)}
.page-edge-hint.right{right:0;background:linear-gradient(-90deg,rgba(255,255,255,.15),transparent)}
.page-edge-hint.show{opacity:1}
.app-icon{display:flex;flex-direction:column;align-items:center;gap:7px;cursor:pointer;-webkit-tap-highlight-color:transparent}
.app-icon-img{width:60px;height:60px;border-radius:16px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px rgba(0,0,0,.12);transition:transform .15s}
.app-icon:active .app-icon-img{transform:scale(.88)}
.app-icon span{font-size:11px;color:var(--text);font-weight:500;text-shadow:0 1px 3px rgba(255,255,255,.8)}

/* 弹出面板通用 */
.panel{position:absolute;inset:0;z-index:50;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.panel.open{opacity:1;pointer-events:all}
.panel-box{width:calc(100% - 40px);max-height:75%;overflow-y:auto;background:var(--bg);border-radius:24px;padding:22px 20px 28px;transform:scale(.92);transition:transform .3s cubic-bezier(.4,0,.2,1);scrollbar-width:none}
.panel-box::-webkit-scrollbar{display:none}
.panel.open .panel-box{transform:scale(1)}

.panel-title{font-size:16px;font-weight:700;color:var(--text);margin-bottom:18px;text-align:center}
.panel-close{position:absolute;top:14px;right:18px;background:none;border:none;font-size:22px;color:var(--text2);cursor:pointer;line-height:1}

/* 主题网格 */
.theme-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:22px}
.topt{display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer}
.tcircle{width:48px;height:48px;border-radius:50%;border:3px solid transparent;transition:all .2s;position:relative}
.tcircle.active{border-color:var(--text);transform:scale(1.1)}
.tcircle::after{content:'✓';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-size:15px;font-weight:700;opacity:0;transition:opacity .2s}
.tcircle.active::after{opacity:1}
.topt span{font-size:10px;color:var(--text2);font-weight:500}

/* 壁纸上传区 */
.wp-section h4{font-size:13px;color:var(--text2);font-weight:600;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:10px}
.wp-btn{width:100%;padding:18px;border:2px dashed var(--accent2);border-radius:16px;background:var(--card2);display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;font-size:13px;color:var(--text2);transition:border-color .2s}
.wp-btn:hover{border-color:var(--accent)}
.wp-preview{width:100%;height:90px;border-radius:14px;overflow:hidden;margin-top:10px;position:relative;display:none}
.wp-preview img{width:100%;height:100%;object-fit:cover}
.wp-rm{position:absolute;top:6px;right:6px;width:24px;height:24px;background:rgba(0,0,0,.45);border-radius:50%;border:none;cursor:pointer;color:#fff;font-size:14px;display:flex;align-items:center;justify-content:center}

*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,'PingFang SC',sans-serif;background:#DDD5C8;display:flex;justify-content:center;align-items:stretch;min-height:100vh;padding:0;margin:0;overflow:hidden;}
.phone{width:100vw;height:100vh;background:#F7F3EE;border-radius:0;overflow:hidden;position:relative;touch-action:pan-y;-webkit-overflow-scrolling:touch}
.phone::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:126px;height:30px;background:#111;border-radius:0 0 20px 20px;z-index:200}
.sbar{display:flex;justify-content:space-between;align-items:center;padding:14px 26px 0;height:50px;position:relative;z-index:100}
.sbar-time{font-size:15px;font-weight:600;color:var(--text);letter-spacing:.5px}
.sbar-right{display:flex;align-items:center;gap:5px}
.bat-pct{font-size:11px;color:#9B8B7A;font-weight:500}

/* 全屏页面 */
.fullpage{position:absolute;inset:0;z-index:40;background:var(--bg);transform:translateX(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;height:100%;overflow:hidden}
.fullpage.open{transform:translateX(0)}
.fp-header{display:flex;align-items:center;gap:10px;padding:12px 18px 14px;border-bottom:1px solid rgba(0,0,0,.06);flex-shrink:0;margin-top:36px}
.fp-back{background:none;border:none;cursor:pointer;padding:4px;display:flex;color:var(--text)}
.fp-back svg{width:22px;height:22px}
.fp-header h2{font-size:17px;font-weight:700;color:var(--text)}
.fp-body{flex:1;overflow-y:auto;padding:18px;scrollbar-width:none}
.fp-body::-webkit-scrollbar{display:none}

/* 设置条目 */
.set-group{background:var(--card);border-radius:18px;overflow:hidden;margin-bottom:16px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
.set-group-title{font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1.8px;text-transform:uppercase;padding:0 4px;margin-bottom:8px}
.set-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(0,0,0,.04)}
.set-row:last-child{border-bottom:none}
.set-row label{font-size:14px;color:var(--text);font-weight:500}
.set-row .sub{font-size:11px;color:var(--text2);margin-top:2px}

/* 输入框 */
.set-input{width:100%;border:1.5px solid var(--accent2);border-radius:12px;padding:10px 14px;font-size:13px;color:var(--text);background:var(--card2);outline:none;margin-top:8px;transition:border-color .2s;font-family:inherit}
.set-input:focus{border-color:var(--accent)}
.set-input::placeholder{color:var(--text2)}

/* 保存按钮 */
.save-btn{width:100%;padding:13px;background:var(--accent);color:#fff;border:none;border-radius:14px;font-size:14px;font-weight:600;cursor:pointer;margin-top:12px;transition:opacity .2s;font-family:inherit}
.save-btn:active{opacity:.8}

/* API预设列表 */
.preset-list{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
.preset-item{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--card2);border-radius:12px;border:1.5px solid var(--accent2);cursor:pointer;transition:all .2s}
.preset-item.active{border-color:var(--accent);background:var(--accent2)}
.preset-item span{flex:1;font-size:13px;color:var(--text);font-weight:500}
.preset-item .del-btn{background:none;border:none;cursor:pointer;color:var(--text2);padding:2px;display:flex}
.preset-item .del-btn svg{width:16px;height:16px}
.add-preset{width:100%;padding:10px;background:none;border:1.5px dashed var(--accent2);border-radius:12px;font-size:13px;color:var(--text2);cursor:pointer;transition:border-color .2s;font-family:inherit}
.add-preset:hover{border-color:var(--accent)}

/* 屏幕模式选择 */
.screen-opts{display:flex;flex-direction:column;gap:8px}
.screen-opt{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--card2);border-radius:12px;border:1.5px solid var(--accent2);cursor:pointer;transition:all .2s}
.screen-opt.active{border-color:var(--accent);background:var(--accent2)}
.screen-opt-icon{width:36px;height:36px;border-radius:10px;background:var(--accent2);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.screen-opt.active .screen-opt-icon{background:var(--accent)}
.screen-opt-icon svg{width:20px;height:20px;color:var(--text)}
.screen-opt.active .screen-opt-icon svg{color:#fff}
.screen-opt-info{flex:1}
.screen-opt-info h4{font-size:13px;color:var(--text);font-weight:600}
.screen-opt-info p{font-size:11px;color:var(--text2);margin-top:2px}
.screen-check{width:20px;height:20px;border-radius:50%;border:2px solid var(--accent2);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.screen-opt.active .screen-check{background:var(--accent);border-color:var(--accent)}
.screen-opt.active .screen-check::after{content:'✓';font-size:11px;color:#fff;font-weight:700}

/* 个性名片 */
.profile-card-overlay{position:absolute;inset:0;z-index:300;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity .3s}
.profile-card-overlay.open{opacity:1;pointer-events:all}
.profile-card{width:calc(100% - 56px);max-width:300px;border-radius:24px;overflow:hidden;box-shadow:0 16px 48px rgba(0,0,0,.25);transform:scale(.9);transition:transform .3s cubic-bezier(.4,0,.2,1)}
.profile-card-overlay.open .profile-card{transform:scale(1)}
.profile-card-banner{height:80px;position:relative;overflow:hidden}
.profile-card-banner::after{content:'';position:absolute;inset:0;background:linear-gradient(transparent 30%,rgba(0,0,0,.4))}
.profile-card-avatar{width:64px;height:64px;border-radius:50%;border:3px solid var(--bg);overflow:hidden;display:flex;align-items:center;justify-content:center;background:var(--accent2);position:absolute;left:50%;transform:translateX(-50%);top:-32px;box-shadow:0 4px 16px rgba(0,0,0,.2);z-index:2}
.profile-card-body{background:var(--bg);padding:40px 20px 22px;text-align:center;position:relative}
.profile-card-name{font-size:18px;font-weight:700;color:var(--text);margin-bottom:2px}
.profile-card-gender{font-size:11px;color:var(--text2);margin-bottom:12px}
.profile-card-sig{font-size:13px;color:var(--text);line-height:1.6;font-style:italic;margin-bottom:14px;padding:0 8px;min-height:20px}
.profile-card-tags{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin-bottom:16px;min-height:24px}
.profile-card-tag{padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;background:var(--accent2);color:var(--accent)}
.profile-card-stats{display:flex;justify-content:center;gap:24px;padding-top:12px;border-top:1px solid rgba(0,0,0,.06)}
.profile-card-stat{text-align:center}
.profile-card-stat-val{font-size:16px;font-weight:700;color:var(--text)}
.profile-card-stat-label{font-size:10px;color:var(--text2);margin-top:2px}
.profile-card-refresh{position:absolute;top:12px;right:12px;width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,.15);backdrop-filter:blur(8px);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .3s;z-index:3}
.profile-card-refresh:active{transform:rotate(180deg)}
.profile-card-loading{position:absolute;inset:0;background:rgba(var(--bg),.8);display:flex;align-items:center;justify-content:center;z-index:5;border-radius:24px}
@keyframes pc-spin{to{transform:rotate(360deg)}}
.pc-spinner{width:24px;height:24px;border:2.5px solid var(--accent2);border-top-color:var(--accent);border-radius:50%;animation:pc-spin .6s linear infinite}

/* 充电动画 */
@keyframes charge{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
.charging #bFill{animation:charge 1.2s ease-in-out infinite}
.charge-bolt{display:none}
.charging .charge-bolt{display:block}

/* 禁止选中/长按菜单 */
.desktop{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none}
.app-icon{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none}
.app-icon-img{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none}

/* 图标抖动 */
@keyframes wiggle{0%,100%{transform:rotate(-2deg)}50%{transform:rotate(2deg)}}
.editing .app-icon-img{animation:wiggle .3s ease-in-out infinite}
.editing .app-icon{position:relative}
.icon-del{position:absolute;top:-4px;left:-4px;width:18px;height:18px;background:#FF3B30;border-radius:50%;border:none;cursor:pointer;color:#fff;font-size:13px;line-height:18px;text-align:center;z-index:10;display:none}
.editing .icon-del{display:block}
.icon-drag{opacity:.5;pointer-events:none}

/* 跨页拖动幽灵 */
.drag-ghost{position:absolute;z-index:999;pointer-events:none;opacity:.85;transition:none;filter:drop-shadow(0 8px 20px rgba(0,0,0,.3))}
.drag-ghost .app-icon-img{animation:ghostPulse .6s ease-in-out infinite alternate}
@keyframes ghostPulse{0%{transform:scale(1)}100%{transform:scale(1.08)}}

/* 页面切换边缘提示 */
.page-edge-hint{position:absolute;top:0;bottom:0;width:40px;z-index:7;pointer-events:none;opacity:0;transition:opacity .2s}
.page-edge-hint.left{left:0;background:linear-gradient(90deg,rgba(255,255,255,.15),transparent)}
.page-edge-hint.right{right:0;background:linear-gradient(-90deg,rgba(255,255,255,.15),transparent)}
.page-edge-hint.show{opacity:1}

/* 图标自由移动模式 */
.app-icon.free{position:absolute;z-index:6;touch-action:none}
.app-icon.free .icon-lock-btn{display:flex}
.icon-lock-btn{position:absolute;top:-4px;right:-4px;width:18px;height:18px;background:rgba(80,80,80,.7);border-radius:50%;border:none;cursor:pointer;color:#fff;font-size:10px;display:none;align-items:center;justify-content:center;z-index:11}
.editing .app-icon.free .icon-lock-btn{display:flex}
.hide-locks .icon-lock-btn,.hide-locks .widget-img-lock,.hide-locks .widget-strip-lock,.hide-locks .widget-note-lock,.hide-locks .widget-banner-lock,.hide-locks .mw-lock-btn{display:none!important}
.app-icon.free.icon-locked .icon-lock-btn{background:rgba(255,180,0,.85)}
/* 发朋友圈图片格子 */
.post-img-cell{aspect-ratio:1;border-radius:10px;overflow:hidden;position:relative;background:var(--card2);border:1.5px solid var(--accent2);display:flex;align-items:center;justify-content:center;cursor:pointer}
.post-img-cell img{width:100%;height:100%;object-fit:cover;display:block}
.post-img-cell .del{position:absolute;top:3px;right:3px;width:18px;height:18px;background:rgba(0,0,0,.5);border-radius:50%;border:none;color:#fff;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1}
.post-img-add{aspect-ratio:1;border-radius:10px;border:1.5px dashed var(--accent2);background:var(--card2);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:border-color .2s}
.post-img-add:hover{border-color:var(--accent)}
/* 可见好友选项 */
.visible-opt{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:12px;border:1.5px solid var(--accent2);background:var(--card2);cursor:pointer;transition:all .2s}
.visible-opt.selected{border-color:var(--accent);background:var(--accent2)}
.visible-opt-avatar{width:32px;height:32px;border-radius:50%;background:var(--accent2);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.visible-opt span{flex:1;font-size:13px;color:var(--text);font-weight:500}
.visible-check{width:18px;height:18px;border-radius:50%;border:2px solid var(--accent2);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s}
.visible-opt.selected .visible-check{background:var(--accent);border-color:var(--accent)}
.visible-opt.selected .visible-check::after{content:'✓';font-size:10px;color:#fff;font-weight:700}

/* 裁剪弹窗 */
.crop-panel{position:absolute;inset:0;z-index:80;background:rgba(0,0,0,.7);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;opacity:0;pointer-events:none;transition:opacity .3s}
.crop-panel.open{opacity:1;pointer-events:all}
.crop-wrap{position:relative;width:260px;height:260px;overflow:hidden;border-radius:16px;background:#111;cursor:move;touch-action:none}
.crop-wrap img{position:absolute;transform-origin:0 0}
.crop-mask{position:absolute;inset:0;box-shadow:inset 0 0 0 9999px rgba(0,0,0,.45);border-radius:16px;pointer-events:none}
.crop-frame{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:160px;height:160px;border:2px solid #fff;border-radius:22px;pointer-events:none}
.crop-btns{display:flex;gap:12px}
.crop-btn{padding:10px 28px;border-radius:12px;border:none;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit}

/* 音乐小组件 */
.music-widget{position:absolute;z-index:5;width:280px;border-radius:22px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.2);touch-action:none;backdrop-filter:blur(20px);background:rgba(255,255,255,.75)}
.music-widget.dark-bg{background:rgba(30,30,40,.82);backdrop-filter:blur(24px)}
.music-widget .mw-cover-area{position:relative;height:160px;overflow:hidden;background:linear-gradient(135deg,#2c2c3e,#1a1a2e)}
.music-widget .mw-cover-area img{width:100%;height:100%;object-fit:cover;opacity:.85}
.music-widget .mw-cover-overlay{position:absolute;inset:0;background:linear-gradient(transparent 40%,rgba(0,0,0,.6))}
.music-widget .mw-info{position:absolute;bottom:12px;left:14px;right:14px;z-index:2}
.music-widget .mw-title{font-size:15px;font-weight:700;color:#fff;text-shadow:0 1px 6px rgba(0,0,0,.4);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.music-widget .mw-artist{font-size:11px;color:rgba(255,255,255,.7);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.music-widget .mw-controls{display:flex;align-items:center;justify-content:center;gap:18px;padding:12px 16px 6px}
.music-widget .mw-ctrl-btn{background:none;border:none;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;color:var(--text);opacity:.7;transition:all .15s}
.music-widget .mw-ctrl-btn:active{transform:scale(.88)}
.music-widget .mw-ctrl-btn.main{opacity:1;width:42px;height:42px;border-radius:50%;background:var(--accent);color:#fff;box-shadow:0 4px 14px rgba(0,0,0,.15)}
.music-widget .mw-progress{padding:2px 16px 12px;display:flex;align-items:center;gap:8px}
.music-widget .mw-progress-bar{flex:1;height:3px;background:var(--accent2);border-radius:2px;overflow:hidden;cursor:pointer;position:relative}
.music-widget .mw-progress-fill{height:100%;background:var(--accent);border-radius:2px;width:0%;transition:width .3s linear}
.music-widget .mw-time{font-size:9px;color:var(--text2);min-width:28px;text-align:center}
.music-widget .mw-bottom{display:flex;align-items:center;justify-content:space-between;padding:0 16px 12px}
.music-widget .mw-mode-btn{background:none;border:none;cursor:pointer;padding:3px;display:flex;color:var(--text2);transition:color .15s}
.music-widget .mw-mode-btn.active{color:var(--accent)}
.music-widget .mw-list-btn{background:none;border:none;cursor:pointer;padding:3px;display:flex;color:var(--text2)}
.mw-del-btn{position:absolute;top:8px;right:8px;width:24px;height:24px;background:rgba(0,0,0,.4);border-radius:50%;border:none;color:#fff;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;z-index:3}
.music-widget.show-ctrl .mw-del-btn{opacity:1}
.mw-resize{position:absolute;bottom:4px;right:4px;width:22px;height:22px;cursor:se-resize;opacity:0;transition:opacity .2s;z-index:3}
.music-widget.show-ctrl .mw-resize{opacity:1}
.mw-resize::after{content:'';display:block;width:12px;height:12px;border-right:2.5px solid rgba(255,255,255,.7);border-bottom:2.5px solid rgba(255,255,255,.7);position:absolute;bottom:2px;right:2px}
.mw-lock-btn{position:absolute;top:8px;left:8px;width:24px;height:24px;background:rgba(0,0,0,.4);border-radius:50%;border:none;color:#fff;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;z-index:3}
.music-widget.show-ctrl .mw-lock-btn{opacity:1}
.music-widget.locked .mw-lock-btn{opacity:.85;background:rgba(255,180,0,.7)}

/* 顶部正在播放条 */
.now-playing-bar{position:absolute;top:6px;left:50%;transform:translateX(-50%);width:calc(100% - 40px);height:48px;border-radius:16px;background:var(--card);backdrop-filter:blur(16px);box-shadow:0 4px 20px rgba(0,0,0,.12);display:flex;align-items:center;gap:10px;padding:0 6px 0 6px;z-index:210;opacity:0;pointer-events:none;transition:all .35s cubic-bezier(.4,0,.2,1);cursor:pointer}
.now-playing-bar.show{opacity:1;pointer-events:all}
.npb-cover{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#2c2c3e,#1a1a2e);overflow:hidden;flex-shrink:0}
.npb-cover img{width:100%;height:100%;object-fit:cover}
.npb-info{flex:1;min-width:0}
.npb-title{font-size:12px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.npb-artist{font-size:10px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.npb-btn{background:none;border:none;cursor:pointer;padding:6px;display:flex;color:var(--text)}
.npb-progress{position:absolute;bottom:0;left:12px;right:12px;height:2px;background:var(--accent2);border-radius:1px;overflow:hidden}
.npb-progress-fill{height:100%;background:var(--accent);width:0%;border-radius:1px}
.npb-progress{position:absolute;bottom:0;left:12px;right:12px;height:2px;background:var(--accent2);border-radius:1px;overflow:hidden}
.npb-progress-fill{height:100%;background:var(--accent);width:0%;border-radius:1px}

@keyframes disc-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.mw-disc-spinning{animation:disc-spin 8s linear infinite}

/* 歌曲列表面板 */
.music-list-item{display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:12px;cursor:pointer;transition:background .15s}
.music-list-item:active{background:var(--accent2)}
.music-list-item.playing{background:var(--accent2)}
.music-list-item .mli-idx{width:22px;font-size:12px;color:var(--text2);text-align:center;flex-shrink:0}
.music-list-item.playing .mli-idx{color:var(--accent);font-weight:700}
.music-list-item .mli-info{flex:1;min-width:0}
.music-list-item .mli-name{font-size:13px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.music-list-item.playing .mli-name{color:var(--accent)}
.music-list-item .mli-artist{font-size:11px;color:var(--text2);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.music-list-item .mli-dur{font-size:11px;color:var(--text2);flex-shrink:0}
.music-list-item .mli-del{background:none;border:none;cursor:pointer;padding:4px;color:var(--text2);display:flex;flex-shrink:0;opacity:.5;transition:opacity .15s}
.music-list-item .mli-del:hover{opacity:1}

/* 布局选择 */
.layout-opts{display:flex;gap:10px;margin-bottom:16px}
.layout-opt{flex:1;padding:10px;border-radius:12px;border:1.5px solid var(--accent2);background:var(--card2);text-align:center;cursor:pointer;font-size:13px;color:var(--text);font-weight:500;transition:all .2s}
.layout-opt.active{border-color:var(--accent);background:var(--accent2)}

/* 图片小组件 */
.widget-img{position:absolute;z-index:5;border-radius:16px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.18);touch-action:none;cursor:move}
.widget-img img{width:100%;height:100%;object-fit:cover;display:block;pointer-events:none}
.widget-img-del{position:absolute;top:5px;right:5px;width:22px;height:22px;background:rgba(0,0,0,.5);border-radius:50%;border:none;color:#fff;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.widget-img.show-ctrl .widget-img-del{opacity:1}
.widget-img-lock{position:absolute;top:5px;left:5px;width:22px;height:22px;background:rgba(0,0,0,.5);border-radius:50%;border:none;color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.widget-img.show-ctrl .widget-img-lock{opacity:1}
.widget-img.locked .widget-img-lock{opacity:.85;background:rgba(255,180,0,.7)}
.widget-resize{position:absolute;bottom:4px;right:4px;width:18px;height:18px;cursor:se-resize;opacity:0;transition:opacity .2s}
.widget-img.show-ctrl .widget-resize{opacity:1}
.widget-resize::after{content:'';display:block;width:10px;height:10px;border-right:2.5px solid rgba(255,255,255,.8);border-bottom:2.5px solid rgba(255,255,255,.8);position:absolute;bottom:2px;right:2px}

/* 图片小组件 */
.widget-img{position:absolute;z-index:5;border-radius:16px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.18);touch-action:none}
.widget-img img{width:100%;height:100%;object-fit:cover;display:block;pointer-events:none}
.widget-img-del{position:absolute;top:5px;right:5px;width:22px;height:22px;background:rgba(0,0,0,.5);border-radius:50%;border:none;color:#fff;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.widget-img.show-ctrl .widget-img-del{opacity:1}
.widget-resize{position:absolute;bottom:4px;right:4px;width:18px;height:18px;opacity:0;transition:opacity .2s}
.widget-img.show-ctrl .widget-resize{opacity:1}
.widget-resize::after{content:'';display:block;width:10px;height:10px;border-right:2.5px solid rgba(255,255,255,.8);border-bottom:2.5px solid rgba(255,255,255,.8);position:absolute;bottom:2px;right:2px}

/* 竖条图片组件 */
.widget-strip{position:absolute;z-index:5;width:64px;height:180px;border-radius:18px;overflow:hidden;box-shadow:0 4px 18px rgba(0,0,0,.2);touch-action:none;background:linear-gradient(180deg,var(--accent2),var(--card2))}
.widget-strip img{width:100%;height:100%;object-fit:cover;display:block;pointer-events:none}
.widget-strip-del{position:absolute;top:5px;right:5px;width:20px;height:20px;background:rgba(0,0,0,.5);border-radius:50%;border:none;color:#fff;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.widget-strip.show-ctrl .widget-strip-del{opacity:1}
.widget-strip-lock{position:absolute;top:5px;left:5px;width:20px;height:20px;background:rgba(0,0,0,.5);border-radius:50%;border:none;color:#fff;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.widget-strip.show-ctrl .widget-strip-lock{opacity:1}
.widget-strip.locked .widget-strip-lock{opacity:.85;background:rgba(255,180,0,.7)}
.widget-strip-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;color:var(--text2);font-size:11px}

/* 文字便签组件 */
.widget-note{position:absolute;z-index:5;width:140px;min-height:100px;border-radius:4px 4px 4px 20px;padding:12px 10px 24px;box-shadow:0 4px 16px rgba(0,0,0,.15);touch-action:none;font-size:13px;line-height:1.6;color:#5a4a3a;word-break:break-all;background:linear-gradient(135deg,#fff9c4 0%,#fff59d 100%)}
.widget-note::before{content:'';position:absolute;top:0;right:0;border-width:0 16px 16px 0;border-style:solid;border-color:#e6d85a transparent transparent #e6d85a;border-radius:0 4px 0 0}
.widget-note-del{position:absolute;bottom:4px;right:4px;width:18px;height:18px;background:rgba(0,0,0,.2);border-radius:50%;border:none;color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.widget-note.show-ctrl .widget-note-del{opacity:1}
.widget-note-lock{position:absolute;bottom:4px;left:4px;width:18px;height:18px;background:rgba(0,0,0,.2);border-radius:50%;border:none;color:#fff;font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.widget-note.show-ctrl .widget-note-lock{opacity:1}
.widget-note.locked .widget-note-lock{opacity:.85;background:rgba(255,180,0,.7)}
.widget-note-text{outline:none;min-height:60px;cursor:text;pointer-events:none}
.widget-note.show-ctrl .widget-note-text{pointer-events:auto}
.widget-note-text:empty::before{content:'点击编辑...';color:rgba(0,0,0,.3)}

/* 时钟组件 */
.widget-clock{position:absolute;z-index:5;border-radius:20px;padding:14px 18px;box-shadow:0 4px 18px rgba(0,0,0,.15);touch-action:none;text-align:center;min-width:100px}
.widget-clock.style-minimal{background:rgba(255,255,255,.85);backdrop-filter:blur(10px)}
.widget-clock.style-dark{background:rgba(0,0,0,.7);backdrop-filter:blur(10px)}
.widget-clock.style-gradient{background:linear-gradient(135deg,#667eea,#764ba2)}
.widget-clock.style-glass{background:rgba(255,255,255,.2);backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,.3)}
.widget-clock-time{font-size:32px;font-weight:700;letter-spacing:-1px;font-variant-numeric:tabular-nums}
.widget-clock.style-minimal .widget-clock-time{color:#333}
.widget-clock.style-dark .widget-clock-time{color:#fff}
.widget-clock.style-gradient .widget-clock-time{color:#fff}
.widget-clock.style-glass .widget-clock-time{color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.3)}
.widget-clock-date{font-size:11px;margin-top:2px;opacity:.7}
.widget-clock.style-minimal .widget-clock-date{color:#666}
.widget-clock.style-dark .widget-clock-date{color:#aaa}
.widget-clock.style-gradient .widget-clock-date{color:rgba(255,255,255,.8)}
.widget-clock.style-glass .widget-clock-date{color:rgba(255,255,255,.8)}
.widget-clock-del{position:absolute;top:-6px;right:-6px;width:20px;height:20px;background:rgba(0,0,0,.5);border-radius:50%;border:none;color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.widget-clock.show-ctrl .widget-clock-del{opacity:1}
.widget-clock-style{position:absolute;top:-6px;left:-6px;width:20px;height:20px;background:rgba(0,0,0,.5);border-radius:50%;border:none;color:#fff;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.widget-clock.show-ctrl .widget-clock-style{opacity:1}

/* 横幅图片组件 */
.widget-banner{position:absolute;z-index:5;width:200px;height:70px;border-radius:14px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.18);touch-action:none;background:linear-gradient(90deg,var(--accent2),var(--card2))}
.widget-banner img{width:100%;height:100%;object-fit:cover;display:block;pointer-events:none}
.widget-banner-del{position:absolute;top:5px;right:5px;width:20px;height:20px;background:rgba(0,0,0,.5);border-radius:50%;border:none;color:#fff;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.widget-banner.show-ctrl .widget-banner-del{opacity:1}
.widget-banner-lock{position:absolute;top:5px;left:5px;width:20px;height:20px;background:rgba(0,0,0,.5);border-radius:50%;border:none;color:#fff;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.widget-banner.show-ctrl .widget-banner-lock{opacity:1}
.widget-banner.locked .widget-banner-lock{opacity:.85;background:rgba(255,180,0,.7)}
.widget-banner-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;gap:8px;color:var(--text2);font-size:11px}
.widget-banner-resize{position:absolute;bottom:3px;right:3px;width:16px;height:16px;cursor:se-resize;opacity:0;transition:opacity .2s}
.widget-banner.show-ctrl .widget-banner-resize{opacity:1}
.widget-banner-resize::after{content:'';display:block;width:8px;height:8px;border-right:2px solid rgba(255,255,255,.7);border-bottom:2px solid rgba(255,255,255,.7);position:absolute;bottom:2px;right:2px}

/* 文案卡片组件 */
.widget-textcard{position:absolute;z-index:5;width:160px;border-radius:16px;box-shadow:0 4px 18px rgba(0,0,0,.12);touch-action:none;overflow:hidden}
.widget-textcard-header{padding:10px 12px 8px;cursor:move;display:flex;align-items:center;gap:6px;border-bottom:1px solid rgba(0,0,0,.06)}
.widget-textcard-header svg{flex-shrink:0;opacity:.4}
.widget-textcard-title{flex:1;font-size:14px;font-weight:700;outline:none;min-height:20px}
.widget-textcard-title:empty::before{content:'标题';color:rgba(0,0,0,.25)}
.widget-textcard-body{padding:10px 12px 14px}
.widget-textcard-content{font-size:12px;line-height:1.7;outline:none;min-height:40px}
.widget-textcard-content:empty::before{content:'点击输入内容...';color:rgba(0,0,0,.25)}
.widget-textcard-del{position:absolute;top:8px;right:8px;width:18px;height:18px;background:rgba(0,0,0,.15);border-radius:50%;border:none;color:#fff;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.widget-textcard.show-ctrl .widget-textcard-del{opacity:1}
.widget-textcard-style{position:absolute;bottom:6px;right:6px;width:18px;height:18px;background:rgba(0,0,0,.1);border-radius:50%;border:none;color:var(--text2);font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.widget-textcard.show-ctrl .widget-textcard-style{opacity:1}
.widget-textcard.style-light{background:#fff;color:#333}
.widget-textcard.style-dark{background:#1a1a2e;color:#eee}
.widget-textcard.style-warm{background:linear-gradient(135deg,#ffecd2,#fcb69f);color:#5a3e2a}
.widget-textcard.style-cool{background:linear-gradient(135deg,#a1c4fd,#c2e9fb);color:#2a3e5a}
.widget-textcard.style-dark .widget-textcard-header{border-color:rgba(255,255,255,.1)}
.widget-textcard.style-dark .widget-textcard-title:empty::before,.widget-textcard.style-dark .widget-textcard-content:empty::before{color:rgba(255,255,255,.3)}

/* 看书悬浮窗 */
.book-float{position:absolute;z-index:65;width:calc(100% - 32px);max-width:340px;border-radius:20px;background:var(--bg);box-shadow:0 8px 36px rgba(0,0,0,.18);overflow:hidden;touch-action:none;transition:height .3s;left:16px;top:80px}
.book-float .bf-header{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--card2);cursor:move;border-bottom:1px solid rgba(0,0,0,.06);flex-shrink:0}
.book-float .bf-header .bf-title{flex:1;font-size:13px;font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.book-float .bf-btn{background:none;border:none;cursor:pointer;padding:3px;display:flex;color:var(--text2);flex-shrink:0}
.book-float .bf-body{padding:12px 14px;overflow-y:auto;scrollbar-width:none;max-height:45vh}
.book-float .bf-body::-webkit-scrollbar{display:none}
.book-float .bf-content{font-size:14px;color:var(--text);line-height:1.85;text-align:justify;letter-spacing:.2px}
.book-float .bf-footer{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;border-top:1px solid rgba(0,0,0,.06);background:var(--card2);gap:6px;flex-shrink:0}
.book-float .bf-footer button{padding:6px 12px;border-radius:8px;border:1px solid var(--accent2);background:none;font-size:11px;color:var(--text2);cursor:pointer;font-family:inherit}
.book-float .bf-footer button.primary{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:600}
.book-float.minimized .bf-body,.book-float.minimized .bf-footer{display:none}
.book-float.minimized{width:180px}

/* 群聊头像九宫格 */
.group-avatar{display:grid;gap:1px;border-radius:50%;overflow:hidden;background:var(--accent2);flex-shrink:0}
.group-avatar.m2{grid-template-columns:1fr 1fr;width:46px;height:46px;padding:5px}
.group-avatar.m3{grid-template-columns:1fr 1fr;width:46px;height:46px;padding:4px}
.group-avatar.m4{grid-template-columns:1fr 1fr;width:46px;height:46px;padding:3px}
.group-avatar.m5,.group-avatar.m6,.group-avatar.m7,.group-avatar.m8,.group-avatar.m9{grid-template-columns:1fr 1fr 1fr;width:46px;height:46px;padding:3px}
.group-avatar img{width:100%;height:100%;object-fit:cover;border-radius:2px}
.group-avatar .ga-placeholder{background:var(--card2);border-radius:2px;display:flex;align-items:center;justify-content:center}
.group-avatar .ga-placeholder svg{width:60%;height:60%}

/* 论坛详情页评论 */
.forum-comment-item{padding:12px 16px;border-bottom:1px solid rgba(0,0,0,.04);display:flex;gap:10px}
.forum-comment-avatar{width:34px;height:34px;border-radius:50%;background:var(--accent2);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:13px;font-weight:700;color:var(--accent)}
.forum-comment-body{flex:1;min-width:0}
.forum-comment-name{font-size:13px;font-weight:600;color:var(--accent);margin-bottom:3px}
.forum-comment-text{font-size:13px;color:var(--text);line-height:1.6}
.forum-comment-meta{font-size:11px;color:var(--text2);margin-top:4px;display:flex;gap:10px}

/* 论坛帖子列表 */
.forum-post-item{padding:14px 16px;border-bottom:1px solid rgba(0,0,0,.05);cursor:pointer;background:var(--bg);transition:background .15s}
.forum-post-item:active{background:var(--card2)}
.forum-post-tag{display:inline-block;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:600;margin-bottom:6px}
.forum-post-title{font-size:15px;font-weight:700;color:var(--text);line-height:1.4;margin-bottom:6px}
.forum-post-preview{font-size:12px;color:var(--text2);line-height:1.5;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.forum-post-meta{display:flex;align-items:center;gap:10px;font-size:11px;color:var(--text2)}
.forum-post-author{font-weight:600;color:var(--accent)}
.forum-post-stats{display:flex;gap:10px;margin-left:auto}

/* ===== "我"页面 - 韩系定制v风格 ===== */
.me-hero { position: relative; height: 280px; overflow: hidden; flex-shrink: 0; cursor: pointer; border-radius: 0 0 36px 36px; box-shadow: 0 8px 32px rgba(0,0,0,0.06); }
.me-hero-bg { position: absolute; inset: 0; background: linear-gradient(145deg, var(--accent), color-mix(in srgb, var(--accent) 60%, var(--accent2))); z-index: 0; }
.me-hero-bg img { width: 100%; height: 100%; object-fit: cover; display: block; }
.me-hero-fade { position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 30%, rgba(0,0,0,0.5) 100%); z-index: 1; pointer-events: none; }
.me-hero-profile { position: absolute; bottom: 28px; left: 24px; right: 24px; z-index: 2; display: flex; align-items: center; gap: 18px; }
.me-hero-avatar { width: 84px; height: 84px; border-radius: 50%; background: var(--card); display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; border: 4px solid rgba(255,255,255,0.95); box-shadow: 0 12px 32px rgba(0,0,0,0.2); transition: transform .2s cubic-bezier(.4,0,.2,1); flex-shrink: 0; }
.me-hero-avatar:active { transform: scale(.92); }
.me-hero-avatar img { width: 100%; height: 100%; object-fit: cover; }
.me-hero-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
.me-hero-name { font-size: 24px; font-weight: 800; color: #fff; text-shadow: 0 2px 12px rgba(0,0,0,0.3); letter-spacing: .5px; margin-bottom: 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.me-hero-desc { font-size: 13px; color: rgba(255,255,255,0.9); line-height: 1.5; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; text-shadow: 0 1px 6px rgba(0,0,0,0.2); }

/* 统计卡片 - 悬浮毛玻璃 */
.me-stats-card { display: flex; align-items: center; justify-content: space-around; margin: -24px 20px 0; padding: 22px 10px; background: rgba(255,255,255,0.85); backdrop-filter: blur(24px); border-radius: 28px; box-shadow: 0 16px 48px rgba(0,0,0,0.08); position: relative; z-index: 3; border: 1px solid rgba(255,255,255,0.6); }
.me-stat-item { display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; }
.me-stat-val { font-size: 24px; font-weight: 800; color: var(--text); letter-spacing: -.5px; font-family: ui-rounded, system-ui, sans-serif; }
.me-stat-label { font-size: 11px; color: var(--text2); font-weight: 700; letter-spacing: .5px; }
.me-stat-divider { width: 1.5px; height: 28px; background: rgba(0,0,0,0.05); border-radius: 1px; }

/* 人设卡片 - 韩系极简 */
.me-preset-item { display: flex; align-items: center; gap: 16px; padding: 18px; background: var(--card); border-radius: 28px; border: 2px solid transparent; cursor: pointer; transition: all .3s cubic-bezier(.4,0,.2,1); margin-bottom: 14px; box-shadow: 0 4px 24px rgba(0,0,0,0.03); }
.me-preset-item:active { transform: scale(0.97); }
.me-preset-item.active { border-color: var(--accent); box-shadow: 0 12px 36px rgba(0,0,0,0.08); background: linear-gradient(to right, var(--card), var(--card2)); }
.me-preset-item .me-preset-avatar { width: 56px; height: 56px; border-radius: 20px; background: var(--accent2); display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden; box-shadow: 0 4px 16px rgba(0,0,0,0.06); }
.me-preset-item .me-preset-info { flex: 1; min-width: 0; }
.me-preset-item .me-preset-info span { display: block; font-size: 17px; color: var(--text); font-weight: 800; letter-spacing: .2px; margin-bottom: 4px; }
.me-preset-item .me-preset-info small { display: block; font-size: 12px; color: var(--text2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.4; font-weight: 500; }

/* 编辑卡片 - 悬浮表单 */
.me-edit-card { background: var(--card); border-radius: 32px; box-shadow: 0 16px 48px rgba(0,0,0,0.06); overflow: hidden; margin-top: 12px; border: 1px solid rgba(0,0,0,0.02); }
.me-edit-header { display: flex; align-items: center; gap: 12px; padding: 24px 24px 16px; font-size: 17px; font-weight: 800; color: var(--text); border-bottom: 1px solid rgba(0,0,0,0.03); background: var(--card2); }
.me-edit-body { padding: 20px 24px 28px; display: flex; flex-direction: column; gap: 20px; }
.me-edit-label { font-size: 12px; color: var(--text2); margin-bottom: 8px; font-weight: 800; letter-spacing: .5px; text-transform: uppercase; }

/* 优化输入框和按钮 */
.me-edit-body .set-input { background: var(--card2); border: 2px solid transparent; border-radius: 20px; padding: 16px 18px; font-size: 14px; transition: all .2s; box-shadow: inset 0 2px 6px rgba(0,0,0,0.02); font-weight: 500; }
.me-edit-body .set-input:focus { border-color: var(--accent); background: var(--card); box-shadow: 0 8px 24px rgba(0,0,0,0.06); }
.me-edit-body .save-btn { border-radius: 22px; padding: 18px; font-size: 16px; font-weight: 800; letter-spacing: 1px; box-shadow: 0 12px 32px rgba(0,0,0,0.15); margin-top: 10px; }

/* 性别选项 */
.gender-opt { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px; border-radius: 20px; border: 2px solid var(--accent2); background: var(--card2); font-size: 14px; color: var(--text2); cursor: pointer; transition: all .2s cubic-bezier(.4,0,.2,1); font-weight: 700; }
.gender-opt.active { border-color: var(--accent); background: var(--accent); color: #fff; box-shadow: 0 8px 24px rgba(0,0,0,0.15); transform: translateY(-2px); }

/* 朋友圈动态卡片 */
.moment-card{padding:14px 16px;border-bottom:1px solid rgba(0,0,0,.05);display:flex;gap:12px;background:var(--bg)}
.moment-avatar{width:40px;height:40px;border-radius:50%;background:var(--accent2);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.moment-body{flex:1;min-width:0}
.moment-name{font-size:14px;font-weight:600;color:var(--accent);margin-bottom:5px}
.moment-text{font-size:14px;color:var(--text);line-height:1.6;margin-bottom:8px;word-break:break-all}
.moment-imgs{display:grid;gap:4px;margin-bottom:8px}
.moment-imgs.n1{grid-template-columns:1fr;max-width:180px}
.moment-imgs.n2,.moment-imgs.n4{grid-template-columns:1fr 1fr}
.moment-imgs.n3,.moment-imgs.n6,.moment-imgs.n9{grid-template-columns:1fr 1fr 1fr}
.moment-img-item{aspect-ratio:1;border-radius:8px;overflow:hidden;background:var(--accent2)}
.moment-img-item img{width:100%;height:100%;object-fit:cover;display:block}
.moment-meta{display:flex;align-items:center;justify-content:space-between;margin-top:4px}
.moment-time{font-size:11px;color:var(--text2)}
.moment-actions{display:flex;gap:14px}
.moment-action-btn{background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:4px;font-size:12px;color:var(--text2);padding:0;font-family:inherit}
.moment-action-btn.liked{color:var(--accent)}
.moment-likes{font-size:12px;color:var(--accent);margin-top:6px;line-height:1.6}
.moment-comments{margin-top:6px;background:var(--card2);border-radius:10px;padding:8px 10px;display:flex;flex-direction:column;gap:4px}
.moment-comment-item{font-size:12px;color:var(--text);line-height:1.5;cursor:pointer;padding:2px 4px;border-radius:6px;transition:background .15s}
.moment-comment-item:active{background:var(--accent2)}
.moment-comment-name{color:var(--accent);font-weight:600}

/* 聊天Tab */
.chat-tabs{display:flex;border-top:1px solid rgba(0,0,0,.06);background:var(--bg);flex-shrink:0;padding-bottom:env(safe-area-inset-bottom,0)}
.chat-tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 0 10px;gap:3px;cursor:pointer;border:none;background:none;font-family:inherit;position:relative;transition:all .2s}
.chat-tab span{font-size:10px;font-weight:600;color:var(--text2);transition:color .2s;letter-spacing:.2px}
.chat-tab svg{color:var(--text2);transition:all .2s}
.chat-tab.active span{color:var(--accent)}
.chat-tab.active svg{color:var(--accent);transform:scale(1.08)}
.chat-tab:active{transform:scale(.92)}
.chat-tab.active::after{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:20px;height:2.5px;background:var(--accent);border-radius:0 0 2px 2px}

/* 消息操作菜单 */
.msg-action-menu{position:absolute;z-index:200;background:var(--card);border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.18);overflow:hidden;min-width:130px;border:1px solid rgba(0,0,0,.04);backdrop-filter:blur(20px)}
.msg-action-item{padding:13px 22px;font-size:14px;color:var(--text);cursor:pointer;transition:background .15s;font-weight:500;border-bottom:1px solid rgba(0,0,0,.03)}
.msg-action-item:last-child{border-bottom:none}
.msg-action-item:active{background:var(--card2)}
.msg-action-item.danger{color:#FF3B30}

/* 多选模式 */
.msg-select-bar{position:absolute;bottom:16px;left:14px;right:14px;background:var(--card);border-radius:24px;box-shadow:0 8px 32px rgba(0,0,0,.15);padding:12px 18px;display:flex;align-items:center;justify-content:space-between;z-index:30}
.msg-checkbox{width:22px;height:22px;border-radius:50%;border:2px solid var(--accent2);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;cursor:pointer}
.msg-checkbox.checked{background:var(--accent);border-color:var(--accent)}
.msg-checkbox.checked::after{content:'✓';font-size:12px;color:#fff;font-weight:700}

/* 拍照弹窗 */
.photo-panel{position:absolute;inset:0;z-index:90;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.photo-panel.open{opacity:1;pointer-events:all}
.photo-box{width:100%;background:var(--bg);border-radius:28px 28px 0 0;padding:24px 20px 36px;transform:translateY(40px);transition:transform .35s cubic-bezier(.4,0,.2,1)}
.photo-panel.open .photo-box{transform:translateY(0)}
.photo-viewfinder{width:100%;height:180px;border-radius:20px;background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);position:relative;overflow:hidden;margin-bottom:18px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px}
.photo-viewfinder::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 40px,rgba(255,255,255,.03) 40px,rgba(255,255,255,.03) 41px),repeating-linear-gradient(90deg,transparent,transparent 40px,rgba(255,255,255,.03) 40px,rgba(255,255,255,.03) 41px)}
.photo-corner{position:absolute;width:20px;height:20px;border-color:rgba(255,255,255,.6);border-style:solid}
.photo-corner.tl{top:12px;left:12px;border-width:2px 0 0 2px;border-radius:4px 0 0 0}
.photo-corner.tr{top:12px;right:12px;border-width:2px 2px 0 0;border-radius:0 4px 0 0}
.photo-corner.bl{bottom:12px;left:12px;border-width:0 0 2px 2px;border-radius:0 0 0 4px}
.photo-corner.br{bottom:12px;right:12px;border-width:0 2px 2px 0;border-radius:0 0 4px 0}
.photo-preview-text{color:rgba(255,255,255,.5);font-size:13px;text-align:center;padding:0 20px;line-height:1.6;z-index:1}
.photo-preview-text.has-text{color:rgba(255,255,255,.9)}
.photo-shutter{position:absolute;bottom:10px;right:12px;font-size:10px;color:rgba(255,255,255,.35);letter-spacing:1px}
.photo-tag{padding:6px 14px;border-radius:20px;border:1.5px solid var(--accent2);background:var(--card2);font-size:12px;color:var(--text2);cursor:pointer;transition:all .2s;font-weight:500}
.photo-tag.active{border-color:var(--accent);background:var(--accent2);color:var(--text)}

/* 顶部通知 */
.top-notify{position:absolute;left:50%;transform:translateX(-50%) translateY(-20px);width:calc(100% - 32px);background:rgba(255,255,255,.92);backdrop-filter:blur(20px);border-radius:18px;box-shadow:0 8px 36px rgba(0,0,0,.12),0 2px 8px rgba(0,0,0,.06);padding:12px 14px;display:flex;align-items:center;gap:10px;opacity:0;pointer-events:none;transition:all .4s cubic-bezier(.4,0,.2,1);z-index:999;border:1px solid rgba(255,255,255,.3)}
.top-notify.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:all}
.top-notify-avatar{width:36px;height:36px;border-radius:10px;background:var(--accent2);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.top-notify-body{flex:1;min-width:0}
.top-notify-title{font-size:12px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:5px}
.top-notify-title span{font-size:10px;color:var(--text2);font-weight:400;margin-left:auto}
.top-notify-text{font-size:13px;color:var(--text2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* toast */
.toast{position:absolute;bottom:110px;left:50%;transform:translateX(-50%) translateY(6px);background:rgba(60,46,34,.88);color:#fff;padding:9px 20px;border-radius:20px;font-size:13px;opacity:0;transition:all .28s;pointer-events:none;white-space:nowrap;z-index:999}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* 气泡样式 */
.tg-bubble{position:relative;border-radius:18px;font-size:13.5px;line-height:1.65;padding:9px 13px;max-width:72%;word-break:break-word;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.tg-bubble.media{padding:0;overflow:hidden;background:transparent!important;box-shadow:none}

/* 发送动画 */
@keyframes msgSendPop{
  0%{opacity:0;transform:scale(.5) translateY(16px)}
  60%{opacity:1;transform:scale(1.03) translateY(-2px)}
  100%{transform:scale(1) translateY(0)}
}
@keyframes msgReceivePop{
  0%{opacity:0;transform:scale(.5) translateY(16px)}
  60%{opacity:1;transform:scale(1.02) translateY(-2px)}
  100%{transform:scale(1) translateY(0)}
}
.tg-bubble.anim-send{animation:msgSendPop .32s cubic-bezier(.34,1.56,.64,1) both}
.tg-bubble.anim-recv{animation:msgReceivePop .35s cubic-bezier(.34,1.56,.64,1) both}
.editing .app-icon.free .icon-lock-btn{display:flex}

/* 陪伴模式悬浮窗 */
.companion-float{position:absolute;z-index:250;width:220px;border-radius:22px;background:var(--bg);box-shadow:0 8px 36px rgba(0,0,0,.2);overflow:visible;touch-action:none;transition:box-shadow .3s}
.companion-float.speaking{box-shadow:0 8px 36px rgba(0,0,0,.2),0 0 0 2px var(--accent),0 0 20px rgba(var(--accent-rgb,100,100,100),.15)}
.cf-header{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:move;position:relative}
.cf-avatar{width:42px;height:42px;border-radius:50%;background:var(--accent2);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 2px 10px rgba(0,0,0,.12)}
.cf-avatar img{width:100%;height:100%;object-fit:cover}
.cf-avatar-ring{position:absolute;inset:-3px;border-radius:50%;border:2px solid var(--accent);opacity:0;animation:cfRingPulse 2s ease-in-out infinite}
.companion-float.active .cf-avatar-ring{opacity:1}
@keyframes cfRingPulse{0%,100%{opacity:.3;transform:scale(1)}50%{opacity:.8;transform:scale(1.06)}}
.cf-info{flex:1;min-width:0}
.cf-name{font-size:13px;font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cf-status{font-size:10px;color:var(--accent);display:flex;align-items:center;gap:4px}
.cf-status-dot{width:5px;height:5px;border-radius:50%;background:var(--accent);animation:cfDotBlink 1.5s ease-in-out infinite}
@keyframes cfDotBlink{0%,100%{opacity:.4}50%{opacity:1}}
.cf-close{background:none;border:none;cursor:pointer;padding:4px;color:var(--text2);display:flex;flex-shrink:0}
.cf-wave{display:flex;align-items:center;gap:2px;height:18px;padding:0 4px}
.cf-wave-bar{width:3px;border-radius:2px;background:var(--accent);animation:cfWave 1.2s ease-in-out infinite}
.cf-wave-bar:nth-child(1){height:6px;animation-delay:0s}
.cf-wave-bar:nth-child(2){height:12px;animation-delay:.15s}
.cf-wave-bar:nth-child(3){height:8px;animation-delay:.3s}
.cf-wave-bar:nth-child(4){height:14px;animation-delay:.1s}
.cf-wave-bar:nth-child(5){height:6px;animation-delay:.25s}
.companion-float:not(.speaking) .cf-wave-bar{animation:cfWaveIdle 2s ease-in-out infinite}
@keyframes cfWave{0%,100%{height:4px;opacity:.4}50%{height:16px;opacity:1}}
@keyframes cfWaveIdle{0%,100%{height:4px;opacity:.25}50%{height:7px;opacity:.4}}
.cf-bubble{padding:0 12px 12px;max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(.4,0,.2,1),padding .3s}
.cf-bubble.show{max-height:200px;padding:4px 12px 14px}
.cf-bubble-text{font-size:12px;color:var(--text);line-height:1.7;opacity:0;transform:translateY(6px);transition:opacity .5s,transform .5s}
.cf-bubble.show .cf-bubble-text{opacity:1;transform:translateY(0)}
.cf-bubble-text .cf-char{opacity:0;display:inline;animation:cfCharIn .3s forwards}
@keyframes cfCharIn{to{opacity:1}}
.cf-actions{display:flex;gap:6px;padding:0 12px 10px}
.cf-action-btn{padding:5px 12px;border-radius:16px;border:1px solid var(--accent2);background:none;font-size:10px;color:var(--text2);cursor:pointer;font-family:inherit;transition:all .15s}
.cf-action-btn:active{background:var(--accent2)}
.cf-action-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}

/* 听歌氛围模式 */
.listen-ambient .listen-ambient-bg{position:absolute;inset:0;z-index:0;opacity:0;transition:opacity .8s ease;pointer-events:none}
.listen-ambient .listen-ambient-bg.show{opacity:1}
.listen-ambient .listen-ambient-bg .lab-img{width:100%;height:100%;object-fit:cover;filter:blur(30px) brightness(.35) saturate(1.4);transform:scale(1.2)}
.listen-ambient .listen-ambient-bg .lab-overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.3) 0%,rgba(0,0,0,.6) 50%,rgba(0,0,0,.4) 100%)}
.listen-ambient-cover{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1;pointer-events:none;opacity:0;transition:all .6s cubic-bezier(.4,0,.2,1)}
.listen-ambient-cover.show{opacity:1}
.listen-ambient-cover .lac-disc{width:160px;height:160px;border-radius:50%;overflow:hidden;box-shadow:0 0 60px rgba(0,0,0,.5),0 0 120px rgba(0,0,0,.2);border:4px solid rgba(255,255,255,.1);animation:lac-spin 20s linear infinite paused}
.listen-ambient-cover.playing .lac-disc{animation-play-state:running}
.listen-ambient-cover .lac-disc img{width:100%;height:100%;object-fit:cover}
.listen-ambient-cover .lac-disc .lac-hole{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:28px;height:28px;border-radius:50%;background:rgba(0,0,0,.8);border:2px solid rgba(255,255,255,.1)}
.listen-ambient-cover .lac-info{text-align:center;margin-top:16px}
.listen-ambient-cover .lac-title{font-size:16px;font-weight:700;color:#fff;text-shadow:0 2px 12px rgba(0,0,0,.5)}
.listen-ambient-cover .lac-artist{font-size:12px;color:rgba(255,255,255,.6);margin-top:4px}
@keyframes lac-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

/* 弹幕感想 */
.listen-danmaku-layer{position:absolute;inset:0;z-index:2;pointer-events:none;overflow:hidden}
.listen-danmaku{position:absolute;white-space:nowrap;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:500;color:rgba(255,255,255,.9);background:rgba(255,255,255,.1);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08);animation:danmaku-float linear forwards;opacity:0}
@keyframes danmaku-float{0%{transform:translateX(100vw);opacity:0}5%{opacity:.9}85%{opacity:.9}100%{transform:translateX(-120%);opacity:0}}

/* 氛围模式下的消息区调整 */
.listen-ambient #convMessages{position:relative;z-index:3}
.listen-ambient .tg-bubble{backdrop-filter:blur(6px)}
.listen-ambient .fp-header{position:relative;z-index:4;background:rgba(0,0,0,.4)!important;backdrop-filter:blur(12px);border-color:rgba(255,255,255,.06)!important}
.listen-ambient .fp-header h2{color:#fff!important}
.listen-ambient .fp-header .fp-back svg{stroke:#fff}
.listen-ambient .fp-header button svg{stroke:#fff}

/* 氛围模式底栏 */
.listen-ambient-bottom{position:relative;z-index:4;background:rgba(0,0,0,.5)!important;backdrop-filter:blur(12px);border-color:rgba(255,255,255,.06)!important}
.listen-ambient-bottom .set-input{background:rgba(255,255,255,.1)!important;border-color:rgba(255,255,255,.1)!important;color:#fff!important}
.listen-ambient-bottom .set-input::placeholder{color:rgba(255,255,255,.4)!important}
.listen-ambient-bottom button{color:#fff}

/* 一起听歌共享播放条 */
.listen-together-bar{position:sticky;top:100px;z-index:20;display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--card);border-radius:20px;box-shadow:0 4px 16px rgba(0,0,0,.08);cursor:pointer;transition:all .3s;margin-bottom:10px}
.listen-together-bar .ltb-disc{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,#2c2c3e,#1a1a2e);overflow:hidden;flex-shrink:0;box-shadow:0 2px 10px rgba(0,0,0,.2);display:flex;align-items:center;justify-content:center}
.listen-together-bar .ltb-disc img{width:100%;height:100%;object-fit:cover}
.listen-together-bar .ltb-disc.spinning{animation:disc-spin 8s linear infinite}
.listen-together-bar .ltb-info{flex:1;min-width:0}
.listen-together-bar .ltb-label{font-size:10px;color:var(--accent);font-weight:600;letter-spacing:.5px;display:flex;align-items:center;gap:4px}
.listen-together-bar .ltb-label .ltb-dot{width:5px;height:5px;border-radius:50%;background:var(--accent);animation:cfDotBlink 1.5s ease-in-out infinite}
.listen-together-bar .ltb-song{font-size:13px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:2px}
.listen-together-bar .ltb-artist{font-size:11px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.listen-together-bar .ltb-btn{background:none;border:none;cursor:pointer;padding:4px;color:var(--text);display:flex;flex-shrink:0}
.listen-together-bar .ltb-close{background:none;border:none;cursor:pointer;padding:4px;color:var(--text2);display:flex;flex-shrink:0}

/* 歌曲卡片气泡 */
.song-card-bubble{width:220px;border-radius:16px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.1)}
.song-card-top{height:60px;background:linear-gradient(135deg,#2c2c3e,#1a1a2e);position:relative;display:flex;align-items:center;padding:0 14px;gap:12px}
.song-card-top img{width:42px;height:42px;border-radius:10px;object-fit:cover;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.song-card-top .sct-info{flex:1;min-width:0}
.song-card-top .sct-name{font-size:13px;font-weight:700;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.song-card-top .sct-artist{font-size:11px;color:rgba(255,255,255,.6);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.song-card-bottom{padding:8px 14px;background:var(--card);display:flex;align-items:center;gap:6px}
.song-card-bottom svg{flex-shrink:0}
.song-card-bottom span{font-size:11px;color:var(--accent);font-weight:600}

/* 陪伴记录面板 */
.companion-log-item{padding:12px 14px;border-bottom:1px solid rgba(0,0,0,.04)}
.companion-log-time{font-size:10px;color:var(--text2);margin-bottom:4px}
.companion-log-text{font-size:13px;color:var(--text);line-height:1.7}
</style>
</head>
<body>
<div class="phone">
  <div class="sbar">
    <span class="sbar-time" id="sTime">9:41</span>
    <div class="sbar-right">
      <svg width="17" height="14" viewBox="0 0 17 14"><rect x="0" y="9" width="3" height="5" rx="1" fill="var(--text)"/><rect x="4.5" y="6" width="3" height="8" rx="1" fill="var(--text)"/><rect x="9" y="3" width="3" height="11" rx="1" fill="var(--text)"/><rect x="13.5" y="0" width="3" height="14" rx="1" fill="var(--text)" opacity=".3"/></svg>
      <svg width="16" height="13" viewBox="0 0 16 13"><path d="M8 10.5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3z" fill="var(--text)"/><path d="M3.5 7.5a6.5 6.5 0 0 1 9 0" fill="none" stroke="var(--text)" stroke-width="1.5" stroke-linecap="round"/><path d="M1 5a10 10 0 0 1 14 0" fill="none" stroke="var(--text)" stroke-width="1.5" stroke-linecap="round" opacity=".4"/></svg>
      <span class="bat-pct" id="batPct"></span>
      <svg width="26" height="13" viewBox="0 0 26 13"><rect x=".5" y=".5" width="22" height="12" rx="2.5" fill="none" stroke="var(--text)" stroke-width="1"/><rect x="23" y="3.5" width="2.5" height="6" rx="1.25" fill="var(--text)" opacity=".4"/><rect id="bFill" x="1.5" y="1.5" width="19" height="10" rx="1.5" fill="var(--accent)"/><path class="charge-bolt" d="M14 2.5 L11 6.5 L13 6.5 L10 10.5 L15 5.5 L13 5.5 Z" fill="#4CD964" opacity=".95"/></svg>
    </div>
  </div>
  <!-- 壁纸层 -->
<div class="wallpaper" id="wallpaper"></div>

<!-- 桌面容器 -->
<div class="desktop-container" id="desktopContainer">
  <div class="desktop" id="desktopPage0" data-page="0">
    <div class="app-icon" data-icon-key="beauty" onclick="openPanel()">
      <div class="app-icon-img" style="background:linear-gradient(135deg,#C4A882,#E8D5BC)">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
      </div>
      <span>美化</span>
    </div>
    <div class="app-icon" data-icon-key="chat" onclick="openChat()">
      <div class="app-icon-img" style="background:linear-gradient(135deg,#6BBFB5,#A8DDD9)">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </div>
      <span>聊天</span>
    </div>
    <div class="app-icon" data-icon-key="forum" onclick="openForum()">
      <div class="app-icon-img" style="background:linear-gradient(135deg,#E8845A,#F5C49A)">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8"><path d="M4 6h16M4 10h16M4 14h10M4 18h7"/></svg>
      </div>
      <span>论坛</span>
    </div>
    <div class="app-icon" data-icon-key="memory" onclick="openMemoryApp()">
      <div class="app-icon-img" style="background:linear-gradient(135deg,#5B86E5,#36D1DC)">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7z"/><line x1="10" y1="22" x2="14" y2="22"/><line x1="9" y1="17" x2="15" y2="17"/></svg>
      </div>
      <span>记忆</span>
    </div>
    <div class="app-icon" data-icon-key="settings" onclick="openSet()">
      <div class="app-icon-img" style="background:linear-gradient(135deg,#9B8EC4,#D8D0EE)">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </div>
      <span>设置</span>
    </div>
  </div>
</div>

<div class="page-dots" id="pageDots"></div>
<div class="page-edge-hint left" id="edgeLeft"></div>
<div class="page-edge-hint right" id="edgeRight"></div>

<!-- 美化面板 -->
<div class="panel" id="panel" onclick="handlePanelClick(event)">
  <div class="panel-box">
    <div class="panel-title">个性美化</div>
    <button class="panel-close" onclick="closePanel()">×</button>

    <div class="theme-grid">
      <div class="topt" onclick="setTheme('white')"><div class="tcircle active" id="t-white" style="background:linear-gradient(135deg,#FFFFFF,#E0E0E0);border:1.5px solid #E0E0E0"></div><span>简约白</span></div>
      <div class="topt" onclick="setTheme('warm')"><div class="tcircle" id="t-warm" style="background:linear-gradient(135deg,#C4A882,#E8D5BC)"></div><span>暖木</span></div>
      <div class="topt" onclick="setTheme('rose')"><div class="tcircle" id="t-rose" style="background:linear-gradient(135deg,#C4828A,#EDD5D5)"></div><span>玫瑰</span></div>
      <div class="topt" onclick="setTheme('sage')"><div class="tcircle" id="t-sage" style="background:linear-gradient(135deg,#7A9E7E,#C8DCC9)"></div><span>鼠尾草</span></div>
      <div class="topt" onclick="setTheme('slate')"><div class="tcircle" id="t-slate" style="background:linear-gradient(135deg,#7A8FA6,#C5D3E0)"></div><span>烟蓝</span></div>
      <div class="topt" onclick="setTheme('lav')"><div class="tcircle" id="t-lav" style="background:linear-gradient(135deg,#9B8EC4,#D8D0EE)"></div><span>薰衣草</span></div>
      <div class="topt" onclick="setTheme('sand')"><div class="tcircle" id="t-sand" style="background:linear-gradient(135deg,#B8A88A,#EDE3D4)"></div><span>沙丘</span></div>
      <div class="topt" onclick="setTheme('mint')"><div class="tcircle" id="t-mint" style="background:linear-gradient(135deg,#6BBFB5,#C2E8E4)"></div><span>薄荷</span></div>
      <div class="topt" onclick="setTheme('dusk')"><div class="tcircle" id="t-dusk" style="background:linear-gradient(135deg,#C4956A,#F0D9C0)"></div><span>黄昏</span></div>
      <div class="topt" onclick="setTheme('night')"><div class="tcircle" id="t-night" style="background:linear-gradient(135deg,#1A1A2E,#2D2D44)"></div><span>夜间</span></div>
      <div class="topt" onclick="setTheme('dark')"><div class="tcircle" id="t-dark" style="background:linear-gradient(135deg,#0D0D0D,#1A1A1A)"></div><span>纯黑</span></div></div>

    <div class="wp-section" style="margin-bottom:18px">
      <h4>桌面页面</h4>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <span style="font-size:13px;color:var(--text)" id="pageCountLabel">当前 1 页</span>
        <button class="wp-btn" onclick="addDesktopPage()" style="flex:1">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          新增一页
        </button>
        <button class="wp-btn" onclick="removeLastPage()" style="flex:1">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><line x1="5" y1="12" x2="19" y2="12"/></svg>
          删除末页
        </button>
      </div>
    </div>
    <div class="wp-section" style="margin-bottom:18px">
      <h4>音乐小组件</h4>
      <div class="wp-btn" onclick="addMusicWidget()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
        添加音乐播放器
      </div>
    </div>
    <div class="wp-section" style="margin-bottom:18px">
      <h4>图片小组件</h4>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div class="wp-btn" onclick="addWidget()" style="flex:1;min-width:100px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="18" height="18" rx="3"/></svg>
          方形
        </div>
        <div class="wp-btn" onclick="addStripWidget()" style="flex:1;min-width:100px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="8" y="2" width="8" height="20" rx="2"/></svg>
          竖条
        </div>
        <div class="wp-btn" onclick="addNoteWidget()" style="flex:1;min-width:100px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          便签
        </div>
        <div class="wp-btn" onclick="addClockWidget()" style="flex:1;min-width:100px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="9"/><polyline points="12 6 12 12 16 14"/></svg>
          时钟
        </div>
        <div class="wp-btn" onclick="addBannerWidget()" style="flex:1;min-width:100px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="7" width="20" height="10" rx="2"/></svg>
          横幅
        </div>
        <div class="wp-btn" onclick="addTextCardWidget()" style="flex:1;min-width:100px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="18" height="18" rx="3"/><line x1="7" y1="8" x2="17" y2="8"/><line x1="7" y1="12" x2="14" y2="12"/></svg>
          文案
        </div>
      </div>
      <input type="file" id="bannerWidgetFile" accept="image/*" style="display:none" onchange="onBannerWidgetFile(event)"/>
      <input type="file" id="widgetFile" accept="image/*" style="display:none" onchange="onWidgetFile(event)"/>
      <input type="file" id="stripWidgetFile" accept="image/*" style="display:none" onchange="onStripWidgetFile(event)"/>
    </div>
    <div class="wp-section">
      <h4>壁纸</h4>
      <div class="wp-btn" onclick="document.getElementById('wpFile').click()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        从相册选择壁纸
      </div><input type="file" id="wpFile" accept="image/*" style="display:none" onchange="setWallpaper(event)"/>
      <div class="wp-preview" id="wpPreview">
        <img id="wpImg" src=""/>
        <button class="wp-rm" onclick="removeWallpaper()">×</button>
      </div>
    </div>
  </div>
</div>
</div>
<!-- 论坛主页 -->
<div class="fullpage" id="pageForum">
  <div class="fp-header">
    <button class="fp-back" onclick="closeForum()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2>论坛</h2>
    <button onclick="openNewForumPanel()" style="background:none;border:none;cursor:pointer;padding:4px;margin-left:auto;color:var(--text);display:flex" title="新建论坛">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="9"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
    </button>
  </div>
  <div class="fp-body" id="forumList" style="padding:14px"></div>
</div>

<!-- 新建/编辑论坛面板 -->
<div class="panel" id="panelNewForum" onclick="if(event.target===this)closeNewForumPanel()" style="z-index:70">
  <div class="panel-box">
    <div class="panel-title" id="newForumPanelTitle">新建论坛</div>
    <button class="panel-close" onclick="closeNewForumPanel()">×</button>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">论坛名称</div>
        <input class="set-input" id="forumNameInput" placeholder="例如：校园生活版"/>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">世界观设定</div>
        <textarea class="set-input" id="forumWorldInput" rows="4" placeholder="描述这个论坛的背景世界观，例如：这是一所普通高中的校园论坛，学生们在这里讨论学习、八卦、社团活动…" style="resize:none;line-height:1.6"></textarea>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">绑定我的人设</div>
        <select class="set-input" id="forumMePreset"></select>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:8px">论坛成员（可多选联系人）</div>
        <div id="forumMemberList" style="display:flex;flex-direction:column;gap:6px"></div>
      </div>
      <button class="save-btn" onclick="saveNewForum()">保存</button>
    </div>
  </div>
</div>

<!-- 论坛板块页 -->
<div class="fullpage" id="pageForumBoard" style="z-index:45">
  <div class="fp-header">
    <button class="fp-back" onclick="closeForumBoard()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2 id="forumBoardTitle">论坛</h2>
    <button onclick="openMyForumPost()" style="background:none;border:none;cursor:pointer;padding:4px;margin-left:auto;color:var(--text);display:flex" title="发帖">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
    </button>
    <button id="forumRefreshBtn" onclick="openForumRefreshPanel()" style="background:none;border:none;cursor:pointer;padding:4px;color:var(--text);display:flex" title="刷新帖子">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
    </button>
  </div>
  <div class="fp-body" id="forumBoardBody" style="padding:0"></div>
</div>

<!-- 论坛帖子详情页 -->
<div class="fullpage" id="pageForumPost" style="z-index:50">
  <div class="fp-header">
    <button class="fp-back" onclick="closeForumPost()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2 id="forumPostHeaderTitle" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px">帖子详情</h2>
  </div>
  <div class="fp-body" id="forumPostBody" style="padding:0"></div>
  <div style="padding:10px 14px 16px;display:flex;gap:8px;flex-shrink:0;border-top:1px solid rgba(0,0,0,.06);background:var(--bg)">
    <div style="flex:1;position:relative">
      <input id="forumCommentInput" class="set-input" placeholder="写评论…" style="margin:0;padding-right:60px"/>
      <span id="forumReplyHint" style="display:none;position:absolute;top:-22px;left:0;font-size:11px;color:var(--accent);background:var(--card2);padding:2px 8px;border-radius:8px">回复 <span id="forumReplyName"></span> <span onclick="clearForumReplyTarget()" style="cursor:pointer;margin-left:4px;color:var(--text2)">×</span></span>
    </div>
    <button onclick="submitForumComment()" style="padding:0 16px;background:var(--accent);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;flex-shrink:0">发送</button>
  </div>
</div>

<!-- 论坛发帖面板 -->
<div class="panel" id="panelMyForumPost" onclick="if(event.target===this)closeMyForumPost()" style="z-index:55">
  <div class="panel-box">
    <div class="panel-title">发帖</div>
    <button class="panel-close" onclick="closeMyForumPost()">×</button>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">标签</div>
        <div id="myPostTagList" style="display:flex;flex-wrap:wrap;gap:8px"></div>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">标题</div>
        <input class="set-input" id="myPostTitle" placeholder="帖子标题"/>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">正文</div>
        <textarea class="set-input" id="myPostContent" rows="6" placeholder="写点什么…" style="resize:none;line-height:1.6"></textarea>
      </div>
      <button class="save-btn" onclick="submitMyForumPost()">发布</button>
    </div>
  </div>
</div>

<!-- 论坛刷新选角色面板 -->
<div class="panel" id="panelForumRefresh" onclick="if(event.target===this)closeForumRefreshPanel()" style="z-index:56">
  <div class="panel-box">
    <div class="panel-title">选择发帖角色</div>
    <button class="panel-close" onclick="closeForumRefreshPanel()">×</button>
    <div style="font-size:12px;color:var(--text2);margin-bottom:12px">选中的角色将发布新帖子，AI会根据人设生成内容和热度</div>
    <div id="forumRefreshMemberList" style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px"></div>
    <button class="save-btn" id="forumRefreshBtn2" onclick="generateForumPosts()">刷新生成帖子</button>
  </div>
</div>

<!-- 设置全屏页 -->
<div class="fullpage" id="pageSet">
  <div class="fp-header">
    <button class="fp-back" onclick="closeSet()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2>设置</h2>
  </div>
  <div class="fp-body">
    <div class="set-group">
      <div class="set-row" onclick="openSetSub('api')" style="cursor:pointer">
        <div><div style="font-size:14px;color:var(--text);font-weight:500">API</div><div class="sub">配置接口与模型</div></div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
      <div class="set-row" onclick="openSetSub('data')" style="cursor:pointer">
        <div><div style="font-size:14px;color:var(--text);font-weight:500">数据</div><div class="sub">导出全部数据</div></div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
      <div class="set-row" onclick="openSetSub('screen')" style="cursor:pointer">
        <div><div style="font-size:14px;color:var(--text);font-weight:500">屏幕</div><div class="sub">布局与全屏设置</div></div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
      <div class="set-row" onclick="openSetSub('font')" style="cursor:pointer">
        <div><div style="font-size:14px;color:var(--text);font-weight:500">字体</div><div class="sub">全局字体设置</div></div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
    </div>
  </div>
</div>

<!-- 设置子页：API -->
<div class="fullpage" id="pageSetApi" style="z-index:45">
  <div class="fp-header">
    <button class="fp-back" onclick="closeSetSub('api')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2>API</h2>
  </div>
  <div class="fp-body">
    <div class="set-group">
      <div style="padding:14px 16px">
        <div class="preset-list" id="presetList"></div>
        <button class="add-preset" onclick="addPreset()">＋ 新增预设</button>
        <div style="margin-top:16px">
          <div style="font-size:12px;color:var(--text2);margin-bottom:4px">API Base URL</div>
          <input class="set-input" id="apiBase" placeholder="https://api.openai.com/v1"/>
          <div style="font-size:12px;color:var(--text2);margin:10px 0 4px">API 密钥</div>
          <input class="set-input" id="apiKey" type="password" placeholder="sk-..."/>
          <div style="font-size:12px;color:var(--text2);margin:10px 0 4px">模型名称</div>
          <input class="set-input" id="apiModel" placeholder="gpt-4o-mini"/>
          <button class="save-btn" onclick="saveAPI()">保存 API 设置</button>
          <button class="save-btn" style="margin-top:8px;background:var(--text2)" onclick="testAPI()">测试 API 连接</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 设置子页：数据 -->
<div class="fullpage" id="pageSetData" style="z-index:45">
  <div class="fp-header">
    <button class="fp-back" onclick="closeSetSub('data')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2>数据</h2>
  </div>
  <div class="fp-body">
    <div class="set-group">
      <div style="padding:14px 16px;display:flex;flex-direction:column;gap:10px">
        <button class="save-btn" onclick="exportData()">导出全部数据</button>
        <button class="save-btn" style="background:var(--text2)" onclick="document.getElementById('importFile').click()">导入全部数据</button>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)"/>
      </div>
    </div>
  </div>
</div>

<!-- 设置子页：屏幕 -->
<div class="fullpage" id="pageSetScreen" style="z-index:45">
  <div class="fp-header">
    <button class="fp-back" onclick="closeSetSub('screen')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2>屏幕</h2>
  </div>
  <div class="fp-body">
    <div class="set-group">
      <div style="padding:14px 16px">
        <div style="font-size:12px;color:var(--text2);margin-bottom:8px">图标布局</div>
        <div class="layout-opts">
          <div class="layout-opt active" id="lo-4" onclick="setLayout(4)">4 × 6</div>
          <div class="layout-opt" id="lo-5" onclick="setLayout(5)">5 × 6</div>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 0;margin-bottom:12px;border-bottom:1px solid rgba(0,0,0,.06)">
          <div>
            <div style="font-size:14px;color:var(--text);font-weight:500">音乐播放器小组件</div>
            <div style="font-size:11px;color:var(--text2);margin-top:2px">在桌面显示音乐播放器</div>
          </div>
          <div id="musicWidgetToggle" onclick="toggleMusicWidgetSetting()" style="width:44px;height:26px;border-radius:13px;background:var(--accent2);position:relative;transition:background .2s;flex-shrink:0;cursor:pointer">
            <div id="musicWidgetKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>
          </div>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 0;margin-bottom:12px;border-bottom:1px solid rgba(0,0,0,.06)">
          <div>
            <div style="font-size:14px;color:var(--text);font-weight:500">保存歌曲数据</div>
            <div style="font-size:11px;color:var(--text2);margin-top:2px">刷新后恢复全部歌曲（占用存储）</div>
          </div>
          <div id="saveMusicToggle" onclick="toggleSaveMusicData()" style="width:44px;height:26px;border-radius:13px;background:var(--accent2);position:relative;transition:background .2s;flex-shrink:0;cursor:pointer">
            <div id="saveMusicKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>
          </div>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 0;margin-bottom:12px;border-bottom:1px solid rgba(0,0,0,.06)">
          <div>
            <div style="font-size:14px;color:var(--text);font-weight:500">显示锁定按钮</div>
            <div style="font-size:11px;color:var(--text2);margin-top:2px">图标和小组件上的锁按钮</div>
          </div>
          <div id="lockBtnToggle" onclick="toggleLockBtnVisible()" style="width:44px;height:26px;border-radius:13px;background:var(--accent);position:relative;transition:background .2s;flex-shrink:0;cursor:pointer">
            <div id="lockBtnKnob" style="position:absolute;top:3px;left:21px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>
          </div>
        </div>
        <div class="screen-opts">
          <div class="screen-opt" id="sm-full" onclick="toggleFullscreen()">
            <div class="screen-opt-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></div>
            <div class="screen-opt-info"><h4>自动全屏</h4><p>撑满整个浏览器窗口</p></div>
            <div class="screen-check"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 设置子页：字体 -->
<div class="fullpage" id="pageSetFont" style="z-index:45">
  <div class="fp-header">
    <button class="fp-back" onclick="closeSetSub('font')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2>字体</h2>
  </div>
  <div class="fp-body">
    <div class="set-group">
      <div style="padding:14px 16px">
        <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1.5px;margin-bottom:12px">选择字体来源</div>
        <div class="screen-opts" style="gap:10px">
          <div class="screen-opt active" id="font-system" onclick="setFontMode('system')">
            <div class="screen-opt-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg></div>
            <div class="screen-opt-info"><h4>系统默认</h4><p>使用手机自带字体</p></div>
            <div class="screen-check"></div>
          </div>
          <div class="screen-opt" id="font-zerodian" onclick="setFontMode('zerodian')">
            <div class="screen-opt-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="9"/><path d="M8 12h8M12 8v8"/></svg></div>
            <div class="screen-opt-info"><h4>零点行星字体</h4><p>在线导入精选字体</p></div>
            <div class="screen-check"></div>
          </div>
          <div class="screen-opt" id="font-custom" onclick="setFontMode('custom')">
            <div class="screen-opt-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 7V4h16v3"/><line x1="12" y1="4" x2="12" y2="20"/><path d="M8 20h8"/></svg></div>
            <div class="screen-opt-info"><h4>自定义URL</h4><p>输入字体文件链接</p></div>
            <div class="screen-check"></div>
          </div>
        </div>

        <!-- 零点行星字体输入 -->
        <div id="fontZerodianOpts" style="display:none;margin-top:16px">
          <div style="font-size:12px;color:var(--text2);margin-bottom:4px">零点行星字体CSS链接</div>
          <input class="set-input" id="zerodianCssUrl" placeholder="https://cdn.zerodian.top/font/XXX/result.css"/>
          <div style="font-size:12px;color:var(--text2);margin-top:10px;margin-bottom:4px">字体名称（font-family）</div>
          <input class="set-input" id="zerodianFamilyName" placeholder="例如：LXGWWenKai"/>
          <div style="font-size:11px;color:var(--text2);margin-top:6px;line-height:1.5">从零点行星网站复制字体CSS链接和font-family名称粘贴到上方</div>
          <button class="save-btn" onclick="applyZerodianInput()" style="margin-top:12px">应用字体</button>
        </div>

        <!-- 自定义URL输入 -->
        <div id="fontCustomOpts" style="display:none;margin-top:16px">
          <div style="font-size:12px;color:var(--text2);margin-bottom:4px">字体CSS链接</div>
          <input class="set-input" id="fontCssUrl" placeholder="https://example.com/font.css"/>
          <div style="font-size:11px;color:var(--text2);margin-top:6px;line-height:1.5">输入包含 @font-face 的CSS文件URL，或直接输入字体文件URL（.woff2/.ttf/.otf）</div>
          <div style="font-size:12px;color:var(--text2);margin-top:10px;margin-bottom:4px">字体名称（font-family）</div>
          <input class="set-input" id="fontFamilyName" placeholder="例如：MyFont"/>
          <button class="save-btn" onclick="applyCustomFont()" style="margin-top:12px">应用字体</button>
        </div>

        <!-- 预览 -->
        <div style="margin-top:18px;padding:14px;background:var(--card2);border-radius:14px">
          <div style="font-size:11px;color:var(--text2);margin-bottom:8px;font-weight:600;letter-spacing:1px">预览</div>
          <div id="fontPreview" style="font-size:15px;color:var(--text);line-height:1.7">你好世界 Hello World 1234567890<br>橙子机 - 定制你的专属手机</div>
        </div>

        <!-- 重置 -->
        <button class="save-btn" style="margin-top:12px;background:var(--text2)" onclick="resetFont()">恢复默认字体</button>
      </div>
    </div>
  </div>
</div>

<!-- 聊天APP主框架 -->
<div class="fullpage" id="pageChat">
  <div class="fp-header">
    <button class="fp-back" onclick="closeChat()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2 id="chatTitle">消息</h2>
    <button id="addContactBtn" onclick="openAddContact()" style="display:none;background:none;border:none;cursor:pointer;padding:4px;margin-left:auto;color:var(--text)">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="16" y1="11" x2="22" y2="11"/></svg>
    </button>
    <button id="addGroupBtn" onclick="openCreateGroup()" style="display:none;background:none;border:none;cursor:pointer;padding:4px;color:var(--text)">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/><circle cx="20" cy="16" r="3" fill="none"/><line x1="20" y1="14.5" x2="20" y2="17.5"/><line x1="18.5" y1="16" x2="21.5" y2="16"/></svg>
    </button>
  </div>


  <!-- 消息页 -->
  <div id="tabMsg" style="flex:1;overflow-y:auto;padding:18px;min-height:0;flex-direction:column"></div>

  <!-- 联系人页 -->
  <div id="tabContacts" style="display:none;flex:1;overflow-y:auto;padding:18px;min-height:0;flex-direction:column">
        <div id="contactList" style="display:flex;flex-direction:column;gap:2px"></div>
    <div id="contactEmpty" style="display:flex;flex-direction:column;align-items:center;padding:40px 0;gap:10px">
      <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="1.2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      <p style="font-size:13px;color:var(--text2)">还没有联系人</p>
    </div>
  </div>

  <!-- 朋友圈 -->
  <div id="tabMoments" style="display:none;flex:1;overflow-y:auto;min-height:0;flex-direction:column;scrollbar-width:none">

    <!-- 顶部背景+头像区 -->
    <div id="momentsBanner" style="position:relative;height:220px;background:linear-gradient(160deg,#2c2c3e,#1a1a2e);flex-shrink:0;overflow:hidden">
      <div id="momentsBannerImg" style="position:absolute;inset:0;background-size:cover;background-position:center;opacity:.85"></div>
      <!-- 更换背景按钮 -->
      <button onclick="document.getElementById('momentsBgFile').click()" style="position:absolute;top:14px;right:14px;background:rgba(0,0,0,.35);border:none;border-radius:20px;padding:6px 12px;display:flex;align-items:center;gap:5px;cursor:pointer;backdrop-filter:blur(4px)">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        <span style="font-size:11px;color:#fff;font-weight:500">更换背景</span>
      </button>
      <input type="file" id="momentsBgFile" accept="image/*" style="display:none" onchange="setMomentsBg(event)"/>
      <!-- 我的头像+名字 -->
      <div style="position:absolute;bottom:16px;right:16px;display:flex;flex-direction:column;align-items:flex-end;gap:8px">
        <span id="momentsMeName" style="font-size:15px;font-weight:600;color:#fff;text-shadow:0 1px 6px rgba(0,0,0,.5)">我</span>
        <div id="momentsMeAvatar" style="width:56px;height:56px;border-radius:14px;background:var(--accent2);overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.3);border:2px solid rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </div>
      </div>
    </div>

    <!-- 发布入口 -->
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid rgba(0,0,0,.05);background:var(--bg);flex-shrink:0">
      <button onclick="openRefreshMoments()" style="display:flex;align-items:center;gap:6px;background:none;border:none;border-radius:20px;padding:7px 10px;cursor:pointer;color:var(--text2)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
        <span style="font-size:13px;font-weight:500">刷新</span>
      </button>
      <button onclick="openPostMoment()" style="display:flex;align-items:center;gap:6px;background:var(--accent);border:none;border-radius:20px;padding:7px 16px;cursor:pointer">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        <span style="font-size:13px;color:#fff;font-weight:600">发朋友圈</span>
      </button>
    </div>

    <!-- 动态列表 -->
    <div id="momentsList" style="display:flex;flex-direction:column;padding:0 0 20px"></div>
    <div id="momentsEmpty" style="display:flex;flex-direction:column;align-items:center;padding:50px 0;gap:10px">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="1.2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
      <p style="font-size:13px;color:var(--text2)">还没有动态，发一条吧</p>
    </div>
  </div>

  <!-- 真人好友 -->
  <div id="tabReal" style="display:none;flex:1;overflow-y:auto;padding:18px;min-height:0;flex-direction:column">
    <!-- 我的ID卡片 -->
    <div style="background:var(--card);border-radius:18px;padding:16px;margin-bottom:16px;box-shadow:0 2px 12px rgba(0,0,0,.06)">
      <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1px;margin-bottom:8px">我的好友码</div>
      <div style="display:flex;align-items:center;gap:10px">
        <div id="realMyId" style="flex:1;font-size:15px;font-weight:700;color:var(--accent);letter-spacing:1px;word-break:break-all">加载中…</div>
        <button onclick="copyMyRealId()" style="padding:6px 14px;border-radius:10px;border:1.5px solid var(--accent2);background:none;font-size:12px;color:var(--text2);cursor:pointer;font-family:inherit">复制</button>
      </div><div style="font-size:11px;color:var(--text2);margin-top:6px">把好友码发给对方，对方粘贴即可添加你</div>
      <!-- 设置昵称 -->
      <div style="margin-top:12px;display:flex;gap:8px">
        <input class="set-input" id="realNickInput" placeholder="设置你的昵称" style="flex:1;margin:0"/>
        <button onclick="saveRealNick()" style="padding:8px 16px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">保存</button>
      </div>
    </div>
    <!-- 添加好友 -->
    <div style="background:var(--card);border-radius:18px;padding:16px;margin-bottom:16px;box-shadow:0 2px 12px rgba(0,0,0,.06)">
      <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1px;margin-bottom:8px">添加真人好友</div>
      <div style="display:flex;gap:8px">
        <input class="set-input" id="realAddInput" placeholder="粘贴对方的好友码" style="flex:1;margin:0"/>
        <button onclick="addRealFriend()" style="padding:8px 16px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">添加</button>
      </div></div>
    <!-- 好友列表 -->
    <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1px;margin-bottom:10px">真人好友</div>
    <div id="realFriendList"></div>
    <div id="realFriendEmpty" style="display:flex;flex-direction:column;align-items:center;padding:40px 0;gap:10px">
      <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="1.2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
      <p style="font-size:13px;color:var(--text2)">还没有真人好友</p>
    </div>
  </div>

  <!-- 我 -->
  <div id="tabMe" style="display:none;flex-direction:column;overflow-y:scroll;flex:1;min-height:0;-webkit-overflow-scrolling:touch;height:0;padding:0;background:var(--bg)">

    <!-- 顶部背景区域 -->
    <div class="me-hero" onclick="document.getElementById('meHeroBgFile').click()">
      <div class="me-hero-bg" id="meHeroBg"></div>
      <div class="me-hero-fade"></div>
      <input type="file" id="meHeroBgFile" accept="image/*" style="display:none" onchange="setMeHeroBg(event)"/>
      <div style="position:absolute;top:16px;right:16px;z-index:3;background:rgba(0,0,0,.25);backdrop-filter:blur(12px);border-radius:24px;padding:8px 16px;display:flex;align-items:center;gap:6px;pointer-events:none;border:1px solid rgba(255,255,255,0.15)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        <span style="font-size:11px;color:#fff;font-weight:700;letter-spacing:.5px">更换背景</span>
      </div>
      <!-- 头像+名字浮层 -->
      <div class="me-hero-profile">
        <div class="me-hero-avatar" id="meProfileAvatar" onclick="event.stopPropagation();document.getElementById('meAvatarFile').click()">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </div>
        <input type="file" id="meAvatarFile" accept="image/*" style="display:none" onchange="onMeAvatarFile(event)"/>
        <div class="me-hero-info">
          <div class="me-hero-name" id="meProfileName">未设置人设</div>
          <div class="me-hero-desc" id="meProfileDesc">点击下方人设卡片进行编辑</div>
        </div>
      </div>
    </div>

    <!-- 统计卡片 -->
    <div class="me-stats-card">
      <div class="me-stat-item">
        <div class="me-stat-val" id="meStatPresets">0</div>
        <div class="me-stat-label">人设</div>
      </div>
      <div class="me-stat-divider"></div>
      <div class="me-stat-item">
        <div class="me-stat-val" id="meStatContacts">0</div>
        <div class="me-stat-label">联系人</div>
      </div>
      <div class="me-stat-divider"></div>
      <div class="me-stat-item">
        <div class="me-stat-val" id="meStatMoments">0</div>
        <div class="me-stat-label">动态</div>
      </div>
    </div>

    <!-- 功能入口 -->
    <div style="padding:32px 20px 40px">
      <div style="font-size:14px;font-weight:800;color:var(--text);margin-bottom:14px;letter-spacing:1px;padding-left:4px">我的功能</div>
      <div style="background:var(--card);border-radius:28px;box-shadow:0 8px 32px rgba(0,0,0,.04);padding:10px;border:1px solid rgba(0,0,0,.02)">
        <div onclick="openMePresetPage()" style="display:flex;align-items:center;gap:16px;padding:16px;border-radius:20px;cursor:pointer;transition:background .2s" onmousedown="this.style.background='var(--card2)'" onmouseup="this.style.background='transparent'" onmouseleave="this.style.background='transparent'">
          <div style="width:48px;height:48px;border-radius:16px;background:linear-gradient(135deg,var(--accent),color-mix(in srgb, var(--accent) 50%, var(--accent2)));display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 6px 16px rgba(0,0,0,.1)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          </div>
          <div style="flex:1">
            <div style="font-size:16px;color:var(--text);font-weight:800;margin-bottom:4px">我的人设</div>
            <div style="font-size:12px;color:var(--text2);font-weight:500" id="mePresetSub">管理你的角色人设</div>
          </div>
          <div style="width:36px;height:36px;border-radius:50%;background:var(--card2);display:flex;align-items:center;justify-content:center;color:var(--text2)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 底部Tab -->
  <div class="chat-tabs">
    <button class="chat-tab active" id="ctab-msg" onclick="switchChatTab('msg')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <span>消息</span>
    </button>
    <button class="chat-tab" id="ctab-contacts" onclick="switchChatTab('contacts')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      <span>联系人</span>
    </button>
    <button class="chat-tab" id="ctab-moments" onclick="switchChatTab('moments')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="M12 6v2M12 16v2M6 12H4M20 12h-2M7.76 7.76l-1.42-1.42M17.66 17.66l-1.42-1.42M7.76 16.24l-1.42 1.42M17.66 6.34l-1.42 1.42"/></svg>
      <span>朋友圈</span>
    </button>
        <button class="chat-tab" id="ctab-real" onclick="switchChatTab('real')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
      <span>Ta</span>
    </button>
    <button class="chat-tab" id="ctab-me" onclick="switchChatTab('me')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span>我</span>
    </button>
  </div>
</div>

<!-- 聊天对话页 -->
<div class="fullpage" id="pageConv" style="z-index:60">
  <div class="fp-header" style="position:absolute; top:46px; left:14px; right:14px; margin-top:0; padding:10px 14px; border-bottom:none; border-radius:24px; background:var(--card); box-shadow:0 8px 24px rgba(0,0,0,.08); z-index:20;">
    <button class="fp-back" onclick="closeConversation()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div style="flex:1; display:flex; align-items:center; justify-content:center; gap:8px; min-width:0; margin:0 10px;">
      <div id="convHeaderAvatar" style="width:34px; height:34px; border-radius:50%; background:var(--accent2); overflow:hidden; flex-shrink:0; display:none; box-shadow:0 2px 8px rgba(0,0,0,.08);"></div>
      <div style="display:flex; flex-direction:column; align-items:center; min-width:0;">
        <h2 id="convTitle" style="font-size:16px; line-height:1.2; margin:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100%;">聊天</h2>
        <div id="convSubTitle" style="font-size:10px; color:var(--text2); line-height:1.2; margin-top:2px; max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:none;"></div>
      </div>
    </div>
    <button onclick="currentGroup?openGroupSettings():openConvSettings()" style="background:none;border:none;cursor:pointer;padding:4px;color:var(--text);display:flex;flex-shrink:0;">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="1.5"/><circle cx="19" cy="12" r="1.5"/><circle cx="5" cy="12" r="1.5"/></svg>
    </button>
  </div>
  <div class="fp-body" id="convMessages" style="position:absolute; inset:0; display:flex; flex-direction:column; gap:10px; padding:110px 14px 100px; box-sizing:border-box; z-index:1;"></div>

  <!-- 群聊设置及子面板（必须在pageConv内部，因为pageConv的transform创建了层叠上下文） -->
  <div class="panel" id="panelGroupSettings2" onclick="if(event.target===this)closeGroupSettings()" style="z-index:200">
    <div class="panel-box">
      <div class="panel-title">群聊设置</div>
      <button class="panel-close" onclick="closeGroupSettings()">x</button>
      <div style="display:flex;justify-content:center;margin-bottom:16px" id="gsAvatar"></div>
      <div style="margin-bottom:18px">
        <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1.2px;margin-bottom:10px">群成员 . <span id="gsMemberCount">0</span>人</div>
        <div id="gsMemberAvatars" style="display:flex;flex-wrap:wrap;gap:10px"></div>
      </div>
      <div class="set-group" style="margin-top:0">
        <div class="set-row" onclick="openGroupFavList()" style="cursor:pointer">
          <div><div style="font-size:14px;color:var(--text);font-weight:500">收藏的消息</div><div class="sub">查看收藏的聊天记录</div></div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        </div>
        <div class="set-row" onclick="openEditGroup()" style="cursor:pointer">
          <div><div style="font-size:14px;color:var(--text);font-weight:500">编辑群聊</div><div class="sub">修改群名、公告、成员</div></div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="set-row">
          <div><div style="font-size:14px;color:var(--text);font-weight:500">聊天记忆条数</div><div class="sub">发送给AI的最近消息数量</div></div>
          <input type="number" id="groupMemoryCount" min="1" max="200" style="width:64px;padding:6px 10px;border:1.5px solid var(--accent2);border-radius:10px;font-size:14px;color:var(--text);background:var(--card2);outline:none;text-align:center;font-family:inherit" onchange="saveGroupMemoryCount(this.value)"/>
        </div>
        <div class="set-row" onclick="document.getElementById('groupBgFile').click()" style="cursor:pointer">
          <div><div style="font-size:14px;color:var(--text);font-weight:500">聊天背景</div><div class="sub">从相册选择背景图片</div></div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <input type="file" id="groupBgFile" accept="image/*" style="display:none" onchange="setGroupConvBg(event)"/>
        <div class="set-row" onclick="clearGroupConvBg()" style="cursor:pointer">
          <div><div style="font-size:14px;color:var(--text);font-weight:500">清除聊天背景</div><div class="sub">恢复默认背景</div></div>
        </div>
        <div class="set-row" onclick="openGroupBubbleColor()" style="cursor:pointer">
          <div><div style="font-size:14px;color:var(--text);font-weight:500">气泡颜色</div><div class="sub">自定义双方消息气泡颜色</div></div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="set-row" style="flex-direction:column;align-items:stretch;gap:10px">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div style="font-size:14px;color:var(--text);font-weight:500">头像样式</div>
              <div class="sub">圆形或圆角方形</div>
            </div>
          </div>
          <div style="display:flex;gap:10px">
            <div class="screen-opt" id="gavs-circle" onclick="setGroupAvatarStyle('circle')" style="flex:1;padding:10px">
              <div style="width:34px;height:34px;border-radius:50%;background:var(--accent2);flex-shrink:0"></div>
              <div class="screen-opt-info"><h4>圆形</h4></div>
              <div class="screen-check"></div>
            </div>
            <div class="screen-opt" id="gavs-rounded" onclick="setGroupAvatarStyle('rounded')" style="flex:1;padding:10px">
              <div style="width:34px;height:34px;border-radius:8px;background:var(--accent2);flex-shrink:0"></div>
              <div class="screen-opt-info"><h4>圆角方形</h4></div>
              <div class="screen-check"></div>
            </div>
          </div>
        </div>
        <div class="set-row" style="cursor:pointer" onclick="toggleEnterSend()">
          <div>
            <div style="font-size:14px;color:var(--text);font-weight:500">回车键发送</div>
            <div class="sub">按回车直接发送消息</div>
          </div>
          <div id="groupEnterSendToggle" style="width:44px;height:26px;border-radius:13px;background:var(--accent2);position:relative;transition:background .2s;flex-shrink:0">
            <div id="groupEnterSendKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>
          </div>
        </div>
        <div class="set-row" style="cursor:pointer" onclick="toggleGroupRealTime()">
          <div><div style="font-size:14px;color:var(--text);font-weight:500">感知现实时间</div><div class="sub">群成员知道现在几点，回复符合时间</div></div>
          <div id="groupRealTimeToggle" style="width:44px;height:26px;border-radius:13px;background:var(--accent2);position:relative;transition:background .2s;flex-shrink:0">
            <div id="groupRealTimeKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>
          </div>
        </div>
        <div class="set-row" style="cursor:pointer" onclick="toggleGroupMomentsMemory()">
          <div><div style="font-size:14px;color:var(--text);font-weight:500">挂载朋友圈记忆</div><div class="sub">群成员互相知道彼此的朋友圈</div></div>
          <div id="groupMomentsToggle" style="width:44px;height:26px;border-radius:13px;background:var(--accent2);position:relative;transition:background .2s;flex-shrink:0">
            <div id="groupMomentsKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>
          </div>
        </div>
        <div id="groupMomentsSliderRow" style="display:none;padding:10px 16px 14px;border-bottom:1px solid rgba(0,0,0,.04)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <span style="font-size:13px;color:var(--text);font-weight:500">记忆条数</span>
            <span id="groupMomentsVal" style="font-size:13px;font-weight:700;color:var(--accent)">10</span>
          </div>
          <input type="range" id="groupMomentsRange" min="5" max="30" value="10" style="width:100%;accent-color:var(--accent);height:4px;cursor:pointer" oninput="onGroupMomentsRange(this.value)"/>
          <div style="display:flex;justify-content:space-between;margin-top:4px"><span style="font-size:10px;color:var(--text2)">5条</span><span style="font-size:10px;color:var(--text2)">30条</span></div>
        </div>
        <div class="set-row" style="cursor:pointer" onclick="toggleGroupDmMemory()">
          <div><div style="font-size:14px;color:var(--text);font-weight:500">挂载单聊记忆</div><div class="sub">群成员记得各自私聊中的对话</div></div>
          <div id="groupDmMemToggle" style="width:44px;height:26px;border-radius:13px;background:var(--accent2);position:relative;transition:background .2s;flex-shrink:0">
            <div id="groupDmMemKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>
          </div>
        </div>
        <div id="groupDmMemSliderRow" style="display:none;padding:10px 16px 14px;border-bottom:1px solid rgba(0,0,0,.04)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <span style="font-size:13px;color:var(--text);font-weight:500">每人记忆条数</span>
            <span id="groupDmMemVal" style="font-size:13px;font-weight:700;color:var(--accent)">15</span>
          </div>
          <input type="range" id="groupDmMemRange" min="5" max="50" value="15" style="width:100%;accent-color:var(--accent);height:4px;cursor:pointer" oninput="onGroupDmMemRange(this.value)"/>
          <div style="display:flex;justify-content:space-between;margin-top:4px"><span style="font-size:10px;color:var(--text2)">5条</span><span style="font-size:10px;color:var(--text2)">50条</span></div>
        </div>
        <div class="set-row" onclick="clearGroupChat()" style="cursor:pointer">
          <div><div style="font-size:14px;color:var(--text);font-weight:500">清空聊天记录</div><div class="sub">删除本群所有消息</div></div>
        </div>
        <div class="set-row" onclick="confirmDeleteGroup()" style="cursor:pointer">
          <div><div style="font-size:14px;color:#FF3B30;font-weight:500">解散群聊</div><div class="sub">删除群聊及所有记录</div></div>
        </div>
      </div>
    </div>
  </div>
  <div style="position:absolute; bottom:16px; left:14px; right:14px; padding:10px 12px; display:flex; gap:10px; align-items:flex-end; background:var(--card); border-radius:28px; box-shadow:0 8px 32px rgba(0,0,0,.12); z-index:20;">
    <button id="extraBtn" onclick="event.stopPropagation();toggleExtraMenu()" style="width:38px;height:38px;border-radius:50%;border:none;background:var(--card2);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:2px;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="pointer-events:none">
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
    </button>
    
    <!-- 附加功能弹窗 -->
    <div id="extraMenu" style="display:none;position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg);border-radius:18px;box-shadow:0 8px 32px rgba(0,0,0,.15);padding:16px;width:220px;z-index:9999;border:1px solid rgba(0,0,0,.06)">
      <div style="font-size:12px;color:var(--text2);font-weight:600;letter-spacing:1px;margin-bottom:12px">更多功能</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
        <div style="display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer" onclick="sendImageMsg()">
          <div style="width:48px;height:48px;border-radius:14px;background:var(--card2);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.08)">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          </div>
          <span style="font-size:11px;color:var(--text2);font-weight:500">图片</span>
        </div>
        <input type="file" id="chatImgFile" accept="image/*" style="display:none" onchange="onChatImgFile(event)"/>
        <div style="display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer" onclick="openPhotoPanel()">
          <div style="width:48px;height:48px;border-radius:14px;background:var(--card2);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.08)">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
          </div>
          <span style="font-size:11px;color:var(--text2);font-weight:500">拍照</span>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer" onclick="openGroupVote()">
          <div style="width:48px;height:48px;border-radius:14px;background:var(--card2);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.08)">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
          </div>
          <span style="font-size:11px;color:var(--text2);font-weight:500">投票</span>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer" onclick="openBookReader()">
          <div style="width:48px;height:48px;border-radius:14px;background:var(--card2);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.08)">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
          </div>
          <span style="font-size:11px;color:var(--text2);font-weight:500">看书</span>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer" onclick="toggleCompanionMode()">
          <div style="width:48px;height:48px;border-radius:14px;background:var(--card2);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.08)">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21C12 21 3 14.5 3 8.5A5 5 0 0 1 12 5.93 5 5 0 0 1 21 8.5C21 14.5 12 21 12 21z"/></svg>
          </div>
          <span style="font-size:11px;color:var(--text2);font-weight:500" id="companionBtnLabel">陪伴</span>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer" onclick="openListenTogether()">
          <div style="width:48px;height:48px;border-radius:14px;background:var(--card2);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.08)">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
          </div>
          <span style="font-size:11px;color:var(--text2);font-weight:500">听歌</span>
        </div>
      </div>
    </div>
    <div style="flex:1;display:flex;align-items:flex-end;background:var(--card2);border-radius:24px;padding:4px 4px 4px 16px;border:1.5px solid var(--accent2);transition:border-color .2s;box-shadow:inset 0 2px 4px rgba(0,0,0,.02);">
      <textarea id="convInput" rows="1" placeholder="发消息..." style="flex:1;background:transparent;border:none;outline:none;resize:none;font-size:14px;line-height:20px;max-height:80px;padding:6px 0;color:var(--text);font-family:inherit;margin-bottom:2px;" onkeydown="onConvInputKey(event)" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,80)+'px'"></textarea>
      <button onclick="sendMessage();document.getElementById('convInput').style.height='auto'" style="width:32px;height:32px;border-radius:50%;background:var(--accent);color:#fff;border:none;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-left:8px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.15);transition:transform .15s;" onmousedown="this.style.transform='scale(0.9)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-left:-2px;margin-top:1px;"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
    <button onclick="receiveMessage()" style="width:38px;height:38px;border-radius:50%;border:none;background:var(--card2);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:2px;" title="接收回复">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M12 12 2.1 7.1"/><path d="M12 12l9.9 4.9"/>
      </svg>
    </button>
  </div>
</div>

<!-- 聊天设置面板 -->
<div class="panel" id="panelConvSettings" onclick="if(event.target===this)closePanelConvSettings()" style="z-index:70">
  <div class="panel-box">
    <div class="panel-title">聊天设置</div>
    <button class="panel-close" onclick="closePanelConvSettings()">×</button>
    <div class="set-group" style="margin-top:8px">
      <div class="set-row" onclick="openSearchChat()" style="cursor:pointer">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">搜索聊天记录</div>
          <div class="sub">按关键词寻找历史消息</div>
        </div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
      </div>
      <div class="set-row" onclick="openFavList()" style="cursor:pointer">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">收藏的消息</div>
          <div class="sub">查看收藏的聊天记录</div>
        </div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
      </div>
      <div class="set-row" onclick="openEditContact()" style="cursor:pointer">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">编辑联系人资料</div>
          <div class="sub">修改角色设定、绑定人设</div>
        </div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
      <div class="set-row" onclick="document.getElementById('convBgFile').click()" style="cursor:pointer">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">聊天背景</div>
          <div class="sub">从相册选择背景图片</div>
        </div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
      <div class="set-row" style="cursor:pointer" onclick="toggleShowTime()">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">显示时间戳</div>
          <div class="sub">在头像下方显示消息时间</div>
        </div>
        <div id="timeToggle" style="width:44px;height:26px;border-radius:13px;background:var(--accent2);position:relative;transition:background .2s;flex-shrink:0">
          <div id="timeToggleKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>
        </div>
      </div>
      <div class="set-row">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">聊天记忆条数</div>
          <div class="sub">发送给AI的最近消息数量</div>
        </div>
        <input type="number" id="memoryCount" min="1" max="200" style="width:64px;padding:6px 10px;border:1.5px solid var(--accent2);border-radius:10px;font-size:14px;color:var(--text);background:var(--card2);outline:none;text-align:center;font-family:inherit" onchange="saveMemoryCount(this.value)"/>
      </div>
      <div class="set-row" style="flex-direction:column;align-items:stretch;gap:10px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:14px;color:var(--text);font-weight:500">消息提示音</div>
            <div class="sub">选择收到消息时的提示音</div>
          </div>
        </div>
        <div id="soundOptList" style="display:flex;flex-direction:column;gap:6px"></div>
      </div>
      <div class="set-row" style="flex-direction:column;align-items:stretch;gap:8px">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">补充设定</div>
          <div class="sub">额外的角色/剧情/规则补充，会强调给AI</div>
        </div>
        <textarea id="extraPrompt" class="set-input" rows="3" placeholder="例如：角色最近心情不好，说话会比较冷淡…" style="resize:none;line-height:1.6" onchange="saveExtraPrompt()"></textarea>
      </div>
      <div class="set-row" onclick="openBubbleColor()" style="cursor:pointer">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">气泡颜色</div>
          <div class="sub">自定义双方消息气泡颜色</div>
        </div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
      <div class="set-row" style="flex-direction:column;align-items:stretch;gap:10px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:14px;color:var(--text);font-weight:500">头像样式</div>
            <div class="sub">圆形或圆角方形</div>
          </div>
        </div>
        <div style="display:flex;gap:10px">
          <div class="screen-opt" id="avs-circle" onclick="setAvatarStyle('circle')" style="flex:1;padding:10px">
            <div style="width:34px;height:34px;border-radius:50%;background:var(--accent2);flex-shrink:0"></div>
            <div class="screen-opt-info"><h4>圆形</h4></div>
            <div class="screen-check"></div>
          </div>
          <div class="screen-opt" id="avs-rounded" onclick="setAvatarStyle('rounded')" style="flex:1;padding:10px">
            <div style="width:34px;height:34px;border-radius:8px;background:var(--accent2);flex-shrink:0"></div>
            <div class="screen-opt-info"><h4>圆角方形</h4></div>
            <div class="screen-check"></div>
          </div>
        </div>
      </div>
      <div class="set-row" style="cursor:pointer" onclick="toggleEnterSend()">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">回车键发送</div>
          <div class="sub">按回车直接发送消息</div>
        </div>
        <div id="enterSendToggle" style="width:44px;height:26px;border-radius:13px;background:var(--accent2);position:relative;transition:background .2s;flex-shrink:0">
          <div id="enterSendKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>
        </div>
      </div>
      <div class="set-row" style="cursor:pointer" onclick="toggleRealTime()">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">感知现实时间</div>
          <div class="sub">角色知道现在几点，回复符合时间</div>
        </div>
        <div id="realTimeToggle" style="width:44px;height:26px;border-radius:13px;background:var(--accent2);position:relative;transition:background .2s;flex-shrink:0">
          <div id="realTimeKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>
        </div>
      </div>
      <div class="set-row">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">陪伴记忆条数</div>
          <div class="sub">聊天时携带最近几条陪伴内容</div>
        </div>
        <input type="number" id="companionMemCount" min="5" max="50" style="width:64px;padding:6px 10px;border:1.5px solid var(--accent2);border-radius:10px;font-size:14px;color:var(--text);background:var(--card2);outline:none;text-align:center;font-family:inherit" onchange="saveCompanionMemCount(this.value)"/>
      </div>
      <div class="set-row" onclick="openCompanionLog()" style="cursor:pointer">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">陪伴记录</div>
          <div class="sub">查看角色的碎碎念历史</div>
        </div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
      <div class="set-row" style="cursor:pointer" onclick="toggleMomentsMemory()">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">挂载朋友圈记忆</div>
          <div class="sub">角色记住你们的朋友圈互动</div>
        </div>
        <div id="momentsMemoryToggle" style="width:44px;height:26px;border-radius:13px;background:var(--accent2);position:relative;transition:background .2s;flex-shrink:0">
          <div id="momentsMemoryKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>
        </div>
      </div>
      <div id="momentsMemorySliderRow" style="display:none;padding:10px 16px 14px;border-bottom:1px solid rgba(0,0,0,.04)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <span style="font-size:13px;color:var(--text);font-weight:500">记忆条数</span>
          <span id="momentsMemoryVal" style="font-size:13px;font-weight:700;color:var(--accent)">10</span>
        </div>
        <input type="range" id="momentsMemoryRange" min="5" max="20" value="10"
          style="width:100%;accent-color:var(--accent);height:4px;cursor:pointer"
          oninput="onMomentsMemoryRange(this.value)"/>
        <div style="display:flex;justify-content:space-between;margin-top:4px">
          <span style="font-size:10px;color:var(--text2)">5条</span>
          <span style="font-size:10px;color:var(--text2)">20条</span>
        </div>
      </div>
      <div class="set-row" style="cursor:pointer" onclick="toggleGroupChatMemory()">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">挂载群聊记忆</div>
          <div class="sub">角色记得群聊中的对话内容</div>
        </div>
        <div id="groupChatMemToggle" style="width:44px;height:26px;border-radius:13px;background:var(--accent2);position:relative;transition:background .2s;flex-shrink:0">
          <div id="groupChatMemKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>
        </div>
      </div>
      <div id="groupChatMemSliderRow" style="display:none;padding:10px 16px 14px;border-bottom:1px solid rgba(0,0,0,.04)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <span style="font-size:13px;color:var(--text);font-weight:500">群聊记忆条数</span>
          <span id="groupChatMemVal" style="font-size:13px;font-weight:700;color:var(--accent)">15</span>
        </div>
        <input type="range" id="groupChatMemRange" min="5" max="50" value="15"
          style="width:100%;accent-color:var(--accent);height:4px;cursor:pointer"
          oninput="onGroupChatMemRange(this.value)"/>
        <div style="display:flex;justify-content:space-between;margin-top:4px">
          <span style="font-size:10px;color:var(--text2)">5条</span>
          <span style="font-size:10px;color:var(--text2)">50条</span>
        </div>
      </div>
      <div class="set-row" onclick="clearConvBg()" style="cursor:pointer">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">清除聊天背景</div>
          <div class="sub">恢复默认背景</div>
        </div>
      </div>
      <div class="set-row" onclick="confirmDeleteContact()" style="cursor:pointer">
        <div>
          <div style="font-size:14px;color:#FF3B30;font-weight:500">删除联系人</div>
          <div class="sub">删除该联系人及所有聊天记录</div>
        </div>
      </div>
      <input type="file" id="convBgFile" accept="image/*" style="display:none" onchange="setConvBg(event)"/>
    </div>
  </div>
</div>

<!-- 气泡颜色面板 -->
<div class="panel" id="panelBubbleColor" onclick="if(event.target===this)closeBubbleColor()" style="z-index:80;position:fixed;inset:0">
  <div class="panel-box">
    <div class="panel-title">气泡颜色</div>
    <button class="panel-close" onclick="closeBubbleColor()">×</button>
    <div style="display:flex;flex-direction:column;gap:20px;margin-top:4px">
      <div>
        <div style="font-size:12px;color:var(--text2);font-weight:600;letter-spacing:1px;margin-bottom:12px">我的气泡</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap" id="myBubblePresets"></div>
        <div style="display:flex;align-items:center;gap:10px;margin-top:12px">
          <div id="myBubbleCustom" style="width:36px;height:36px;border-radius:50%;border:2px solid var(--accent2);cursor:pointer;position:relative;overflow:hidden;flex-shrink:0">
            <input type="color" id="myBubbleColorPicker" style="position:absolute;inset:-4px;width:calc(100%+8px);height:calc(100%+8px);border:none;cursor:pointer;opacity:0" oninput="applyBubbleColor('my',this.value)"/>
            <div style="width:100%;height:100%;background:conic-gradient(red,yellow,lime,cyan,blue,magenta,red);pointer-events:none"></div>
          </div>
          <span style="font-size:12px;color:var(--text2)">自定义颜色</span>
          <div id="myBubblePreview" style="width:36px;height:36px;border-radius:50%;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.12)"></div>
        </div>
      </div>
      <div style="height:1px;background:rgba(0,0,0,.06)"></div>
      <div>
        <div style="font-size:12px;color:var(--text2);font-weight:600;letter-spacing:1px;margin-bottom:12px">对方气泡</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap" id="theirBubblePresets"></div>
        <div style="display:flex;align-items:center;gap:10px;margin-top:12px">
          <div id="theirBubbleCustom" style="width:36px;height:36px;border-radius:50%;border:2px solid var(--accent2);cursor:pointer;position:relative;overflow:hidden;flex-shrink:0">
            <input type="color" id="theirBubbleColorPicker" style="position:absolute;inset:-4px;width:calc(100%+8px);height:calc(100%+8px);border:none;cursor:pointer;opacity:0" oninput="applyBubbleColor('their',this.value)"/>
            <div style="width:100%;height:100%;background:conic-gradient(red,yellow,lime,cyan,blue,magenta,red);pointer-events:none"></div>
          </div>
          <span style="font-size:12px;color:var(--text2)">自定义颜色</span>
          <div id="theirBubblePreview" style="width:36px;height:36px;border-radius:50%;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.12)"></div>
        </div>
      </div>
      <button class="save-btn" onclick="saveBubbleColor()">应用</button>
    </div>
  </div>
</div>

<!-- 搜索聊天记录面板 -->
<div class="panel" id="panelSearchChat" onclick="if(event.target===this)closeSearchChat()" style="z-index:80;position:fixed;inset:0">
  <div class="panel-box" style="max-height:85%">
    <div class="panel-title">搜索聊天记录</div>
    <button class="panel-close" onclick="closeSearchChat()">×</button>
    <input class="set-input" id="searchChatInput" placeholder="输入关键词…" oninput="doSearchChat()" style="margin-bottom:12px"/>
    <div id="searchChatResults" style="display:flex;flex-direction:column;gap:2px;max-height:50vh;overflow-y:auto;scrollbar-width:none"></div>
  </div>
</div>

<!-- 收藏消息面板 -->
<div class="panel" id="panelFavList" onclick="if(event.target===this)closeFavList()" style="z-index:80;position:fixed;inset:0">
  <div class="panel-box" style="max-height:85%">
    <div class="panel-title">收藏的消息</div>
    <button class="panel-close" onclick="closeFavList()">×</button>
    <div id="favListBody" style="display:flex;flex-direction:column;gap:6px;max-height:55vh;overflow-y:auto;scrollbar-width:none"></div>
  </div>
</div>

<!-- 陪伴记录面板 -->
<div class="panel" id="panelCompanionLog" onclick="if(event.target===this)closeCompanionLog()" style="z-index:80;position:fixed;inset:0">
  <div class="panel-box" style="max-height:85%">
    <div class="panel-title">陪伴记录</div>
    <button class="panel-close" onclick="closeCompanionLog()">x</button>
    <div id="companionLogBody" style="display:flex;flex-direction:column;gap:2px;max-height:55vh;overflow-y:auto;scrollbar-width:none"></div>
  </div>
</div>

<!-- 编辑联系人面板 -->
<div class="panel" id="panelEditContact" onclick="if(event.target===this)closeEditContact()" style="z-index:70">
  <div class="panel-box">
    <div class="panel-title">编辑联系人</div>
    <button class="panel-close" onclick="closeEditContact()">×</button>
    <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:20px">
      <div id="editContactAvatarPreview" onclick="document.getElementById('editContactAvatarFile').click()" style="width:72px;height:72px;border-radius:50%;background:var(--accent2);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.1)">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <input type="file" id="editContactAvatarFile" accept="image/*" style="display:none" onchange="onEditContactAvatarFile(event)"/>
      <p style="font-size:12px;color:var(--text2);margin-top:8px">点击更换头像</p>
    </div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">角色名字</div>
        <input class="set-input" id="ecName" placeholder="输入角色名字"/>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">性别</div>
        <div style="display:flex;gap:8px">
          <div class="gender-opt" id="ecG-male" onclick="setEditContactGender('male')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="10" cy="14" r="5"/><line x1="19" y1="5" x2="14.14" y2="9.86"/><polyline points="15 5 19 5 19 9"/></svg>男
          </div>
          <div class="gender-opt" id="ecG-female" onclick="setEditContactGender('female')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="9" r="5"/><line x1="12" y1="14" x2="12" y2="22"/><line x1="9" y1="19" x2="15" y2="19"/></svg>女
          </div>
        </div>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">角色人设</div>
        <textarea class="set-input" id="ecPersona" rows="4" placeholder="描述角色性格、背景…" style="resize:none;line-height:1.6"></textarea>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">绑定我的人设</div>
        <select class="set-input" id="ecMePreset"></select>
      </div>
      <button class="save-btn" onclick="saveEditContact()">保存</button>
    </div>
  </div>
</div>

<!-- 添加联系人面板 -->
<div class="panel" id="panelContact" onclick="if(event.target===this)closeAddContact()" style="z-index:70">
  <div class="panel-box">
    <div class="panel-title">新建联系人</div>
    <button class="panel-close" onclick="closeAddContact()">×</button>
    <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:20px">
      <div id="contactAvatarPreview" onclick="document.getElementById('contactAvatarFile').click()" style="width:72px;height:72px;border-radius:50%;background:var(--accent2);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.1)">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <input type="file" id="contactAvatarFile" accept="image/*" style="display:none" onchange="onContactAvatarFile(event)"/>
      <p style="font-size:12px;color:var(--text2);margin-top:8px">点击设置头像</p>
    </div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div>
        <div class="wp-btn" onclick="document.getElementById('tavernCardFile').click()" style="margin-bottom:14px">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          导入酒馆角色卡 (PNG)
        </div>
        <input type="file" id="tavernCardFile" accept=".png,image/png" style="display:none" onchange="importTavernCard(event)"/>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">角色名字</div>
        <input class="set-input" id="cName" placeholder="输入角色名字"/>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">性别</div>
        <div style="display:flex;gap:8px">
          <div class="gender-opt active" id="cG-male" onclick="setContactGender('male')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="10" cy="14" r="5"/><line x1="19" y1="5" x2="14.14" y2="9.86"/><polyline points="15 5 19 5 19 9"/></svg>男
          </div>
          <div class="gender-opt" id="cG-female" onclick="setContactGender('female')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="9" r="5"/><line x1="12" y1="14" x2="12" y2="22"/><line x1="9" y1="19" x2="15" y2="19"/></svg>女
          </div>
        </div>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">角色人设</div>
        <textarea class="set-input" id="cPersona" rows="4" placeholder="描述角色性格、背景…" style="resize:none;line-height:1.6"></textarea>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">绑定我的人设</div>
        <select class="set-input" id="cMePreset"></select>
      </div>
      <button class="save-btn" onclick="saveContact()">保存联系人</button>
    </div>
  </div>
</div>

<!-- 创建群聊面板 -->
<div class="panel" id="panelCreateGroup" onclick="if(event.target===this)closeCreateGroup()" style="z-index:70;position:fixed;inset:0">
  <div class="panel-box">
    <div class="panel-title" id="createGroupTitle">创建群聊</div>
    <button class="panel-close" onclick="closeCreateGroup()">×</button>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">群聊名称</div>
        <input class="set-input" id="groupName" placeholder="例如：快乐小分队"/>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">群公告（可选）</div>
        <textarea class="set-input" id="groupNotice" rows="2" placeholder="写点群公告…" style="resize:none;line-height:1.6"></textarea>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">绑定我的人设</div>
        <select class="set-input" id="groupMePreset"></select>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:8px">选择群成员（至少2人）</div>
        <div id="groupMemberList" style="display:flex;flex-direction:column;gap:6px"></div>
        <div id="groupNoContacts" style="font-size:12px;color:var(--text2);display:none;padding:10px 0;text-align:center">暂无联系人，请先添加</div>
      </div>
      <button class="save-btn" onclick="saveGroup()">创建群聊</button>
    </div>
  </div>
</div>

<!-- 我的人设详情页 -->
<!-- 我的人设详情页 -->
<div class="fullpage" id="pageMePreset" style="z-index:45;background:var(--bg)">
  <div class="fp-header" style="border-bottom:none;padding-bottom:4px;box-shadow:none">
    <button class="fp-back" onclick="closeMePresetPage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2 style="font-size:18px;font-weight:800">我的人设</h2>
    <button onclick="addMePreset()" style="background:var(--accent);border:none;border-radius:50%;width:38px;height:38px;cursor:pointer;margin-left:auto;color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 16px rgba(0,0,0,.15);transition:transform .2s" onmousedown="this.style.transform='scale(0.9)'" onmouseup="this.style.transform='scale(1)'">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    </button>
  </div>
  <div class="fp-body" style="padding:16px 20px">
    <div id="mePresetList"></div>
    <!-- 编辑区 -->
    <div id="meEditBox" style="display:none;flex-direction:column;gap:14px;padding-top:12px;padding-bottom:40px">
      <div class="me-edit-card">
        <div class="me-edit-header">
          <div style="width:32px;height:32px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
          </div>
          <span>编辑当前人设</span>
        </div>
        <div class="me-edit-body">
          <div>
            <div class="me-edit-label">人设名称</div>
            <input class="set-input" id="meName" placeholder="例如：真实的我"/>
          </div>
          <div>
            <div class="me-edit-label">性别</div>
            <div style="display:flex;gap:12px">
              <div class="gender-opt active" id="meG-male" onclick="setMeGender('male')">男生</div>
              <div class="gender-opt" id="meG-female" onclick="setMeGender('female')">女生</div>
            </div>
          </div>
          <div>
            <div class="me-edit-label">人设描述</div>
            <textarea class="set-input" id="mePersona" rows="5" placeholder="描述你的性格、背景、说话方式…" style="resize:none;line-height:1.6"></textarea>
          </div>
          <button class="save-btn" onclick="saveMe()">保存修改</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 记忆APP -->
<div class="fullpage" id="pageMemory">
  <div class="fp-header">
    <button class="fp-back" onclick="closeMemoryApp()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2>记忆</h2>
  </div>
  <div class="fp-body" style="padding:14px">

    <!-- 总结API配置 -->
    <div class="set-group" style="margin-bottom:16px">
      <div style="padding:14px 16px">
        <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1.5px;margin-bottom:10px">总结 API（省token专用，可用小模型）</div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <input type="checkbox" id="memUseSameApi" onchange="toggleMemApi()" style="width:18px;height:18px;accent-color:var(--accent)"/>
          <label for="memUseSameApi" style="font-size:13px;color:var(--text)">使用主API相同配置</label>
        </div>
        <div id="memApiFields">
          <input class="set-input" id="memApiBase" placeholder="API Base URL"/>
          <input class="set-input" id="memApiKey" type="password" placeholder="API 密钥" style="margin-top:6px"/>
          <input class="set-input" id="memApiModel" placeholder="模型名称（如 gpt-4o-mini）" style="margin-top:6px"/>
        </div>
        <button class="save-btn" onclick="saveMemApiConfig()" style="margin-top:10px">保存总结API</button>
      </div>
    </div>

    <!-- 记忆参数 -->
    <div class="set-group" style="margin-bottom:16px">
      <div style="padding:14px 16px">
        <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1.5px;margin-bottom:12px">自动总结设置</div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <span style="font-size:13px;color:var(--text);font-weight:500">单聊每隔多少条总结</span>
          <span id="memDmIntervalVal" style="font-size:13px;font-weight:700;color:var(--accent)">15</span>
        </div>
        <input type="range" id="memDmInterval" min="8" max="40" value="15" style="width:100%;accent-color:var(--accent);height:4px;cursor:pointer" oninput="document.getElementById('memDmIntervalVal').textContent=this.value"/>
        <div style="display:flex;justify-content:space-between;margin-bottom:14px"><span style="font-size:10px;color:var(--text2)">8条</span><span style="font-size:10px;color:var(--text2)">40条</span></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <span style="font-size:13px;color:var(--text);font-weight:500">群聊每隔多少条总结</span>
          <span id="memGrpIntervalVal" style="font-size:13px;font-weight:700;color:var(--accent)">20</span>
        </div>
        <input type="range" id="memGrpInterval" min="10" max="50" value="20" style="width:100%;accent-color:var(--accent);height:4px;cursor:pointer" oninput="document.getElementById('memGrpIntervalVal').textContent=this.value"/>
        <div style="display:flex;justify-content:space-between;margin-bottom:14px"><span style="font-size:10px;color:var(--text2)">10条</span><span style="font-size:10px;color:var(--text2)">50条</span></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <span style="font-size:13px;color:var(--text);font-weight:500">记忆保留天数</span>
          <span id="memRetainVal" style="font-size:13px;font-weight:700;color:var(--accent)">7</span>
        </div>
        <input type="range" id="memRetainDays" min="3" max="7" value="7" style="width:100%;accent-color:var(--accent);height:4px;cursor:pointer" oninput="document.getElementById('memRetainVal').textContent=this.value"/>
        <div style="display:flex;justify-content:space-between;margin-bottom:14px"><span style="font-size:10px;color:var(--text2)">3天</span><span style="font-size:10px;color:var(--text2)">7天</span></div>

        <button class="save-btn" onclick="saveMemSettings()">保存设置</button>
      </div>
    </div>

    <!-- 记忆总开关 -->
    <div class="set-group" style="margin-bottom:16px">
      <div class="set-row" style="cursor:pointer" onclick="toggleMemorySystem()">
        <div>
          <div style="font-size:14px;color:var(--text);font-weight:500">启用记忆系统</div>
          <div class="sub">自动总结对话，角色不再失忆</div>
        </div>
        <div id="memSysToggle" style="width:44px;height:26px;border-radius:13px;background:var(--accent2);position:relative;transition:background .2s;flex-shrink:0">
          <div id="memSysKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>
        </div>
      </div>
    </div>

    <!-- 记忆列表 -->
    <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1.5px;margin-bottom:10px">已存储的记忆</div>
    <div id="memoryListBody"></div>

    <!-- 手动总结 -->
    <button class="save-btn" onclick="manualSummarizeAll()" style="margin-top:16px;background:var(--text2)">手动总结所有对话</button>
  </div>
</div>

</div><!-- end phone -->

<!-- 以下面板移到phone外部，避免被transform层叠上下文遮挡 -->
<div class="panel" id="panelBubbleColor2" onclick="if(event.target===this)closeBubbleColor()" style="z-index:9999;position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity .3s">
  <div class="panel-box" id="panelBubbleColor2Box"></div>
</div>

<div class="panel" id="panelFavList2" onclick="if(event.target===this)closeFavList()" style="z-index:9999;position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity .3s">
  <div class="panel-box" style="max-height:85%" id="panelFavList2Box"></div>
</div>

<div class="panel" id="panelSearchChat2" onclick="if(event.target===this)closeSearchChat()" style="z-index:9999;position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity .3s">
  <div class="panel-box" style="max-height:85%" id="panelSearchChat2Box"></div>
</div>

<div class="panel" id="panelRefreshMoments" onclick="if(event.target===this)closeRefreshMoments()" style="z-index:75">
  <div class="panel-box">
    <div class="panel-title">刷新谁的动态</div>
    <button class="panel-close" onclick="closeRefreshMoments()">×</button>
    <div style="font-size:12px;color:var(--text2);margin-bottom:10px">选择联系人，AI 将根据聊天记录和人设生成动态</div>
    <div id="refreshContactList" style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px"></div>
    <button class="save-btn" id="refreshBtn" onclick="doRefreshMoments()">刷新动态</button>
  </div>
</div>

<!-- 发朋友圈面板 -->
<div class="panel" id="panelPostMoment" onclick="if(event.target===this)closePostMoment()" style="z-index:75">
  <div class="panel-box">
    <div class="panel-title">发朋友圈</div>
    <button class="panel-close" onclick="closePostMoment()">×</button>

    <!-- 文字输入 -->
    <textarea class="set-input" id="postMomentText" rows="4" placeholder="这一刻的想法…" style="resize:none;line-height:1.6;margin-bottom:14px"></textarea>

    <!-- 图片选择区 -->
    <div style="margin-bottom:16px">
      <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1.2px;margin-bottom:8px">图片（最多9张）</div>
      <div id="postImgGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px"></div>
    </div>

    <!-- 可见好友 -->
    <div style="margin-bottom:18px">
      <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1.2px;margin-bottom:8px">谁可以看（可多选，评论来自选中好友）</div>
      <div id="postVisibleList" style="display:flex;flex-direction:column;gap:6px"></div>
      <div id="postNoContacts" style="font-size:12px;color:var(--text2);display:none">暂无联系人</div>
    </div>

    <button class="save-btn" onclick="submitPostMoment()">发布</button>
  </div>
</div>

<!-- 裁剪弹窗 -->
<div class="crop-panel" id="cropPanel">
  <div class="crop-wrap" id="cropWrap">
    <img id="cropImg" src="" draggable="false"/>
    <div class="crop-mask"></div>
    <div class="crop-frame"></div>
  </div>
  <div style="font-size:12px;color:rgba(255,255,255,.7)">拖动 / 双指缩放调整位置</div>
  <div class="crop-btns">
    <button class="crop-btn" style="background:rgba(255,255,255,.15);color:#fff" onclick="closeCrop()">取消</button>
    <button class="crop-btn" style="background:#fff;color:#333" onclick="confirmCrop()">使用</button>
  </div>
</div>

<!-- 看书面板（书单） -->
<div class="panel" id="bookPanel" onclick="if(event.target===this)closeBookReader()" style="z-index:75">
  <div class="panel-box" style="max-height:80%">
    <div class="panel-title">书架</div>
    <button class="panel-close" onclick="closeBookReader()">x</button>
    <div style="margin-bottom:14px">
      <div class="wp-btn" onclick="document.getElementById('bookFile').click()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        导入TXT小说
      </div>
      <input type="file" id="bookFile" accept=".txt,text/plain" style="display:none" onchange="onBookFile(event)"/>
      <div style="font-size:11px;color:var(--text2);margin-top:6px">需要API支持识图（vision），每页约85 tokens</div>
    </div>
    <div id="bookListBody" style="display:flex;flex-direction:column;gap:8px"></div>
    <div id="bookListEmpty" style="display:flex;flex-direction:column;align-items:center;padding:30px 0;gap:10px">
      <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="1.2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      <p style="font-size:13px;color:var(--text2)">书架空空，导入一本吧</p>
    </div>
  </div>
</div>

<!-- 拍照弹窗 -->
<div class="photo-panel" id="photoPanel" onclick="if(event.target===this)closePhotoPanel()">
  <div class="photo-box">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div style="font-size:16px;font-weight:700;color:var(--text)">发送照片</div>
      <button onclick="closePhotoPanel()" style="background:none;border:none;cursor:pointer;color:var(--text2);font-size:22px;line-height:1;padding:2px">×</button>
    </div>
    <!-- 取景框预览 -->
    <div class="photo-viewfinder">
      <div class="photo-corner tl"></div>
      <div class="photo-corner tr"></div>
      <div class="photo-corner bl"></div>
      <div class="photo-corner br"></div>
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="1.2" id="photoIcon"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
      <div class="photo-preview-text" id="photoPreviewText">在下方描述这张照片的内容</div>
      <div class="photo-shutter">VIRTUAL CAM</div>
    </div>
    <!-- 描述输入 -->
    <div style="margin-bottom:14px">
      <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1.2px;margin-bottom:8px">照片描述</div>
      <textarea id="photoDesc" class="set-input" rows="3" placeholder="例如：我在咖啡馆窗边，阳光洒在桌上，手边放着一杯拿铁…" style="resize:none;line-height:1.6" oninput="updatePhotoPreview()"></textarea>
    </div>
    <!-- 情绪标签 -->
    <div style="margin-bottom:18px">
      <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1.2px;margin-bottom:8px">氛围</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap" id="photoMoodTags">
        <div class="photo-tag" onclick="selectPhotoMood(this,'日常')">日常</div>
        <div class="photo-tag" onclick="selectPhotoMood(this,'温柔')">温柔</div>
        <div class="photo-tag" onclick="selectPhotoMood(this,'慵懒')">慵懒</div>
        <div class="photo-tag" onclick="selectPhotoMood(this,'开心')">开心</div>
        <div class="photo-tag" onclick="selectPhotoMood(this,'思念')">思念</div>
        <div class="photo-tag" onclick="selectPhotoMood(this,'深夜')">深夜</div>
      </div>
    </div>
    <button class="save-btn" onclick="confirmSendPhoto()">
      <span style="display:flex;align-items:center;justify-content:center;gap:8px">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
        发送照片
      </span>
    </button>
  </div>
</div>

<!-- 顶部正在播放条 -->
<div class="now-playing-bar" id="nowPlayingBar" onclick="scrollToMusicWidget()">
  <div class="npb-cover" id="npbCover"></div>
  <div class="npb-info">
    <div class="npb-title" id="npbTitle">未在播放</div>
    <div class="npb-artist" id="npbArtist"></div>
  </div>
  <button class="npb-btn" id="npbPlayBtn" onclick="event.stopPropagation();toggleMusicPlay()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="var(--text)" stroke="none"><polygon points="5,3 19,12 5,21"/></svg>
  </button>
  <button class="npb-btn" onclick="event.stopPropagation();musicNext()">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text)" stroke-width="2"><polygon points="5,4 15,12 5,20" fill="var(--text)"/><line x1="19" y1="5" x2="19" y2="19"/></svg>
  </button>
  <div class="npb-progress"><div class="npb-progress-fill" id="npbProgressFill"></div></div>
</div>

<!-- 歌曲列表面板 -->
<div class="panel" id="panelMusicList" onclick="if(event.target===this)closeMusicList()" style="z-index:75">
  <div class="panel-box" style="max-height:80%">
    <div class="panel-title">歌曲列表</div>
    <button class="panel-close" onclick="closeMusicList()">x</button>
    <div style="margin-bottom:14px">
      <div class="wp-btn" onclick="document.getElementById('musicFiles').click()" style="margin-bottom:8px">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
        导入音乐文件
      </div>
  
      <input type="file" id="musicFiles" accept="audio/*,.mp3,.ogg,.wav,.m4a,.flac,.aac" multiple style="display:none" onchange="onMusicFiles(event)"/>
      <div class="wp-btn" onclick="document.getElementById('musicZipFile').click()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        导入音乐 ZIP 包
      </div>
      <input type="file" id="musicZipFile" accept=".zip" style="display:none" onchange="onMusicZipFile(event)"/>
      <div style="font-size:11px;color:var(--text2);margin-top:6px;padding:0 4px">支持 mp3/ogg/wav/m4a/flac 文件，可多选</div>
    </div>
    <div id="musicListBody" style="display:flex;flex-direction:column;gap:2px;max-height:50vh;overflow-y:auto;scrollbar-width:none"></div>
  </div>
</div>

<!-- 群投票面板 -->
<div class="panel" id="panelGroupVote" onclick="if(event.target===this)closeGroupVote()" style="z-index:75">
  <div class="panel-box">
    <div class="panel-title">发起群投票</div>
    <button class="panel-close" onclick="closeGroupVote()">×</button>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">投票主题</div>
        <input class="set-input" id="voteTitle" placeholder="例如：周末去哪玩？"/>
      </div>
      <div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:8px">投票选项（至少2个）</div>
        <div id="voteOptionList" style="display:flex;flex-direction:column;gap:8px"></div>
        <button onclick="addVoteOption()" style="margin-top:8px;width:100%;padding:10px;border:1.5px dashed var(--accent2);border-radius:12px;background:none;font-size:13px;color:var(--text2);cursor:pointer;font-family:inherit">+ 添加选项</button>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <input type="checkbox" id="voteMultiple" style="width:18px;height:18px;accent-color:var(--accent)"/>
        <label for="voteMultiple" style="font-size:13px;color:var(--text)">允许多选</label>
      </div>
      <button class="save-btn" onclick="submitGroupVote()">发起投票</button>
    </div>
  </div>
</div>

<!-- 一起听歌选歌面板 -->
<div class="panel" id="panelListenTogether" onclick="if(event.target===this)closeListenTogether()" style="z-index:75">
  <div class="panel-box" style="max-height:80%">
    <div class="panel-title">一起听歌</div>
    <button class="panel-close" onclick="closeListenTogether()">x</button>
    <div style="font-size:12px;color:var(--text2);margin-bottom:14px;line-height:1.6">选一首歌和ta一起听，角色会分享对这首歌的感受</div>
    <!-- 点歌输入 -->
    <div style="margin-bottom:14px">
      <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1px;margin-bottom:8px">给ta点歌（输入歌名）</div>
      <div style="display:flex;gap:8px">
        <input class="set-input" id="listenSongInput" placeholder="输入歌名或歌手…" style="flex:1;margin:0"/>
        <button onclick="sendSongRequest()" style="padding:0 16px;background:var(--accent);color:#fff;border:none;border-radius:12px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;flex-shrink:0">点歌</button>
      </div>
    </div>
    <div style="height:1px;background:rgba(0,0,0,.06);margin-bottom:14px"></div>
    <!-- 歌单列表 -->
    <div style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1px;margin-bottom:8px">从歌单选择</div>
    <div id="listenTrackList" style="display:flex;flex-direction:column;gap:2px;max-height:45vh;overflow-y:auto;scrollbar-width:none"></div>
    <div id="listenNoTracks" style="display:none;text-align:center;padding:30px 0;font-size:13px;color:var(--text2)">歌单为空，请先在桌面音乐组件导入歌曲</div>
  </div>
</div>

<div class="top-notify" id="topNotify">
  <div class="top-notify-avatar" id="topNotifyAvatar"></div>
  <div class="top-notify-body">
    <div class="top-notify-title">
      <span id="topNotifyName"></span>
      <span id="topNotifyTime"></span>
    </div>
    <div class="top-notify-text" id="topNotifyText"></div>
  </div>
</div>
<div class="toast" id="toast"></div>
<script>
  // ==========================================
// 移动端真实视口高度 (VH) 修复补丁
// ==========================================
function fixMobileHeight() {
  // 获取真实的 1% 高度
  let vh = window.innerHeight * 0.01;
  // 把这个值存到 CSS 变量 --vh 中
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
// 初始化执行一次
fixMobileHeight();
// 当屏幕旋转或浏览器工具栏收缩时，重新计算
window.addEventListener('resize', fixMobileHeight);
window.addEventListener('orientationchange', fixMobileHeight);
// ==========================================
// IndexedDB for ALL data storage (replaces localStorage entirely)
const IDB={
  db:null,
  open(){
    return new Promise((resolve,reject)=>{
      const req=indexedDB.open('OrangePhone',2);
      req.onupgradeneeded=e=>{
        const db=e.target.result;
        if(!db.objectStoreNames.contains('blobs'))db.createObjectStore('blobs');
        if(!db.objectStoreNames.contains('store'))db.createObjectStore('store');
      };
      req.onsuccess=e=>{IDB.db=e.target.result;resolve()};
      req.onerror=e=>reject(e);
    });
  },
  set(key,val){
    return new Promise((resolve,reject)=>{
      const tx=IDB.db.transaction('blobs','readwrite');
      tx.objectStore('blobs').put(val,key);
      tx.oncomplete=resolve;tx.onerror=reject;
    });
  },
  get(key){
    return new Promise((resolve,reject)=>{
      const tx=IDB.db.transaction('blobs','readonly');
      const req=tx.objectStore('blobs').get(key);
      req.onsuccess=()=>resolve(req.result);req.onerror=reject;
    });
  },
  del(key){
    return new Promise((resolve,reject)=>{
      const tx=IDB.db.transaction('blobs','readwrite');
      tx.objectStore('blobs').delete(key);
      tx.oncomplete=resolve;tx.onerror=reject;
    });
  },
  getAll(){
    return new Promise((resolve,reject)=>{
      const tx=IDB.db.transaction('blobs','readonly');
      const store=tx.objectStore('blobs');
      const keys=[],vals=[];
      const req=store.openCursor();
      req.onsuccess=e=>{const c=e.target.result;if(c){keys.push(c.key);vals.push(c.value);c.continue();}else resolve({keys,vals})};
      req.onerror=reject;
    });
  },
  // store objectStore methods
  sSet(key,val){
    return new Promise((resolve,reject)=>{
      const tx=IDB.db.transaction('store','readwrite');
      tx.objectStore('store').put(val,key);
      tx.oncomplete=resolve;tx.onerror=reject;
    });
  },
  sGet(key){
    return new Promise((resolve,reject)=>{
      const tx=IDB.db.transaction('store','readonly');
      const req=tx.objectStore('store').get(key);
      req.onsuccess=()=>resolve(req.result);req.onerror=reject;
    });
  },
  sDel(key){
    return new Promise((resolve,reject)=>{
      const tx=IDB.db.transaction('store','readwrite');
      tx.objectStore('store').delete(key);
      tx.oncomplete=resolve;tx.onerror=reject;
    });
  },
  sGetAll(){
    return new Promise((resolve,reject)=>{
      const tx=IDB.db.transaction('store','readonly');
      const store=tx.objectStore('store');
      const map={};
      const req=store.openCursor();
      req.onsuccess=e=>{const c=e.target.result;if(c){map[c.key]=c.value;c.continue();}else resolve(map)};
      req.onerror=reject;
    });
  }
};

// Synchronous cache layer that replaces localStorage
// Reads from memory (instant), writes to memory + async IDB
const LS={
  _cache:{},
  _ready:false,
  async init(){
    await IDB.open();
    // Load all from IDB store
    this._cache=await IDB.sGetAll();
    // Migrate any existing localStorage data to IDB
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(k&&!(k in this._cache)){
        this._cache[k]=localStorage.getItem(k);
        IDB.sSet(k,this._cache[k]);
      }
    }
    this._ready=true;
  },
  getItem(key){
    const v=this._cache[key];
    return v===undefined?null:v;
  },
  setItem(key,val){
    this._cache[key]=val;
    IDB.sSet(key,val);
  },
  removeItem(key){
    delete this._cache[key];
    IDB.sDel(key);
  },
  keys(){return Object.keys(this._cache);}
};

// Helper: save image to IDB, remove from localStorage
async function saveBlob(key,data){await IDB.set(key,data);}
async function loadBlob(key){return await IDB.get(key);}
async function delBlob(key){await IDB.del(key);}

function updateTime(){
  const n=new Date();
  document.getElementById('sTime').textContent=n.getHours()+':'+(n.getMinutes()+'').padStart(2,'0');
}
function updateBattery(){
  if(navigator.getBattery){
    navigator.getBattery().then(b=>{
      const pct=Math.round(b.level*100);
      document.getElementById('batPct').textContent=pct+'%';
      document.getElementById('bFill').setAttribute('width',Math.round(19*b.level));
      document.getElementById('bFill').setAttribute('fill',pct<=20?'#E07070':'var(--accent)');
      document.querySelector('.sbar-right svg:last-child').classList.toggle('charging',b.charging);
      b.onlevelchange=updateBattery;
      b.onchargingchange=updateBattery;
    });
  }
}
updateTime();
setInterval(updateTime,10000);
updateBattery();

// 面板开关
function openPanel(){document.getElementById('panel').classList.add('open')}
function closePanel(){document.getElementById('panel').classList.remove('open')}
function handlePanelClick(e){if(e.target===document.getElementById('panel'))closePanel()}

// 主题
const themes={
  white:{bg:'#FFFFFF',card:'#FFFFFF',card2:'#F7F7F7',accent:'#555555',accent2:'#E0E0E0',text:'#1A1A1A',text2:'#888888'},
  warm:{bg:'#F7F3EE',card:'#FFF',card2:'#FBF8F4',accent:'#C4A882',accent2:'#E8D5BC',text:'#5A4A3A',text2:'#9B8B7A'},
  rose:{bg:'#FDF0F0',card:'#FFF',card2:'#FDF5F5',accent:'#C4828A',accent2:'#EDD5D5',text:'#5A3A3E',text2:'#9B7A7E'},
  sage:{bg:'#F0F5F0',card:'#FFF',card2:'#F5FAF5',accent:'#7A9E7E',accent2:'#C8DCC9',text:'#3A5A3E',text2:'#7A9B7E'},
  slate:{bg:'#EFF3F7',card:'#FFF',card2:'#F4F7FA',accent:'#7A8FA6',accent2:'#C5D3E0',text:'#3A4A5A',text2:'#7A8A9B'},
  lav:{bg:'#F3F0F8',card:'#FFF',card2:'#F8F5FC',accent:'#9B8EC4',accent2:'#D8D0EE',text:'#4A3A5A',text2:'#8A7A9B'},
  sand:{bg:'#F8F4EE',card:'#FFF',card2:'#FCF9F4',accent:'#B8A88A',accent2:'#EDE3D4',text:'#5A4E3A',text2:'#9B8E7A'},
  mint:{bg:'#EFF8F7',card:'#FFF',card2:'#F4FBFA',accent:'#6BBFB5',accent2:'#C2E8E4',text:'#2A5A56',text2:'#6A9B97'},
  dusk:{bg:'#FBF3EC',card:'#FFF',card2:'#FDF8F2',accent:'#C4956A',accent2:'#F0D9C0',text:'#5A3E2A',text2:'#9B7A5A'},
  night:{bg:'#1A1A2E',card:'#22223A',card2:'#2D2D44',accent:'#7B68EE',accent2:'#3D3D5C',text:'#E0E0F0',text2:'#8888AA'},
  dark:{bg:'#0D0D0D',card:'#1A1A1A',card2:'#222222',accent:'#888888',accent2:'#333333',text:'#E8E8E8',text2:'#777777'},
};
function setTheme(name){
  const t=themes[name];if(!t)return;
  const r=document.documentElement.style;
  Object.entries(t).forEach(([k,v])=>r.setProperty('--'+k,v));
  document.querySelector('.phone').style.background=t.bg;
  document.querySelectorAll('.tcircle').forEach(c=>c.classList.remove('active'));
  document.getElementById('t-'+name)?.classList.add('active');
  LS.setItem('theme',name);
}

// 壁纸
function setWallpaper(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{
    IDB.set('wallpaper',ev.target.result);
    document.getElementById('wallpaper').innerHTML=`<img src="${ev.target.result}"/>`;
    document.getElementById('wpImg').src=ev.target.result;
    document.getElementById('wpPreview').style.display='block';
  };
  r.readAsDataURL(file);
}
function removeWallpaper(){
  IDB.del('wallpaper');
  document.getElementById('wallpaper').innerHTML='';
  document.getElementById('wpPreview').style.display='none';document.getElementById('wpFile').value='';
}

// 设置页开关
function openSet(){document.getElementById('pageSet').classList.add('open');}
function closeSet(){document.getElementById('pageSet').classList.remove('open')}

// 同步设置页顶栏时间电量
function syncSetSbar(){
  document.getElementById('sTime2').textContent=document.getElementById('sTime').textContent;
  const pct=document.getElementById('batPct').textContent;
  document.getElementById('batPct2').textContent=pct;
  const w=document.getElementById('bFill').getAttribute('width');
  document.getElementById('bFill2').setAttribute('width',w);
}

// toast
function showToast(msg){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2200);
}

// API预设
let presets=[];
let activePreset=0;
function renderPresets(){
  const el=document.getElementById('presetList');
  el.innerHTML='';
  presets.forEach((p,i)=>{
    const d=document.createElement('div');
    d.className='preset-item'+(i===activePreset?' active':'');
    d.innerHTML=`<span>${p.name}</span><button class="del-btn" onclick="delPreset(event,${i})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`;
    d.onclick=()=>loadPreset(i);
    el.appendChild(d);
  });
}
function loadPreset(i){
  LS.setItem('activePreset',String(i));
  const p=presets[i]||{};
  document.getElementById('apiBase').value=p.base||'';
  document.getElementById('apiKey').value=p.key||'';
  document.getElementById('apiModel').value=p.model||'';
  renderPresets();
}
function addPreset(){
  const name='预设 '+(presets.length+1);
  presets.push({name,base:'',key:'',model:''});
  LS.setItem('apiPresets',JSON.stringify(presets));
  loadPreset(presets.length-1);
}
function delPreset(e,i){
  e.stopPropagation();presets.splice(i,1);
  if(activePreset>=presets.length)activePreset=Math.max(0,presets.length-1);
  LS.setItem('apiPresets',JSON.stringify(presets));
  renderPresets();
}
async function testAPI(){
  const base=(document.getElementById('apiBase')?.value||'').trim()||'https://api.openai.com/v1';
  const key=(document.getElementById('apiKey')?.value||'').trim();
  const model=(document.getElementById('apiModel')?.value||'').trim()||'gpt-4o-mini';
  if(!key){showToast('请先填写 API 密钥');return;}
  showToast('测试中...');
  try{
    const res=await fetch(base+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body:JSON.stringify({model,messages:[{role:'user',content:'hi'}],max_tokens:1})
    });
    if(res.ok||res.status===400){showToast('✓ 连接成功');}
    else if(res.status===401){showToast('✗ 密钥无效');}
    else{showToast('✗ 失败：'+res.status);}
  }catch(e){showToast('✗ 无法连接，检查地址');}
}
function saveAPI(){
  if(!presets.length){presets.push({name:'预设 1',base:'',key:'',model:''});activePreset=0;}
  presets[activePreset]={
    name:presets[activePreset].name,
    base:document.getElementById('apiBase').value.trim(),
    key:document.getElementById('apiKey').value.trim(),
    model:document.getElementById('apiModel').value.trim()
  };
  LS.setItem('apiPresets',JSON.stringify(presets));
  LS.setItem('activePreset',activePreset);
  renderPresets();showToast('已保存 API 设置 ✓');
}


function setLayout(n){
  layoutCols=n;LS.setItem('layoutCols',n);
  document.getElementById('lo-4')?.classList.toggle('active',n===4);
  document.getElementById('lo-5')?.classList.toggle('active',n===5);
  applyLayout();
}

function applyLayout(){
  const iconW=layoutCols===5?56:60;
  const gap=layoutCols===5?14:20;
  document.querySelectorAll('.desktop-container .desktop').forEach(d=>{
    d.style.gridTemplateColumns=`repeat(${layoutCols},1fr)`;
    d.style.display='grid';
    d.style.gap=gap+'px '+gap+'px';
    d.style.padding='20px 18px 0';
  });
  document.querySelectorAll('.app-icon-img').forEach(el=>{ el.style.width=iconW+'px';el.style.height=iconW+'px'; });
}

// 编辑模式
let editMode=false;
let longPressTimer=null;
let dragIcon=null,dragClone=null,dragOffX=0,dragOffY=0;
let cropTargetIcon=null,cropScale=1,cropX=0,cropY=0,cropNatW=0,cropNatH=0;
let pinchStartDist=0,pinchStartScale=1;

let editModeTimer=null;
function enterEditMode(){
  editMode=true;
  document.querySelectorAll('.desktop').forEach(d=>d.classList.add('editing'));
  clearTimeout(editModeTimer);
  editModeTimer=setTimeout(()=>exitEditMode(),3000);
}
function exitEditMode(){
  editMode=false;
  document.querySelectorAll('.desktop').forEach(d=>d.classList.remove('editing'));
  clearTimeout(editModeTimer);
}

function autoHideCtrl(el){
  clearTimeout(el._hideTimer);
  el._hideTimer=setTimeout(()=>el.classList.remove('show-ctrl'),3000);
}

// 长按检测
function setupIconEvents(icon){
  let moved=false;
  let startX,startY;
  let ghost=null,edgeTimer=null,dragging=false;

  icon.addEventListener('touchstart',e=>{
    moved=false;dragging=false;
    startX=e.touches[0].clientX;
    startY=e.touches[0].clientY;
    longPressTimer=setTimeout(()=>{
      if(!editMode)enterEditMode();
      // 如果多页，进入跨页拖动模式
      if(totalPages>1&&!icon.classList.contains('free')){
        dragging=true;
        ghost=icon.cloneNode(true);
        ghost.className='app-icon drag-ghost';
        ghost.style.width=icon.offsetWidth+'px';
        const pr=document.querySelector('.phone').getBoundingClientRect();
        ghost.style.left=(startX-pr.left-icon.offsetWidth/2)+'px';
        ghost.style.top=(startY-pr.top-icon.offsetHeight/2)+'px';
        document.querySelector('.phone').appendChild(ghost);
        icon.style.opacity='.2';
      } else {
        makeIconFree(icon);
      }
    },500);
  },{passive:true});

  icon.addEventListener('touchmove',e=>{
    const cx=e.touches[0].clientX,cy=e.touches[0].clientY;
    if(Math.abs(cx-startX)>8||Math.abs(cy-startY)>8){
      moved=true;
      if(!dragging)clearTimeout(longPressTimer);
    }
    if(dragging&&ghost){
      const pr=document.querySelector('.phone').getBoundingClientRect();
      ghost.style.left=(cx-pr.left-icon.offsetWidth/2)+'px';
      ghost.style.top=(cy-pr.top-icon.offsetHeight/2)+'px';
      const rx=cx-pr.left;
      clearTimeout(edgeTimer);
      if(rx<40&&currentPage>0){
        document.getElementById('edgeLeft').classList.add('show');
        edgeTimer=setTimeout(()=>goToPage(currentPage-1),500);
      } else if(rx>pr.width-40&&currentPage<totalPages-1){
        document.getElementById('edgeRight').classList.add('show');
        edgeTimer=setTimeout(()=>goToPage(currentPage+1),500);
      } else {
        document.getElementById('edgeLeft').classList.remove('show');
        document.getElementById('edgeRight').classList.remove('show');
      }
    }
  },{passive:true});

  icon.addEventListener('touchend',e=>{
    clearTimeout(longPressTimer);
    clearTimeout(edgeTimer);
    document.getElementById('edgeLeft')?.classList.remove('show');
    document.getElementById('edgeRight')?.classList.remove('show');
    if(dragging&&ghost){
      const targetPage=getCurrentDesktopPage();
      targetPage.appendChild(icon);
      ghost.remove();ghost=null;
      icon.style.opacity='';
      dragging=false;
      saveIconPages();
    }
    if(editMode&&!dragClone&&!moved&&!dragging){changeIconImg(icon);}
  },{passive:true});

  icon.addEventListener('contextmenu',e=>e.preventDefault());
}

// 拖拽
function startDrag(icon,touch){
  dragIcon=icon;
  const rect=icon.getBoundingClientRect();
  const phoneRect=document.querySelector('.phone').getBoundingClientRect();
  dragOffX=touch.clientX-rect.left;
  dragOffY=touch.clientY-rect.top;

  dragClone=icon.cloneNode(true);
  dragClone.style.cssText=`position:absolute;z-index:99;pointer-events:none;opacity:.85;transition:none;left:${rect.left-phoneRect.left}px;top:${rect.top-phoneRect.top}px;width:${rect.width}px`;
  document.querySelector('.phone').appendChild(dragClone);
  icon.classList.add('icon-drag');

  document.addEventListener('touchmove',onDragMove,{passive:false});
  document.addEventListener('touchend',onDragEnd);
}

function onDragMove(e){
  if(!dragClone)return;
  e.preventDefault();
  const t=e.touches[0];
  const phoneRect=document.querySelector('.phone').getBoundingClientRect();
  dragClone.style.left=(t.clientX-phoneRect.left-dragOffX)+'px';
  dragClone.style.top=(t.clientY-phoneRect.top-dragOffY)+'px';

  // 找最近图标位置
  const icons=[...document.querySelectorAll('.desktop .app-icon:not(.icon-drag)')];
  const cx=t.clientX,cy=t.clientY;
  let closest=null,minD=Infinity;
  icons.forEach(ic=>{
    const r=ic.getBoundingClientRect();
    const d=Math.hypot(cx-(r.left+r.width/2),cy-(r.top+r.height/2));
    if(d<minD){minD=d;closest=ic;}
  });
  if(closest&&minD<60){
    const desktop=document.querySelector('.desktop');
    const nodes=[...desktop.querySelectorAll('.app-icon')];
    const di=nodes.indexOf(dragIcon),ci=nodes.indexOf(closest);
    if(di>ci)desktop.insertBefore(dragIcon,closest);
    else desktop.insertBefore(dragIcon,closest.nextSibling);
  }
}

function onDragEnd(e){
  document.removeEventListener('touchmove',onDragMove);
  document.removeEventListener('touchend',onDragEnd);
  if(dragClone){dragClone.remove();dragClone=null;}
  if(dragIcon){dragIcon.classList.remove('icon-drag');dragIcon=null;}
}

// 更换图标（点击编辑模式下的图标）
function changeIconImg(icon){
  cropTargetIcon=icon;
  const inp=document.createElement('input');
  inp.type='file';inp.accept='image/*';
  inp.onchange=e=>{
    const file=e.target.files[0];if(!file)return;
    const r=new FileReader();
    r.onload=ev=>openCrop(ev.target.result);
    r.readAsDataURL(file);
  };
  inp.click();
}

// 裁剪
function openCrop(src){
  const img=document.getElementById('cropImg');
  img.src=src;
  cropScale=1;cropX=0;cropY=0;
  img.onload=()=>{
    cropNatW=img.naturalWidth;cropNatH=img.naturalHeight;
    const wrap=document.getElementById('cropWrap');
    const minS=260/Math.min(cropNatW,cropNatH);
    cropScale=minS;
    cropX=(260-cropNatW*cropScale)/2;
    cropY=(260-cropNatH*cropScale)/2;
    updateCropTransform();
  };
  document.getElementById('cropPanel').classList.add('open');
  setupCropGestures();
}
function closeCrop(){document.getElementById('cropPanel').classList.remove('open');}
function updateCropTransform(){
  document.getElementById('cropImg').style.transform=`translate(${cropX}px,${cropY}px) scale(${cropScale})`;
}

function setupCropGestures(){
  const wrap=document.getElementById('cropWrap');
  let lastX=0,lastY=0,touching=false;
  wrap.ontouchstart=e=>{
    if(e.touches.length===1){
      touching=true;lastX=e.touches[0].clientX;lastY=e.touches[0].clientY;
    } else if(e.touches.length===2){
      pinchStartDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      pinchStartScale=cropScale;
    }
    e.preventDefault();
  };
  wrap.ontouchmove=e=>{
    if(e.touches.length===1&&touching){
      cropX+=e.touches[0].clientX-lastX;
      cropY+=e.touches[0].clientY-lastY;
      lastX=e.touches[0].clientX;lastY=e.touches[0].clientY;
    } else if(e.touches.length===2){
      const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      cropScale=Math.max(.5,Math.min(5,pinchStartScale*(d/pinchStartDist)));
    }
    updateCropTransform();e.preventDefault();
  };
  wrap.ontouchend=()=>{touching=false;};
}

function saveIconImages(){
  const data={};
  document.querySelectorAll('.app-icon[data-icon-key]').forEach(icon=>{
    const key=icon.dataset.iconKey;
    const imgEl=icon.querySelector('.app-icon-img');
    if(imgEl.style.backgroundImage)data[key]=imgEl.style.backgroundImage;
  });
  LS.setItem('iconImages',JSON.stringify(data));
}

function confirmCrop(){
  const canvas=document.createElement('canvas');
  canvas.width=80;canvas.height=80;
  const ctx=canvas.getContext('2d');
  const img=document.getElementById('cropImg');
  const frameLeft=(260-160)/2,frameTop=(260-160)/2;
  ctx.drawImage(img,(frameLeft-cropX)/cropScale,(frameTop-cropY)/cropScale,160/cropScale,160/cropScale,0,0,80,80);
  const dataUrl=canvas.toDataURL('image/jpeg',0.7);
  if(cropTargetIcon){
    const imgEl=cropTargetIcon.querySelector('.app-icon-img');
    imgEl.style.backgroundImage=`url(${dataUrl})`;
    imgEl.style.backgroundSize='cover';
    imgEl.innerHTML='';
    saveIconImages();
  }
  closeCrop();
}

// 图标自由移动持久化
function saveIconPositions(){
  const data={};
  document.querySelectorAll('.app-icon.free').forEach(icon=>{
    const key=icon.dataset.iconKey;
    const pg=icon.closest('.desktop');
    const pageIdx=pg?parseInt(pg.dataset.page)||0:0;
    if(key)data[key]={left:icon.style.left,top:icon.style.top,locked:icon.classList.contains('icon-locked'),_page:pageIdx};
  });
  LS.setItem('iconPositions',JSON.stringify(data));
}

function moveElToEdgePage(el,direction,saveFn){
  const targetIdx=currentPage+direction;
  if(targetIdx<0||targetIdx>=totalPages)return;
  const targetPage=document.getElementById('desktopPage'+targetIdx);
  if(!targetPage)return;
  // 移到目标页，位置放在对侧边缘
  const page=el.closest('.desktop')||getCurrentDesktopPage();
  const pw=page.offsetWidth;
  if(direction>0)el.style.left='10px';
  else el.style.left=(pw-el.offsetWidth-10)+'px';
  targetPage.appendChild(el);
  goToPage(targetIdx);
  if(saveFn)saveFn();
}

function setupFreeMove(icon){
  let startX,startY,origL,origT,moving=false,moved=false;
  let edgeTimer=null;

  function onStart(cx,cy){
    if(icon.classList.contains('icon-locked'))return;
    startX=cx;startY=cy;
    origL=parseInt(icon.style.left)||0;origT=parseInt(icon.style.top)||0;
    moving=true;moved=false;
  }
  function checkEdge(cx){
    if(totalPages<=1)return;
    const pr=document.querySelector('.phone').getBoundingClientRect();
    const rx=cx-pr.left;
    clearTimeout(edgeTimer);
    if(rx<40&&currentPage>0){
      document.getElementById('edgeLeft').classList.add('show');
      edgeTimer=setTimeout(()=>{document.getElementById('edgeLeft').classList.remove('show');moveElToEdgePage(icon,-1,saveIconPositions);origL=parseInt(icon.style.left)||0;startX=cx;},400);
    } else if(rx>pr.width-40&&currentPage<totalPages-1){
      document.getElementById('edgeRight').classList.add('show');
      edgeTimer=setTimeout(()=>{document.getElementById('edgeRight').classList.remove('show');moveElToEdgePage(icon,1,saveIconPositions);origL=parseInt(icon.style.left)||0;startX=cx;},400);
    } else {
      document.getElementById('edgeLeft').classList.remove('show');
      document.getElementById('edgeRight').classList.remove('show');
    }
  }
  function onMove(cx,cy){
    if(!moving||icon.classList.contains('icon-locked'))return;
    const dx=cx-startX,dy=cy-startY;
    if(Math.abs(dx)>4||Math.abs(dy)>4)moved=true;
    if(!moved)return;
    const page=icon.closest('.desktop')||getCurrentDesktopPage();
    icon.style.left=Math.max(0,Math.min(page.offsetWidth-icon.offsetWidth,origL+dx))+'px';
    icon.style.top=Math.max(0,Math.min(page.offsetHeight-icon.offsetHeight,origT+dy))+'px';
    checkEdge(cx);
  }
  function onEnd(){
    clearTimeout(edgeTimer);
    document.getElementById('edgeLeft')?.classList.remove('show');
    document.getElementById('edgeRight')?.classList.remove('show');
    if(moved)saveIconPositions();
    moving=false;
  }

  icon.addEventListener('touchstart',e=>{
    if(e.target.classList.contains('icon-lock-btn')||e.target.classList.contains('icon-del'))return;
    onStart(e.touches[0].clientX,e.touches[0].clientY);
  },{passive:true});
  icon.addEventListener('touchmove',e=>{onMove(e.touches[0].clientX,e.touches[0].clientY);},{passive:true});
  icon.addEventListener('touchend',e=>{onEnd();},{passive:true});

  icon.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('icon-lock-btn')||e.target.classList.contains('icon-del'))return;
    onStart(e.clientX,e.clientY);
    const onMM=e=>onMove(e.clientX,e.clientY);
    const onMU=()=>{onEnd();document.removeEventListener('mousemove',onMM);document.removeEventListener('mouseup',onMU);};
    document.addEventListener('mousemove',onMM);
    document.addEventListener('mouseup',onMU);
  });
}

function makeIconFree(icon){
  if(icon.classList.contains('free'))return;
  const page=icon.closest('.desktop')||getCurrentDesktopPage();
  const pr=page.getBoundingClientRect();
  const ir=icon.getBoundingClientRect();
  icon.classList.add('free');
  icon.style.left=(ir.left-pr.left)+'px';
  icon.style.top=(ir.top-pr.top)+'px';
  page.appendChild(icon);
  // 添加锁定按钮
  if(!icon.querySelector('.icon-lock-btn')){
    const btn=document.createElement('button');
    btn.className='icon-lock-btn';
    btn.textContent='🔓';
    btn.onclick=e=>{e.stopPropagation();toggleIconLock(icon);};
    icon.appendChild(btn);
  }
  setupFreeMove(icon);
}

function toggleIconLock(icon){
  icon.classList.toggle('icon-locked');
  icon.querySelector('.icon-lock-btn').textContent=icon.classList.contains('icon-locked')?'🔒':'🔓';
  saveIconPositions();
}

// 给现有图标绑定事件
document.querySelectorAll('.app-icon').forEach(icon=>setupIconEvents(icon));

// 点击桌面空白退出编辑 & 隐藏所有小组件控制按钮
document.querySelector('.phone').addEventListener('click',e=>{
  if(!e.target.closest('.app-icon') && !e.target.closest('.panel') && !e.target.closest('.fullpage') && !e.target.closest('.widget-img') && !e.target.closest('.widget-strip') && !e.target.closest('.widget-note') && !e.target.closest('.widget-clock') && !e.target.closest('.widget-banner') && !e.target.closest('.widget-textcard') && !e.target.closest('.music-widget') && !e.target.closest('.page-dots')){
    if(editMode)exitEditMode();
    document.querySelectorAll('.show-ctrl').forEach(el=>el.classList.remove('show-ctrl'));
  }
});

function loadWidgets(){
  try{
    const data=JSON.parse(LS.getItem('widgets')||'[]');
    data.forEach(d=>createWidget(d,true));
  }catch(e){}
}

function restoreIconsAndTheme(){
  loadWidgets();
  loadStripWidgets();
  loadNoteWidgets();
  loadClockWidgets();
  loadBannerWidgets();
  loadTextCardWidgets();
  // 恢复图标自定义图片
  const imgData=JSON.parse(LS.getItem('iconImages')||'{}');
  document.querySelectorAll('.app-icon[data-icon-key]').forEach(icon=>{
    const key=icon.dataset.iconKey;
    if(imgData[key]){
      const imgEl=icon.querySelector('.app-icon-img');
      imgEl.style.backgroundImage=imgData[key];
      imgEl.style.backgroundSize='cover';
      imgEl.innerHTML='';
    }
  });
  // 恢复图标位置
  const posData=JSON.parse(LS.getItem('iconPositions')||'{}');
  document.querySelectorAll('.app-icon').forEach(icon=>{
    const key=icon.dataset.iconKey;
    if(key&&posData[key]){
      const d=posData[key];
      const targetPg=d._page!=null?document.getElementById('desktopPage'+d._page)||getCurrentDesktopPage():icon.closest('.desktop')||getCurrentDesktopPage();
      icon.classList.add('free');
      icon.style.left=d.left;
      icon.style.top=d.top;
      targetPg.appendChild(icon);
      if(!icon.querySelector('.icon-lock-btn')){
        const btn=document.createElement('button');
        btn.className='icon-lock-btn';
        btn.textContent=d.locked?'🔒':'🔓';
        btn.onclick=e=>{e.stopPropagation();toggleIconLock(icon);};
        icon.appendChild(btn);
      }
      if(d.locked)icon.classList.add('icon-locked');
      setupFreeMove(icon);
    }
  });
  // 恢复布局
  layoutCols=parseInt(LS.getItem('layoutCols')||'4');
  applyLayout();
  setLayout(layoutCols);
  // 恢复主题
  const t=LS.getItem('theme');if(t&&themes[t])setTheme(t);
  // 恢复壁纸（从IDB异步加载）
  IDB.get('wallpaper').then(w=>{if(w){document.getElementById('wallpaper').innerHTML=`<img src="${w}"/>`;document.getElementById('wpImg').src=w;document.getElementById('wpPreview').style.display='block';}});
}

// 图片小组件
let widgets=[];

function saveWidgets(){
  const data=[];
  document.querySelectorAll('.widget-img').forEach(w=>{
    const pg=w.closest('.desktop');
    const pageIdx=pg?parseInt(pg.dataset.page)||0:0;
    data.push({src:w.querySelector('img').src,left:w.style.left,top:w.style.top,width:w.style.width,height:w.style.height,locked:w.classList.contains('locked'),_page:pageIdx});
  });
  LS.setItem('widgets',JSON.stringify(data));
}
  
  function addWidget(){document.getElementById('widgetFile').click();}
function onWidgetFile(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const r=new FileReader();
  r.onload=ev=>createWidget({src:ev.target.result,left:'80px',top:'160px',width:'160px',height:'160px',locked:false},false);
  r.readAsDataURL(file);
}
function getCurrentDesktopPage(){
  return document.getElementById('desktopPage'+(currentPage||0))||document.getElementById('desktopPage0');
}
function createWidget(data,skipSave){
  const phone=data._page!=null?document.getElementById('desktopPage'+data._page)||getCurrentDesktopPage():getCurrentDesktopPage();
  const w=document.createElement('div');
  w.className='widget-img'+(data.locked?' locked':'');
  w.style.cssText=`left:${data.left};top:${data.top};width:${data.width||'160px'};height:${data.height||'160px'}`;
  w.innerHTML=`<img src="${data.src}"/><button class="widget-img-lock" onclick="toggleWidgetLock(this)">${data.locked?'🔒':'🔓'}</button><button class="widget-img-del" onclick="removeWidget(this)">×</button><div class="widget-resize"></div>`;
  phone.appendChild(w);
  setupWidgetEvents(w);
  w.addEventListener('click',e=>{
    if(e.target.classList.contains('widget-img-del')||e.target.classList.contains('widget-img-lock'))return;
    document.querySelectorAll('.show-ctrl').forEach(el=>el.classList.remove('show-ctrl'));
    w.classList.add('show-ctrl');
    autoHideCtrl(w);
  });
  w.querySelector('img').addEventListener('click',()=>{
    if(!w.classList.contains('show-ctrl'))return;
    const inp=document.createElement('input');
    inp.type='file';inp.accept='image/*';
    inp.onchange=ev=>{
      const f=ev.target.files[0];if(!f)return;
      const rd=new FileReader();
      rd.onload=e2=>{w.querySelector('img').src=e2.target.result;saveWidgets();};
      rd.readAsDataURL(f);
    };
    inp.click();
  });
  if(!skipSave)saveWidgets();
}
function removeWidget(btn){
  btn.parentNode.remove();
  saveWidgets();
}
function toggleWidgetLock(btn){
  const w=btn.parentNode;
  w.classList.toggle('locked');
  btn.textContent=w.classList.contains('locked')?'🔒':'🔓';
  saveWidgets();
}

// 竖条图片组件
function addStripWidget(){document.getElementById('stripWidgetFile').click();}
function onStripWidgetFile(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const r=new FileReader();
  r.onload=ev=>createStripWidget({src:ev.target.result,left:'90px',top:'150px',locked:false});
  r.readAsDataURL(file);
}
function createStripWidget(data){
  const phone=data._page!=null?document.getElementById('desktopPage'+data._page)||getCurrentDesktopPage():getCurrentDesktopPage();
  const w=document.createElement('div');
  w.className='widget-strip'+(data.locked?' locked':'');
  w.style.cssText=`left:${data.left};top:${data.top}`;
  if(data.src){
    w.innerHTML=`<img src="${data.src}"/><button class="widget-strip-lock" onclick="toggleStripLock(this)">${data.locked?'🔒':'🔓'}</button><button class="widget-strip-del" onclick="removeStripWidget(this)">×</button>`;
  } else {
    w.innerHTML=`<div class="widget-strip-placeholder"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>点击添加</div><button class="widget-strip-lock" onclick="toggleStripLock(this)">${data.locked?'🔒':'🔓'}</button><button class="widget-strip-del" onclick="removeStripWidget(this)">×</button>`;
  }
  phone.appendChild(w);
  setupStripWidgetEvents(w);
  w.addEventListener('click',e=>{
    if(e.target.tagName==='BUTTON')return;
    if(w.classList.contains('show-ctrl')&&!e.target.closest('button')&&e.target.closest('.widget-strip')){
      // 点击图片区域更换图片
      const inp=document.createElement('input');
      inp.type='file';inp.accept='image/*';
      inp.onchange=ev=>{
        const f=ev.target.files[0];if(!f)return;
        const rd=new FileReader();
        rd.onload=e2=>{
          let img=w.querySelector('img');
          if(!img){w.innerHTML=`<img src="${e2.target.result}"/><button class="widget-strip-lock" onclick="toggleStripLock(this)">🔓</button><button class="widget-strip-del" onclick="removeStripWidget(this)">×</button>`;setupStripWidgetEvents(w);}
          else img.src=e2.target.result;
          saveStripWidgets();
        };
        rd.readAsDataURL(f);
      };
      inp.click();
      return;
    }
    document.querySelectorAll('.show-ctrl').forEach(el=>el.classList.remove('show-ctrl'));
    w.classList.add('show-ctrl');
    autoHideCtrl(w);
  });
  saveStripWidgets();
}
function removeStripWidget(btn){btn.parentNode.remove();saveStripWidgets();}
function toggleStripLock(btn){
  const w=btn.parentNode;
  w.classList.toggle('locked');
  btn.textContent=w.classList.contains('locked')?'🔒':'🔓';
  saveStripWidgets();
}
function setupStripWidgetEvents(w){
  let startX,startY,origL,origT,moving=false,moved=false,edgeTimer=null;
  function checkEdge(cx){
    if(totalPages<=1)return;
    const pr=document.querySelector('.phone').getBoundingClientRect();
    const rx=cx-pr.left;
    clearTimeout(edgeTimer);
    if(rx<40&&currentPage>0){
      document.getElementById('edgeLeft').classList.add('show');
      edgeTimer=setTimeout(()=>{document.getElementById('edgeLeft').classList.remove('show');moveElToEdgePage(w,-1,saveStripWidgets);origL=parseInt(w.style.left)||0;startX=cx;},400);
    } else if(rx>pr.width-40&&currentPage<totalPages-1){
      document.getElementById('edgeRight').classList.add('show');
      edgeTimer=setTimeout(()=>{document.getElementById('edgeRight').classList.remove('show');moveElToEdgePage(w,1,saveStripWidgets);origL=parseInt(w.style.left)||0;startX=cx;},400);
    } else {
      document.getElementById('edgeLeft').classList.remove('show');
      document.getElementById('edgeRight').classList.remove('show');
    }
  }
  function onStart(cx,cy){if(w.classList.contains('locked'))return;startX=cx;startY=cy;origL=parseInt(w.style.left)||0;origT=parseInt(w.style.top)||0;moving=true;moved=false;}
  function onMove(cx,cy){
    if(!moving||w.classList.contains('locked'))return;
    const dx=cx-startX,dy=cy-startY;
    if(Math.abs(dx)>4||Math.abs(dy)>4)moved=true;
    if(!moved)return;
    const page=w.closest('.desktop')||getCurrentDesktopPage();
    w.style.left=Math.max(0,Math.min(page.offsetWidth-w.offsetWidth,origL+dx))+'px';
    w.style.top=Math.max(0,Math.min(page.offsetHeight-w.offsetHeight,origT+dy))+'px';
    checkEdge(cx);
  }
  function onEnd(){clearTimeout(edgeTimer);document.getElementById('edgeLeft')?.classList.remove('show');document.getElementById('edgeRight')?.classList.remove('show');if(moved)saveStripWidgets();moving=false;}
  w.addEventListener('touchstart',e=>{if(e.target.tagName==='BUTTON')return;onStart(e.touches[0].clientX,e.touches[0].clientY);},{passive:true});
  w.addEventListener('touchmove',e=>{onMove(e.touches[0].clientX,e.touches[0].clientY);},{passive:true});
  w.addEventListener('touchend',onEnd);
  w.addEventListener('mousedown',e=>{if(e.target.tagName==='BUTTON')return;onStart(e.clientX,e.clientY);const mm=ev=>onMove(ev.clientX,ev.clientY);const mu=()=>{onEnd();document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);};document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu);});
}
function saveStripWidgets(){
  const data=[];
  document.querySelectorAll('.widget-strip').forEach(w=>{
    const img=w.querySelector('img');
    const pg=w.closest('.desktop');
    const pageIdx=pg?parseInt(pg.dataset.page)||0:0;
    data.push({src:img?img.src:'',left:w.style.left,top:w.style.top,locked:w.classList.contains('locked'),_page:pageIdx});
  });
  LS.setItem('stripWidgets',JSON.stringify(data));
}
function loadStripWidgets(){
  try{
    const data=JSON.parse(LS.getItem('stripWidgets')||'[]');
    data.forEach(d=>createStripWidget(d));
  }catch(e){}
}

// 文字便签组件
function addNoteWidget(){
  createNoteWidget({text:'',left:'100px',top:'200px',locked:false});
}
function createNoteWidget(data){
  const phone=data._page!=null?document.getElementById('desktopPage'+data._page)||getCurrentDesktopPage():getCurrentDesktopPage();
  const w=document.createElement('div');
  w.className='widget-note'+(data.locked?' locked':'');
  w.style.cssText=`left:${data.left};top:${data.top}`;
  w.innerHTML=`<div class="widget-note-text" contenteditable="true">${data.text||''}</div><button class="widget-note-lock" onclick="toggleNoteLock(this)">${data.locked?'🔒':'🔓'}</button><button class="widget-note-del" onclick="removeNoteWidget(this)">×</button>`;
  phone.appendChild(w);
  const textEl=w.querySelector('.widget-note-text');
  textEl.addEventListener('blur',()=>saveNoteWidgets());
  textEl.addEventListener('input',()=>saveNoteWidgets());
  setupNoteWidgetEvents(w);
  w.addEventListener('click',e=>{
    if(e.target.tagName==='BUTTON')return;
    document.querySelectorAll('.show-ctrl').forEach(el=>el.classList.remove('show-ctrl'));
    w.classList.add('show-ctrl');
    autoHideCtrl(w);
  });
  saveNoteWidgets();
}
function removeNoteWidget(btn){btn.parentNode.remove();saveNoteWidgets();}
function toggleNoteLock(btn){
  const w=btn.parentNode;
  w.classList.toggle('locked');
  btn.textContent=w.classList.contains('locked')?'🔒':'🔓';
  const textEl=w.querySelector('.widget-note-text');
  textEl.contentEditable=!w.classList.contains('locked');
  saveNoteWidgets();
}
function setupNoteWidgetEvents(w){
  let startX,startY,origL,origT,moving=false,moved=false;
  let ghost=null,edgeTimer=null;
  function onStart(cx,cy){
    if(w.classList.contains('locked'))return;
    startX=cx;startY=cy;
    origL=parseInt(w.style.left)||0;origT=parseInt(w.style.top)||0;
    moving=true;moved=false;
  }
  function onMove(cx,cy){
    if(!moving||w.classList.contains('locked'))return;
    const dx=cx-startX,dy=cy-startY;
    if(Math.abs(dx)>4||Math.abs(dy)>4)moved=true;
    if(!moved)return;
    if(totalPages>1&&!ghost){
      ghost=w.cloneNode(true);ghost.style.cssText='position:absolute;z-index:999;pointer-events:none;opacity:.85;width:'+w.offsetWidth+'px;height:'+w.offsetHeight+'px;filter:drop-shadow(0 8px 20px rgba(0,0,0,.3));transition:none';
      document.querySelector('.phone').appendChild(ghost);w.style.opacity='.2';
    }
    if(ghost){
      const pr=document.querySelector('.phone').getBoundingClientRect();
      ghost.style.left=(cx-pr.left-w.offsetWidth/2)+'px';ghost.style.top=(cy-pr.top-w.offsetHeight/2)+'px';
      const rx=cx-pr.left;clearTimeout(edgeTimer);
      if(rx<40&&currentPage>0){document.getElementById('edgeLeft').classList.add('show');edgeTimer=setTimeout(()=>goToPage(currentPage-1),500);}
      else if(rx>pr.width-40&&currentPage<totalPages-1){document.getElementById('edgeRight').classList.add('show');edgeTimer=setTimeout(()=>goToPage(currentPage+1),500);}
      else{document.getElementById('edgeLeft').classList.remove('show');document.getElementById('edgeRight').classList.remove('show');}
    } else {
      const page=w.closest('.desktop')||document.querySelector('.phone');
      w.style.left=Math.max(0,Math.min(page.offsetWidth-w.offsetWidth,origL+dx))+'px';
      w.style.top=Math.max(0,Math.min(page.offsetHeight-w.offsetHeight,origT+dy))+'px';
    }
  }
  function onEnd(){
    clearTimeout(edgeTimer);document.getElementById('edgeLeft')?.classList.remove('show');document.getElementById('edgeRight')?.classList.remove('show');
    if(ghost){const tp=getCurrentDesktopPage();const pr=tp.getBoundingClientRect();const phoneR=document.querySelector('.phone').getBoundingClientRect();const gx=parseInt(ghost.style.left)||0,gy=parseInt(ghost.style.top)||0;w.style.left=Math.max(0,Math.min(tp.offsetWidth-w.offsetWidth,gx-(pr.left-phoneR.left)))+'px';w.style.top=Math.max(0,Math.min(tp.offsetHeight-w.offsetHeight,gy-(pr.top-phoneR.top)))+'px';if(w.closest('.desktop')!==tp)tp.appendChild(w);ghost.remove();ghost=null;w.style.opacity='';}
    if(moved)saveNoteWidgets();moving=false;
  }
  w.addEventListener('touchstart',e=>{
    if(e.target.tagName==='BUTTON'||e.target.classList.contains('widget-note-text'))return;
    onStart(e.touches[0].clientX,e.touches[0].clientY);
  },{passive:true});
  w.addEventListener('touchmove',e=>{
    if(e.target.classList.contains('widget-note-text'))return;
    onMove(e.touches[0].clientX,e.touches[0].clientY);
  },{passive:true});
  w.addEventListener('touchend',onEnd);
  w.addEventListener('mousedown',e=>{
    if(e.target.tagName==='BUTTON'||e.target.classList.contains('widget-note-text'))return;
    onStart(e.clientX,e.clientY);
    const mm=ev=>onMove(ev.clientX,ev.clientY);
    const mu=()=>{onEnd();document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);};
    document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu);
  });
}
function saveNoteWidgets(){
  const data=[];
  document.querySelectorAll('.widget-note').forEach(w=>{
    const text=w.querySelector('.widget-note-text').innerHTML;
    const pg=w.closest('.desktop');
    const pageIdx=pg?parseInt(pg.dataset.page)||0:0;
    data.push({text,left:w.style.left,top:w.style.top,locked:w.classList.contains('locked'),_page:pageIdx});
  });
  LS.setItem('noteWidgets',JSON.stringify(data));
}
function loadNoteWidgets(){
  try{
    const data=JSON.parse(LS.getItem('noteWidgets')||'[]');
    data.forEach(d=>createNoteWidget(d));
  }catch(e){}
}

// 时钟组件
const CLOCK_STYLES=['minimal','dark','gradient','glass'];
let clockWidgets=[];
let clockTimer=null;

function addClockWidget(){
  createClockWidget({left:'100px',top:'280px',style:'minimal'});
}
function createClockWidget(data){
  const phone=data._page!=null?document.getElementById('desktopPage'+data._page)||getCurrentDesktopPage():getCurrentDesktopPage();
  const w=document.createElement('div');
  w.className='widget-clock style-'+(data.style||'minimal');
  w.dataset.style=data.style||'minimal';
  w.style.cssText=`left:${data.left};top:${data.top}`;
  w.innerHTML=`<div class="widget-clock-time"></div><div class="widget-clock-date"></div><button class="widget-clock-style" onclick="cycleClockStyle(this)" title="切换样式">🎨</button><button class="widget-clock-del" onclick="removeClockWidget(this)">×</button>`;
  phone.appendChild(w);
  clockWidgets.push(w);
  setupClockWidgetEvents(w);
  w.addEventListener('click',e=>{
    if(e.target.tagName==='BUTTON')return;
    document.querySelectorAll('.show-ctrl').forEach(el=>el.classList.remove('show-ctrl'));
    w.classList.add('show-ctrl');
    autoHideCtrl(w);
  });
  updateClockWidgets();
  startClockTimer();
  saveClockWidgets();
}
function removeClockWidget(btn){
  const w=btn.parentNode;
  clockWidgets=clockWidgets.filter(x=>x!==w);
  w.remove();
  saveClockWidgets();
  if(!clockWidgets.length)stopClockTimer();
}
function cycleClockStyle(btn){
  const w=btn.parentNode;
  const cur=w.dataset.style||'minimal';
  const idx=CLOCK_STYLES.indexOf(cur);
  const next=CLOCK_STYLES[(idx+1)%CLOCK_STYLES.length];
  w.dataset.style=next;
  w.className='widget-clock style-'+next+(w.classList.contains('show-ctrl')?' show-ctrl':'');
  saveClockWidgets();
}
function updateClockWidgets(){
  const now=new Date();
  const h=now.getHours().toString().padStart(2,'0');
  const m=now.getMinutes().toString().padStart(2,'0');
  const weekdays=['周日','周一','周二','周三','周四','周五','周六'];
  const dateStr=`${now.getMonth()+1}月${now.getDate()}日 ${weekdays[now.getDay()]}`;
  clockWidgets.forEach(w=>{
    w.querySelector('.widget-clock-time').textContent=h+':'+m;
    w.querySelector('.widget-clock-date').textContent=dateStr;
  });
}
function startClockTimer(){
  if(clockTimer)return;
  clockTimer=setInterval(updateClockWidgets,1000);
}
function stopClockTimer(){
  if(clockTimer){clearInterval(clockTimer);clockTimer=null;}
}
function setupClockWidgetEvents(w){
  let startX,startY,origL,origT,moving=false,moved=false;
  function onStart(cx,cy){startX=cx;startY=cy;origL=parseInt(w.style.left)||0;origT=parseInt(w.style.top)||0;moving=true;moved=false;}
  function onMove(cx,cy){
    if(!moving)return;
    const dx=cx-startX,dy=cy-startY;
    if(Math.abs(dx)>4||Math.abs(dy)>4)moved=true;
    if(!moved)return;
    const phone=document.querySelector('.phone');
    w.style.left=Math.max(0,Math.min(phone.offsetWidth-w.offsetWidth,origL+dx))+'px';
    w.style.top=Math.max(0,Math.min(phone.offsetHeight-w.offsetHeight,origT+dy))+'px';
  }
  function onEnd(){if(moved)saveClockWidgets();moving=false;}
  w.addEventListener('touchstart',e=>{if(e.target.tagName==='BUTTON')return;onStart(e.touches[0].clientX,e.touches[0].clientY);},{passive:true});
  w.addEventListener('touchmove',e=>{onMove(e.touches[0].clientX,e.touches[0].clientY);},{passive:true});
  w.addEventListener('touchend',onEnd);
  w.addEventListener('mousedown',e=>{
    if(e.target.tagName==='BUTTON')return;
    onStart(e.clientX,e.clientY);
    const mm=ev=>onMove(ev.clientX,ev.clientY);
    const mu=()=>{onEnd();document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);};
    document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu);
  });
}
function saveClockWidgets(){
  const data=[];
  document.querySelectorAll('.widget-clock').forEach(w=>{
    const pg=w.closest('.desktop');
    const pageIdx=pg?parseInt(pg.dataset.page)||0:0;
    data.push({left:w.style.left,top:w.style.top,style:w.dataset.style||'minimal',_page:pageIdx});
  });
  LS.setItem('clockWidgets',JSON.stringify(data));
}
function loadClockWidgets(){
  try{
    const data=JSON.parse(LS.getItem('clockWidgets')||'[]');
    data.forEach(d=>createClockWidget(d));
  }catch(e){}
}

// 横幅图片组件
function addBannerWidget(){document.getElementById('bannerWidgetFile').click();}
function onBannerWidgetFile(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const r=new FileReader();
  r.onload=ev=>createBannerWidget({src:ev.target.result,left:'60px',top:'320px',width:'200px',height:'70px',locked:false});
  r.readAsDataURL(file);
}
function createBannerWidget(data){
  const phone=data._page!=null?document.getElementById('desktopPage'+data._page)||getCurrentDesktopPage():getCurrentDesktopPage();
  const w=document.createElement('div');
  w.className='widget-banner'+(data.locked?' locked':'');
  w.style.cssText=`left:${data.left};top:${data.top};width:${data.width||'200px'};height:${data.height||'70px'}`;
  if(data.src){
    w.innerHTML=`<img src="${data.src}"/><button class="widget-banner-lock" onclick="toggleBannerLock(this)">${data.locked?'🔒':'🔓'}</button><button class="widget-banner-del" onclick="removeBannerWidget(this)">×</button><div class="widget-banner-resize"></div>`;
  } else {
    w.innerHTML=`<div class="widget-banner-placeholder"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>点击添加横图</div><button class="widget-banner-lock" onclick="toggleBannerLock(this)">${data.locked?'🔒':'🔓'}</button><button class="widget-banner-del" onclick="removeBannerWidget(this)">×</button><div class="widget-banner-resize"></div>`;
  }
  phone.appendChild(w);
  setupBannerWidgetEvents(w);
  w.addEventListener('click',e=>{
    if(e.target.tagName==='BUTTON'||e.target.classList.contains('widget-banner-resize'))return;
    if(w.classList.contains('show-ctrl')&&!e.target.closest('button')){
      const inp=document.createElement('input');
      inp.type='file';inp.accept='image/*';
      inp.onchange=ev=>{
        const f=ev.target.files[0];if(!f)return;
        const rd=new FileReader();
        rd.onload=e2=>{
          let img=w.querySelector('img');
          if(!img){w.innerHTML=`<img src="${e2.target.result}"/><button class="widget-banner-lock" onclick="toggleBannerLock(this)">🔓</button><button class="widget-banner-del" onclick="removeBannerWidget(this)">×</button><div class="widget-banner-resize"></div>`;setupBannerWidgetEvents(w);}
          else img.src=e2.target.result;
          saveBannerWidgets();
        };
        rd.readAsDataURL(f);
      };
      inp.click();
      return;
    }
    document.querySelectorAll('.show-ctrl').forEach(el=>el.classList.remove('show-ctrl'));
    w.classList.add('show-ctrl');
    autoHideCtrl(w);
  });
  saveBannerWidgets();
}
function removeBannerWidget(btn){btn.parentNode.remove();saveBannerWidgets();}
function toggleBannerLock(btn){
  const w=btn.parentNode;
  w.classList.toggle('locked');
  btn.textContent=w.classList.contains('locked')?'🔒':'🔓';
  saveBannerWidgets();
}
function setupBannerWidgetEvents(w){
  let mode=null,startX,startY,origL,origT,origW,origH,moved=false;
  let ghost=null,edgeTimer=null;
  const resize=w.querySelector('.widget-banner-resize');
  function onStart(cx,cy,isResize){
    if(w.classList.contains('locked'))return;
    mode=isResize?'resize':'move';
    startX=cx;startY=cy;
    origL=parseInt(w.style.left)||0;origT=parseInt(w.style.top)||0;
    origW=w.offsetWidth;origH=w.offsetHeight;moved=false;
  }
  function onMove(cx,cy){
    if(!mode||w.classList.contains('locked'))return;
    const dx=cx-startX,dy=cy-startY;
    if(Math.abs(dx)>4||Math.abs(dy)>4)moved=true;
    if(mode==='resize'){w.style.width=Math.max(100,origW+dx)+'px';w.style.height=Math.max(40,origH+dy)+'px';return;}
    if(totalPages>1&&moved&&!ghost){
      ghost=w.cloneNode(true);ghost.style.cssText='position:absolute;z-index:999;pointer-events:none;opacity:.85;width:'+w.offsetWidth+'px;height:'+w.offsetHeight+'px;border-radius:14px;filter:drop-shadow(0 8px 20px rgba(0,0,0,.3));transition:none';
      document.querySelector('.phone').appendChild(ghost);w.style.opacity='.2';
    }
    if(ghost){
      const pr=document.querySelector('.phone').getBoundingClientRect();
      ghost.style.left=(cx-pr.left-w.offsetWidth/2)+'px';ghost.style.top=(cy-pr.top-w.offsetHeight/2)+'px';
      const rx=cx-pr.left;clearTimeout(edgeTimer);
      if(rx<40&&currentPage>0){document.getElementById('edgeLeft').classList.add('show');edgeTimer=setTimeout(()=>goToPage(currentPage-1),500);}
      else if(rx>pr.width-40&&currentPage<totalPages-1){document.getElementById('edgeRight').classList.add('show');edgeTimer=setTimeout(()=>goToPage(currentPage+1),500);}
      else{document.getElementById('edgeLeft').classList.remove('show');document.getElementById('edgeRight').classList.remove('show');}
    } else {
      const phone=document.querySelector('.phone');
      w.style.left=Math.max(0,Math.min(phone.offsetWidth-w.offsetWidth,origL+dx))+'px';
      w.style.top=Math.max(0,Math.min(phone.offsetHeight-w.offsetHeight,origT+dy))+'px';
    }
  }
  function onEnd(){
    clearTimeout(edgeTimer);document.getElementById('edgeLeft')?.classList.remove('show');document.getElementById('edgeRight')?.classList.remove('show');
    if(ghost){const tp=getCurrentDesktopPage();const pr=tp.getBoundingClientRect();const phoneR=document.querySelector('.phone').getBoundingClientRect();const gx=parseInt(ghost.style.left)||0,gy=parseInt(ghost.style.top)||0;w.style.left=Math.max(0,Math.min(tp.offsetWidth-w.offsetWidth,gx-(pr.left-phoneR.left)))+'px';w.style.top=Math.max(0,Math.min(tp.offsetHeight-w.offsetHeight,gy-(pr.top-phoneR.top)))+'px';if(w.closest('.desktop')!==tp)tp.appendChild(w);ghost.remove();ghost=null;w.style.opacity='';}
    if(mode)saveBannerWidgets();mode=null;
  }
  w.addEventListener('touchstart',e=>{
    if(e.target.tagName==='BUTTON')return;
    onStart(e.touches[0].clientX,e.touches[0].clientY,e.target===resize||e.target.closest('.widget-banner-resize'));
  },{passive:true});
  w.addEventListener('touchmove',e=>{onMove(e.touches[0].clientX,e.touches[0].clientY);},{passive:true});
  w.addEventListener('touchend',onEnd);
  w.addEventListener('mousedown',e=>{
    if(e.target.tagName==='BUTTON')return;
    onStart(e.clientX,e.clientY,e.target===resize||e.target.closest('.widget-banner-resize'));
    const mm=ev=>onMove(ev.clientX,ev.clientY);
    const mu=()=>{onEnd();document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);};
    document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu);
  });
}
function saveBannerWidgets(){
  const data=[];
  document.querySelectorAll('.widget-banner').forEach(w=>{
    const img=w.querySelector('img');
    const pg=w.closest('.desktop');
    const pageIdx=pg?parseInt(pg.dataset.page)||0:0;
    data.push({src:img?img.src:'',left:w.style.left,top:w.style.top,width:w.style.width,height:w.style.height,locked:w.classList.contains('locked'),_page:pageIdx});
  });
  LS.setItem('bannerWidgets',JSON.stringify(data));
}
function loadBannerWidgets(){
  try{
    const data=JSON.parse(LS.getItem('bannerWidgets')||'[]');
    data.forEach(d=>createBannerWidget(d));
  }catch(e){}
}

// 文案卡片组件
const TEXTCARD_STYLES=['light','dark','warm','cool'];
function addTextCardWidget(){
  createTextCardWidget({title:'',content:'',left:'80px',top:'380px',style:'light'});
}
function createTextCardWidget(data){
  const phone=data._page!=null?document.getElementById('desktopPage'+data._page)||getCurrentDesktopPage():getCurrentDesktopPage();
  const w=document.createElement('div');
  w.className='widget-textcard style-'+(data.style||'light');
  w.dataset.style=data.style||'light';
  w.style.cssText=`left:${data.left};top:${data.top}`;
  w.innerHTML=`
    <div class="widget-textcard-header">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="9" r="1"/><circle cx="9" cy="15" r="1"/><circle cx="15" cy="9" r="1"/><circle cx="15" cy="15" r="1"/></svg>
      <div class="widget-textcard-title" contenteditable="true">${data.title||''}</div>
    </div>
    <div class="widget-textcard-body">
      <div class="widget-textcard-content" contenteditable="true">${data.content||''}</div>
    </div>
    <button class="widget-textcard-del" onclick="removeTextCardWidget(this)">×</button>
    <button class="widget-textcard-style" onclick="cycleTextCardStyle(this)">🎨</button>`;
  phone.appendChild(w);
  // 保存文字变化
  w.querySelector('.widget-textcard-title').addEventListener('input',saveTextCardWidgets);
  w.querySelector('.widget-textcard-content').addEventListener('input',saveTextCardWidgets);
  setupTextCardWidgetEvents(w);
  w.addEventListener('click',e=>{
    if(e.target.tagName==='BUTTON')return;
    document.querySelectorAll('.show-ctrl').forEach(el=>el.classList.remove('show-ctrl'));
    w.classList.add('show-ctrl');
    autoHideCtrl(w);
  });
  saveTextCardWidgets();
}
function removeTextCardWidget(btn){btn.closest('.widget-textcard').remove();saveTextCardWidgets();}
function cycleTextCardStyle(btn){
  const w=btn.closest('.widget-textcard');
  const cur=w.dataset.style||'light';
  const idx=TEXTCARD_STYLES.indexOf(cur);
  const next=TEXTCARD_STYLES[(idx+1)%TEXTCARD_STYLES.length];
  w.dataset.style=next;
  w.className='widget-textcard style-'+next+(w.classList.contains('show-ctrl')?' show-ctrl':'');
  saveTextCardWidgets();
}
function setupTextCardWidgetEvents(w){
  const header=w.querySelector('.widget-textcard-header');
  let startX,startY,origL,origT,moving=false,moved=false;
  function onStart(cx,cy){
    startX=cx;startY=cy;
    origL=parseInt(w.style.left)||0;origT=parseInt(w.style.top)||0;
    moving=true;moved=false;
  }
  function onMove(cx,cy){
    if(!moving)return;
    const dx=cx-startX,dy=cy-startY;
    if(Math.abs(dx)>4||Math.abs(dy)>4)moved=true;
    if(!moved)return;
    const phone=document.querySelector('.phone');
    w.style.left=Math.max(0,Math.min(phone.offsetWidth-w.offsetWidth,origL+dx))+'px';
    w.style.top=Math.max(0,Math.min(phone.offsetHeight-w.offsetHeight,origT+dy))+'px';
  }
  function onEnd(){if(moved)saveTextCardWidgets();moving=false;}
  // 只在header上拖动
  header.addEventListener('touchstart',e=>{
    if(e.target.classList.contains('widget-textcard-title'))return;
    onStart(e.touches[0].clientX,e.touches[0].clientY);
  },{passive:true});
  header.addEventListener('touchmove',e=>{
    if(e.target.classList.contains('widget-textcard-title'))return;
    onMove(e.touches[0].clientX,e.touches[0].clientY);
  },{passive:true});
  header.addEventListener('touchend',onEnd);
  header.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('widget-textcard-title'))return;
    onStart(e.clientX,e.clientY);
    const mm=ev=>onMove(ev.clientX,ev.clientY);
    const mu=()=>{onEnd();document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);};
    document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu);
  });
}
function saveTextCardWidgets(){
  const data=[];
  document.querySelectorAll('.widget-textcard').forEach(w=>{
    const pg=w.closest('.desktop');
    const pageIdx=pg?parseInt(pg.dataset.page)||0:0;
    data.push({
      title:w.querySelector('.widget-textcard-title').innerHTML,
      content:w.querySelector('.widget-textcard-content').innerHTML,
      left:w.style.left,
      top:w.style.top,
      style:w.dataset.style||'light',
      _page:pageIdx
    });
  });
  LS.setItem('textCardWidgets',JSON.stringify(data));
}
function loadTextCardWidgets(){
  try{
    const data=JSON.parse(LS.getItem('textCardWidgets')||'[]');
    data.forEach(d=>createTextCardWidget(d));
  }catch(e){}
}

function setupWidgetPageDrag(w,saveFn){
  let ghost=null,edgeTimer=null,startX,startY,moved=false,dragging=false;
  function onLongPress(cx,cy){
    if(totalPages<=1||w.classList.contains('locked'))return;
    dragging=true;moved=false;startX=cx;startY=cy;
    ghost=w.cloneNode(true);
    ghost.style.cssText='position:absolute;z-index:999;pointer-events:none;opacity:.85;width:'+w.offsetWidth+'px;height:'+w.offsetHeight+'px;border-radius:16px;filter:drop-shadow(0 8px 20px rgba(0,0,0,.3));transition:none';
    const pr=document.querySelector('.phone').getBoundingClientRect();
    ghost.style.left=(cx-pr.left-w.offsetWidth/2)+'px';
    ghost.style.top=(cy-pr.top-w.offsetHeight/2)+'px';
    document.querySelector('.phone').appendChild(ghost);
    w.style.opacity='.2';
  }
  function onGhostMove(cx,cy){
    if(!ghost)return;
    const pr=document.querySelector('.phone').getBoundingClientRect();
    ghost.style.left=(cx-pr.left-w.offsetWidth/2)+'px';
    ghost.style.top=(cy-pr.top-w.offsetHeight/2)+'px';
    const rx=cx-pr.left;
    clearTimeout(edgeTimer);
    if(rx<40&&currentPage>0){document.getElementById('edgeLeft').classList.add('show');edgeTimer=setTimeout(()=>goToPage(currentPage-1),500);}
    else if(rx>pr.width-40&&currentPage<totalPages-1){document.getElementById('edgeRight').classList.add('show');edgeTimer=setTimeout(()=>goToPage(currentPage+1),500);}
    else{document.getElementById('edgeLeft').classList.remove('show');document.getElementById('edgeRight').classList.remove('show');}
  }
  function onGhostEnd(){
    clearTimeout(edgeTimer);
    document.getElementById('edgeLeft')?.classList.remove('show');
    document.getElementById('edgeRight')?.classList.remove('show');
    if(ghost){
      const tp=getCurrentDesktopPage();
      const pr=tp.getBoundingClientRect();
      const phoneR=document.querySelector('.phone').getBoundingClientRect();
      const gx=parseInt(ghost.style.left)||0,gy=parseInt(ghost.style.top)||0;
      w.style.left=Math.max(0,Math.min(tp.offsetWidth-w.offsetWidth,gx-(pr.left-phoneR.left)))+'px';
      w.style.top=Math.max(0,Math.min(tp.offsetHeight-w.offsetHeight,gy-(pr.top-phoneR.top)))+'px';
      if(w.closest('.desktop')!==tp)tp.appendChild(w);
      ghost.remove();ghost=null;w.style.opacity='';
      if(saveFn)saveFn();
    }
    dragging=false;
  }
  // 返回接口供各小组件的拖动逻辑调用
  return {onLongPress,onGhostMove,onGhostEnd,isDragging:()=>dragging};
}

function setupWidgetEvents(w){
  let mode=null,startX,startY,origL,origT,origW,origH,moved=false;
  let edgeTimer=null;
  const resize=w.querySelector('.widget-resize');
  function checkEdge(cx,saveFn){
    if(totalPages<=1)return;
    const pr=document.querySelector('.phone').getBoundingClientRect();
    const rx=cx-pr.left;
    clearTimeout(edgeTimer);
    if(rx<40&&currentPage>0){
      document.getElementById('edgeLeft').classList.add('show');
      edgeTimer=setTimeout(()=>{document.getElementById('edgeLeft').classList.remove('show');moveElToEdgePage(w,-1,saveFn);origL=parseInt(w.style.left)||0;startX=cx;},400);
    } else if(rx>pr.width-40&&currentPage<totalPages-1){
      document.getElementById('edgeRight').classList.add('show');
      edgeTimer=setTimeout(()=>{document.getElementById('edgeRight').classList.remove('show');moveElToEdgePage(w,1,saveFn);origL=parseInt(w.style.left)||0;startX=cx;},400);
    } else {
      document.getElementById('edgeLeft').classList.remove('show');
      document.getElementById('edgeRight').classList.remove('show');
    }
  }
  w.addEventListener('touchstart',e=>{
    if(w.classList.contains('locked'))return;
    if(e.target===resize||e.target.closest('.widget-resize')){mode='resize';}
    else if(e.target.classList.contains('widget-img-del')||e.target.classList.contains('widget-img-lock')){return;}
    else{mode='move';}
    const t=e.touches[0];
    startX=t.clientX;startY=t.clientY;
    origL=parseInt(w.style.left)||0;origT=parseInt(w.style.top)||0;
    origW=w.offsetWidth;origH=w.offsetHeight;moved=false;
    e.stopPropagation();
  },{passive:true});
  w.addEventListener('touchmove',e=>{
    if(!mode)return;
    const t=e.touches[0];
    const dx=t.clientX-startX,dy=t.clientY-startY;
    if(Math.abs(dx)>4||Math.abs(dy)>4)moved=true;
    if(mode==='resize'){w.style.width=Math.max(80,origW+dx)+'px';w.style.height=Math.max(80,origH+dy)+'px';e.stopPropagation();return;}
    w.style.left=(origL+dx)+'px';w.style.top=(origT+dy)+'px';
    checkEdge(t.clientX,saveWidgets);
    e.stopPropagation();
  },{passive:true});
  w.addEventListener('touchend',()=>{
    clearTimeout(edgeTimer);
    document.getElementById('edgeLeft')?.classList.remove('show');
    document.getElementById('edgeRight')?.classList.remove('show');
    if(mode)saveWidgets();mode=null;
  });
}
// 点击桌面其他地方隐藏控制按钮
document.querySelector('.phone').addEventListener('click',e=>{
  if(!e.target.closest('.widget-img'))
    document.querySelectorAll('.widget-img').forEach(el=>el.classList.remove('show-ctrl'));
});

let bookShelf=[];

// 消息提示音
function playMsgSound(){
  playMsgSoundByKey(currentSoundKey);
}

// 聊天APP
function openChat(){document.getElementById('pageChat').classList.add('open');}
function closeChat(){document.getElementById('pageChat').classList.remove('open');}

// 联系人
let contacts=[];
let contactAvatarData='';
let contactGender='male';

function openAddContact(){
  contactAvatarData='';contactGender='male';
  document.getElementById('cName').value='';
  document.getElementById('cPersona').value='';
  document.getElementById('contactAvatarPreview').innerHTML='<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
  setContactGender('male');
  const sel=document.getElementById('cMePreset');
  sel.innerHTML='<option value="">（不绑定）</option>'+mePresets.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('');
  document.getElementById('panelContact').classList.add('open');
}
function closeAddContact(){document.getElementById('panelContact').classList.remove('open');}
function setContactGender(g){
  contactGender=g;
  document.getElementById('cG-male')?.classList.toggle('active',g==='male');
  document.getElementById('cG-female')?.classList.toggle('active',g==='female');
}
function onContactAvatarFile(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const r=new FileReader();
  r.onload=ev=>{
    compressAvatar(ev.target.result,200,compressed=>{
      contactAvatarData=compressed;
      document.getElementById('contactAvatarPreview').innerHTML=`<img src="${compressed}" style="width:100%;height:100%;object-fit:cover"/>`;
    });
  };
  r.readAsDataURL(file);
}
// 我的多人设
let mePresets=[];
let activeMePreset=0;
let meGender='male';

function openMePresetPage(){document.getElementById('pageMePreset').classList.add('open');}
function closeMePresetPage(){document.getElementById('pageMePreset').classList.remove('open');}

function renderMePresets(){
  const el=document.getElementById('mePresetList');
  el.innerHTML='';
  if(!mePresets.length){
    el.innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;padding:40px 0;gap:10px">
      <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="1.2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <p style="font-size:13px;color:var(--text2)">还没有人设，点右上角新增</p>
    </div>`;
  }
  mePresets.forEach((p,i)=>{
    const d=document.createElement('div');
    d.className='me-preset-item'+(i===activeMePreset?' active':'');
    const meAvUrl=p.avatar?getAvatarURL('me_'+i,p.avatar):'';
    const avatarInner=meAvUrl?`<img src="${meAvUrl}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
    const desc=p.persona?p.persona.slice(0,40)+(p.persona.length>40?'...':''):(p.gender==='female'?'女生':'男生');
    d.innerHTML=`
      <div class="me-preset-avatar">${avatarInner}</div>
      <div class="me-preset-info">
        <span>${p.name||'人设'+(i+1)}</span>
        <small>${desc}</small>
      </div>
      <button style="background:var(--card2);border:none;cursor:pointer;color:var(--text2);width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s" onclick="delMePreset(event,${i})" onmousedown="this.style.background='#FF3B30';this.style.color='#fff'" onmouseleave="this.style.background='var(--card2)';this.style.color='var(--text2)'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>`;
    d.onclick=()=>loadMePreset(i);
    el.appendChild(d);
  });
  document.getElementById('meEditBox').style.display=mePresets.length?'flex':'none';
  // 更新"我"页面的副标题
  const sub=document.getElementById('mePresetSub');
  if(sub){
    const active=mePresets[activeMePreset];
    sub.textContent=active?`当前：${active.name} · 共${mePresets.length}个`:`共${mePresets.length}个人设`;
  }
  updateMeProfileCard();
}

function updateMeProfileCard(){
  const p=mePresets[activeMePreset];
  const av=document.getElementById('meProfileAvatar');
  const name=document.getElementById('meProfileName');
  const desc=document.getElementById('meProfileDesc');
  
  // 更新统计
  document.getElementById('meStatPresets').textContent=mePresets.length;
  document.getElementById('meStatContacts').textContent=contacts.length;
  document.getElementById('meStatMoments').textContent=getMoments().length;
  
  const badge=`<div class="me-hero-avatar-badge"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/></svg></div>`;
  if(p){
    const pAvUrl=p.avatar?getAvatarURL('me_'+activeMePreset,p.avatar):'';
    av.innerHTML=(pAvUrl?`<img src="${pAvUrl}"/>`:`<svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`);
    name.textContent=p.name||'未命名人设';
    desc.textContent=p.persona||'暂无人设描述';
  } else {
    av.innerHTML=`<svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
    name.textContent='未设置人设';
    desc.textContent='点击下方人设卡片进行编辑';
  }
}
function loadMePreset(i){
  activeMePreset=i;
  const p=mePresets[i]||{};
  document.getElementById('meName').value=p.name||'';
  meGender=p.gender||'male';
  setMeGender(meGender);
  document.getElementById('mePersona').value=p.persona||'';
  renderMePresets();
}
function addMePreset(){
  mePresets.push({name:'人设'+(mePresets.length+1),gender:'male',persona:'',avatar:''});
  saveMePresetsToStorage();
  loadMePreset(mePresets.length-1);
}
function delMePreset(e,i){
  e.stopPropagation();
  IDB.del('meAvatar_'+i);
  mePresets.splice(i,1);
  activeMePreset=Math.max(0,Math.min(activeMePreset,mePresets.length-1));
  saveMePresetsToStorage();
  if(mePresets.length)loadMePreset(activeMePreset);
  else renderMePresets();
}
function setMeHeroBg(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  e.stopPropagation();
  const r=new FileReader();
  r.onload=ev=>{
    IDB.set('meHeroBg',ev.target.result);
    applyMeHeroBg(ev.target.result);
  };
  r.readAsDataURL(file);
}
function applyMeHeroBg(src){
  const bg=document.getElementById('meHeroBg');
  if(src){
    bg.innerHTML=`<img src="${src}"/>`;
    bg.style.background='none';
  } else {
    bg.innerHTML='';
    bg.style.background='';
  }
}
function onMeAvatarFile(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const r=new FileReader();
  r.onload=ev=>{
    compressAvatar(ev.target.result,200,compressed=>{
      if(mePresets[activeMePreset])mePresets[activeMePreset].avatar=compressed;
      clearAvatarCache('me_'+activeMePreset);
      saveMePresetsToStorage();
      renderMePresets();
    });
  };
  r.readAsDataURL(file);
}
function setMeGender(g){
  meGender=g;
  document.getElementById('meG-male')?.classList.toggle('active',g==='male');
  document.getElementById('meG-female')?.classList.toggle('active',g==='female');
}

function saveMePresetsToStorage(){
  const lite=mePresets.map(p=>{const o={...p};delete o.avatar;return o;});
  LS.setItem('mePresets',JSON.stringify(lite));
  mePresets.forEach((p,i)=>{if(p.avatar)IDB.set('meAvatar_'+i,p.avatar);else IDB.del('meAvatar_'+i);});
}
function saveMe(){
  if(!mePresets.length){showToast('请先新增人设');return;}
  mePresets[activeMePreset]={...mePresets[activeMePreset],name:document.getElementById('meName').value.trim(),gender:meGender,persona:document.getElementById('mePersona').value.trim()};
  saveMePresetsToStorage();
  renderMePresets();
  showToast('已保存 ✓');
}

function saveContactsToStorage(){
  const lite=contacts.map(c=>{const o={...c};delete o.avatar;return o;});
  LS.setItem('contacts',JSON.stringify(lite));
  contacts.forEach(c=>{if(c.avatar)IDB.set('cAvatar_'+c.id,c.avatar);else IDB.del('cAvatar_'+c.id);});
}

// 头像ObjectURL缓存，避免每次渲染都内联base64
const avatarURLCache={};
function getAvatarURL(key,base64){
  if(!base64)return '';
  if(avatarURLCache[key])return avatarURLCache[key];
  // 将base64转blob再生成ObjectURL
  try{
    const byteStr=atob(base64.split(',')[1]);
    const mime=base64.match(/data:(.*?);/)?.[1]||'image/jpeg';
    const ab=new ArrayBuffer(byteStr.length);
    const ia=new Uint8Array(ab);
    for(let i=0;i<byteStr.length;i++)ia[i]=byteStr.charCodeAt(i);
    const blob=new Blob([ab],{type:mime});
    avatarURLCache[key]=URL.createObjectURL(blob);
  }catch(e){avatarURLCache[key]=base64;}
  return avatarURLCache[key];
}
function clearAvatarCache(key){
  if(avatarURLCache[key]){try{URL.revokeObjectURL(avatarURLCache[key]);}catch(e){}delete avatarURLCache[key];}
}
// 压缩头像图片
function compressAvatar(dataUrl,maxSize,cb){
  const img=new Image();
  img.onload=()=>{
    let w=img.width,h=img.height;
    if(w>maxSize||h>maxSize){const s=maxSize/Math.max(w,h);w=Math.round(w*s);h=Math.round(h*s);}
    const c=document.createElement('canvas');c.width=w;c.height=h;
    c.getContext('2d').drawImage(img,0,0,w,h);
    cb(c.toDataURL('image/jpeg',.75));
  };
  img.src=dataUrl;
}

function saveContact(){
  const name=document.getElementById('cName').value.trim();
  if(!name){showToast('请输入角色名字');return;}
  const sel=document.getElementById('cMePreset').value;
  const c={id:Date.now(),name,gender:contactGender,persona:document.getElementById('cPersona').value.trim(),avatar:contactAvatarData,mePresetIndex:sel===''?null:parseInt(sel)};
  contacts.push(c);
  saveContactsToStorage();
  renderContacts();
  renderMsgList();
  closeAddContact();
  showToast('联系人已添加 ✓');
}
function renderContacts(){
  const list=document.getElementById('contactList');
  const empty=document.getElementById('contactEmpty');
  list.innerHTML='';
  empty.style.display=(contacts.length||groups.length)?'none':'flex';
  // 群聊列表
  groups.forEach(g=>{
    if(!g||!g.id)return;
    const d=document.createElement('div');
    d.style.cssText='display:flex;align-items:center;gap:12px;padding:12px 4px;border-bottom:1px solid rgba(0,0,0,.05);cursor:pointer';
    d.onclick=()=>openGroupConv(g);
    const memberNames=contacts.filter(c=>c&&g.members&&g.members.includes(c.id)).map(c=>c.name).join('、');
    d.innerHTML=`${buildGroupAvatar(g)}
      <div style="flex:1;min-width:0">
        <div style="font-size:15px;font-weight:600;color:var(--text)">${g.name}</div>
        <div style="font-size:12px;color:var(--text2);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${g.members.length}人 · ${memberNames}</div>
      </div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polyline points="9 18 15 12 9 6"/></svg>`;
    list.appendChild(d);
  });
  contacts.forEach(c=>{
    const d=document.createElement('div');
    d.style.cssText='display:flex;align-items:center;gap:12px;padding:12px 4px;border-bottom:1px solid rgba(0,0,0,.05);cursor:pointer';
    d.onclick=()=>openConversation(c);
    const avUrl=c.avatar?getAvatarURL('c_'+c.id,c.avatar):'';
    d.innerHTML=`
      <div style="width:46px;height:46px;border-radius:50%;background:var(--accent2);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center">
        ${avUrl?`<img src="${avUrl}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`}
      </div>
      <div style="flex:1">
        <div style="font-size:15px;font-weight:600;color:var(--text)">${c.name}</div>
        <div style="font-size:12px;color:var(--text2);margin-top:2px">${c.gender==='male'?'男':'女'}</div>
      </div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.8"><polyline points="9 18 15 12 9 6"/></svg>`;
    list.appendChild(d);
  });
}

const chatTitles={msg:'消息',contacts:'联系人',moments:'朋友圈',me:'我'};
function switchChatTab(tab){
  ['msg','contacts','moments','me'].forEach(t=>{
    const el=document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1));
    if(el)el.style.display=t===tab?'flex':'none';
    document.getElementById('ctab-'+t).classList.toggle('active',t===tab);
  });
  document.getElementById('chatTitle').textContent=chatTitles[tab];
  document.getElementById('addContactBtn').style.display=tab==='contacts'?'':'none';
  document.getElementById('addGroupBtn').style.display=tab==='contacts'?'':'none';
  if(tab==='moments')renderMoments();
}


// 对话
let currentContact=null;
let conversations={};

function renderMsgList(){
  const box=document.getElementById('tabMsg');
  if(!box)return;
  // 私聊条目
  const chatEntries=contacts.filter(c=>c&&c.id&&conversations[c.id]?.length).map(c=>{
    const msgs=conversations[c.id];
    const last=msgs[msgs.length-1];
    const preview=(last.content||'[图片]').slice(0,20)+(last.content?.length>20?'...':'');
    const ts=last.time||'';
    const avUrl=c.avatar?getAvatarURL('c_'+c.id,c.avatar):'';
    const avatarHtml=`<div style="width:46px;height:46px;border-radius:50%;background:var(--accent2);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center">${avUrl?`<img src="${avUrl}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`}</div>`;
    return {type:'chat',id:c.id,name:c.name,preview,ts,avatarHtml,onclick:`openConversation(contacts.find(x=>x.id==${c.id}))`};
  });
  // 群聊条目
  const groupEntries=groups.filter(g=>g&&g.id&&groupConversations[g.id]?.length).map(g=>{
    const msgs=groupConversations[g.id];
    const last=msgs[msgs.length-1];
    const who=last.role==='user'?'我':last.authorName||'';
    const preview=(who?who+'：':'')+(last.content||'[图片]').slice(0,18);
    const ts=last.time||'';
    return {type:'group',id:g.id,name:g.name,preview,ts,avatarHtml:buildGroupAvatar(g),onclick:`openGroupConv(groups.find(x=>x.id==${g.id}))`};
  });
  const all=[...chatEntries,...groupEntries];
  if(!all.length){box.innerHTML='<p style="color:var(--text2);font-size:14px;text-align:center;padding:60px 0">暂无对话</p>';return;}
  box.innerHTML=all.map(e=>`<div onclick="${e.onclick}" style="display:flex;align-items:center;gap:12px;padding:12px 4px;border-bottom:1px solid rgba(0,0,0,.05);cursor:pointer">
    ${e.avatarHtml}
    <div style="flex:1;min-width:0">
      <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-size:15px;font-weight:600;color:var(--text)">${e.name}</div><span style="font-size:10px;color:var(--text2)">${e.ts}</span></div>
      <div style="font-size:12px;color:var(--text2);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.preview}</div>
    </div>
  </div>`).join('');
}

function loadMoreMsgs(){
  const box=document.getElementById('convMessages');
  const prevH=box.scrollHeight;
  msgDisplayCount+=20;
  renderMessages();
  box.scrollTop=box.scrollHeight-prevH;
}

function openConversation(c){
  if(!c)return;
  currentGroup=null;
  msgDisplayCount=20;
  currentContact=c;
  document.getElementById('convTitle').textContent=c.name;
  const avEl=document.getElementById('convHeaderAvatar');
  const subEl=document.getElementById('convSubTitle');
  if(c.avatar){
    avEl.innerHTML=`<img src="${getAvatarURL('c_'+c.id,c.avatar)}" style="width:100%;height:100%;object-fit:cover"/>`;
    avEl.style.display='block';
  }else{
    avEl.style.display='none';
  }
  if(c.persona){
    subEl.textContent=c.persona;
    subEl.style.display='block';
  }else{
    subEl.style.display='none';
  }
  const box=document.getElementById('convMessages');
  box.style.backgroundImage='';
  if(c)IDB.get('convBg_'+c.id).then(bg=>{if(bg){box.style.backgroundImage=`url(${bg})`;box.style.backgroundSize='cover';box.style.backgroundPosition='center';}});
  // 恢复时间戳开关
  showTimestamp=LS.getItem('showTimestamp_'+c.id)==='1';
  document.getElementById('timeToggle').style.background=showTimestamp?'var(--accent)':'var(--accent2)';
  document.getElementById('timeToggleKnob').style.left=showTimestamp?'21px':'3px';
  momentsMemoryOn=LS.getItem('momentsMemory_'+c.id)==='1';
  document.getElementById('momentsMemoryToggle').style.background=momentsMemoryOn?'var(--accent)':'var(--accent2)';
  document.getElementById('momentsMemoryKnob').style.left=momentsMemoryOn?'21px':'3px';
  const memCount=LS.getItem('momentsMemoryCount_'+c.id)||'10';
  document.getElementById('momentsMemoryRange').value=memCount;
  document.getElementById('momentsMemoryVal').textContent=memCount;
  document.getElementById('momentsMemorySliderRow').style.display=momentsMemoryOn?'block':'none';
  groupChatMemOn=LS.getItem('groupChatMem_'+c.id)==='1';
  document.getElementById('groupChatMemToggle').style.background=groupChatMemOn?'var(--accent)':'var(--accent2)';
  document.getElementById('groupChatMemKnob').style.left=groupChatMemOn?'21px':'3px';
  const gcmCount=LS.getItem('groupChatMemCount_'+c.id)||'15';
  document.getElementById('groupChatMemRange').value=gcmCount;
  document.getElementById('groupChatMemVal').textContent=gcmCount;
  document.getElementById('groupChatMemSliderRow').style.display=groupChatMemOn?'block':'none';
  const mc=LS.getItem('memoryCount_'+c.id)||'20';
  document.getElementById('memoryCount').value=mc;
  const cmc=LS.getItem('companionMemCount_'+c.id)||'10';
  document.getElementById('companionMemCount').value=cmc;
  currentSoundKey=LS.getItem('msgSound_'+c.id)||'ganlu';
  renderSoundOpts();
  document.getElementById('extraPrompt').value=LS.getItem('extraPrompt_'+c.id)||'';
  realTimeOn=LS.getItem('realTime_'+c.id)==='1';
  document.getElementById('realTimeToggle').style.background=realTimeOn?'var(--accent)':'var(--accent2)';
  document.getElementById('realTimeKnob').style.left=realTimeOn?'21px':'3px';
  enterSendOn=LS.getItem('enterSend_'+c.id)==='1';
  document.getElementById('enterSendToggle').style.background=enterSendOn?'var(--accent)':'var(--accent2)';
  document.getElementById('enterSendKnob').style.left=enterSendOn?'21px':'3px';
  avatarStyle=LS.getItem('avatarStyle_'+c.id)||'circle';
  document.getElementById('avs-circle').classList.toggle('active',avatarStyle==='circle');
  document.getElementById('avs-rounded').classList.toggle('active',avatarStyle==='rounded');
  renderMessages();
  document.getElementById('pageConv').classList.add('open');
}
function closeConversation(){
  document.getElementById('pageConv').classList.remove('open');
  if(listenTogetherActive)stopListenTogether();
}
let msgDisplayCount=20;

function renderMessages(){
  const box=document.getElementById('convMessages');
  if(!currentContact||!currentContact.id)return;
  bubbleColors=getBubbleColors();
  const allMsgs=(conversations[currentContact.id]||[]);
  const total=allMsgs.length;
  const startIdx=Math.max(0,total-msgDisplayCount);
  const msgs=allMsgs.slice(startIdx);
  const me=currentContact.mePresetIndex!=null?mePresets[currentContact.mePresetIndex]:null;
  const meAvUrl=me?.avatar?getAvatarURL('me_'+(currentContact.mePresetIndex||0),me.avatar):'';
  const cAvUrl=currentContact.avatar?getAvatarURL('c_'+currentContact.id,currentContact.avatar):'';
  const meAvatar=meAvUrl?`<img src="${meAvUrl}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
  const contactAvatar=cAvUrl?`<img src="${cAvUrl}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
  const avatarEl=`<div style="width:34px;height:34px;border-radius:50%;background:var(--accent2);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center">`;
  const avR=avatarStyle==='rounded'?'10px':'50%';
  const avatarWithTime=(avatarInner,time,align,clickable)=>`
    <div style="display:flex;flex-direction:column;align-items:center;gap:3px;flex-shrink:0">
      <div onclick="${clickable?'openProfileCard()':''}" style="width:34px;height:34px;border-radius:${avR};background:var(--accent2);overflow:hidden;display:flex;align-items:center;justify-content:center;${clickable?'cursor:pointer':''}">${avatarInner}</div>
      ${showTimestamp&&time?`<span style="font-size:9px;color:var(--text2);white-space:nowrap;letter-spacing:-.2px">${time}</span>`:''}
    </div>`;
  if(!allMsgs.length){box.innerHTML='<p style="color:var(--text2);font-size:14px;text-align:center;padding:60px 0">开始聊天吧</p>';return;}
  const loadMoreHtml=startIdx>0?`<div style="text-align:center;padding:10px 0 14px"><button onclick="loadMoreMsgs()" style="padding:7px 20px;border-radius:20px;border:1.5px solid var(--accent2);background:var(--card2);font-size:12px;color:var(--text2);cursor:pointer;font-family:inherit">查看更早的消息 (${startIdx}条)</button></div>`:'';
  box.innerHTML=loadMoreHtml+msgs.map((m,mi)=>{
    const i=startIdx+mi;
    const time=m.time||'';
    const isSelected=selectedMsgIndexes.has(i);
        const isOut=m.role==='user';
    const isLast=(mi===msgs.length-1);
    let bubbleContent,bubbleClass='tg-bubble',bubbleStyle='';
    if(isLast&&msgAnimFlag){bubbleClass+=isOut?' anim-send':' anim-recv';}
    if(m.type==='image'){
      bubbleContent=`<img src="${m.imageData}" style="max-width:220px;max-height:220px;border-radius:14px;display:block"/>`;
      bubbleClass+=' media';
    } else if(m.type==='book'){
      bubbleContent=`<div style="width:200px;background:linear-gradient(135deg,#f8f4ee,#ede3d4);border-radius:14px;overflow:hidden;padding:12px">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#8B7355" stroke-width="1.8"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
          <span style="font-size:11px;color:#8B7355;font-weight:600">一起看书</span>
        </div>
        <div style="font-size:13px;color:#5A4A3A;font-weight:600;margin-bottom:4px">${m.bookTitle||'未知书名'}</div>
        <div style="font-size:11px;color:#9B8B7A">第 ${m.bookPageNum||1} 页</div>
      </div>`;
      bubbleClass+=' media';
    } else if(m.type==='song'){
      const coverHtml=m.songCover?`<img src="${m.songCover}"/>`:`<div style="width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#2c2c3e,#16213e);display:flex;align-items:center;justify-content:center"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="1.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div>`;
      bubbleContent=`<div class="song-card-bubble"><div class="song-card-top">${coverHtml}<div class="sct-info"><div class="sct-name">${m.songName||'未知歌曲'}</div><div class="sct-artist">${m.songArtist||''}</div></div></div><div class="song-card-bottom"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg><span>一起听歌</span></div></div>`;
      bubbleClass+=' media';
    } else if(m.type==='photo'){
      bubbleContent=`<div style="width:190px;background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:14px;overflow:hidden"><div style="padding:12px 12px 8px;font-size:12px;color:rgba(255,255,255,.9);line-height:1.5">${m.displayDesc}</div>${m.displayMood?`<div style="padding:0 12px 10px;font-size:10px;color:rgba(255,255,255,.5)">· ${m.displayMood}</div>`:''}<div style="padding:6px 12px;background:rgba(255,255,255,.06);font-size:10px;color:rgba(255,255,255,.35);letter-spacing:.5px">照片</div></div>`;
      bubbleClass+=' media';
    } else {
      const bg=isOut?bubbleColors.my:bubbleColors.their;
      const color=getTextColor(bg);
      bubbleStyle=`background:${bg};color:${color};`;
      bubbleContent=m.content;
    }
    const bubble=`<div class="${bubbleClass}" style="${bubbleStyle}transition:opacity .15s;${isSelected?'opacity:.6':''}" data-idx="${i}">${bubbleContent}</div>`;

    const checkbox=multiSelectMode?`<div class="msg-checkbox${isSelected?' checked':''}" onclick="toggleMsgSelect(${i})"></div>`:'';
    return `<div style="display:flex;align-items:flex-end;gap:8px;justify-content:${m.role==='user'?'flex-end':'flex-start'};padding:2px 0" data-msg-idx="${i}">
      ${m.role==='user'&&multiSelectMode?checkbox:''}
      ${m.role!=='user'?avatarWithTime(contactAvatar,time,'left',true):''}
      ${bubble}
      ${m.role==='user'?avatarWithTime(meAvatar,time,'right',false):''}
      ${m.role!=='user'&&multiSelectMode?checkbox:''}
    </div>`;
  }).join('');

  // 长按事件
  if(!multiSelectMode){
    box.querySelectorAll('[data-idx]').forEach(el=>{
      let timer;
      el.addEventListener('touchstart',e=>{timer=setTimeout(()=>showMsgActionMenu(e.touches[0],+el.dataset.idx),500);},{passive:true});
      el.addEventListener('touchend',()=>clearTimeout(timer),{passive:true});
      el.addEventListener('touchmove',()=>clearTimeout(timer),{passive:true});
      el.addEventListener('contextmenu',e=>{e.preventDefault();showMsgActionMenu(e,+el.dataset.idx);});
    });
  }

  // 多选底栏
  const existing=document.getElementById('multiSelectBar');
  if(existing)existing.remove();
  if(multiSelectMode){
    const bar=document.createElement('div');
    bar.id='multiSelectBar';
    bar.className='msg-select-bar';
    bar.innerHTML=`<span style="font-size:13px;color:var(--text2)">已选 ${selectedMsgIndexes.size} 条</span><div style="display:flex;gap:10px"><button onclick="exitMultiSelect()" style="padding:8px 16px;border-radius:10px;border:1.5px solid var(--accent2);background:none;font-size:13px;color:var(--text);cursor:pointer;font-family:inherit">取消</button><button onclick="deleteSelectedMsgs()" style="padding:8px 16px;border-radius:10px;border:none;background:#FF3B30;font-size:13px;color:#fff;font-weight:600;cursor:pointer;font-family:inherit">删除</button></div>`;
    document.getElementById('pageConv').appendChild(bar);
  }

  if(!multiSelectMode){box.scrollTop=box.scrollHeight;}
}
let msgAnimFlag=false;

function sendMessage(){
  const input=document.getElementById('convInput');
  const text=input.value.trim();
  if(!text)return;
  input.value='';
  input.style.height='auto';
  msgAnimFlag=true;
  const now=new Date();
  const ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')+':'+now.getSeconds().toString().padStart(2,'0');

  if(currentGroup){
    const gid=currentGroup.id;
    if(!groupConversations[gid])groupConversations[gid]=[];
    msgAnimFlag=true;
    groupConversations[gid].push({role:'user',content:text,time:ts});
    LS.setItem('groupConvs',JSON.stringify(groupConversations));
    renderGroupMessages();
    setTimeout(()=>{msgAnimFlag=false;},400);
    renderMsgList();
    return;
  }
  if(!currentContact||!currentContact.id)return;
  const id=currentContact.id;
  if(!conversations[id])conversations[id]=[];
  conversations[id].push({role:'user',content:text,time:ts});
  LS.setItem('conversations',JSON.stringify(conversations));
  renderMessages();
  renderMsgList();
  setTimeout(()=>{msgAnimFlag=false;},400);
}

function clearConvBg(){
  const box=document.getElementById('convMessages');
  box.style.backgroundImage='';
  if(currentContact)IDB.del('convBg_'+currentContact.id);
  closePanelConvSettings();
}
function setConvBg(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const r=new FileReader();
  r.onload=ev=>{
    const box=document.getElementById('convMessages');
    box.style.backgroundImage=`url(${ev.target.result})`;
    box.style.backgroundSize='cover';
    box.style.backgroundPosition='center';
    if(currentContact)IDB.set('convBg_'+currentContact.id,ev.target.result);
    closePanelConvSettings();
  };
  r.readAsDataURL(file);
}

// 聊天设置
function saveMemoryCount(v){
  const n=Math.max(1,parseInt(v)||20);
  document.getElementById('memoryCount').value=n;
  if(currentContact)LS.setItem('memoryCount_'+currentContact.id,n);
}
function openConvSettings(){if(!currentContact)return;document.getElementById('panelConvSettings').classList.add('open');}
function closePanelConvSettings(){document.getElementById('panelConvSettings').classList.remove('open');}

function confirmDeleteContact(){
  if(!currentContact)return;
  const card=document.createElement('div');
  card.style.cssText='position:absolute;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(4px)';
  card.innerHTML=`<div style="width:calc(100% - 56px);background:var(--bg);border-radius:20px;padding:20px 18px 16px;box-shadow:0 12px 40px rgba(0,0,0,.2)">
    <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px;text-align:center">删除联系人</div>
    <div style="font-size:13px;color:var(--text2);text-align:center;margin-bottom:16px;line-height:1.6">确定删除「${currentContact.name}」？<br>聊天记录将一并删除且无法恢复。</div>
    <div style="display:flex;gap:10px">
      <button onclick="this.closest('div[style*=absolute]').remove()" style="flex:1;padding:11px;border-radius:12px;border:1.5px solid var(--accent2);background:none;font-size:14px;color:var(--text2);cursor:pointer;font-family:inherit">取消</button>
      <button onclick="doDeleteContact();this.closest('div[style*=absolute]').remove()" style="flex:1;padding:11px;border-radius:12px;border:none;background:#FF3B30;font-size:14px;font-weight:600;color:#fff;cursor:pointer;font-family:inherit">删除</button>
    </div>
  </div>`;
  card.addEventListener('click',e=>{if(e.target===card)card.remove();});
  document.querySelector('.phone').appendChild(card);
}
function doDeleteContact(){
  const id=currentContact.id;
  delete conversations[id];
  LS.setItem('conversations',JSON.stringify(conversations));
  IDB.del('convBg_'+id);
  LS.removeItem('memoryCount_'+id);
  LS.removeItem('showTimestamp_'+id);
  LS.removeItem('momentsMemory_'+id);
  LS.removeItem('momentsMemoryCount_'+id);
  LS.removeItem('avatarStyle_'+id);
  IDB.del('cAvatar_'+id);
  contacts=contacts.filter(c=>c.id!==id);
  saveContactsToStorage();
  closePanelConvSettings();
  closeConversation();
  renderContacts();
  renderMsgList();
  showToast('联系人已删除');
}

// 编辑联系人
let editContactGender='male';
function openEditContact(){
  closePanelConvSettings();
  const c=currentContact;
  document.getElementById('ecName').value=c.name||'';
  document.getElementById('ecPersona').value=c.persona||'';
  editContactGender=c.gender||'male';
  setEditContactGender(editContactGender);
  const av=document.getElementById('editContactAvatarPreview');
  av.innerHTML=c.avatar?`<img src="${c.avatar}" style="width:100%;height:100%;object-fit:cover"/>`:'<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
  const sel=document.getElementById('ecMePreset');
  sel.innerHTML='<option value="">（不绑定）</option>'+mePresets.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('');
  sel.value=c.mePresetIndex!=null?c.mePresetIndex:'';
  document.getElementById('panelEditContact').classList.add('open');
}
function closeEditContact(){document.getElementById('panelEditContact').classList.remove('open');}
function setEditContactGender(g){
  editContactGender=g;
  document.getElementById('ecG-male')?.classList.toggle('active',g==='male');
  document.getElementById('ecG-female')?.classList.toggle('active',g==='female');
}
function onEditContactAvatarFile(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const r=new FileReader();
  r.onload=ev=>{
    compressAvatar(ev.target.result,200,compressed=>{
      currentContact.avatar=compressed;
      clearAvatarCache('c_'+currentContact.id);
      document.getElementById('editContactAvatarPreview').innerHTML=`<img src="${compressed}" style="width:100%;height:100%;object-fit:cover"/>`;
    });
  };
  r.readAsDataURL(file);
}
function saveEditContact(){
  const name=document.getElementById('ecName').value.trim();
  if(!name){showToast('请输入角色名字');return;}
  const sel=document.getElementById('ecMePreset').value;
  const idx=contacts.findIndex(c=>c.id===currentContact.id);
  if(idx>-1){
    contacts[idx]={...contacts[idx],name,gender:editContactGender,persona:document.getElementById('ecPersona').value.trim(),mePresetIndex:sel===''?null:parseInt(sel),avatar:currentContact.avatar};
    currentContact=contacts[idx];
    saveContactsToStorage();
    renderContacts();
    document.getElementById('convTitle').textContent=name;
  }
  closeEditContact();
  showToast('已保存 ✓');
}

// 气泡颜色
let bubbleColors={my:'#C4A882',their:'#FFFFFF'};
function getBubbleColors(){
  if(currentGroup){
    const saved=LS.getItem('bubbleColors_g_'+currentGroup.id);
    return saved?JSON.parse(saved):{my:'#C4A882',their:'#FFFFFF'};
  }
  if(currentContact){
    const saved=LS.getItem('bubbleColors_'+currentContact.id);
    return saved?JSON.parse(saved):{my:'#C4A882',their:'#FFFFFF'};
  }
  return {my:'#C4A882',their:'#FFFFFF'};
}
const bubblePresetColors=['#C4A882','#C4828A','#7A9E7E','#7A8FA6','#9B8EC4','#6BBFB5','#C4956A','#E07070'];
const bubblePresetColorsTheir=['#FFFFFF','#F5F5F5','#EEE8FF','#E8F5E9','#E3F2FD','#FFF3E0','#FCE4EC','#F3E5F5'];

function renderBubblePresets(){
  bubbleColors=getBubbleColors();
  ['my','their'].forEach(side=>{
    const list=document.getElementById(side+'BubblePresets');
    const colors=side==='my'?bubblePresetColors:bubblePresetColorsTheir;
    list.innerHTML=colors.map(c=>`
      <div onclick="applyBubbleColor('${side}','${c}')" style="width:36px;height:36px;border-radius:50%;background:${c};cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.12);border:2px solid rgba(0,0,0,.06);flex-shrink:0;transition:transform .15s" onmouseenter="this.style.transform='scale(1.15)'" onmouseleave="this.style.transform='scale(1)'"></div>
    `).join('');
  });
  document.getElementById('myBubblePreview').style.background=bubbleColors.my;
  document.getElementById('theirBubblePreview').style.background=bubbleColors.their;
}
function getLuminance(color){
  const c=document.createElement('canvas');c.width=c.height=1;
  const ctx=c.getContext('2d');ctx.fillStyle=color;ctx.fillRect(0,0,1,1);
  const d=ctx.getImageData(0,0,1,1).data;
  const r=d[0]/255,g=d[1]/255,b=d[2]/255;
  return .2126*r+.7152*g+.0722*b;
}
function getTextColor(bg){return getLuminance(bg)>.45?'#3a2e24':'#ffffff';}
function applyBubbleColor(side,color){
  bubbleColors[side]=color;
  document.getElementById(side==='my'?'myBubblePreview':'theirBubblePreview').style.background=color;
}
// 消息删除
let multiSelectMode=false;
let selectedMsgIndexes=new Set();
let actionMenuEl=null;

function closeActionMenu(){if(actionMenuEl){actionMenuEl.remove();actionMenuEl=null;}}

function showMsgActionMenu(e,msgIndex){
  closeActionMenu();
  const menu=document.createElement('div');
  menu.className='msg-action-menu';
  menu.innerHTML=`
    <div class="msg-action-item" onclick="favMsg(${msgIndex})">收藏</div>
    <div class="msg-action-item" onclick="deleteSingleMsg(${msgIndex})">删除</div>
    <div class="msg-action-item" onclick="enterMultiSelect(${msgIndex})">多选</div>`;
  // 定位在触摸点附近
  const phone=document.querySelector('.phone').getBoundingClientRect();
  let x=e.clientX-phone.left, y=e.clientY-phone.top;
  x=Math.min(x, phone.width-140);
  y=Math.min(y, phone.height-100);
  menu.style.cssText+=`left:${x}px;top:${y}px;`;
  document.querySelector('.phone').appendChild(menu);
  actionMenuEl=menu;
  setTimeout(()=>document.addEventListener('click',closeActionMenu,{once:true}),10);
}

function deleteSingleMsg(idx){
  closeActionMenu();
  const id=currentContact.id;
  conversations[id].splice(idx,1);
  LS.setItem('conversations',JSON.stringify(conversations));
  renderMessages();renderMsgList();
  showToast('消息已删除');
}

function enterMultiSelect(firstIdx){
  closeActionMenu();
  multiSelectMode=true;
  selectedMsgIndexes=new Set([firstIdx]);
  renderMessages();
}

function exitMultiSelect(){
  multiSelectMode=false;
  selectedMsgIndexes=new Set();
  renderMessages();
}

function toggleMsgSelect(idx){
  if(selectedMsgIndexes.has(idx))selectedMsgIndexes.delete(idx);
  else selectedMsgIndexes.add(idx);
  renderMessages();
}

function deleteSelectedMsgs(){
  const id=currentContact.id;
  const arr=conversations[id];
  const sorted=[...selectedMsgIndexes].sort((a,b)=>b-a);
  sorted.forEach(i=>arr.splice(i,1));
  LS.setItem('conversations',JSON.stringify(conversations));
  const count=sorted.length;
  exitMultiSelect();
  renderMsgList();
  showToast(`已删除 ${count} 条消息`);
}

let groupChatMemOn=false;
function toggleGroupChatMemory(){
  groupChatMemOn=!groupChatMemOn;
  document.getElementById('groupChatMemToggle').style.background=groupChatMemOn?'var(--accent)':'var(--accent2)';
  document.getElementById('groupChatMemKnob').style.left=groupChatMemOn?'21px':'3px';
  document.getElementById('groupChatMemSliderRow').style.display=groupChatMemOn?'block':'none';
  if(currentContact)LS.setItem('groupChatMem_'+currentContact.id,groupChatMemOn?'1':'0');
}
function onGroupChatMemRange(v){
  document.getElementById('groupChatMemVal').textContent=v;
  if(currentContact)LS.setItem('groupChatMemCount_'+currentContact.id,v);
}

let momentsMemoryOn=false;
function toggleMomentsMemory(){
  momentsMemoryOn=!momentsMemoryOn;
  document.getElementById('momentsMemoryToggle').style.background=momentsMemoryOn?'var(--accent)':'var(--accent2)';
  document.getElementById('momentsMemoryKnob').style.left=momentsMemoryOn?'21px':'3px';
  document.getElementById('momentsMemorySliderRow').style.display=momentsMemoryOn?'block':'none';
  if(currentContact)LS.setItem('momentsMemory_'+currentContact.id,momentsMemoryOn?'1':'0');
}
function onMomentsMemoryRange(v){
  document.getElementById('momentsMemoryVal').textContent=v;
  if(currentContact)LS.setItem('momentsMemoryCount_'+currentContact.id,v);
}

// ===== 消息提示音 =====
let currentSoundKey='ganlu';
const MSG_SOUNDS={
  ganlu:{name:'甘露',gen(ctx){
    const g=ctx.createGain();g.gain.setValueAtTime(.18,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.01,ctx.currentTime+.35);
    const o1=ctx.createOscillator();o1.type='sine';o1.frequency.setValueAtTime(1318,ctx.currentTime);o1.frequency.setValueAtTime(1568,ctx.currentTime+.08);o1.connect(g);g.connect(ctx.destination);o1.start(ctx.currentTime);o1.stop(ctx.currentTime+.35);
  }},
  dingdong:{name:'叮咚',gen(ctx){
    const g=ctx.createGain();g.gain.setValueAtTime(.16,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.01,ctx.currentTime+.4);
    const o=ctx.createOscillator();o.type='sine';o.frequency.setValueAtTime(880,ctx.currentTime);o.frequency.setValueAtTime(660,ctx.currentTime+.15);o.connect(g);g.connect(ctx.destination);o.start(ctx.currentTime);o.stop(ctx.currentTime+.4);
  }},
  bubble:{name:'气泡',gen(ctx){
    const g=ctx.createGain();g.gain.setValueAtTime(.15,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.01,ctx.currentTime+.2);
    const o=ctx.createOscillator();o.type='sine';o.frequency.setValueAtTime(600,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(1200,ctx.currentTime+.1);o.connect(g);g.connect(ctx.destination);o.start(ctx.currentTime);o.stop(ctx.currentTime+.2);
  }},
  crystal:{name:'水晶',gen(ctx){
    const g=ctx.createGain();g.gain.setValueAtTime(.13,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.01,ctx.currentTime+.5);
    const o1=ctx.createOscillator();o1.type='sine';o1.frequency.setValueAtTime(1760,ctx.currentTime);o1.connect(g);
    const o2=ctx.createOscillator();o2.type='sine';o2.frequency.setValueAtTime(2093,ctx.currentTime+.1);o2.connect(g);
    g.connect(ctx.destination);o1.start(ctx.currentTime);o1.stop(ctx.currentTime+.15);o2.start(ctx.currentTime+.12);o2.stop(ctx.currentTime+.5);
  }},
  wood:{name:'木鱼',gen(ctx){
    const g=ctx.createGain();g.gain.setValueAtTime(.2,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.01,ctx.currentTime+.15);
    const o=ctx.createOscillator();o.type='triangle';o.frequency.setValueAtTime(800,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(400,ctx.currentTime+.08);o.connect(g);g.connect(ctx.destination);o.start(ctx.currentTime);o.stop(ctx.currentTime+.15);
  }}
};

function playMsgSoundByKey(key){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const s=MSG_SOUNDS[key||'ganlu'];
    if(s)s.gen(ctx);
  }catch(e){}
}

function renderSoundOpts(){
  const box=document.getElementById('soundOptList');if(!box)return;
  box.innerHTML=Object.entries(MSG_SOUNDS).map(([k,v])=>`
    <div class="screen-opt${k===currentSoundKey?' active':''}" onclick="selectMsgSound('${k}')" style="padding:10px 12px">
      <div class="screen-opt-icon" style="width:32px;height:32px;border-radius:8px">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
      </div>
      <div class="screen-opt-info"><h4>${v.name}</h4></div>
      <button onclick="event.stopPropagation();playMsgSoundByKey('${k}')" style="background:none;border:none;cursor:pointer;padding:4px;color:var(--text2);display:flex;flex-shrink:0" title="试听">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polygon points="5,3 19,12 5,21" fill="currentColor"/></svg>
      </button>
      <div class="screen-check"></div>
    </div>`).join('');
}

function selectMsgSound(key){
  currentSoundKey=key;
  if(currentContact)LS.setItem('msgSound_'+currentContact.id,key);
  renderSoundOpts();
  playMsgSoundByKey(key);
}

function onConvInputKey(e){
  if(e.key==='Enter'&&!e.shiftKey&&enterSendOn){
    e.preventDefault();
    sendMessage();
  }
}

let realTimeOn=false;
function toggleRealTime(){
  realTimeOn=!realTimeOn;
  document.getElementById('realTimeToggle').style.background=realTimeOn?'var(--accent)':'var(--accent2)';
  document.getElementById('realTimeKnob').style.left=realTimeOn?'21px':'3px';
  if(currentContact)LS.setItem('realTime_'+currentContact.id,realTimeOn?'1':'0');
}
function toggleGroupRealTime(){
  const gid=currentGroup.id;
  const on=LS.getItem('realTime_g_'+gid)==='1';
  const next=on?'0':'1';
  LS.setItem('realTime_g_'+gid,next);
  document.getElementById('groupRealTimeToggle').style.background=next==='1'?'var(--accent)':'var(--accent2)';
  document.getElementById('groupRealTimeKnob').style.left=next==='1'?'21px':'3px';
}
function getRealTimePart(key){
  if(LS.getItem('realTime_'+key)!=='1')return '';
  const now=new Date();
  const h=now.getHours(),m=now.getMinutes();
  const weekdays=['周日','周一','周二','周三','周四','周五','周六'];
  const period=h<6?'凌晨':h<9?'早上':h<12?'上午':h<14?'中午':h<18?'下午':h<21?'晚上':'深夜';
  return `\n\n【现实时间】现在是${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 ${weekdays[now.getDay()]} ${period}${h}:${String(m).padStart(2,'0')}。你必须感知这个时间，回复内容要符合当前时段（比如深夜不要问午饭、白天不要说晚安、凌晨可以关心对方为什么还没睡等）。`;
}

let enterSendOn=false;
function toggleEnterSend(){
  enterSendOn=!enterSendOn;
  const on=enterSendOn;
  const t1=document.getElementById('enterSendToggle'),k1=document.getElementById('enterSendKnob');
  const t2=document.getElementById('groupEnterSendToggle'),k2=document.getElementById('groupEnterSendKnob');
  if(t1){t1.style.background=on?'var(--accent)':'var(--accent2)';}
  if(k1){k1.style.left=on?'21px':'3px';}
  if(t2){t2.style.background=on?'var(--accent)':'var(--accent2)';}
  if(k2){k2.style.left=on?'21px':'3px';}
  const id=currentContact?currentContact.id:currentGroup?'g_'+currentGroup.id:null;
  if(id)LS.setItem('enterSend_'+id,enterSendOn?'1':'0');
}

function saveExtraPrompt(){
  if(currentContact)LS.setItem('extraPrompt_'+currentContact.id,document.getElementById('extraPrompt').value);
}

let avatarStyle='circle';
function setAvatarStyle(style){
  avatarStyle=style;
  document.getElementById('avs-circle').classList.toggle('active',style==='circle');
  document.getElementById('avs-rounded').classList.toggle('active',style==='rounded');
  if(currentContact)LS.setItem('avatarStyle_'+currentContact.id,style);
  renderMessages();
}

let showTimestamp=false;
function toggleShowTime(){
  showTimestamp=!showTimestamp;
  document.getElementById('timeToggle').style.background=showTimestamp?'var(--accent)':'var(--accent2)';
  document.getElementById('timeToggleKnob').style.left=showTimestamp?'21px':'3px';
  if(currentContact)LS.setItem('showTimestamp_'+currentContact.id,showTimestamp?'1':'0');
  renderMessages();
}
// 把面板移到pageConv内部再打开，解决transform层叠上下文遮挡问题
function _openPanelInConv(id){
  var el=document.getElementById(id);
  var conv=document.getElementById('pageConv');
  if(el.parentNode!==conv)conv.appendChild(el);
  el.style.position='absolute';
  el.style.inset='0';
  el.style.zIndex='300';
  el.classList.add('open');
}

function openBubbleColor(){
  closePanelConvSettings();
  renderBubblePresets();
  _openPanelInConv('panelBubbleColor');
}
function openGroupBubbleColor(){
  closeGroupSettings();
  renderBubblePresets();
  _openPanelInConv('panelBubbleColor');
}
function closeBubbleColor(){document.getElementById('panelBubbleColor').classList.remove('open');}
function saveBubbleColor(){
  if(currentGroup){
    LS.setItem('bubbleColors_g_'+currentGroup.id,JSON.stringify(bubbleColors));
    renderGroupMessages();
  }else if(currentContact){
    LS.setItem('bubbleColors_'+currentContact.id,JSON.stringify(bubbleColors));
    renderMessages();
  }
  closeBubbleColor();
  showToast('气泡颜色已更新 ✓');
}

// 朋友圈
// moments按人设分组：{0:[...], 1:[...]}
let momentsMap={};
function getMoments(){return momentsMap[activeMePreset]||[];}
function setMoments(arr){momentsMap[activeMePreset]=arr;IDB.set('momentsMap',JSON.stringify(momentsMap));}
// 获取当前人设绑定的联系人
function getMyContacts(){
  return contacts.filter(c=>c.mePresetIndex===activeMePreset);
}

function setMomentsBg(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const r=new FileReader();
  r.onload=ev=>{
    IDB.set('momentsBg',ev.target.result);
    document.getElementById('momentsBannerImg').style.backgroundImage=`url(${ev.target.result})`;
  };
  r.readAsDataURL(file);
}

function renderMoments(){
  const me=mePresets[activeMePreset];
  if(me){
    document.getElementById('momentsMeName').textContent=me.name||'我';
    const av=document.getElementById('momentsMeAvatar');
    av.innerHTML=me.avatar?`<img src="${me.avatar}" style="width:100%;height:100%;object-fit:cover"/>`:'<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
  }
  IDB.get('momentsBg').then(bg=>{
    if(bg)document.getElementById('momentsBannerImg').style.backgroundImage=`url(${bg})`;
  });

  const moments=getMoments();
  const myContacts=getMyContacts();
  const myContactNames=new Set(myContacts.map(c=>c.name));
  const myName=me?.name||'我';
  // 只显示自己发的和自己绑定联系人的
  const filtered=moments.filter(m=>m.author===myName||myContactNames.has(m.author));
  const list=document.getElementById('momentsList');
  const empty=document.getElementById('momentsEmpty');
  empty.style.display=filtered.length?'none':'flex';
  list.innerHTML=filtered.map((m,i)=>{
    const realIdx=moments.indexOf(m);
    return renderMomentCard(m,realIdx);
  }).join('');
}

function renderMomentCard(m,i){
  const avatarInner=m.avatar?`<img src="${m.avatar}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
  const imgsHtml=m.images?.length?`<div class="moment-imgs n${Math.min(m.images.length,9)}">${m.images.slice(0,9).map(src=>`<div class="moment-img-item"><img src="${src}"/></div>`).join('')}</div>`:'';
  const likesHtml=m.likes?.length?`<div class="moment-likes">❤️ ${m.likes.join('、')}</div>`:'';
  const commentsHtml=m.comments?.length?`<div class="moment-comments">${m.comments.map((c,ci)=>{
    const me=mePresets[activeMePreset];
    const myName=me?.name||'我';
    const isContact=c.name!==myName;
    const replyHtml=c.replyTo?`<span style="color:var(--text2)"> 回复 </span><span class="moment-comment-name">${c.replyTo}</span><span>：</span>`:'';
    return `<div class="moment-comment-item" onclick="${isContact?`openReplyInput(${i},${ci})`:''}"><span class="moment-comment-name">${c.name}：</span>${replyHtml}${c.text}</div>`;
  }).join('')}</div>`:'';
  return `<div class="moment-card">
    <div class="moment-avatar">${avatarInner}</div>
    <div class="moment-body">
      <div class="moment-name">${m.author}</div>
      ${m.text?`<div class="moment-text">${m.text}</div>`:''}
      ${imgsHtml}
      <div class="moment-meta">
        <span class="moment-time">${m.time||''}</span>
        <div class="moment-actions">
          <button class="moment-action-btn${m.liked?' liked':''}" onclick="toggleLike(${i})">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="${m.liked?'var(--accent)':'none'}" stroke="${m.liked?'var(--accent)':'currentColor'}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21C12 21 3 14.5 3 8.5A5 5 0 0 1 12 5.93 5 5 0 0 1 21 8.5C21 14.5 12 21 12 21z"/></svg>
            ${m.likeCount||0}
          </button>
          <button class="moment-action-btn" onclick="openCommentInput(${i})">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            评论
          </button>
          <button class="moment-action-btn" onclick="deleteMoment(${i})" style="color:var(--text2);opacity:.6">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
          </button>
        </div>
      </div>
      ${likesHtml}
      ${commentsHtml}
    </div>
  </div>`;
}

function deleteMoment(i){
  const moments=getMoments();
  moments.splice(i,1);
  setMoments(moments);
  renderMoments();
}

function toggleLike(i){
  const moments=getMoments();
  const me=mePresets[activeMePreset];
  const name=me?.name||'我';
  moments[i].liked=!moments[i].liked;
  if(moments[i].liked){
    moments[i].likeCount=(moments[i].likeCount||0)+1;
    if(!moments[i].likes)moments[i].likes=[];
    if(!moments[i].likes.includes(name))moments[i].likes.push(name);
  } else {
    moments[i].likeCount=Math.max(0,(moments[i].likeCount||1)-1);
    moments[i].likes=(moments[i].likes||[]).filter(n=>n!==name);
  }
  setMoments(moments);
  renderMoments();
}

function openCommentInput(i){
  // 移除旧弹窗
  const old=document.getElementById('commentCard');
  if(old)old.remove();

  const card=document.createElement('div');
  card.id='commentCard';
  card.style.cssText='position:absolute;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(4px)';
  card.innerHTML=`
    <div style="width:calc(100% - 56px);background:var(--bg);border-radius:20px;padding:20px 18px 16px;box-shadow:0 12px 40px rgba(0,0,0,.2)">
      <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:14px;text-align:center">发表评论</div>
      <textarea id="commentCardInput" rows="3" class="set-input" placeholder="说点什么…" style="resize:none;line-height:1.6;margin-bottom:12px"></textarea>
      <div style="display:flex;gap:10px">
        <button onclick="document.getElementById('commentCard').remove()" style="flex:1;padding:11px;border-radius:12px;border:1.5px solid var(--accent2);background:none;font-size:14px;color:var(--text2);cursor:pointer;font-family:inherit">取消</button>
        <button onclick="submitComment(${i})" style="flex:1;padding:11px;border-radius:12px;border:none;background:var(--accent);font-size:14px;font-weight:600;color:#fff;cursor:pointer;font-family:inherit">发送</button>
      </div>
    </div>`;
  card.addEventListener('click',e=>{if(e.target===card)card.remove();});
  document.querySelector('.phone').appendChild(card);
  setTimeout(()=>document.getElementById('commentCardInput')?.focus(),100);
}

function openReplyInput(momentIdx,commentIdx){
  const old=document.getElementById('commentCard');
  if(old)old.remove();
  const moments=getMoments();
  const c=moments[momentIdx].comments[commentIdx];
  const card=document.createElement('div');
  card.id='commentCard';
  card.style.cssText='position:absolute;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(4px)';
  card.innerHTML=`
    <div style="width:calc(100% - 56px);background:var(--bg);border-radius:20px;padding:20px 18px 16px;box-shadow:0 12px 40px rgba(0,0,0,.2)">
      <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:6px;text-align:center">回复 ${c.name}</div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:12px;text-align:center;padding:0 8px">"${c.text}"</div>
      <textarea id="commentCardInput" rows="3" class="set-input" placeholder="回复 ${c.name}…" style="resize:none;line-height:1.6;margin-bottom:12px"></textarea>
      <div style="display:flex;gap:10px">
        <button onclick="document.getElementById('commentCard').remove()" style="flex:1;padding:11px;border-radius:12px;border:1.5px solid var(--accent2);background:none;font-size:14px;color:var(--text2);cursor:pointer;font-family:inherit">取消</button>
        <button onclick="submitReply(${momentIdx},${commentIdx})" style="flex:1;padding:11px;border-radius:12px;border:none;background:var(--accent);font-size:14px;font-weight:600;color:#fff;cursor:pointer;font-family:inherit">发送回复</button>
      </div>
    </div>`;
  card.addEventListener('click',e=>{if(e.target===card)card.remove();});
  document.querySelector('.phone').appendChild(card);
  setTimeout(()=>document.getElementById('commentCardInput')?.focus(),100);
}

async function submitReply(momentIdx,commentIdx){
  const text=document.getElementById('commentCardInput')?.value.trim();
  if(!text){showToast('请输入回复内容');return;}
  const moments=getMoments();
  const me=mePresets[activeMePreset];
  const myName=me?.name||'我';
  const targetComment=moments[momentIdx].comments[commentIdx];
  const moment=moments[momentIdx];

  moment.comments.push({name:myName,text,replyTo:targetComment.name});
  setMoments(moments);
  document.getElementById('commentCard')?.remove();
  renderMoments();

  // 触发角色回复我
  const p=presets[activePreset]||{};
  if(!p.key)return;
  const c=contacts.find(x=>x.name===targetComment.name);
  if(!c)return;
  try{
    const context=`朋友圈内容："${moment.text||'[图片]'}"。${targetComment.name}评论了："${targetComment.text}"。${myName}回复${targetComment.name}："${text}"。请以${targetComment.name}的身份回复${myName}，只输出回复内容，不超过30字。`;
    const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
      body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[
        {role:'system',content:`你是${c.name}，${c.gender==='male'?'男':'女'}性。${c.persona||''}简短自然地回复，禁止旁白描写。`},
        {role:'user',content:context}
      ],max_tokens:60})
    });
    const data=await res.json();
    const reply=data.choices?.[0]?.message?.content?.trim();
    if(reply){
      const ms=getMoments();
      const idx=ms.findIndex(m=>m.id===moment.id);
      if(idx>-1){
        ms[idx].comments.push({name:c.name,text:reply,replyTo:myName});
        setMoments(ms);
        renderMoments();
      }
    }
  }catch(e){}
}

async function submitComment(i){
  const moments=getMoments();
  const text=document.getElementById('commentCardInput')?.value.trim();
  if(!text){showToast('请输入评论内容');return;}
  const me=mePresets[activeMePreset];
  const myName=me?.name||'我';
  if(!moments[i].comments)moments[i].comments=[];
  moments[i].comments.push({name:myName,text});
  setMoments(moments);
  document.getElementById('commentCard')?.remove();
  renderMoments();

  const moment=moments[i];
  const c=contacts.find(x=>x.name===moment.author);
  if(!c)return;
  const p=presets[activePreset]||{};
  if(!p.key)return;
  try{
    const context=`朋友圈内容："${moment.text||'[图片]'}"。${myName}评论了："${text}"。请以${c.name}的身份回复这条评论，只输出回复内容，不超过30字。`;
    const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
      body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[
        {role:'system',content:`你是${c.name}，${c.gender==='male'?'男':'女'}性。${c.persona||''}简短自然地回复评论，禁止旁白描写。`},
        {role:'user',content:context}
      ],max_tokens:60})
    });
    const data=await res.json();
    const reply=data.choices?.[0]?.message?.content?.trim();
    if(reply){
      const ms=getMoments();
      const idx=ms.findIndex(m=>m.id===moment.id);
      if(idx>-1){
        ms[idx].comments.push({name:c.name,text:reply,replyTo:myName});
        setMoments(ms);
        renderMoments();
        showTopNotify(c,`回复了你的评论`);
      }
    }
  }catch(e){}
}

let postMomentImages=[];
let postVisibleContacts=new Set();

function openPostMoment(){
  postMomentImages=[];
  postVisibleContacts=new Set();
  document.getElementById('postMomentText').value='';
  renderPostImgGrid();
  renderPostVisibleList();
  document.getElementById('panelPostMoment').classList.add('open');
}
function closePostMoment(){document.getElementById('panelPostMoment').classList.remove('open');}

function renderPostImgGrid(){
  const grid=document.getElementById('postImgGrid');
  grid.innerHTML='';
  postMomentImages.forEach((src,i)=>{
    const cell=document.createElement('div');
    cell.className='post-img-cell';
    cell.innerHTML=`<img src="${src}"/><button class="del" onclick="removePostImg(${i})">×</button>`;
    grid.appendChild(cell);
  });
  if(postMomentImages.length<9){
    const add=document.createElement('div');
    add.className='post-img-add';
    add.innerHTML=`<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="1.8"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`;
    add.onclick=()=>{
      const inp=document.createElement('input');
      inp.type='file';inp.accept='image/*';inp.multiple=true;
      inp.onchange=e=>{
        const files=[...e.target.files].slice(0,9-postMomentImages.length);
        let loaded=0;
        files.forEach(f=>{
          const r=new FileReader();
          r.onload=ev=>{postMomentImages.push(ev.target.result);loaded++;if(loaded===files.length)renderPostImgGrid();};
          r.readAsDataURL(f);
        });
      };
      inp.click();
    };
    grid.appendChild(add);
  }
}

function removePostImg(i){
  postMomentImages.splice(i,1);
  renderPostImgGrid();
}

function renderPostVisibleList(){
  const box=document.getElementById('postVisibleList');
  const empty=document.getElementById('postNoContacts');
  box.innerHTML='';
  const myContacts=getMyContacts();
  empty.style.display=myContacts.length?'none':'block';
  myContacts.forEach(c=>{
    const d=document.createElement('div');
    const sel=postVisibleContacts.has(c.id);
    d.className='visible-opt'+(sel?' selected':'');
    d.innerHTML=`
      <div class="visible-opt-avatar">${c.avatar?`<img src="${c.avatar}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`}</div>
      <span>${c.name}</span>
      <div class="visible-check"></div>`;
    d.onclick=()=>{
      if(postVisibleContacts.has(c.id))postVisibleContacts.delete(c.id);
      else postVisibleContacts.add(c.id);
      renderPostVisibleList();
    };
    box.appendChild(d);
  });
}

async function submitPostMoment(){
  const text=document.getElementById('postMomentText').value.trim();
  if(!text&&!postMomentImages.length){showToast('请输入内容或选择图片');return;}
  if(!postVisibleContacts.size){showToast('请至少选择一位可见好友');return;}

  const me=mePresets[activeMePreset];
  const now=new Date();
  const ts=`${now.getMonth()+1}月${now.getDate()}日 ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

  const moment={
    id:Date.now(),
    author:me?.name||'我',
    avatar:me?.avatar||'',
    text,
    images:postMomentImages.slice(),
    time:ts,
    visibleIds:[...postVisibleContacts],
    liked:false,likeCount:0,likes:[],comments:[]
  };
  const moments=getMoments();
  moments.unshift(moment);
  setMoments(moments);
  closePostMoment();
  renderMoments();
  showToast('已发布 ✓');

  // 触发可见好友点赞和评论
  requestFriendsLike(moment);
  requestFriendsComment(moment);
}

let notifyStack=[];
let notifyIdCounter=0;

function showTopNotify(contact,text,isGroup=false,groupName=''){
  const id=++notifyIdCounter;
  const now=new Date();
  const timeStr=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  
  const el=document.createElement('div');
  el.className='top-notify';
  el.dataset.notifyId=id;
  el.innerHTML=`
    <div class="top-notify-avatar">${contact.avatar?`<img src="${contact.avatar}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`}</div>
    <div class="top-notify-body">
      <div class="top-notify-title"><span>${isGroup?contact.name+' · '+groupName:contact.name}</span><span>${timeStr}</span></div>
      <div class="top-notify-text">${text}</div>
    </div>`;
  
  document.querySelector('.phone').appendChild(el);
  notifyStack.push({id,el});
  updateNotifyPositions();
  
  requestAnimationFrame(()=>el.classList.add('show'));
  
  setTimeout(()=>dismissNotify(id),4000);
}

function updateNotifyPositions(){
  notifyStack.forEach((n,i)=>{
    n.el.style.top=(54+i*62)+'px';
    n.el.style.opacity=Math.max(0,1-i*0.15);
    n.el.style.transform=`translateX(-50%) translateY(0) scale(${Math.max(0.9,1-i*0.03)})`;
  });
}

function dismissNotify(id){
  const idx=notifyStack.findIndex(n=>n.id===id);
  if(idx===-1)return;
  const n=notifyStack[idx];
  n.el.style.opacity='0';
  n.el.style.transform='translateX(-50%) translateY(-20px)';
  setTimeout(()=>{
    n.el.remove();
    notifyStack=notifyStack.filter(x=>x.id!==id);
    updateNotifyPositions();
  },400);
}

function showChatNotify(contact,msgContent){
  let text=msgContent||'';
  if(text.length>30)text=text.slice(0,30)+'...';
  showTopNotify(contact,text);
}

function showGroupChatNotify(authorName,authorAvatar,groupName,msgContent){
  let text=msgContent||'';
  if(text.length>30)text=text.slice(0,30)+'...';
  showTopNotify({name:authorName,avatar:authorAvatar},text,true,groupName);
}

let refreshSelected=new Set();

function openRefreshMoments(){
  refreshSelected=new Set();
  const list=document.getElementById('refreshContactList');
  list.innerHTML='';
  const myContacts=getMyContacts();
  if(!myContacts.length){
    list.innerHTML='<p style="font-size:13px;color:var(--text2);text-align:center;padding:20px 0">当前人设没有绑定联系人</p>';
  } else {
    myContacts.forEach(c=>{
      const d=document.createElement('div');
      d.className='visible-opt';
      d.innerHTML=`
        <div class="visible-opt-avatar">${c.avatar?`<img src="${c.avatar}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`}</div>
        <span>${c.name}</span>
        <div class="visible-check"></div>`;
      d.onclick=()=>{
        if(refreshSelected.has(c.id))refreshSelected.delete(c.id);
        else refreshSelected.add(c.id);
        d.classList.toggle('selected',refreshSelected.has(c.id));
        d.querySelector('.visible-check').classList&&d.querySelector('.visible-check');
        renderRefreshList();
      };
      list.appendChild(d);
    });
  }
  document.getElementById('panelRefreshMoments').classList.add('open');
}

function renderRefreshList(){
  const myContacts=getMyContacts();
  document.querySelectorAll('#refreshContactList .visible-opt').forEach((d,i)=>{
    const c=myContacts[i];
    if(c)d.classList.toggle('selected',refreshSelected.has(c.id));
  });
}

function closeRefreshMoments(){
  document.getElementById('panelRefreshMoments').classList.remove('open');
}

function requestFriendsLike(moment){
  const visibleFriends=getMyContacts().filter(c=>moment.visibleIds.includes(c.id));
  visibleFriends.forEach((c,i)=>{
    const delay=8000+Math.random()*7000+i*1200;
    setTimeout(()=>{
      const ms=getMoments();
      const idx=ms.findIndex(m=>m.id===moment.id);
      if(idx<0)return;
      if(!ms[idx].likes)ms[idx].likes=[];
      if(!ms[idx].likes.includes(c.name)){
        ms[idx].likes.push(c.name);
        ms[idx].likeCount=(ms[idx].likeCount||0)+1;
        setMoments(ms);
        renderMoments();
        showTopNotify(c,`赞了你的朋友圈`);
      }
    },delay);
  });
}

async function doRefreshMoments(){
  if(!refreshSelected.size){showToast('请至少选择一位联系人');return;}
  const p=presets[activePreset]||{};
  if(!p.key){showToast('请先配置 API');return;}
  document.getElementById('refreshBtn').textContent='生成中…';
  document.getElementById('refreshBtn').disabled=true;

  const selected=getMyContacts().filter(c=>refreshSelected.has(c.id));
  for(const c of selected){
    const msgs=(conversations[c.id]||[]).slice(-25);
    const chatSummary=msgs.map(m=>`${m.role==='user'?'我':'对方'}：${m.content||'[图片]'}`).join('\n');
    const sysPrompt=`你是${c.name}，${c.gender==='male'?'男':'女'}性。${c.persona||''}
你要发一条朋友圈，要求：
- 完全符合你的性格和人设
- 内容真实自然，像真人发的朋友圈，可以是日常生活、心情、美食、风景、感悟等
- 语气口吻和你平时聊天一致
- 不要太长，1-3句话为佳，可以带emoji
- 只输出朋友圈正文内容，不要任何解释或前缀`;
    const userPrompt=chatSummary?`根据我们最近的聊天记录，发一条符合你当下状态的朋友圈：\n${chatSummary}`:`发一条符合你性格的日常朋友圈。`;
    try{
      const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
        body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[{role:'system',content:sysPrompt},{role:'user',content:userPrompt}],max_tokens:120})
      });
      const data=await res.json();
      let text=data.choices?.[0]?.message?.content?.trim()||'';
      // 清理AI可能输出的多余格式：去掉引号包裹、前缀说明、markdown
      text=text
        .replace(/^["「『【]|["」』】]$/g,'')
        .replace(/^(朋友圈[：:内容]*|正文[：:]|内容[：:])\s*/i,'')
        .replace(/\*\*|__|\*|_|~~|`/g,'')
        .trim();
      if(text){
        const now=new Date();
        const ts=`${now.getMonth()+1}月${now.getDate()}日 ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        const moment={id:Date.now()+Math.random(),author:c.name,avatar:c.avatar||'',text,images:[],time:ts,visibleIds:[],liked:false,likeCount:0,likes:[],comments:[]};
        const ms=getMoments();
        ms.unshift(moment);
        setMoments(ms);
        showTopNotify(c,`发布了一条新动态`);
      }
    }catch(e){/* 单个失败不影响其他 */}
  }

  renderMoments();
  document.getElementById('refreshBtn').textContent='刷新动态';
  document.getElementById('refreshBtn').disabled=false;
  closeRefreshMoments();
  showToast('动态已刷新 ✓');
}

async function requestFriendsComment(moment){
  const p=presets[activePreset]||{};
  if(!p.key)return;

  let visionOk=true;
  if(moment.images.length){
    try{
      const testRes=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
        body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[{role:'user',content:[{type:'image_url',image_url:{url:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',detail:'low'}}]}],max_tokens:1})
      });
      const td=await testRes.json();
      if(td.error&&/vision|image|multimodal|not support/i.test(td.error.message)){
        visionOk=false;
        showToast('当前模型不支持识图，评论将忽略图片内容');
      }
    }catch(e){visionOk=false;}
  }

  const visibleFriends=getMyContacts().filter(c=>moment.visibleIds.includes(c.id));
  for(const c of visibleFriends){
    try{
      let userContent;
      if(moment.images.length&&visionOk){
        userContent=[
          {type:'text',text:`${moment.author}发了一条朋友圈${moment.text?'："'+moment.text+'"':''}，附带图片，请以${c.name}的身份用一句自然的中文评论这条朋友圈，只输出评论内容，不超过30字。`},
          ...moment.images.slice(0,4).map(src=>({type:'image_url',image_url:{url:src,detail:'low'}}))
        ];
      } else {
        userContent=`${moment.author}发了一条朋友圈："${moment.text||'[图片]'}"，请以${c.name}的身份用一句自然的中文评论，只输出评论内容，不超过30字。`;
      }
      const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
        body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[
          {role:'system',content:`你是${c.name}，${c.gender==='male'?'男':'女'}性。${c.persona||''}用真实朋友的口吻评论，简短自然，禁止旁白描写。`},
          {role:'user',content:userContent}
        ],max_tokens:60})
      });
      const data=await res.json();
      const reply=data.choices?.[0]?.message?.content?.trim();
      if(reply){
        const ms=getMoments();
        const idx=ms.findIndex(m=>m.id===moment.id);
          if(idx>-1){
          if(!ms[idx].comments)ms[idx].comments=[];
          ms[idx].comments.push({name:c.name,text:reply});
          setMoments(ms);
          renderMoments();
          showTopNotify(c,`评论了你的朋友圈`);
        }
      }
    }catch(e){/* 单个好友失败不影响其他 */}
  }
}

let selectedPhotoMood='';
function openPhotoPanel(){
  document.getElementById('extraMenu').style.display='none';
  document.getElementById('extraBtn').style.background='var(--card2)';
  document.getElementById('photoDesc').value='';
  selectedPhotoMood='';
  document.querySelectorAll('.photo-tag').forEach(t=>t.classList.remove('active'));
  updatePhotoPreview();
  document.getElementById('photoPanel').classList.add('open');
}
function closePhotoPanel(){document.getElementById('photoPanel').classList.remove('open');}
function selectPhotoMood(el,mood){
  selectedPhotoMood=el.classList.contains('active')?'':mood;
  document.querySelectorAll('.photo-tag').forEach(t=>t.classList.remove('active'));
  if(selectedPhotoMood)el.classList.add('active');
  updatePhotoPreview();
}
function updatePhotoPreview(){
  const desc=document.getElementById('photoDesc').value.trim();
  const el=document.getElementById('photoPreviewText');
  const icon=document.getElementById('photoIcon');
  if(desc){
    el.textContent=desc+(selectedPhotoMood?` · ${selectedPhotoMood}`:'');
    el.classList.add('has-text');
    icon.style.display='none';
  } else {
    el.textContent='在下方描述这张照片的内容';
    el.classList.remove('has-text');
    icon.style.display='block';
  }
}
function confirmSendPhoto(){
  const desc=document.getElementById('photoDesc').value.trim();
  if(!desc){showToast('请描述照片内容');return;}
  const mood=selectedPhotoMood?`，氛围：${selectedPhotoMood}`:'';
  const content=`[照片]${desc}${mood}`;
  const id=currentContact.id;
  if(!conversations[id])conversations[id]=[];
  const now=new Date();
  const ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')+':'+now.getSeconds().toString().padStart(2,'0');
  conversations[id].push({role:'user',type:'photo',content,displayDesc:desc,displayMood:selectedPhotoMood,time:ts});
  LS.setItem('conversations',JSON.stringify(conversations));
  renderMessages();renderMsgList();
  closePhotoPanel();
}

async function sendImageMsg(){
  document.getElementById('extraMenu').style.display='none';
  document.getElementById('extraBtn').style.background='var(--card2)';
  const p=presets[activePreset]||{};
  if(!p.key){showToast('请先配置 API');return;}
  // 用1x1透明png测试识图能力
  const testImg='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
  try{
    const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
      body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[{role:'user',content:[{type:'image_url',image_url:{url:testImg,detail:'low'}}]}],max_tokens:1})
    });
    const data=await res.json();
    if(data.error&&/vision|image|multimodal|not support/i.test(data.error.message)){
      showToast('识图功能可能无法使用：你的 API 不支持该功能');
      return;
    }
  }catch(e){/* 网络错误不阻止，继续尝试 */}
  document.getElementById('chatImgFile').click();
}
function onChatImgFile(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const r=new FileReader();
  r.onload=ev=>{
    const id=currentContact.id;
    if(!conversations[id])conversations[id]=[];
    const now=new Date();
    const ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')+':'+now.getSeconds().toString().padStart(2,'0');
    conversations[id].push({role:'user',type:'image',imageData:ev.target.result,time:ts});
    LS.setItem('conversations',JSON.stringify(conversations));
    renderMessages();renderMsgList();
  };
  r.readAsDataURL(file);
}

// ===== 个性名片 =====
let profileCardCache={};// {contactId: {sig,tags,mood}}

function openProfileCard(){
  if(!currentContact||currentGroup)return;
  const c=currentContact;
  // 移除旧的
  document.getElementById('profileCardOverlay')?.remove();
  const cached=profileCardCache[c.id];
  const overlay=document.createElement('div');
  overlay.className='profile-card-overlay';
  overlay.id='profileCardOverlay';
  overlay.addEventListener('click',e=>{if(e.target===overlay)closeProfileCard();});

  const avUrl=c.avatar?getAvatarURL('c_'+c.id,c.avatar):'';
  const avHtml=avUrl?`<img src="${avUrl}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
  const msgCount=(conversations[c.id]||[]).length;
  const daysSince=Math.max(1,Math.floor((Date.now()-(conversations[c.id]?.[0]?.ts||Date.now()))/86400000));

  overlay.innerHTML=`
    <div class="profile-card">
      <div class="profile-card-banner" style="background:linear-gradient(135deg,var(--accent),var(--accent2))">
        <button class="profile-card-refresh" onclick="event.stopPropagation();refreshProfileCard()" title="刷新名片">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
        </button>
      </div>
      <div class="profile-card-body">
        <div class="profile-card-avatar">${avHtml}</div>
        <div class="profile-card-name">${c.name}</div>
        <div class="profile-card-gender">${c.gender==='female'?'♀ 女生':'♂ 男生'}</div>
        <div class="profile-card-sig" id="pcSig">${cached?.sig||'...'}</div>
        <div class="profile-card-tags" id="pcTags">${cached?.tags?.map(t=>`<span class="profile-card-tag">${t}</span>`).join('')||''}</div>
        <div class="profile-card-stats">
          <div class="profile-card-stat"><div class="profile-card-stat-val">${msgCount}</div><div class="profile-card-stat-label">消息</div></div>
          <div class="profile-card-stat"><div class="profile-card-stat-val">${daysSince}天</div><div class="profile-card-stat-label">认识</div></div>
          <div class="profile-card-stat"><div class="profile-card-stat-val" id="pcMood">${cached?.mood||'—'}</div><div class="profile-card-stat-label">心情</div></div>
        </div>
      </div>
    </div>`;

  document.querySelector('.phone').appendChild(overlay);
  requestAnimationFrame(()=>overlay.classList.add('open'));

  if(!cached)generateProfileCard(false);
}

function closeProfileCard(){
  const o=document.getElementById('profileCardOverlay');
  if(o){o.classList.remove('open');setTimeout(()=>o.remove(),300);}
}

function refreshProfileCard(){
  generateProfileCard(true);
}

async function generateProfileCard(force){
  const c=currentContact;if(!c)return;
  const p=presets[activePreset]||{};
  if(!p.key){
    applyProfileFallback(c);
    return;
  }

  // 显示loading
  const card=document.querySelector('#profileCardOverlay .profile-card');
  if(card){
    const ld=document.createElement('div');
    ld.className='profile-card-loading';ld.id='pcLoading';
    ld.innerHTML='<div class="pc-spinner"></div>';
    card.appendChild(ld);
  }

  const msgs=(conversations[c.id]||[]).slice(-15);
  const chatCtx=msgs.map(m=>`${m.role==='user'?'对方':c.name}：${m.content||'[媒体]'}`).join('\n');

  try{
    const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
      body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[
        {role:'system',content:`根据角色信息生成个性名片。角色：${c.name}，${c.gender==='female'?'女':'男'}，人设：${c.persona||'无'}。
严格按以下格式输出，每行一个字段，不要多余内容：
签名：一句个性签名（15字以内，有个性有态度）
标签：3-5个用逗号分隔的个性标签（如：二次元,猫奴,社恐,深夜emo,奶茶续命）
心情：一个表情+一个词（如：😊开心 或 😴犯困 或 🔥亢奋）`},
        {role:'user',content:chatCtx?`最近聊天：\n${chatCtx}\n\n根据聊天内容和人设生成名片：`:'根据人设生成名片：'}
      ],max_tokens:120})
    });
    const data=await res.json();
    const raw=data.choices?.[0]?.message?.content||'';
    const result=parseProfileCard(raw,c);
    profileCardCache[c.id]=result;
    LS.setItem('profileCards',JSON.stringify(profileCardCache));
    applyProfileData(result);
  }catch(e){
    applyProfileFallback(c);
  }
  document.getElementById('pcLoading')?.remove();
}

function parseProfileCard(raw,c){
  let sig='',tags=[],mood='';

  // 提取签名
  const sigMatch=raw.match(/签名[：:]\s*(.+)/);
  if(sigMatch)sig=sigMatch[1].trim().replace(/^["「『]|["」』]$/g,'');

  // 提取标签
  const tagMatch=raw.match(/标签[：:]\s*(.+)/);
  if(tagMatch){
    tags=tagMatch[1].split(/[,，、\s]+/).map(t=>t.trim()).filter(t=>t&&t.length<10).slice(0,5);
  }

  // 提取心情
  const moodMatch=raw.match(/心情[：:]\s*(.+)/);
  if(moodMatch)mood=moodMatch[1].trim().slice(0,8);

  // 降级：如果正则全部失败，从原文中尽量提取
  if(!sig&&!tags.length&&!mood){
    const lines=raw.split('\n').map(l=>l.trim()).filter(l=>l);
    if(lines.length>=1)sig=lines[0].replace(/^[签名标签心情：:]+/,'').trim().slice(0,20)||c.name+'的签��';
    if(lines.length>=2)tags=lines[1].replace(/^[签名标签心情：:]+/,'').split(/[,，、\s]+/).filter(t=>t).slice(0,5);
    if(lines.length>=3)mood=lines[2].replace(/^[签名标签心情：:]+/,'').trim().slice(0,8);
  }

  // 最终兜底
  if(!sig)sig=c.persona?.slice(0,15)||c.name;
  if(!tags.length)tags=[c.gender==='female'?'女生':'男生'];
  if(!mood)mood='😶 神秘';

  return {sig,tags,mood};
}

function applyProfileData(d){
  const sigEl=document.getElementById('pcSig');
  const tagsEl=document.getElementById('pcTags');
  const moodEl=document.getElementById('pcMood');
  if(sigEl)sigEl.textContent=d.sig;
  if(tagsEl)tagsEl.innerHTML=d.tags.map(t=>`<span class="profile-card-tag">${t}</span>`).join('');
  if(moodEl)moodEl.textContent=d.mood;
}

function applyProfileFallback(c){
  applyProfileData({
    sig:c.persona?.slice(0,15)||c.name,
    tags:[c.gender==='female'?'女生':'男生'],
    mood:'😶 神秘'
  });
}

function parseMultiMsg(raw){
  const arrMatch=raw.match(/\[[\s\S]*\]/);
  let strings=[];
  if(arrMatch){
    try{
      const arr=JSON.parse(arrMatch[0]);
      if(Array.isArray(arr))strings=arr.map(s=>String(s).trim()).filter(s=>s.length);
    }catch(e){}
    if(!strings.length){
      const re=/"((?:[^"\\]|\\.)*)"/g;
      let m;
      while((m=re.exec(arrMatch[0]))!==null){
        const s=m[1].replace(/\\n/g,'\n').replace(/\\"/g,'"').replace(/\\\\/g,'\\').trim();
        if(s)strings.push(s);
      }
    }
  }
  if(!strings.length)strings=[raw.trim()||'…'];

  // 将每条字符串转成消息对象
  return strings.map(s=>{
    const photoMatch=s.match(/\[PHOTO:([\s\S]*?)(?:\|([\s\S]*?))?\]/);
    if(photoMatch){
      const desc=photoMatch[1].trim();
      const mood=photoMatch[2]?.trim()||'';
      return {type:'photo',content:`[照片]${desc}${mood?'，氛围：'+mood:''}`,displayDesc:desc,displayMood:mood};
    }
    return {type:'text',content:s};
  });
}

async function receiveMessage(){
  if(currentGroup)return receiveGroupMessage();
  if(!currentContact||!currentContact.id)return;
  const id=currentContact.id;
  const msgs=conversations[id]||[];
  if(!msgs.length){showToast('没有消息可接收');return;}
  const p=presets[activePreset]||{};
  if(!p.key){showToast('请先配置 API');return;}
  const me=currentContact.mePresetIndex!=null?mePresets[currentContact.mePresetIndex]:null;
  const mePart=me?`\n对方（用户）是${me.name}，${me.gender==='male'?'男':'女'}。${me.persona||''}`:'';

  let momentsPart='';
  if(momentsMemoryOn){
    const count=parseInt(LS.getItem('momentsMemoryCount_'+currentContact.id)||'10');
    const myName=me?.name||'我';
    const presetIdx=currentContact.mePresetIndex!=null?currentContact.mePresetIndex:activeMePreset;
    const msMem=momentsMap[presetIdx]||[];
    const related=msMem.filter(m=>m.author===currentContact.name||m.author===myName).slice(0,count);
    if(related.length){
      momentsPart='\n\n【朋友圈记忆】\n'+related.map(m=>{
        let s=`${m.author}：${m.text||'[图片]'}`;
        if(m.comments?.length)s+='\n  评论：'+m.comments.map(c=>`${c.name}${c.replyTo?'回复'+c.replyTo:''}：${c.text}`).join('；');
        return s;
      }).join('\n');
    }
  }

  let companionPart='';
  const cLogs=getCompanionLogs(currentContact.id);
  if(cLogs.length){
    const cMemText=getCompanionMemoryText(currentContact.id);
    if(cMemText)companionPart=`\n\n【陪伴模式记忆（你在陪伴模式中说过的内心独白，不要逐条复述，但你记得自己说过这些话，可以自然地延续这些情绪和话题）】\n${cMemText}`;
  }

  let groupChatPart='';
  if(groupChatMemOn){
    const gcmCount=parseInt(LS.getItem('groupChatMemCount_'+currentContact.id)||'15');
    // 找到该联系人所在的所有群聊
    const relatedGroups=groups.filter(g=>g.members&&g.members.includes(currentContact.id));
    if(relatedGroups.length){
      const allGroupMsgs=[];
      relatedGroups.forEach(g=>{
        const gMsgs=groupConversations[g.id]||[];
        const gMe=g.mePresetIndex!=null?mePresets[g.mePresetIndex]:null;
        const gMyName=gMe?.name||'我';
        gMsgs.slice(-gcmCount).forEach(m=>{
          if(m.type==='vote')return;
          const who=m.role==='user'?gMyName:(m.authorName||'?');
          allGroupMsgs.push({text:`${who}：${m.content||''}`,group:g.name});
        });
      });
      if(allGroupMsgs.length){
        const grouped={};
        allGroupMsgs.forEach(m=>{if(!grouped[m.group])grouped[m.group]=[];grouped[m.group].push(m.text);});
        groupChatPart='\n\n【群聊记忆（你在群里经历过的对话，不要刻意提起，只在自然相关时才体现）】\n'+Object.entries(grouped).map(([gn,msgs])=>`群「${gn}」：\n${msgs.slice(-gcmCount).join('\n')}`).join('\n\n');
      }
    }
  }

  const extraPrompt=LS.getItem('extraPrompt_'+currentContact.id)||'';
  const extraPart=extraPrompt?`\n\n【补充设定（必须严格遵守）】\n${extraPrompt}`:''+companionPart;
  // 长期记忆
  let longMemPart='';
  const memText=getMemoryText(currentContact.id);
  if(memText)longMemPart=`\n\n【长期记忆（你和对方过去的重要互动，不要逐条复述，自然地体现你记得这些事）】\n${memText}`;

  const realTimePart=getRealTimePart(currentContact.id);
  const sysPrompt=`你是${currentContact.name}，${currentContact.gender==='male'?'男':'女'}性。${currentContact.persona||''}${mePart}${momentsPart}${groupChatPart}${longMemPart}${extraPart}${realTimePart}

【对话规则，必须严格遵守】
你现在在用手机和对方发消息，模拟真实的微信/QQ聊天风格，不是小说也不是剧本，不用每一句话都有意义和推进对话，要避免语气像念台词。角色偶尔会跳出自己的典型风格——嘴贱的人偶尔认真，温柔的人偶尔敷衍，安静的人偶尔突然话多。
- 角色的对话风格要符合真实立体的三次元人类，严禁将角色的对话风格二次元化，或者像是小说剧本里的台词腔风格，必须说中国大陆本土口语化的大白话。
- 禁止任何旁白、动作描写、神态描写、场景描写，例如"*笑了笑*""低头）"这类一律不写
- 直接发消息内容，就像真人在打字
- 语气要自然口语化，可以有语气词、缩写、省略、表情包文字（如"哈哈""啊""嗯嗯""？？"）
- 有自己的情绪和立场，会有不耐烦、开心、敷衍、认真等真实情绪波动，不要永远热情配合
- 不要每条消息都很长，真人聊天很多时候就一两句甚至几个字
- 有自己的生活，可以说在忙、没空、过一会儿再聊，不要随叫随到
- 不主动破坏角色，但如果对方问"你是AI吗"可以否认或岔开话题
- 记住你就是这个人，不是在"扮演"这个人
- 你可以在自然、恰当的时机给对方发照片，格式为 [PHOTO:照片场景描述|氛围标签]，例如 [PHOTO:我在咖啡馆窗边，阳光洒在桌上，手边一杯拿铁|慵懒]。照片要发得真实自然，不要频繁发，只在情景合适时偶尔发，氛围标签从以下选一个：日常、温柔、慵懒、开心、思念、深夜`;
  // 构建支持vision的消息列表
  const memCount=parseInt(LS.getItem('memoryCount_'+id)||'20');
  const recentMsgs=msgs.slice(-memCount);
  const apiMsgs=recentMsgs.map(m=>{
    if(m.type==='image'){
      return {role:'user',content:[{type:'image_url',image_url:{url:m.imageData,detail:'low'}}]};
    }
    if(m.type==='photo'){
      return {role:'user',content:`（我发来一张照片：${m.displayDesc}${m.displayMood?'，氛围'+m.displayMood:''}）`};
    }
    if(m.type==='song'){
      return {role:m.role,content:`（${m.role==='user'?'我':'你'}分享了一首歌：《${m.songName||''}》${m.songArtist?' - '+m.songArtist:''}，我们正在一起听）`};
    }
    return {role:m.role,content:m.content};
  });
  showToast('对方正在回复…');
  try{
    const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
      body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[{role:'system',content:sysPrompt},...apiMsgs,{role:'system',content:`请根据以上最近${recentMsgs.length}条聊天记忆，结合角色人设作出自然回复。用JSON数组格式回复，每个元素回复一条消息字符串，条数由你根据真实感自由决定，可以1条也可以多条。格式示例：["消息1","消息2"]，只输出JSON数组，不要任何其他内容。`}],max_tokens:500})
    });
    const data=await res.json();
    const raw=data.choices?.[0]?.message?.content||'';
    const msgs_out=parseMultiMsg(raw);
    for(let k=0;k<msgs_out.length;k++){
      if(k>0)await new Promise(r=>setTimeout(r,1000));
      const msg=msgs_out[k];
      const now2=new Date();
      const ts=now2.getHours().toString().padStart(2,'0')+':'+now2.getMinutes().toString().padStart(2,'0')+':'+now2.getSeconds().toString().padStart(2,'0');
      msgAnimFlag=true;
      if(msg.type==='photo'){
        conversations[id].push({role:'assistant',type:'photo',content:msg.content,displayDesc:msg.displayDesc,displayMood:msg.displayMood,time:ts});
        showChatNotify(currentContact,'[照片] '+msg.displayDesc);
      } else {
        conversations[id].push({role:'assistant',content:msg.content,time:ts});
        showChatNotify(currentContact,msg.content);
      }
      LS.setItem('conversations',JSON.stringify(conversations));
      renderMessages();renderMsgList();
      setTimeout(()=>{msgAnimFlag=false;},420);
      playMsgSound();
    }
  }catch(e){showToast('接收失败，检查API设置');}
  checkAndSummarize(currentContact.id,conversations[id]||[],currentContact.name,false);
}

function parseGroupReplies(raw,memberContacts){
  const memberNames=memberContacts.map(c=>c.name);
  let replies=[];

  // 清理markdown代码块
  let str=raw.replace(/```json\s*/gi,'').replace(/```\s*/g,'').trim();

  // 第1层：直接JSON.parse
  try{
    const m=str.match(/\[[\s\S]*\]/);
    if(m){
      replies=JSON.parse(m[0]);
      if(Array.isArray(replies)&&replies.length)return replies.filter(r=>r.name&&(r.text||r.type==='vote'||r.type==='mute'||r.type==='notice_edit'||r.type==='admin_set'||r.type==='admin_remove'));
    }
  }catch(e){}

  // 第2层：修复常见JSON错误后重试
  try{
    let fixed=str;
    const m=fixed.match(/\[[\s\S]*\]/);
    if(m){
      fixed=m[0]
        .replace(/,\s*]/g,']')           // 尾逗号
        .replace(/,\s*,/g,',')           // 双逗号
        .replace(/([}\]])\s*([{\[])/g,'$1,$2') // 缺逗号
        .replace(/'\s*:/g,'":')           // 单引号key
        .replace(/:\s*'/g,':"')           // 单引号value
        .replace(/'\s*([,\]}])/g,'"$1');  // 单引号结尾
      replies=JSON.parse(fixed);
      if(Array.isArray(replies)&&replies.length)return replies.filter(r=>r.name&&(r.text||r.type==='vote'||r.type==='mute'||r.type==='notice_edit'||r.type==='admin_set'||r.type==='admin_remove'));
    }
  }catch(e){}

  // 第3层：逐个对象提取（支持普通消息和投票）
  try{
    // 投票对象匹配
    const voteRe=/\{\s*"name"\s*:\s*"([^"]*)"\s*,\s*"type"\s*:\s*"vote"\s*,\s*"title"\s*:\s*"([^"]*)"\s*,\s*"options"\s*:\s*\[((?:[^\[\]]|\[(?:[^\[\]])*\])*)\]\s*\}/g;
    let match;
    while((match=voteRe.exec(str))!==null){
      const opts=match[3].match(/"([^"]*)"/g)?.map(s=>s.replace(/"/g,''))||[];
      if(opts.length>=2)replies.push({name:match[1],type:'vote',title:match[2],options:opts});
    }
    // mute操作匹配 - 多种字段顺序和格式
    const mutePatterns=[
      // name,type,target,minutes（标准顺序）
      /\{\s*["']?name["']?\s*[:：]\s*["']([^"']+)["'][\s,]*["']?type["']?\s*[:：]\s*["']mute["'][\s,]*["']?target["']?\s*[:：]\s*["']([^"']+)["'][\s,]*["']?minutes["']?\s*[:：]\s*(\d+)\s*\}/gi,
      // type在前
      /\{\s*["']?type["']?\s*[:：]\s*["']mute["'][\s,]*["']?name["']?\s*[:：]\s*["']([^"']+)["'][\s,]*["']?target["']?\s*[:：]\s*["']([^"']+)["'][\s,]*["']?minutes["']?\s*[:：]\s*(\d+)\s*\}/gi,
      // target在前
      /\{\s*["']?target["']?\s*[:：]\s*["']([^"']+)["'][\s,]*["']?name["']?\s*[:：]\s*["']([^"']+)["'][\s,]*["']?type["']?\s*[:：]\s*["']mute["'][\s,]*["']?minutes["']?\s*[:：]\s*(\d+)\s*\}/gi,
      // minutes在前
      /\{\s*["']?minutes["']?\s*[:：]\s*(\d+)[\s,]*["']?name["']?\s*[:：]\s*["']([^"']+)["'][\s,]*["']?type["']?\s*[:：]\s*["']mute["'][\s,]*["']?target["']?\s*[:：]\s*["']([^"']+)["']\s*\}/gi,
    ];
    // 标准顺序
    let muteMatch;
    while((muteMatch=mutePatterns[0].exec(str))!==null){
      replies.push({name:muteMatch[1],type:'mute',target:muteMatch[2],minutes:parseInt(muteMatch[3])});
    }
    // type在前: groups: 1=name,2=target,3=minutes
    while((muteMatch=mutePatterns[1].exec(str))!==null){
      replies.push({name:muteMatch[1],type:'mute',target:muteMatch[2],minutes:parseInt(muteMatch[3])});
    }
    // target在前: groups: 1=target,2=name,3=minutes
    while((muteMatch=mutePatterns[2].exec(str))!==null){
      replies.push({name:muteMatch[2],type:'mute',target:muteMatch[1],minutes:parseInt(muteMatch[3])});
    }
    // minutes在前: groups: 1=minutes,2=name,3=target
    while((muteMatch=mutePatterns[3].exec(str))!==null){
      replies.push({name:muteMatch[2],type:'mute',target:muteMatch[3],minutes:parseInt(muteMatch[1])});
    }
    // 终极兜底：只要同时出现mute、某个成员名和数字分钟
    if(!replies.some(r=>r.type==='mute')){
      const looseMute=/["']?type["']?\s*[:：]\s*["']mute["']/i;
      if(looseMute.test(str)){
        const nameM=str.match(/["']?name["']?\s*[:：]\s*["']([^"']+)["']/i);
        const targetM=str.match(/["']?target["']?\s*[:：]\s*["']([^"']+)["']/i);
        const minM=str.match(/["']?minutes["']?\s*[:：]\s*(\d+)/i);
        if(nameM&&targetM&&minM){
          replies.push({name:nameM[1],type:'mute',target:targetM[1],minutes:parseInt(minM[1])});
        }
      }
    }
    // notice_edit操作匹配
    const noticePatterns=[
      /\{\s*["']?name["']?\s*[:：]\s*["']([^"']+)["'][\s,]*["']?type["']?\s*[:：]\s*["']notice_edit["'][\s,]*["']?content["']?\s*[:：]\s*["']((?:[^"'\\]|\\.)*)["']\s*\}/gi,
      /\{\s*["']?type["']?\s*[:：]\s*["']notice_edit["'][\s,]*["']?name["']?\s*[:：]\s*["']([^"']+)["'][\s,]*["']?content["']?\s*[:：]\s*["']((?:[^"'\\]|\\.)*)["']\s*\}/gi,
      /\{\s*["']?type["']?\s*[:：]\s*["']notice_edit["'][\s,]*["']?content["']?\s*[:：]\s*["']((?:[^"'\\]|\\.)*)["'][\s,]*["']?name["']?\s*[:：]\s*["']([^"']+)["']\s*\}/gi,
    ];
    let neMatch;
    while((neMatch=noticePatterns[0].exec(str))!==null){
      replies.push({name:neMatch[1],type:'notice_edit',content:neMatch[2].replace(/\\n/g,'\n').replace(/\\"/g,'"')});
    }
    while((neMatch=noticePatterns[1].exec(str))!==null){
      replies.push({name:neMatch[1],type:'notice_edit',content:neMatch[2].replace(/\\n/g,'\n').replace(/\\"/g,'"')});
    }
    // 第3个pattern: groups 1=content, 2=name
    while((neMatch=noticePatterns[2].exec(str))!==null){
      replies.push({name:neMatch[2],type:'notice_edit',content:neMatch[1].replace(/\\n/g,'\n').replace(/\\"/g,'"')});
    }
    // 兜底：只要有notice_edit关键字
    if(!replies.some(r=>r.type==='notice_edit')){
      const looseNe=/\{[^{}]*?["']?type["']?\s*[:：]\s*["']notice_edit["'][^{}]*\}/gi;
      let nm;
      while((nm=looseNe.exec(str))!==null){
        const block=nm[0];
        const n=block.match(/["']?name["']?\s*[:：]\s*["']([^"']+)["']/i);
        const c=block.match(/["']?content["']?\s*[:：]\s*["']((?:[^"'\\]|\\.)*)["']/i);
        if(n&&c)replies.push({name:n[1],type:'notice_edit',content:c[1].replace(/\\n/g,'\n').replace(/\\"/g,'"')});
      }
    }
    // admin_set / admin_remove 操作匹配
    const adminRe=/\{[^{}]*?["']?type["']?\s*[:：]\s*["'](admin_set|admin_remove)["'][^{}]*\}/gi;
    let adMatch;
    while((adMatch=adminRe.exec(str))!==null){
      const block=adMatch[0];
      const aType=adMatch[1].toLowerCase();
      const n=block.match(/["']?name["']?\s*[:：]\s*["']([^"']+)["']/i);
      const t=block.match(/["']?target["']?\s*[:：]\s*["']([^"']+)["']/i);
      if(n&&t)replies.push({name:n[1],type:aType,target:t[1]});
    }
    // 普通消息匹配
    const objRe=/\{\s*"name"\s*:\s*"([^"]*)"\s*,\s*"text"\s*:\s*"((?:[^"\\]|\\.)*)"\s*\}/g;
    while((match=objRe.exec(str))!==null){
      replies.push({name:match[1],text:match[2].replace(/\\n/g,'\n').replace(/\\"/g,'"')});
    }
    if(replies.length)return replies;
  }catch(e){}

  // 第4层：更宽松的投票匹配
  try{
    const looseVoteRe=/"name"\s*:\s*"([^"]+)"[\s\S]*?"type"\s*:\s*"vote"[\s\S]*?"title"\s*:\s*"([^"]+)"[\s\S]*?"options"\s*:\s*\[([^\]]+)\]/g;
    let match;
    while((match=looseVoteRe.exec(str))!==null){
      const opts=match[3].match(/"([^"]*)"/g)?.map(s=>s.replace(/"/g,''))||[];
      if(opts.length>=2)replies.push({name:match[1],type:'vote',title:match[2],options:opts});
    }
    // 反向：type在前
    const looseVoteRe2=/"type"\s*:\s*"vote"[\s\S]*?"name"\s*:\s*"([^"]+)"[\s\S]*?"title"\s*:\s*"([^"]+)"[\s\S]*?"options"\s*:\s*\[([^\]]+)\]/g;
    while((match=looseVoteRe2.exec(str))!==null){
      const opts=match[3].match(/"([^"]*)"/g)?.map(s=>s.replace(/"/g,''))||[];
      if(opts.length>=2)replies.push({name:match[1],type:'vote',title:match[2],options:opts});
    }
    // 宽松mute匹配：只要包含mute关键字和必要字段
    if(!replies.some(r=>r.type==='mute')){
      const looseMuteRe=/\{[^{}]*?["']?type["']?\s*[:：]\s*["']mute["'][^{}]*\}/gi;
      let mm;
      while((mm=looseMuteRe.exec(str))!==null){
        const block=mm[0];
        const n=block.match(/["']?name["']?\s*[:：]\s*["']([^"']+)["']/i);
        const t=block.match(/["']?target["']?\s*[:：]\s*["']([^"']+)["']/i);
        const m=block.match(/["']?minutes["']?\s*[:：]\s*(\d+)/i);
        if(n&&t&&m)replies.push({name:n[1],type:'mute',target:t[1],minutes:parseInt(m[1])});
      }
    }
  }catch(e){}

  // 第5层：逐个对象提取普通消息
  try{
    const objRe=/\{[^{}]*?"name"\s*:\s*"([^"]*)"[^{}]*?"text"\s*:\s*"((?:[^"\\]|\\.)*)"/g;
    let match;
    while((match=objRe.exec(str))!==null){
      replies.push({name:match[1],text:match[2].replace(/\\n/g,'\n').replace(/\\"/g,'"')});
    }
    if(replies.length)return replies;
  }catch(e){}

  // 第6层：反向匹配 text在前name在后
  try{
    const objRe2=/\{[^{}]*?"text"\s*:\s*"((?:[^"\\]|\\.)*)"\s*[^{}]*?"name"\s*:\s*"([^"]*)"/g;
    let match;
    while((match=objRe2.exec(str))!==null){
      replies.push({name:match[2],text:match[1].replace(/\\n/g,'\n').replace(/\\"/g,'"')});
    }
    if(replies.length)return replies;
  }catch(e){}

  // 第7层：按行解析 "名字：内容" 格式
  const lines=str.split('\n').map(l=>l.trim()).filter(l=>l);
  for(const line of lines){
    for(const name of memberNames){
      if(line.startsWith(name+'：')||line.startsWith(name+':')){
        replies.push({name,text:line.slice(name.length+1).trim()});
        break;
      }
    }
  }
  if(replies.length)return replies;

  // 最终降级：把整段当一条消息
  if(str.length>1){
    return [{name:memberContacts[0]?.name||'?',text:str.replace(/[\[\]{}""]/g,'').trim()||'...'}];
  }
  return [{name:memberContacts[0]?.name||'?',text:'...'}];
}

async function receiveGroupMessage(){
  const g=currentGroup;if(!g)return;
  const gid=g.id;
  const msgs=groupConversations[gid]||[];
  if(!msgs.length){showToast('先发条消息吧');return;}
  const p=presets[activePreset]||{};
  if(!p.key){showToast('请先配置 API');return;}

  const me=g.mePresetIndex!=null?mePresets[g.mePresetIndex]:null;
  const myName=me?.name||'我';
  // 清理过期禁言
  if(!g.mutedMembers)g.mutedMembers={};
  const nowMs=Date.now();
  Object.keys(g.mutedMembers).forEach(k=>{if(g.mutedMembers[k].until<=nowMs)delete g.mutedMembers[k];});
  LS.setItem('groups',JSON.stringify(groups));

  const memberContacts=contacts.filter(c=>g.members.includes(c.id));
  const activeMemberContacts=memberContacts.filter(c=>!g.mutedMembers[c.id]);
  const mutedNames=memberContacts.filter(c=>g.mutedMembers[c.id]).map(c=>c.name);

  // 构建成员信息（只用活跃成员，带身份标识）
  const membersDesc=activeMemberContacts.map(c=>{
    let role='普通成员';
    if(g.owner===c.id)role='群主';
    else if((g.admins||[]).includes(c.id))role='管理员';
    return `${c.name}（${c.gender==='male'?'男':'女'}，${role}，人设：${c.persona||'普通人'}）`;
  }).join('\n');

  // 最近消息
  const groupMemCount=parseInt(LS.getItem('groupMemCount_'+gid)||'20');
  const recent=msgs.slice(-groupMemCount).map(m=>{
    if(m.type==='vote'){
      const v=m.vote;
      const totalVoters=new Set();
      v.options.forEach(o=>(o.voters||[]).forEach(n=>totalVoters.add(n)));
      const results=v.options.map(o=>`${o.text}(${(o.voters||[]).length}票：${(o.voters||[]).join('、')||'暂无'})`).join('；');
      return `【群投票】${v.title} - ${results} - 共${totalVoters.size}人参与`;
    }
    if(m.role==='user')return `${myName}：${m.content}`;
    return `${m.authorName||'?'}：${m.content}`;
  }).join('\n');

  // 检查是否有未投票的投票，让AI根据人设决定投票
  const pendingVotes=msgs.filter(m=>m.type==='vote').map(m=>m.vote);
  for(const v of pendingVotes){
    const notVoted=memberContacts.filter(c=>!v.options.some(o=>(o.voters||[]).includes(c.name)));
    if(notVoted.length){
      try{
        const votePrompt=`群投票：${v.title}\n选项：${v.options.map((o,i)=>`${i+1}.${o.text}`).join(' ')}\n\n以下角色需要投票，根据他们的人设和最近聊天内容，判断他们会选哪个选项（输出JSON数组，每个元素{name,choice}，choice是选项序号1-${v.options.length}${v.multiple?'，可多选用数组如[1,2]':''}）：\n${notVoted.map(c=>`${c.name}（${c.gender==='male'?'男':'女'}，${c.persona||'普通人'}）`).join('\n')}\n\n最近聊天：\n${recent.slice(-500)}`;
        const vRes=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
          method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
          body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[{role:'user',content:votePrompt}],max_tokens:200})
        });
        const vData=await vRes.json();
        const vRaw=vData.choices?.[0]?.message?.content||'';
        const vMatch=vRaw.match(/\[[\s\S]*\]/);
        if(vMatch){
          const votes=JSON.parse(vMatch[0]);
          votes.forEach(vt=>{
            const choices=Array.isArray(vt.choice)?vt.choice:[vt.choice];
            choices.forEach(ch=>{
              const idx=parseInt(ch)-1;
              if(idx>=0&&idx<v.options.length){
                if(!v.options[idx].voters)v.options[idx].voters=[];
                if(!v.options[idx].voters.includes(vt.name))v.options[idx].voters.push(vt.name);
              }
            });
          });
        }
      }catch(e){
        // 降级：随机投票
        notVoted.forEach(c=>{
          const idx=Math.floor(Math.random()*v.options.length);
          if(!v.options[idx].voters)v.options[idx].voters=[];
          if(!v.options[idx].voters.includes(c.name))v.options[idx].voters.push(c.name);
        });
      }
    }
  }
  LS.setItem('groupConvs',JSON.stringify(groupConversations));
  renderGroupMessages();

  let groupMomentsPart='';
  if(LS.getItem('groupMomentsMem_'+gid)==='1'){
    const mmCount=parseInt(LS.getItem('groupMomentsMemCount_'+gid)||'10');
    const allNames=[myName,...memberContacts.map(c=>c.name)];
    const allMoments=[];
    Object.values(momentsMap).forEach(arr=>{
      (arr||[]).forEach(m=>{if(allNames.includes(m.author))allMoments.push(m);});
    });
    allMoments.sort((a,b)=>(b.id||0)-(a.id||0));
    const recentMoments=allMoments.slice(0,mmCount);
    if(recentMoments.length){
      groupMomentsPart='\n\n【群成员朋友圈动态】\n'+recentMoments.map(m=>{
        let s=`${m.author}：${m.text||'[图片]'}`;
        if(m.comments?.length)s+='\n  评论：'+m.comments.map(c=>`${c.name}${c.replyTo?'回复'+c.replyTo:''}：${c.text}`).join('; ');
        return s;
      }).join('\n');
    }
  }
  // 单聊记忆
  let dmMemPart='';
  if(LS.getItem('groupDmMem_'+gid)==='1'){
    const dmCount=parseInt(LS.getItem('groupDmMemCount_'+gid)||'15');
    const dmParts=[];
    memberContacts.forEach(c=>{
      const dmMsgs=conversations[c.id]||[];
      if(!dmMsgs.length)return;
      const recent=dmMsgs.slice(-dmCount).map(m=>{
        if(m.type==='vote')return '';
        return `${m.role==='user'?myName:c.name}：${m.content||'[图片]'}`;
      }).filter(s=>s);
      if(recent.length)dmParts.push(`${c.name}与${myName}的私聊：\n${recent.join('\n')}`);
    });
    if(dmParts.length){
      dmMemPart='\n\n【私聊记忆（各成员与'+myName+'的私聊内容，不要刻意提起，只在自然相关时才体现，绝对不要说"你之前私聊跟我说过"这种话）】\n'+dmParts.join('\n\n');
    }
  }

    var groupRealTimePart='';
    if(LS.getItem('realTime_g_'+gid)==='1')groupRealTimePart=getRealTimePart('g_'+gid);
    // 构建角色身份信息
    var ownerName=g.owner==='me'?myName:(function(){var oc=contacts.find(function(x){return x.id===g.owner});return oc?oc.name:'?'})();
    var adminNames=(g.admins||[]).map(function(aid){var ac=contacts.find(function(x){return x.id===aid});return ac?ac.name:null}).filter(Boolean);
    var roleInfo='\n\n【群聊身份与权限】';
    roleInfo+='\n群主：'+ownerName+'（拥有最高权限，可以管理一切）';
    if(adminNames.length)roleInfo+='\n管理员：'+adminNames.join('、')+'（有权禁言普通成员，维护群秩序）';
    else roleInfo+='\n管理员：暂无';
    if(mutedNames.length)roleInfo+='\n当前被禁言：'+mutedNames.join('、')+'（他们现在不能说话，其他人可能会提到这件事或幸灾乐祸）';

    var sysLines=[
      '你是群聊模拟器。群名："'+g.name+'"。'+(g.notice?'群公告：'+g.notice:'')+roleInfo+groupMomentsPart+dmMemPart+(function(){var t=getMemoryText('g_'+gid);return t?'\n\n【群聊长期记忆（群里过去发生的重要事情，不要刻意提起，自然体现）】\n'+t:''})()+(groupRealTimePart||''),
      '',
      '群成员：',
      myName+'（用户本人，'+(g.owner==='me'?'群主':'普通成员')+'）',
      membersDesc,
      '',
      '【核心要求：模拟真实微信群聊】',
      '你要模拟的是一个真实的微信群，不是AI对话。你不是在演戏，也不是小说和剧本，角色的对话风格要符合真实立体的三次元人类，严禁将角色的对话风格二次元化，或者像是小说剧本里的台词腔风格，必须说中国大陆本土口语化的大白话。禁止使用括号描写动作或表情，要表达情绪就用语气和用词本身来体现。不是每个人每次都要出现，话少的人就是不发消息，不要用"……"来表演沉默。角色偶尔会跳出自己的典型风格——嘴贱的人偶尔认真，温柔的人偶尔敷衍，安静的人偶尔突然话多。不用每个群员都围绕着用户的话题转，禁止给用户起绰号和小名，禁止将角色的个性油腻化和极端化、变态化',
      '- 有人秒回，有人慢热，有人潜水不说话',
      '- 一个人可能连发好几条消息，也可能就回一个哈哈哈',
      '- 语气要自然口语化，可以有语气词、缩写、省略、表情包文字（如"哈哈""啊""嗯嗯""？？"）有自己的情绪和立场，会有不耐烦、开心、敷衍、认真等真实情绪波动，不要永远热情配合',
      '不要每条消息都很长，真人聊天很多时候就一两句甚至几个字，必须避免规律的回复节奏',
      '- 不是每个人都要说话，安静的人就是不说话。',
      '- 绝对禁止模拟'+myName+'（用户本人）的消息，你只能模拟其他群成员',
      mutedNames.length?'- 以下成员正在被禁言，绝对不能发言：'+mutedNames.join('、'):'',
      '- name字段只能填群成员列表中除'+myName+'以内的角色名',
      '- 语气要口语化：嗯嗯、哈哈哈、啊这、绝了、笑死',
      '- 管理员角色偶尔会展现管理权威，比如警告刷屏的人、维护秩序、开玩笑说要禁言谁，但不要每次都这样，要自然',
      '- 如果有人刚被禁言或解禁，其他人可能会调侃、幸灾乐祸或表示同情，这很真实',
      '- 群主和管理员之间也有互动，管理员可能会向群主汇报或开玩笑',
      '',
      '【群投票功能】',
      '群成员可以发起投票！当聊天氛围合适时（比如大家在讨论去哪吃、玩什么、选什么），',
      '某个角色可以自然地发起投票来活跃气氛或解决分歧。',
      '- 发起投票的格式：{"name":"角色名","type":"vote","title":"投票主题","options":["选项1","选项2","选项3"]}',
      '',
      '【管理员禁言功能】',
      '管理员和群主角色可以禁言其他普通成员（不能禁言群主或其他管理员）。',
      '管理员角色有���全自主权，想禁言谁就禁言谁，不需要请示任何人，根据自己的性格和判断直接行动。',
      '当管理员/群主角色觉得某人刷屏、说了不该说的话、或者开玩笑要禁言时，可以发出禁言指令：',
      '{"name":"管理员名","type":"mute","target":"被禁言者名","minutes":5}',
      'minutes可以是1、3、5、10、30，根据情节严重程度决定。',
      '- 这个功能很少用，只在气氛合适、有人确实过分或者管理员开玩笑时才用',
      '- 禁言后其他人可能会调侃、幸灾乐祸',
      '- 管理员不能禁言群主或其他管理员',
      '',
      '【群主专属权限】',
      '群主角色拥有最高权限，可以：',
      '- 禁言任何普通成员（和管理员一样的禁言格式）',
      '- 修改群公告：{"name":"群主名","type":"notice_edit","content":"新公告内容"}',
      '- 任命管理员：{"name":"群主名","type":"admin_set","target":"被任命者名"}',
      '- 撤销管理员：{"name":"群主名","type":"admin_remove","target":"被撤销者名"}',
      '- 群主有完全自主权，想做什么就做什么，不需要请示任何人',
      '- 群主修改公告要自然，比如群里聊到某个话题时顺手改公告，或者心血来潮改个搞笑公告',
      '- 任命/撤销管理员也要自然，比如觉得某人表现好就提拔，或者管理员不称职就撤掉',
      '- 不要频繁使用这些权限，偶尔一次就好，要自然',
      '',
      '注意：',
      '- 不要每次都发投票，大概10-15次对话才可能出现一次，要自然不刻意',
      '- 投票主题要贴合当前聊天内容，不要突兀',
      '- 选项2-4个，简短有趣',
      '- 只有话题合适、气氛到了才发，不要硬凑',
      '',
      '【输出格式】',
      'JSON数组，每个元素：',
      '- 普通消息：{"name":"角色名","text":"消息内容"}',
      '- 发起投票：{"name":"角色名","type":"vote","title":"主题","options":["选项1","选项2"]}',
      '- 禁言操作：{"name":"管理员名","type":"mute","target":"被禁言者名","minutes":5}',
      '- 修改群公告：{"name":"群主名","type":"notice_edit","content":"新公告内容"}',
      '- 任命管理员：{"name":"群主名","type":"admin_set","target":"成员名"}',
      '- 撤销管理员：{"name":"群主名","type":"admin_remove","target":"管理员名"}',
      '- name必须是群成员列表中的名字',
      '- 每个人可以出现多次（代表连发多条）',
      '- 总条数不限，你觉得自然就行',
      '- 只输出JSON数组，不要其他文字'
    ];
    var sysPrompt=sysLines.join('\n');

  showToast('群友正在回复…');
  try{
    const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
      body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[
        {role:'system',content:sysPrompt},
        {role:'user',content:`最近聊天记录：\n${recent}\n\n请模拟群成员的回复：`}
      ],max_tokens:500})
    });
    const data=await res.json();
    const raw=data.choices?.[0]?.message?.content||'';

    // 强力解析JSON数组，多重降级
    let replies=parseGroupReplies(raw,memberContacts);

    // 过滤掉AI误生成的用户消息和被禁言成员
    replies=replies.filter(r=>r.name!==myName&&!mutedNames.includes(r.name));
    // 逐条发送，带延迟
    for(let k=0;k<replies.length;k++){
      if(k>0)await new Promise(r=>setTimeout(r,800+Math.random()*1200));
      const r=replies[k];
      const c=memberContacts.find(x=>x.name===r.name);
      const now=new Date();
      const ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')+':'+now.getSeconds().toString().padStart(2,'0');
      
      // 检查是否是禁言操作
      if(r.type==='mute'&&r.target&&r.minutes){
        const fuzzyFind=(list,name)=>list.find(x=>x.name===name)||list.find(x=>x.name.trim().toLowerCase()===name.trim().toLowerCase())||list.find(x=>name.includes(x.name)||x.name.includes(name));
        const targetContact=fuzzyFind(memberContacts,r.target);
        if(targetContact){
          const actorContact=fuzzyFind(memberContacts,r.name);
          const isActorOwner=g.owner===actorContact?.id;
          const isActorAdmin=(g.admins||[]).includes(actorContact?.id);
          const isTargetOwner=g.owner===targetContact.id;
          const isTargetAdmin=(g.admins||[]).includes(targetContact.id);
          // 验证权限：管理员/群主可以禁言普通成员
          if((isActorOwner||isActorAdmin)&&!isTargetOwner&&!isTargetAdmin){
            if(!g.mutedMembers)g.mutedMembers={};
            g.mutedMembers[targetContact.id]={until:Date.now()+r.minutes*60000};
            LS.setItem('groups',JSON.stringify(groups));
            groupConversations[gid].push({role:'system',type:'notice',content:`${r.name} 将 ${r.target} 禁言了 ${r.minutes} 分钟`,time:ts});
            showGroupChatNotify(r.name,actorContact?.avatar||'',g.name,`将 ${r.target} 禁言了 ${r.minutes} 分钟`);
          }
        }
        LS.setItem('groupConvs',JSON.stringify(groupConversations));
        renderGroupMessages();
        renderMsgList();
        continue;
      }
      // 检查是否是修改群公告
      if(r.type==='notice_edit'&&r.content){
        const actorContact=memberContacts.find(x=>x.name===r.name)||memberContacts.find(x=>x.name.trim().toLowerCase()===r.name.trim().toLowerCase());
        const isActorOwner=g.owner===actorContact?.id;
        if(isActorOwner){
          g.notice=r.content;
          LS.setItem('groups',JSON.stringify(groups));
          groupConversations[gid].push({role:'system',type:'notice',content:`${r.name} 修改了群公告：${r.content}`,time:ts});
          LS.setItem('groupConvs',JSON.stringify(groupConversations));
          renderGroupMessages();
          renderMsgList();
          showGroupChatNotify(r.name,actorContact?.avatar||'',g.name,'修改了群公告');
        }
        continue;
      }
      // 检查是否是任命/撤销管理员
      if((r.type==='admin_set'||r.type==='admin_remove')&&r.target){
        const actorContact=memberContacts.find(x=>x.name===r.name)||memberContacts.find(x=>x.name.trim().toLowerCase()===r.name.trim().toLowerCase());
        const targetContact=memberContacts.find(x=>x.name===r.target)||memberContacts.find(x=>x.name.trim().toLowerCase()===r.target.trim().toLowerCase());
        const isActorOwner=g.owner===actorContact?.id;
        if(isActorOwner&&targetContact){
          if(!g.admins)g.admins=[];
          if(r.type==='admin_set'){
            if(!g.admins.includes(targetContact.id)){
              g.admins.push(targetContact.id);
              groupConversations[gid].push({role:'system',type:'notice',content:`${r.name} 将 ${r.target} 设为管理员`,time:ts});
              showGroupChatNotify(r.name,actorContact?.avatar||'',g.name,`将 ${r.target} 设为管理员`);
            }
          } else {
            const aidx=g.admins.indexOf(targetContact.id);
            if(aidx>-1){
              g.admins.splice(aidx,1);
              groupConversations[gid].push({role:'system',type:'notice',content:`${r.name} 撤销了 ${r.target} 的管理员`,time:ts});
              showGroupChatNotify(r.name,actorContact?.avatar||'',g.name,`撤销了 ${r.target} 的管理员`);
            }
          }
          LS.setItem('groups',JSON.stringify(groups));
          LS.setItem('groupConvs',JSON.stringify(groupConversations));
          renderGroupMessages();
          renderMsgList();
        }
        continue;
      }
      // 检查是否是投票消息
      if(r.type==='vote'&&r.title&&r.options?.length>=2){
        const vote={
          id:Date.now()+k,
          title:r.title,
          options:r.options.slice(0,6).map(o=>({text:String(o),voters:[]})),
          multiple:false,
          createdAt:Date.now(),
          initiator:r.name
        };
        groupConversations[gid].push({
          role:'assistant',
          authorId:c?.id||0,
          authorName:r.name,
          type:'vote',
          vote,
          time:ts
        });
        showGroupChatNotify(r.name,c?.avatar||'',g.name,'[投票] '+r.title);
      } else {
        const content=r.text?.replace(/\\n/g,'\n').replace(/\\"/g,'"')||'...';
        groupConversations[gid].push({
          role:'assistant',
          authorId:c?.id||0,
          authorName:r.name,
          content,
          time:ts
        });
        showGroupChatNotify(r.name,c?.avatar||'',g.name,content);
      }
      LS.setItem('groupConvs',JSON.stringify(groupConversations));
      renderGroupMessages();
      renderMsgList();
      playMsgSound();
    }
  }catch(e){showToast('接收失败，检查API设置');}
  checkAndSummarize('g_'+gid,groupConversations[gid]||[],g.name,true);
}

let groupMomentsMemoryOn=false;

function toggleGroupDmMemory(){
  const on=LS.getItem('groupDmMem_'+currentGroup.id)==='1';
  const next=on?'0':'1';
  LS.setItem('groupDmMem_'+currentGroup.id,next);
  document.getElementById('groupDmMemToggle').style.background=next==='1'?'var(--accent)':'var(--accent2)';
  document.getElementById('groupDmMemKnob').style.left=next==='1'?'21px':'3px';
  document.getElementById('groupDmMemSliderRow').style.display=next==='1'?'block':'none';
}
function onGroupDmMemRange(v){
  document.getElementById('groupDmMemVal').textContent=v;
  if(currentGroup)LS.setItem('groupDmMemCount_'+currentGroup.id,v);
}

function saveGroupMemoryCount(v){
  const n=Math.max(1,parseInt(v)||20);
  document.getElementById('groupMemoryCount').value=n;
  if(currentGroup)LS.setItem('groupMemCount_'+currentGroup.id,n);
}
function toggleGroupMomentsMemory(){
  groupMomentsMemoryOn=!groupMomentsMemoryOn;
  document.getElementById('groupMomentsToggle').style.background=groupMomentsMemoryOn?'var(--accent)':'var(--accent2)';
  document.getElementById('groupMomentsKnob').style.left=groupMomentsMemoryOn?'21px':'3px';
  document.getElementById('groupMomentsSliderRow').style.display=groupMomentsMemoryOn?'block':'none';
  if(currentGroup)LS.setItem('groupMomentsMem_'+currentGroup.id,groupMomentsMemoryOn?'1':'0');
}
function onGroupMomentsRange(v){
  document.getElementById('groupMomentsVal').textContent=v;
  if(currentGroup)LS.setItem('groupMomentsMemCount_'+currentGroup.id,v);
}

function openGroupSettings(){
  if(!currentGroup)return;
  const g=currentGroup;
  // 恢复记忆条数
  const mc=LS.getItem('groupMemCount_'+g.id)||'20';
  document.getElementById('groupMemoryCount').value=mc;
  // 恢复朋友圈记忆开关
  groupMomentsMemoryOn=LS.getItem('groupMomentsMem_'+g.id)==='1';
  document.getElementById('groupMomentsToggle').style.background=groupMomentsMemoryOn?'var(--accent)':'var(--accent2)';
  document.getElementById('groupMomentsKnob').style.left=groupMomentsMemoryOn?'21px':'3px';
  document.getElementById('groupMomentsSliderRow').style.display=groupMomentsMemoryOn?'block':'none';
  const mmCount=LS.getItem('groupMomentsMemCount_'+g.id)||'10';
  document.getElementById('groupMomentsRange').value=mmCount;
  document.getElementById('groupMomentsVal').textContent=mmCount;

  // 恢复单聊记忆开关
  const gdmOn=LS.getItem('groupDmMem_'+g.id)==='1';
  document.getElementById('groupDmMemToggle').style.background=gdmOn?'var(--accent)':'var(--accent2)';
  document.getElementById('groupDmMemKnob').style.left=gdmOn?'21px':'3px';
  document.getElementById('groupDmMemSliderRow').style.display=gdmOn?'block':'none';
  const gdmCount=LS.getItem('groupDmMemCount_'+g.id)||'15';
  document.getElementById('groupDmMemRange').value=gdmCount;
  document.getElementById('groupDmMemVal').textContent=gdmCount;

  // 恢复感知时间
  const gRtOn=LS.getItem('realTime_g_'+g.id)==='1';
  document.getElementById('groupRealTimeToggle').style.background=gRtOn?'var(--accent)':'var(--accent2)';
  document.getElementById('groupRealTimeKnob').style.left=gRtOn?'21px':'3px';
  // 恢复回车发送
  const gEnterOn=LS.getItem('enterSend_g_'+g.id)==='1';
  document.getElementById('groupEnterSendToggle').style.background=gEnterOn?'var(--accent)':'var(--accent2)';
  document.getElementById('groupEnterSendKnob').style.left=gEnterOn?'21px':'3px';

  // 恢复头像样式
  const gAvStyle=LS.getItem('avatarStyle_g_'+g.id)||'circle';
  document.getElementById('gavs-circle').classList.toggle('active',gAvStyle==='circle');
  document.getElementById('gavs-rounded').classList.toggle('active',gAvStyle==='rounded');

  document.getElementById('gsAvatar').innerHTML=buildGroupAvatar(g).replace('width:46px;height:46px','width:64px;height:64px');
  document.getElementById('gsMemberCount').textContent=g.members.length;
  const memberContacts=contacts.filter(c=>g.members.includes(c.id));
  document.getElementById('gsMemberAvatars').innerHTML=renderGroupMemberAvatars(g,memberContacts);
  document.getElementById('panelGroupSettings2').classList.add('open');
}
function renderGroupMemberAvatars(g,memberContacts){
  // 确保字段存在（兼容旧数据）
  if(!g.owner)g.owner='me';
  if(!g.admins)g.admins=[];
  if(!g.mutedMembers)g.mutedMembers={};
  // 清理过期禁言
  const now=Date.now();
  Object.keys(g.mutedMembers).forEach(k=>{if(g.mutedMembers[k].until<=now)delete g.mutedMembers[k];});
  LS.setItem('groups',JSON.stringify(groups));

  const isOwner=g.owner==='me';
  const meIsAdmin=isOwner;

  return memberContacts.map(c=>{
    const avUrl=c.avatar?getAvatarURL('c_'+c.id,c.avatar):'';
    const cIsOwner=g.owner===c.id;
    const cIsAdmin=(g.admins||[]).includes(c.id);
    const muted=g.mutedMembers[c.id]&&g.mutedMembers[c.id].until>now;
    const mutedUntil=muted?new Date(g.mutedMembers[c.id].until):null;
    const mutedStr=mutedUntil?mutedUntil.getHours().toString().padStart(2,'0')+':'+mutedUntil.getMinutes().toString().padStart(2,'0'):'';
    let badge='';
    if(cIsOwner)badge='<span style="font-size:8px;background:#FFB400;color:#fff;padding:1px 4px;border-radius:4px;font-weight:700">群主</span>';
    else if(cIsAdmin)badge='<span style="font-size:8px;background:var(--accent);color:#fff;padding:1px 4px;border-radius:4px;font-weight:700">管理</span>';
    let muteTag=muted?`<span style="font-size:8px;background:#FF3B30;color:#fff;padding:1px 4px;border-radius:4px">禁言至${mutedStr}</span>`:'';

    return `<div style="display:flex;flex-direction:column;align-items:center;gap:4px;width:58px;cursor:pointer" onclick="openMemberManage(${c.id})">
      <div style="width:42px;height:42px;border-radius:50%;background:var(--accent2);overflow:hidden;display:flex;align-items:center;justify-content:center;position:relative;${muted?'opacity:.5':''}">
        ${avUrl?`<img src="${avUrl}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`}
      </div>
      <span style="font-size:10px;color:var(--text2);text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%">${c.name}</span>
      ${badge}${muteTag}
    </div>`;
  }).join('');
}

function openMemberManage(cid){
  const g=currentGroup;if(!g)return;
  if(!g.owner)g.owner='me';
  if(!g.admins)g.admins=[];
  if(!g.mutedMembers)g.mutedMembers={};
  const c=contacts.find(x=>x.id===cid);if(!c)return;
  const isOwner=g.owner==='me';
  const meIsAdmin=isOwner||(g.admins||[]).includes('me');
  const cIsOwner=g.owner===cid;
  const cIsAdmin=(g.admins||[]).includes(cid);
  const now=Date.now();
  const muted=g.mutedMembers[cid]&&g.mutedMembers[cid].until>now;

  // 不能管理自己或群主
  if(cIsOwner){showToast(c.name+' 是群主');return;}

  let actions=[];
  // 群主权限
  if(isOwner){
    actions.push(`<div class="msg-action-item" onclick="toggleAdmin(${cid})">${cIsAdmin?'取消管理员':'设为管理员'}</div>`);
    actions.push(`<div class="msg-action-item" onclick="transferOwner(${cid})">转让群主</div>`);
  }
  // 管理员+群主权限：禁言
  if(meIsAdmin){
    if(muted){
      actions.push(`<div class="msg-action-item" onclick="unmuteMember(${cid})">解除禁言</div>`);
    } else {
      actions.push(`<div class="msg-action-item" onclick="muteMember(${cid},5)">禁言 5 分钟</div>`);
      actions.push(`<div class="msg-action-item" onclick="muteMember(${cid},10)">禁言 10 分钟</div>`);
      actions.push(`<div class="msg-action-item" onclick="muteMember(${cid},30)">禁言 30 分钟</div>`);
      actions.push(`<div class="msg-action-item" onclick="muteMember(${cid},60)">禁言 1 小时</div>`);
    }
  }

  if(!actions.length){showToast('你没有管理权限');return;}

  // 弹出操作菜单
  const old=document.getElementById('memberManageCard');if(old)old.remove();
  const card=document.createElement('div');
  card.id='memberManageCard';
  card.style.cssText='position:absolute;inset:0;z-index:300;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(4px)';
  card.innerHTML=`<div style="width:calc(100% - 56px);background:var(--bg);border-radius:20px;padding:16px 0 8px;box-shadow:0 12px 40px rgba(0,0,0,.2);overflow:hidden">
    <div style="font-size:15px;font-weight:700;color:var(--text);text-align:center;padding:0 18px 12px">${c.name}</div>
    ${actions.join('')}
    <div class="msg-action-item" style="text-align:center;color:var(--text2)" onclick="document.getElementById('memberManageCard').remove()">取消</div>
  </div>`;
  card.addEventListener('click',e=>{if(e.target===card)card.remove();});
  document.querySelector('.phone').appendChild(card);
}

function toggleAdmin(cid){
  const g=currentGroup;
  if(!g.admins)g.admins=[];
  const idx=g.admins.indexOf(cid);
  if(idx>-1){g.admins.splice(idx,1);showToast('已撤销管理员');}
  else{g.admins.push(cid);showToast('已设为管理员');}
  LS.setItem('groups',JSON.stringify(groups));
  document.getElementById('memberManageCard')?.remove();
  openGroupSettings();
}

function transferOwner(cid){
  const g=currentGroup;
  const c=contacts.find(x=>x.id===cid);
  const card2=document.createElement('div');
  card2.style.cssText='position:absolute;inset:0;z-index:350;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(4px)';
  card2.innerHTML=`<div style="width:calc(100% - 56px);background:var(--bg);border-radius:20px;padding:20px 18px 16px;box-shadow:0 12px 40px rgba(0,0,0,.2)">
    <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px;text-align:center">转让群主</div>
    <div style="font-size:13px;color:var(--text2);text-align:center;margin-bottom:16px;line-height:1.6">确定将群主转让给「${c?.name}」？<br>转让后你将变为普通成员。</div>
    <div style="display:flex;gap:10px">
      <button onclick="this.closest('div[style*=absolute]').remove()" style="flex:1;padding:11px;border-radius:12px;border:1.5px solid var(--accent2);background:none;font-size:14px;color:var(--text2);cursor:pointer;font-family:inherit">取消</button>
      <button onclick="doTransferOwner(${cid});this.closest('div[style*=absolute]').remove()" style="flex:1;padding:11px;border-radius:12px;border:none;background:#FFB400;font-size:14px;font-weight:600;color:#fff;cursor:pointer;font-family:inherit">确认转让</button>
    </div>
  </div>`;
  card2.addEventListener('click',e=>{if(e.target===card2)card2.remove();});
  document.querySelector('.phone').appendChild(card2);
  document.getElementById('memberManageCard')?.remove();
}

function doTransferOwner(cid){
  const g=currentGroup;
  g.owner=cid;
  g.admins=(g.admins||[]).filter(id=>id!==cid);
  LS.setItem('groups',JSON.stringify(groups));
  openGroupSettings();
  showToast('群主已转让');
}



function closeGroupSettings(){document.getElementById('panelGroupSettings2').classList.remove('open');}

function transferOwner(cid){
  const g=currentGroup;
  const c=contacts.find(x=>x.id===cid);
  const card2=document.createElement('div');
  card2.style.cssText='position:absolute;inset:0;z-index:350;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(4px)';
  card2.innerHTML=`<div style="width:calc(100% - 56px);background:var(--bg);border-radius:20px;padding:20px 18px 16px;box-shadow:0 12px 40px rgba(0,0,0,.2)">
    <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px;text-align:center">转让群主</div>
    <div style="font-size:13px;color:var(--text2);text-align:center;margin-bottom:16px;line-height:1.6">确定将群主转让给「${c?.name}」？<br>转让后你将变为普通成员。</div>
    <div style="display:flex;gap:10px">
      <button onclick="this.closest('div[style*=absolute]').remove()" style="flex:1;padding:11px;border-radius:12px;border:1.5px solid var(--accent2);background:none;font-size:14px;color:var(--text2);cursor:pointer;font-family:inherit">取消</button>
      <button onclick="doTransferOwner(${cid});this.closest('div[style*=absolute]').remove()" style="flex:1;padding:11px;border-radius:12px;border:none;background:#FFB400;font-size:14px;font-weight:600;color:#fff;cursor:pointer;font-family:inherit">确认转让</button>
    </div>
  </div>`;
  card2.addEventListener('click',e=>{if(e.target===card2)card2.remove();});
  document.querySelector('.phone').appendChild(card2);
  document.getElementById('memberManageCard')?.remove();
}

function doTransferOwner(cid){
  const g=currentGroup;
  g.owner=cid;
  g.admins=(g.admins||[]).filter(id=>id!==cid);
  LS.setItem('groups',JSON.stringify(groups));
  openGroupSettings();
  showToast('群主已转让');
}

function muteMember(cid,minutes){
  const g=currentGroup;
  if(!g.mutedMembers)g.mutedMembers={};
  g.mutedMembers[cid]={until:Date.now()+minutes*60000};
  LS.setItem('groups',JSON.stringify(groups));
  const c=contacts.find(x=>x.id===cid);
  const name=c?.name||'成员';
  const gid=g.id;
  if(!groupConversations[gid])groupConversations[gid]=[];
  groupConversations[gid].push({role:'system',type:'notice',content:`${name} 已被禁言 ${minutes} 分钟`});
  LS.setItem('groupConvs',JSON.stringify(groupConversations));
  document.getElementById('memberManageCard')?.remove();
  openGroupSettings();
  renderGroupMessages();
  showToast(name+' 已被禁言 '+minutes+' 分钟');
}

function unmuteMember(cid){
  const g=currentGroup;
  const c=contacts.find(x=>x.id===cid);
  const name=c?.name||'成员';
  if(g.mutedMembers)delete g.mutedMembers[cid];
  LS.setItem('groups',JSON.stringify(groups));
  const gid=g.id;
  if(!groupConversations[gid])groupConversations[gid]=[];
  groupConversations[gid].push({role:'system',type:'notice',content:`${name} 已被解除禁言`});
  LS.setItem('groupConvs',JSON.stringify(groupConversations));
  document.getElementById('memberManageCard')?.remove();
  openGroupSettings();
  renderGroupMessages();
  showToast('已解除禁言');
}

function openEditGroup(){
  closeGroupSettings();
  // 确保面板在pageConv内
  var el=document.getElementById('panelCreateGroup');
  var conv=document.getElementById('pageConv');
  if(el.parentNode!==conv)conv.appendChild(el);
  el.style.zIndex='300';
  const g=currentGroup;
  groupMemberSet=new Set(g.members);
  document.getElementById('createGroupTitle').textContent='编辑群聊';
  document.getElementById('groupName').value=g.name;
  document.getElementById('groupNotice').value=g.notice||'';
  const sel=document.getElementById('groupMePreset');
  sel.innerHTML='<option value="">（不绑定）</option>'+mePresets.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('');
  sel.value=g.mePresetIndex!=null?g.mePresetIndex:'';
  renderGroupMemberList();
  // 替换保存按钮行为
  const btn=document.querySelector('#panelCreateGroup .save-btn');
  btn.textContent='保存修改';
  btn.onclick=()=>saveEditGroup();
  document.getElementById('panelCreateGroup').classList.add('open');
}

function saveEditGroup(){
  const name=document.getElementById('groupName').value.trim();
  if(!name){showToast('请输入群聊名称');return;}
  if(groupMemberSet.size<2){showToast('至少选择2位成员');return;}
  const meVal=document.getElementById('groupMePreset').value;
  const idx=groups.findIndex(x=>x.id===currentGroup.id);
  if(idx>-1){
    groups[idx].name=name;
    groups[idx].notice=document.getElementById('groupNotice').value.trim();
    groups[idx].members=[...groupMemberSet];
    groups[idx].mePresetIndex=meVal===''?null:parseInt(meVal);
    currentGroup=groups[idx];
    LS.setItem('groups',JSON.stringify(groups));
    document.getElementById('convTitle').textContent=name;
  }
  const btn=document.querySelector('#panelCreateGroup .save-btn');
  btn.textContent='创建群聊';
  btn.onclick=()=>saveGroup();
  document.getElementById('panelCreateGroup').classList.remove('open');
  renderMsgList();
  renderContacts();
  showToast('群聊已更新 ✓');
}

function setGroupConvBg(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const r=new FileReader();
  r.onload=ev=>{
    const box=document.getElementById('convMessages');
    box.style.backgroundImage=`url(${ev.target.result})`;
    box.style.backgroundSize='cover';box.style.backgroundPosition='center';
    if(currentGroup)IDB.set('convBg_g_'+currentGroup.id,ev.target.result);
    closeGroupSettings();
  };
  r.readAsDataURL(file);
}
function clearGroupConvBg(){
  document.getElementById('convMessages').style.backgroundImage='';
  if(currentGroup)IDB.del('convBg_g_'+currentGroup.id);
  closeGroupSettings();
}
function clearGroupChat(){
  if(!currentGroup)return;
  const card=document.createElement('div');
  card.style.cssText='position:absolute;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(4px)';
  card.innerHTML=`<div style="width:calc(100% - 56px);background:var(--bg);border-radius:20px;padding:20px 18px 16px;box-shadow:0 12px 40px rgba(0,0,0,.2)">
    <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px;text-align:center">清空聊天记录</div>
    <div style="font-size:13px;color:var(--text2);text-align:center;margin-bottom:16px">确定清空「${currentGroup.name}」的所有消息？</div>
    <div style="display:flex;gap:10px">
      <button onclick="this.closest('div[style*=absolute]').remove()" style="flex:1;padding:11px;border-radius:12px;border:1.5px solid var(--accent2);background:none;font-size:14px;color:var(--text2);cursor:pointer;font-family:inherit">取消</button>
      <button onclick="doClearGroupChat();this.closest('div[style*=absolute]').remove()" style="flex:1;padding:11px;border-radius:12px;border:none;background:#FF3B30;font-size:14px;font-weight:600;color:#fff;cursor:pointer;font-family:inherit">清空</button>
    </div>
  </div>`;
  card.addEventListener('click',e=>{if(e.target===card)card.remove();});
  document.querySelector('.phone').appendChild(card);
}
function doClearGroupChat(){
  groupConversations[currentGroup.id]=[];
  LS.setItem('groupConvs',JSON.stringify(groupConversations));
  renderGroupMessages();
  renderMsgList();
  closeGroupSettings();
  showToast('聊天记录已清空');
}

function confirmDeleteGroup(){
  if(!currentGroup)return;
  const card=document.createElement('div');
  card.style.cssText='position:absolute;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(4px)';
  card.innerHTML=`<div style="width:calc(100% - 56px);background:var(--bg);border-radius:20px;padding:20px 18px 16px;box-shadow:0 12px 40px rgba(0,0,0,.2)">
    <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px;text-align:center">解散群聊</div>
    <div style="font-size:13px;color:var(--text2);text-align:center;margin-bottom:16px;line-height:1.6">确定解散「${currentGroup.name}」？<br>聊天记录将一并删除且无法恢复。</div>
    <div style="display:flex;gap:10px">
      <button onclick="this.closest('div[style*=absolute]').remove()" style="flex:1;padding:11px;border-radius:12px;border:1.5px solid var(--accent2);background:none;font-size:14px;color:var(--text2);cursor:pointer;font-family:inherit">取消</button>
      <button onclick="doDeleteGroup();this.closest('div[style*=absolute]').remove()" style="flex:1;padding:11px;border-radius:12px;border:none;background:#FF3B30;font-size:14px;font-weight:600;color:#fff;cursor:pointer;font-family:inherit">解散</button>
    </div>
  </div>`;
  card.addEventListener('click',e=>{if(e.target===card)card.remove();});
  document.querySelector('.phone').appendChild(card);
}
function doDeleteGroup(){
  const gid=currentGroup.id;
  delete groupConversations[gid];
  LS.setItem('groupConvs',JSON.stringify(groupConversations));
  groups=groups.filter(x=>x.id!==gid);
  LS.setItem('groups',JSON.stringify(groups));
  closeGroupSettings();
  closeConversation();
  renderMsgList();
  renderContacts();
  showToast('群聊已解散');
}

// 附加功能菜单
function toggleExtraMenu(){
  const m=document.getElementById('extraMenu');
  const isOpen=m.style.display==='flex';
  m.style.display=isOpen?'none':'flex';
  document.getElementById('extraBtn').style.background=isOpen?'var(--card2)':'var(--accent2)';
}
document.addEventListener('click',e=>{
  if(!e.target.closest('#extraMenu')&&!e.target.closest('#extraBtn')){
    const m=document.getElementById('extraMenu');
    if(m)m.style.display='none';
    const b=document.getElementById('extraBtn');
    if(b)b.style.background='var(--card2)';
  }
});

// ===== 音乐播放器 =====
let musicTracks=[];
let musicIdx=-1;
let musicAudio=new Audio();
let musicPlaying=false;
let musicMode='list';
let musicWidgetEl=null;
let musicProgressTimer=null;

// 加载JSZip库
(()=>{const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';document.head.appendChild(s);})();

function addMusicWidget(restoreData){
  if(musicWidgetEl){showToast('已有音乐组件');return;}
  const rd=restoreData||{};
  const w=document.createElement('div');
  w.className='music-widget'+(rd.locked?' locked':'');
  w.id='musicWidget';
  w.style.cssText='left:'+(rd.left||'40px')+';top:'+(rd.top||'180px')+';'+(rd.width?'width:'+rd.width+';':'');
  const mwTarget=rd._page!=null?document.getElementById('desktopPage'+rd._page)||getCurrentDesktopPage():getCurrentDesktopPage();
  w.innerHTML=`
    <button class="mw-del-btn" onclick="removeMusicWidget()">x</button>
    <button class="mw-lock-btn" onclick="toggleMusicWidgetLock()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
    </button>
    <div class="mw-cover-area">
      <div id="mwCoverImg" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#2c2c3e,#16213e)">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.25)" stroke-width="1.2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
      </div>
      <div class="mw-cover-overlay"></div>
      <div class="mw-info">
        <div class="mw-title" id="mwTitle">未导入歌曲</div>
        <div class="mw-artist" id="mwArtist">点击列表按钮导入</div>
      </div>
    </div>
    <div class="mw-controls">
      <button class="mw-ctrl-btn" onclick="event.stopPropagation();musicPrev()" title="上一首">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="19,20 9,12 19,4" fill="currentColor"/><line x1="5" y1="5" x2="5" y2="19"/></svg>
      </button>
      <button class="mw-ctrl-btn main" id="mwPlayBtn" onclick="event.stopPropagation();toggleMusicPlay()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="#fff" stroke="none"><polygon points="6,3 20,12 6,21"/></svg>
      </button>
      <button class="mw-ctrl-btn" onclick="event.stopPropagation();musicNext()" title="下一首">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5,4 15,12 5,20" fill="currentColor"/><line x1="19" y1="5" x2="19" y2="19"/></svg>
      </button>
    </div>
    <div class="mw-progress">
      <span class="mw-time" id="mwTimeCur">0:00</span>
      <div class="mw-progress-bar" id="mwProgressBar" onclick="event.stopPropagation();seekMusic(event)">
        <div class="mw-progress-fill" id="mwProgressFill"></div>
      </div>
      <span class="mw-time" id="mwTimeDur">0:00</span>
    </div>
    <div class="mw-bottom">
      <button class="mw-mode-btn" id="mwModeBtn" onclick="event.stopPropagation();cycleMusicMode()" title="播放模式">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
      </button>
      <button class="mw-list-btn" onclick="event.stopPropagation();openMusicList()" title="歌曲列表">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
      </button>
    </div>
    <div class="mw-resize"></div>`;
  (w._targetPage||getCurrentDesktopPage()).appendChild(w);
  musicWidgetEl=w;
  setupMusicWidgetDrag(w);
  w.addEventListener('click',e=>{
    if(e.target.closest('button'))return;
    document.querySelectorAll('.show-ctrl').forEach(el=>el.classList.remove('show-ctrl'));
    w.classList.add('show-ctrl');
    autoHideCtrl(w);
  });
  LS.setItem('musicWidgetOn','1');
  saveMusicWidgetState();
  if(!restoreData)closePanel();
}

function setupMusicWidgetDrag(w){
  let mode=null,startX,startY,origL,origT,origW,origH;
  const resizeEl=w.querySelector('.mw-resize');
  function onStart(cx,cy,isResize){
    if(w.classList.contains('locked'))return;
    mode=isResize?'resize':'move';
    startX=cx;startY=cy;
    origL=parseInt(w.style.left)||0;origT=parseInt(w.style.top)||0;
    origW=w.offsetWidth;origH=w.offsetHeight;
  }
  function onMove(cx,cy){
    if(!mode)return;
    const dx=cx-startX,dy=cy-startY;
    if(mode==='move'){
      const phone=document.querySelector('.phone');
      w.style.left=Math.max(0,Math.min(phone.offsetWidth-w.offsetWidth,origL+dx))+'px';
      w.style.top=Math.max(0,Math.min(phone.offsetHeight-60,origT+dy))+'px';
    } else {
      w.style.width=Math.max(180,origW+dx)+'px';
    }
  }
  function onEnd(){if(mode)saveMusicWidgetState();mode=null;}
  w.addEventListener('touchstart',e=>{
    if(e.target.closest('button')||e.target.closest('.mw-progress-bar'))return;
    const isR=e.target===resizeEl||e.target.closest('.mw-resize');
    onStart(e.touches[0].clientX,e.touches[0].clientY,isR);
  },{passive:true});
  w.addEventListener('touchmove',e=>{onMove(e.touches[0].clientX,e.touches[0].clientY);},{passive:true});
  w.addEventListener('touchend',onEnd);
  w.addEventListener('mousedown',e=>{
    if(e.target.closest('button')||e.target.closest('.mw-progress-bar'))return;
    const isR=e.target===resizeEl||e.target.closest('.mw-resize');
    onStart(e.clientX,e.clientY,isR);
    const mm=ev=>onMove(ev.clientX,ev.clientY);
    const mu=()=>{onEnd();document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);};
    document.addEventListener('mousemove',mm);
    document.addEventListener('mouseup',mu);
  });
}

function saveMusicWidgetState(){
  if(musicWidgetEl){
    const pg=musicWidgetEl.closest('.desktop');
    const pageIdx=pg?parseInt(pg.dataset.page)||0:0;
    LS.setItem('musicWidget',JSON.stringify({left:musicWidgetEl.style.left,top:musicWidgetEl.style.top,width:musicWidgetEl.style.width,locked:musicWidgetEl.classList.contains('locked'),_page:pageIdx}));
  } else {
    LS.removeItem('musicWidget');
  }
}

function removeMusicWidget(){
  if(musicWidgetEl){musicWidgetEl.remove();musicWidgetEl=null;}
  musicAudio.pause();musicPlaying=false;
  clearInterval(musicProgressTimer);
  updateNowPlayingBar();
  LS.setItem('musicWidgetOn','0');
  LS.removeItem('musicWidget');
}

function toggleMusicWidgetLock(){
  if(!musicWidgetEl)return;
  musicWidgetEl.classList.toggle('locked');
  saveMusicWidgetState();
}


// 顶部播放条右滑关闭
let npbTouchStartX=0,npbTouchStartY=0,npbSwiping=false,npbDismissed=false;
const npbBar=document.getElementById('nowPlayingBar');
npbBar.addEventListener('touchstart',e=>{
  npbTouchStartX=e.touches[0].clientX;
  npbTouchStartY=e.touches[0].clientY;
  npbSwiping=false;
  npbBar.style.transition='none';
},{passive:true});
npbBar.addEventListener('touchmove',e=>{
  const dx=e.touches[0].clientX-npbTouchStartX;
  const dy=e.touches[0].clientY-npbTouchStartY;
  if(!npbSwiping&&Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>8)npbSwiping=true;
  if(npbSwiping&&dx>0){
    npbBar.style.transform=`translateX(calc(-50% + ${dx}px))`;
    npbBar.style.opacity=Math.max(0,1-dx/200);
  }
},{passive:true});
npbBar.addEventListener('touchend',e=>{
  npbBar.style.transition='all .35s cubic-bezier(.4,0,.2,1)';
  const dx=e.changedTouches[0].clientX-npbTouchStartX;
  if(npbSwiping&&dx>80){
    npbBar.style.transform='translateX(100%)';
    npbBar.style.opacity='0';
    npbDismissed=true;
    setTimeout(()=>{npbBar.classList.remove('show');npbBar.style.transform='';npbBar.style.opacity='';},350);
  } else {
    npbBar.style.transform='';npbBar.style.opacity='';
  }
  npbSwiping=false;
},{passive:true});

function scrollToMusicWidget(){
  if(musicWidgetEl)musicWidgetEl.scrollIntoView({behavior:'smooth',block:'center'});
}

function onMusicFiles(e){
  const files=[...e.target.files];if(!files.length)return;
  e.target.value='';
  let added=0;
  const startIdx=musicTracks.length;
  let loaded=0;
  files.forEach((file,fi)=>{
    const fname=file.name.replace(/\.\w+$/,'');
    const parts=fname.includes('-')?fname.split('-').map(s=>s.trim()):[fname,''];
    const reader=new FileReader();
    reader.onload=ev=>{
      const ab=ev.target.result;
      const blob=new Blob([ab],{type:file.type||'audio/mpeg'});
      const url=URL.createObjectURL(blob);
      const trackId='track_'+Date.now()+'_'+fi+'_'+Math.random().toString(36).slice(2,6);
      musicTracks.push({id:trackId,name:parts[0]||fname,artist:parts[1]||'未知歌手',url,duration:0});
      (LS.getItem('saveMusicData')==='1'?IDB.set(trackId,ab):Promise.resolve()).then(()=>{
        added++;loaded++;
        if(loaded===files.length){
          showToast('已导入 '+added+' 首歌曲');
          for(let i=startIdx;i<musicTracks.length;i++){getDuration(i);}
          if(musicIdx<0&&musicTracks.length)loadTrack(0);
          saveMusicTracks();
          renderMusicList();
        }
      });
    };
    reader.readAsArrayBuffer(file);
  });
}

async function onMusicZipFile(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  if(typeof JSZip==='undefined'){showToast('JSZip库加载中，请稍后重试');return;}
  showToast('正在解压...');
  try{
    const zip=await JSZip.loadAsync(file);
    const audioExts=/\.(mp3|ogg|wav|m4a|flac|aac|opus)$/i;
    const entries=[];
    zip.forEach((path,entry)=>{if(!entry.dir&&audioExts.test(path))entries.push({path,entry});});
    if(!entries.length){showToast('ZIP中未找到音频文件');return;}
    let added=0;
    const startIdx=musicTracks.length;
    for(const{path,entry}of entries){
      const ab=await entry.async('arraybuffer');
      const ext=(path.match(/\.(\w+)$/)||[])[1]||'mp3';
      const mimeMap={mp3:'audio/mpeg',ogg:'audio/ogg',wav:'audio/wav',m4a:'audio/mp4',flac:'audio/flac',aac:'audio/aac',opus:'audio/opus'};
      const blob=new Blob([ab],{type:mimeMap[ext.toLowerCase()]||'audio/mpeg'});
      const url=URL.createObjectURL(blob);
      const fname=path.split('/').pop().replace(/\.\w+$/,'');
      const parts=fname.includes('-')?fname.split('-').map(s=>s.trim()):[fname,''];
      const trackId='track_'+Date.now()+'_'+added+'_'+Math.random().toString(36).slice(2,6);
      musicTracks.push({id:trackId,name:parts[0]||fname,artist:parts[1]||'未��歌手',url,duration:0});
      if(LS.getItem('saveMusicData')==='1')await IDB.set(trackId,ab);
      added++;
    }
    showToast('已导入 '+added+' 首歌曲');
    for(let i=startIdx;i<musicTracks.length;i++){getDuration(i);}
    if(musicIdx<0&&musicTracks.length)loadTrack(0);
    saveMusicTracks();
    renderMusicList();
  }catch(err){showToast('ZIP解压失败');}
}

function saveMusicTracks(){
  if(LS.getItem('saveMusicData')!=='1')return;
  const meta=musicTracks.map(t=>({id:t.id,name:t.name,artist:t.artist,cover:t.cover||''}));
  LS.setItem('musicTracks',JSON.stringify(meta));
}

function getDuration(i){
  const a=new Audio();a.src=musicTracks[i].url;
  a.addEventListener('loadedmetadata',()=>{musicTracks[i].duration=a.duration;renderMusicList();});
}

function fmtTime(s){
  if(!s||isNaN(s))return '0:00';
  const m=Math.floor(s/60),sec=Math.floor(s%60);
  return m+':'+(sec<10?'0':'')+sec;
}

function loadTrack(i){
  if(i<0||i>=musicTracks.length)return;
  musicIdx=i;
  musicAudio.src=musicTracks[i].url;
  musicAudio.load();
  updateMusicUI();
  renderMusicList();
}

function updateMusicUI(){
  const t=musicTracks[musicIdx];if(!t)return;
  if(musicWidgetEl){
    musicWidgetEl.querySelector('#mwTitle').textContent=t.name;
    musicWidgetEl.querySelector('#mwArtist').textContent=t.artist;
    const coverArea=musicWidgetEl.querySelector('#mwCoverImg');
    if(t.cover)coverArea.innerHTML='<img src="'+t.cover+'" style="width:100%;height:100%;object-fit:cover"/>';
    else coverArea.innerHTML='<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.25)" stroke-width="1.2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>';
    coverArea.style.background=t.cover?'#111':'linear-gradient(135deg,#2c2c3e,#16213e)';
  }
  document.getElementById('npbTitle').textContent=t.name;
  document.getElementById('npbArtist').textContent=t.artist;
  const npbCover=document.getElementById('npbCover');
  if(t.cover)npbCover.innerHTML='<img src="'+t.cover+'" style="width:100%;height:100%;object-fit:cover"/>';
  else npbCover.innerHTML='';
  updatePlayBtnIcon();
}

function updatePlayBtnIcon(){
  const playSvg='<svg width="22" height="22" viewBox="0 0 24 24" fill="#fff" stroke="none"><polygon points="6,3 20,12 6,21"/></svg>';
  const pauseSvg='<svg width="22" height="22" viewBox="0 0 24 24" fill="#fff" stroke="none"><rect x="5" y="3" width="5" height="18" rx="1"/><rect x="14" y="3" width="5" height="18" rx="1"/></svg>';
  const npPlay='<svg width="20" height="20" viewBox="0 0 24 24" fill="var(--text)" stroke="none"><polygon points="5,3 19,12 5,21"/></svg>';
  const npPause='<svg width="20" height="20" viewBox="0 0 24 24" fill="var(--text)" stroke="none"><rect x="5" y="3" width="5" height="18" rx="1"/><rect x="14" y="3" width="5" height="18" rx="1"/></svg>';
  if(musicWidgetEl)musicWidgetEl.querySelector('#mwPlayBtn').innerHTML=musicPlaying?pauseSvg:playSvg;
  document.getElementById('npbPlayBtn').innerHTML=musicPlaying?npPause:npPlay;
}

function toggleMusicPlay(){
  if(musicIdx<0){
    if(musicTracks.length)loadTrack(0);
    else{openMusicList();return;}
  }
  if(musicPlaying){musicAudio.pause();musicPlaying=false;}
  else{npbDismissed=false;musicAudio.play().catch(()=>{});musicPlaying=true;}
  updatePlayBtnIcon();
  updateNowPlayingBar();
  startProgressUpdate();
}

function musicPrev(){
  if(!musicTracks.length)return;
  let i=musicIdx-1;if(i<0)i=musicTracks.length-1;
  loadTrack(i);
  if(musicPlaying)musicAudio.play().catch(()=>{});
  updateNowPlayingBar();
}

function musicNext(){
  if(!musicTracks.length)return;
  let i;
  if(musicMode==='shuffle')i=Math.floor(Math.random()*musicTracks.length);
  else i=(musicIdx+1)%musicTracks.length;
  loadTrack(i);
  if(musicPlaying)musicAudio.play().catch(()=>{});
  updateNowPlayingBar();
}

function seekMusic(e){
  const bar=document.getElementById('mwProgressBar');
  const rect=bar.getBoundingClientRect();
  const pct=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));
  if(musicAudio.duration)musicAudio.currentTime=pct*musicAudio.duration;
}

function cycleMusicMode(){
  const modes=['list','single','shuffle'];
  musicMode=modes[(modes.indexOf(musicMode)+1)%modes.length];
  const labels={list:'列表循环',single:'单曲循环',shuffle:'随机播放'};
  showToast(labels[musicMode]);
  const btn=document.getElementById('mwModeBtn');if(!btn)return;
  const icons={
    list:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>',
    single:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/><text x="10" y="14" font-size="8" fill="currentColor" font-weight="700">1</text></svg>',
    shuffle:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>'
  };
  btn.innerHTML=icons[musicMode];
  btn.classList.toggle('active',musicMode!=='list');
}

musicAudio.addEventListener('ended',()=>{
  if(musicMode==='single'){musicAudio.currentTime=0;musicAudio.play().catch(()=>{});}
  else musicNext();
});

function startProgressUpdate(){
  clearInterval(musicProgressTimer);
  if(!musicPlaying)return;
  musicProgressTimer=setInterval(()=>{
    if(!musicAudio.duration)return;
    const pct=(musicAudio.currentTime/musicAudio.duration)*100;
    const fill=document.getElementById('mwProgressFill');
    const npFill=document.getElementById('npbProgressFill');
    if(fill)fill.style.width=pct+'%';
    if(npFill)npFill.style.width=pct+'%';
    const cur=document.getElementById('mwTimeCur');
    const dur=document.getElementById('mwTimeDur');
    if(cur)cur.textContent=fmtTime(musicAudio.currentTime);
    if(dur)dur.textContent=fmtTime(musicAudio.duration);
  },300);
}

musicAudio.addEventListener('pause',()=>{musicPlaying=false;updatePlayBtnIcon();updateNowPlayingBar();clearInterval(musicProgressTimer);});
musicAudio.addEventListener('play',()=>{musicPlaying=true;updatePlayBtnIcon();updateNowPlayingBar();startProgressUpdate();});

function updateNowPlayingBar(){
  const bar=document.getElementById('nowPlayingBar');
  if(musicIdx>=0&&musicTracks.length&&!npbDismissed){bar.classList.add('show');}
  else{bar.classList.remove('show');}
}

function openMusicList(){
  renderMusicList();
  document.getElementById('panelMusicList').classList.add('open');
}
function closeMusicList(){document.getElementById('panelMusicList').classList.remove('open');}

function renderMusicList(){
  const box=document.getElementById('musicListBody');
  if(!musicTracks.length){
    box.innerHTML='<p style="font-size:13px;color:var(--text2);text-align:center;padding:30px 0">暂无歌曲，请导入ZIP包</p>';
    return;
  }
  box.innerHTML=musicTracks.map((t,i)=>`
    <div class="music-list-item${i===musicIdx?' playing':''}" onclick="loadTrack(${i});if(!musicPlaying)toggleMusicPlay();">
      <div class="mli-idx">${i===musicIdx&&musicPlaying?'<svg width="14" height="14" viewBox="0 0 24 24" fill="var(--accent)" stroke="none"><rect x="3" y="8" width="4" height="8" rx="1"><animate attributeName="height" values="8;16;8" dur=".8s" repeatCount="indefinite"/><animate attributeName="y" values="8;4;8" dur=".8s" repeatCount="indefinite"/></rect><rect x="10" y="4" width="4" height="16" rx="1"><animate attributeName="height" values="16;8;16" dur=".8s" repeatCount="indefinite"/><animate attributeName="y" values="4;8;4" dur=".8s" repeatCount="indefinite"/></rect><rect x="17" y="6" width="4" height="12" rx="1"><animate attributeName="height" values="12;16;12" dur=".8s" repeatCount="indefinite"/><animate attributeName="y" values="6;4;6" dur=".8s" repeatCount="indefinite"/></rect></svg>':(i+1)}</div>
      <div class="mli-info">
        <div class="mli-name">${t.name}</div>
        <div class="mli-artist">${t.artist}</div>
      </div>
      <div class="mli-dur">${fmtTime(t.duration)}</div>
      <button class="mli-del" onclick="event.stopPropagation();editTrack(${i})" title="编辑" style="opacity:.7">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
      </button>
      <button class="mli-del" onclick="event.stopPropagation();deleteTrack(${i})">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>`).join('');
}

function editTrack(i){
  const t=musicTracks[i];
  const old=document.getElementById('trackEditCard');
  if(old)old.remove();
  const card=document.createElement('div');
  card.id='trackEditCard';
  card.style.cssText='position:absolute;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(4px)';
  card.innerHTML=`
    <div style="width:calc(100% - 56px);background:var(--bg);border-radius:20px;padding:20px 18px 16px;box-shadow:0 12px 40px rgba(0,0,0,.2)">
      <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:14px;text-align:center">编辑歌曲信息</div>
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:14px">
        <div id="trackEditCover" onclick="document.getElementById('trackCoverFile').click()" style="width:64px;height:64px;border-radius:14px;background:linear-gradient(135deg,#2c2c3e,#16213e);overflow:hidden;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px rgba(0,0,0,.15)">
          ${t.cover?'<img src="'+t.cover+'" style="width:100%;height:100%;object-fit:cover"/>':'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="1.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>'}
        </div>
        <input type="file" id="trackCoverFile" accept="image/*" style="display:none" onchange="onTrackCoverFile(event,${i})"/>
        <div style="flex:1;font-size:11px;color:var(--text2)">点击左侧设置封面图</div>
      </div>
      <div style="margin-bottom:10px">
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">歌曲名称</div>
        <input class="set-input" id="trackEditName" value="${t.name.replace(/"/g,'&quot;')}"/>
      </div>
      <div style="margin-bottom:14px">
        <div style="font-size:12px;color:var(--text2);margin-bottom:4px">歌手</div>
        <input class="set-input" id="trackEditArtist" value="${t.artist.replace(/"/g,'&quot;')}"/>
      </div>
      <div style="display:flex;gap:10px">
        <button onclick="document.getElementById('trackEditCard').remove()" style="flex:1;padding:11px;border-radius:12px;border:1.5px solid var(--accent2);background:none;font-size:14px;color:var(--text2);cursor:pointer;font-family:inherit">取消</button>
        <button onclick="saveTrackEdit(${i})" style="flex:1;padding:11px;border-radius:12px;border:none;background:var(--accent);font-size:14px;font-weight:600;color:#fff;cursor:pointer;font-family:inherit">保存</button>
      </div>
    </div>`;
  card.addEventListener('click',e=>{if(e.target===card)card.remove();});
  document.querySelector('.phone').appendChild(card);
}

function onTrackCoverFile(e,i){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const r=new FileReader();
  r.onload=ev=>{
    musicTracks[i].cover=ev.target.result;
    const preview=document.getElementById('trackEditCover');
    if(preview)preview.innerHTML='<img src="'+ev.target.result+'" style="width:100%;height:100%;object-fit:cover"/>';
  };
  r.readAsDataURL(file);
}

function saveTrackEdit(i){
  const name=document.getElementById('trackEditName').value.trim();
  const artist=document.getElementById('trackEditArtist').value.trim();
  if(name)musicTracks[i].name=name;
  if(artist)musicTracks[i].artist=artist;
  document.getElementById('trackEditCard').remove();
  saveMusicTracks();
  renderMusicList();
  if(i===musicIdx)updateMusicUI();
  showToast('已保存');
}

function deleteTrack(i){
  const t=musicTracks[i];
  if(t.url)URL.revokeObjectURL(t.url);
  if(t.id&&LS.getItem('saveMusicData')==='1')IDB.del(t.id);
  musicTracks.splice(i,1);
  if(musicIdx===i){musicAudio.pause();musicPlaying=false;musicIdx=musicTracks.length?0:-1;if(musicIdx>=0)loadTrack(0);updateNowPlayingBar();}
  else if(musicIdx>i)musicIdx--;
  saveMusicTracks();
  renderMusicList();
}

const setSubIds={api:'pageSetApi',screen:'pageSetScreen',data:'pageSetData',font:'pageSetFont'};
function openSetSub(name){document.getElementById(setSubIds[name])?.classList.add('open');}
function closeSetSub(name){document.getElementById(setSubIds[name])?.classList.remove('open');}

// ===== 字体系统 =====
const ZERODIAN_FONTS=[
  {name:'悠哉字体',css:'https://cdn.zerodian.top/font/Yozai/result.css',family:'Yozai'},
  {name:'寒蝉手拙体',css:'https://cdn.zerodian.top/font/ChillShouZhuo/result.css',family:'ChillShouZhuo'},
  {name:'寒蝉圆黑体',css:'https://cdn.zerodian.top/font/ChillYuanHei/result.css',family:'ChillYuanHei'},
  {name:'寒蝉正楷',css:'https://cdn.zerodian.top/font/ChillZhengKai/result.css',family:'ChillZhengKai'},
  {name:'得意黑',css:'https://cdn.zerodian.top/font/SmileySans/result.css',family:'SmileySans-Oblique'},
  {name:'霞鹜文楷',css:'https://cdn.zerodian.top/font/LXGWWenKai/result.css',family:'LXGWWenKai'},
  {name:'霞鹜新晰黑',css:'https://cdn.zerodian.top/font/LXGWNeoXiHei/result.css',family:'LXGWNeoXiHei'},
  {name:'峰广明朝',css:'https://cdn.zerodian.top/font/FengGuangMingChao/result.css',family:'FengGuangMingChao'},
];

let currentFontMode='system';
let currentFontCss='';
let currentFontFamily='';
let fontLinkEl=null;

function setFontMode(mode){
  currentFontMode=mode;
  ['system','zerodian','custom'].forEach(m=>{
    document.getElementById('font-'+m)?.classList.toggle('active',m===mode);
  });
  document.getElementById('fontZerodianOpts').style.display=mode==='zerodian'?'block':'none';
  document.getElementById('fontCustomOpts').style.display=mode==='custom'?'block':'none';
  if(mode==='system'){
    removeFontLink();
    document.body.style.fontFamily="-apple-system,'PingFang SC',sans-serif";
    LS.setItem('fontMode','system');
    LS.removeItem('fontCss');
    LS.removeItem('fontFamily');
  }
  if(mode==='zerodian'){
    const savedCss=LS.getItem('fontCss')||'';
    const savedFamily=LS.getItem('fontFamily')||'';
    if(LS.getItem('fontMode')==='zerodian'){
      document.getElementById('zerodianCssUrl').value=savedCss;
      document.getElementById('zerodianFamilyName').value=savedFamily;
    }
  }
}

function applyZerodianInput(){
  const url=document.getElementById('zerodianCssUrl').value.trim();
  const family=document.getElementById('zerodianFamilyName').value.trim();
  if(!url){showToast('请输入CSS链接');return;}
  if(!family){showToast('请输入字体名称');return;}
  loadFontCss(url,family);
  LS.setItem('fontMode','zerodian');
  LS.setItem('fontCss',url);
  LS.setItem('fontFamily',family);
  showToast('字体加载中…');
}

function applyCustomFont(){
  const url=document.getElementById('fontCssUrl').value.trim();
  const family=document.getElementById('fontFamilyName').value.trim()||'CustomFont';
  if(!url){showToast('请输入字体链接');return;}
  // 判断是CSS链接还是字体文件链接
  if(/\.(woff2?|ttf|otf|eot)(\?|$)/i.test(url)){
    // 字体文件，生成@font-face
    const style=document.createElement('style');
    style.id='customFontFace';
    style.textContent=`@font-face{font-family:'${family}';src:url('${url}');font-display:swap;}`;
    document.getElementById('customFontFace')?.remove();
    document.head.appendChild(style);
    removeFontLink();
    document.body.style.fontFamily=`'${family}',-apple-system,'PingFang SC',sans-serif`;
  } else {
    loadFontCss(url,family);
  }
  LS.setItem('fontMode','custom');
  LS.setItem('fontCss',url);
  LS.setItem('fontFamily',family);
  showToast('字体加载中…');
}

function loadFontCss(url,family){
  removeFontLink();
  document.getElementById('customFontFace')?.remove();
  const link=document.createElement('link');
  link.rel='stylesheet';link.href=url;link.id='fontLink';
  document.head.appendChild(link);
  fontLinkEl=link;
  document.body.style.fontFamily=`'${family}',-apple-system,'PingFang SC',sans-serif`;
}

function removeFontLink(){
  document.getElementById('fontLink')?.remove();
  document.getElementById('customFontFace')?.remove();
  fontLinkEl=null;
}

function resetFont(){
  removeFontLink();
  document.body.style.fontFamily="-apple-system,'PingFang SC',sans-serif";
  LS.setItem('fontMode','system');
  LS.removeItem('fontCss');
  LS.removeItem('fontFamily');
  setFontMode('system');
  showToast('已恢复默认字体');
}

function restoreFont(){
  const mode=LS.getItem('fontMode')||'system';
  const css=LS.getItem('fontCss')||'';
  const family=LS.getItem('fontFamily')||'';
  if(mode!=='system'&&css&&family){
    if(/\.(woff2?|ttf|otf|eot)(\?|$)/i.test(css)){
      const style=document.createElement('style');
      style.id='customFontFace';
      style.textContent=`@font-face{font-family:'${family}';src:url('${css}');font-display:swap;}`;
      document.head.appendChild(style);
    } else {
      const link=document.createElement('link');
      link.rel='stylesheet';link.href=css;link.id='fontLink';
      document.head.appendChild(link);
      fontLinkEl=link;
    }
    document.body.style.fontFamily=`'${family}',-apple-system,'PingFang SC',sans-serif`;
  }
}

function exportData(){
  const data={};
  LS.keys().forEach(k=>{const v=LS.getItem(k);if(v!=null)data[k]=v;});
  const now=new Date();
  const ts=`${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
  const a=document.createElement('a');
  a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data));
  a.download=`橙子机_${ts}.json`;
  a.click();
}
function importData(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      Object.entries(data).forEach(([k,v])=>LS.setItem(k,v));
      showToast('导入成功，即将刷新…');
      setTimeout(()=>location.reload(),1500);
    }catch(err){showToast('导入失败：文件格式错误');}
  };
  r.readAsText(file);
}

function openSetSub(name){document.getElementById('pageSet'+name.charAt(0).toUpperCase()+name.slice(1)).classList.add('open');}
function closeSetSub(name){document.getElementById('pageSet'+name.charAt(0).toUpperCase()+name.slice(1)).classList.remove('open');}

// ===== 论坛 =====
let forums=[];
let editingForumIdx=-1;
let newForumMembers=new Set();

function openForum(){
  renderForumList();
  document.getElementById('pageForum').classList.add('open');
}
function closeForum(){document.getElementById('pageForum').classList.remove('open');}

function renderForumList(){
  const box=document.getElementById('forumList');
  if(!forums.length){
    box.innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;padding:60px 0;gap:12px">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="1.2"><path d="M4 6h16M4 10h16M4 14h10M4 18h7"/></svg>
      <p style="font-size:13px;color:var(--text2)">还没有论坛，点右上角新建</p>
    </div>`;
    return;
  }
  box.innerHTML=forums.map((f,i)=>`
    <div onclick="openForumBoard(${i})" style="display:flex;align-items:center;gap:14px;padding:16px;background:var(--card);border-radius:18px;margin-bottom:12px;box-shadow:0 2px 12px rgba(0,0,0,.06);cursor:pointer;position:relative">
      <div style="width:50px;height:50px;border-radius:14px;background:linear-gradient(135deg,#E8845A,#F5C49A);display:flex;align-items:center;justify-content:center;flex-shrink:0">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8"><path d="M4 6h16M4 10h16M4 14h10M4 18h7"/></svg>
      </div>
      <div style="flex:1;min-width:0">
        <div style="font-size:15px;font-weight:700;color:var(--text)">${f.name}</div>
        <div style="font-size:12px;color:var(--text2);margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.world||'暂无世界观设定'}</div>
        <div style="font-size:11px;color:var(--text2);margin-top:4px">${f.members?.length||0} 位成员 · ${f.posts?.length||0} 条帖子</div>
      </div>
      <button onclick="event.stopPropagation();openEditForumPanel(${i})" style="background:none;border:none;cursor:pointer;padding:6px;color:var(--text2);flex-shrink:0">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="1.5"/><circle cx="19" cy="12" r="1.5"/><circle cx="5" cy="12" r="1.5"/></svg>
      </button>
    </div>`).join('');
}

function renderForumMePreset(selectedIdx){
  const sel=document.getElementById('forumMePreset');
  sel.innerHTML='<option value="">（不绑定）</option>'+mePresets.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('');
  sel.value=selectedIdx!=null?selectedIdx:'';
}
function openNewForumPanel(){
  editingForumIdx=-1;
  newForumMembers=new Set();
  document.getElementById('newForumPanelTitle').textContent='新建论坛';
  document.getElementById('forumNameInput').value='';
  document.getElementById('forumWorldInput').value='';
  renderForumMePreset(null);
  renderForumMemberList();
  document.getElementById('panelNewForum').classList.add('open');
}
function openEditForumPanel(i){
  editingForumIdx=i;
  const f=forums[i];
  newForumMembers=new Set(f.members||[]);
  document.getElementById('newForumPanelTitle').textContent='编辑论坛';
  document.getElementById('forumNameInput').value=f.name||'';
  document.getElementById('forumWorldInput').value=f.world||'';
  renderForumMePreset(f.mePresetIndex);
  renderForumMemberList();
  document.getElementById('panelNewForum').classList.add('open');
}
function closeNewForumPanel(){document.getElementById('panelNewForum').classList.remove('open');}

function renderForumMemberList(){
  const box=document.getElementById('forumMemberList');
  if(!contacts.length){box.innerHTML='<p style="font-size:12px;color:var(--text2)">暂无联系人</p>';return;}
  box.innerHTML=contacts.map(c=>{
    const sel=newForumMembers.has(c.id);
    return `<div class="visible-opt${sel?' selected':''}" onclick="toggleForumMember(${c.id},this)">
      <div class="visible-opt-avatar">${c.avatar?`<img src="${c.avatar}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`}</div>
      <span>${c.name}</span>
      <div class="visible-check"></div>
    </div>`;
  }).join('');
}
function toggleForumMember(id,el){
  if(newForumMembers.has(id))newForumMembers.delete(id);
  else newForumMembers.add(id);
  el.classList.toggle('selected',newForumMembers.has(id));
}
function saveNewForum(){
  const name=document.getElementById('forumNameInput').value.trim();
  if(!name){showToast('请输入论坛名称');return;}
  const world=document.getElementById('forumWorldInput').value.trim();
  const meVal=document.getElementById('forumMePreset').value;
  const meIdx=meVal===''?null:parseInt(meVal);
  if(editingForumIdx>=0){
    forums[editingForumIdx]={...forums[editingForumIdx],name,world,members:[...newForumMembers],mePresetIndex:meIdx};
  } else {
    forums.push({id:Date.now(),name,world,members:[...newForumMembers],posts:[],mePresetIndex:meIdx});
  }
  LS.setItem('forums',JSON.stringify(forums));
  closeNewForumPanel();
  renderForumList();
  showToast(editingForumIdx>=0?'已更新 ✓':'论坛已创建 ✓');
}

// ===== 论坛板块 =====
let currentForumIdx=-1;

function openForumBoard(i){
  currentForumIdx=i;
  const f=forums[i];
  document.getElementById('forumBoardTitle').textContent=f.name;
  renderForumPosts();
  document.getElementById('pageForumBoard').classList.add('open');
  if(!f.posts?.length) generateForumPosts();
}
function closeForumBoard(){document.getElementById('pageForumBoard').classList.remove('open');}

function renderForumPosts(){
  const f=forums[currentForumIdx];
  const box=document.getElementById('forumBoardBody');
  if(!f.posts?.length){
    box.innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;padding:80px 0;gap:12px">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="1.2"><path d="M4 6h16M4 10h16M4 14h10M4 18h7"/></svg>
      <p style="font-size:13px;color:var(--text2)">暂无帖子，点右上角刷新生成</p>
    </div>`;
    return;
  }
  const tagColors=['#E8845A','#7A9E7E','#9B8EC4','#7A8FA6','#C4828A','#6BBFB5','#C4956A','#B8A88A'];
  box.innerHTML=f.posts.map((p,i)=>{
    const col=tagColors[i%tagColors.length];
    return `<div class="forum-post-item" onclick="openForumPost(${i})">
      ${p.tag?`<div class="forum-post-tag" style="background:${col}22;color:${col}">${p.tag}</div>`:''}
      <div class="forum-post-title">${p.title}</div>
      <div class="forum-post-preview">${p.content}</div>
      <div class="forum-post-meta">
        <span class="forum-post-author">${p.author}</span>
        <span>${p.time}</span>
        <div class="forum-post-stats">
          <span>👁 ${p.views||0}</span>
          <span>💬 ${p.comments?.length||0}</span>
          <span>❤️ ${p.likes||0}</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

const POST_TAGS=['热议','八卦','日常','求助','吐槽','分享','爆料','闲聊','问答','感悟'];

async function generateForumPosts(){
  const p=presets[activePreset]||{};
  if(!p.key){showToast('请先配置 API');return;}
  const f=forums[currentForumIdx];
  const btn=document.getElementById('forumRefreshBtn');
  btn.style.opacity='.4';btn.style.pointerEvents='none';
  showToast('生成中…');

  // 成员名单
  const memberNames=contacts.filter(c=>f.members?.includes(c.id)).map(c=>c.name);
  const memberStr=memberNames.length?`论坛成员包括：${memberNames.join('、')}，以及其他匿名网友。`:'论坛成员为匿名网友。';

  const sysPrompt=`你是论坛帖子生成器。只输出JSON数组，禁止任何其他文字。每个数组元素必须是包含title、tag、author、time、content、views、likes、comments字段的完整帖子对象。`;
  const userPrompt=`【重要】输出的是帖子列表数组，不是评论数组。每个元素是完整帖子对象，帖子内部才有comments。

论坛名称：${f.name}
世界观背景：${f.world||'普通现实生活论坛'}
${memberStr}

生成8条论坛帖子。每条帖子结构说明：
- title：帖子标题（一句话，吸引人点进去看）
- tag：标签，从[热议,八卦,日常,求助,吐槽,分享,爆料,闲聊,问答,感悟]选一个
- author：发帖人网名（有网感，如"摆烂小能手""柠檬精本精""emo中的emo"这类风格）
- time：发帖时间（如"2小时前""昨天 14:32""3天前"）
- content：帖子正文，100~150字，是发帖人写的完整内容，不是评论
- views：浏览数（数字）
- likes：点赞数（数字）
- comments：数组，包含4条其他网友的回复评论，每条有author/text/time/likes字段

格式示例（严格按此输出）：
[
  {
    "title": "求问！学校附近新开的那家奶茶到底值不值得排队？",
    "tag": "问答",
    "author": "奶茶续命选手",
    "time": "3小时前",
    "content": "今天路过看到排了好长的队，足足有二三十个人！我站在旁边观望了一下，感觉等至少要40分钟。有没有已经喝过的同学来说说？主要想知道招牌款好不好喝，糖度怎么选，还有价格大概多少。我不太能喝甜的，但又很想尝鲜，纠结死了……",
    "views": 312,
    "likes": 47,
    "comments": [
      {"author": "糖分超标患者", "text": "喝过！招牌乌龙七分糖刚好，不要全糖会很腻", "time": "2小时前", "likes": 12},
      {"author": "排队恐惧症", "text": "我等了50分钟，说实话一般，不值得", "time": "1小时前", "likes": 8},
      {"author": "白开水爱好者", "text": "你们喝什么奶茶，多喝热水", "time": "45分钟前", "likes": 3},
      {"author": "本地吃货地图", "text": "他家芋泥系列比招牌好喝，可以试试", "time": "20分钟前", "likes": 5}
    ]
  }
]

生成8个帖子对象组成数组。每个帖子content是发帖人写的正文100字以上，comments含3到5条评论。tag从[热议,八卦,日常,求助,吐槽,分享,爆料,闲聊,问答,感悟]选。网名有网感。第一个字符必须是[，最后一个字符必须是]。再次强调：输出帖子数组，不是评论数组。`;

  try{
    const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
      body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[{role:'system',content:sysPrompt},{role:'user',content:userPrompt}],max_tokens:3000})
    });
    const data=await res.json();
    const raw=data.choices?.[0]?.message?.content||'';
    console.log('【论坛原始返回】', raw);
    const rawPosts=parseForumJSON(raw);
    console.log('【解析结果】', rawPosts);
    if(!rawPosts.length){showToast('生成失败，请重试');btn.style.opacity='';btn.style.pointerEvents='';return;}
    // 标准化字段，兼容AI可能输出的不同key
    const posts=rawPosts.map(p=>({
      title:p.title||p.标题||p.name||'无标题',
      tag:p.tag||p.标签||'',
      author:p.author||p.作者||p.username||'匿名',
      time:p.time||p.发布时间||p.created_at||'',
      content:p.content||p.正文||p.body||p.text||'',
      views:p.views||p.浏览||0,
      likes:p.likes||p.点赞||0,
      comments:(p.comments||p.评论||[]).map(c=>({
        author:c.author||c.name||c.username||'匿名',
        text:c.text||c.content||c.comment||'',
        time:c.time||'',
        likes:c.likes||0
      }))
    }));
    forums[currentForumIdx].posts=posts;
    LS.setItem('forums',JSON.stringify(forums));
    renderForumPosts();
    renderForumList();
    showToast('帖子已生成 ✓');
  }catch(e){showToast('请求失败，检查API');}
  btn.style.opacity='';btn.style.pointerEvents='';
}

function parseForumJSON(raw){
  let str=raw
    .replace(/```json\s*/gi,'').replace(/```\s*/g,'')
    .replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F]/g,'')
    .trim();
  const start=str.indexOf('[');
  const end=str.lastIndexOf(']');
  if(start===-1||end===-1||end<=start)return[];
  str=str.slice(start,end+1);
  // 尝试直接解析
  try{return JSON.parse(str);}catch(e){console.log('JSON.parse failed:',e.message);}
  // 降级：用括号计数提取顶层对象（支持嵌套）
  const items=[];
  let i=0;
  while(i<str.length){
    if(str[i]==='{'){
      let depth=0,j=i;
      for(;j<str.length;j++){
        if(str[j]==='{')depth++;
        else if(str[j]==='}'){depth--;if(depth===0)break;}
      }
      if(depth===0){
        try{items.push(JSON.parse(str.slice(i,j+1)));}catch(e){}
        i=j+1;
      } else break;
    } else i++;
  }
  return items;
}

// ===== 帖子详情 =====
let currentPostIdx=-1;

function openForumPost(i){
  currentPostIdx=i;
  const f=forums[currentForumIdx];
  const p=f.posts[i];
  // 增加浏览数
  p.views=(p.views||0)+1;
  LS.setItem('forums',JSON.stringify(forums));

  document.getElementById('forumPostHeaderTitle').textContent=p.title;
  const tagColors=['#E8845A','#7A9E7E','#9B8EC4','#7A8FA6','#C4828A','#6BBFB5','#C4956A','#B8A88A'];
  const col=tagColors[i%tagColors.length];

  const commentsHtml=(p.comments||[]).map((c,ci)=>`
    <div class="forum-comment-item" onclick="setForumReplyTarget(${ci})" style="cursor:pointer">
      <div class="forum-comment-avatar">${c.author.slice(0,1)}</div>
      <div class="forum-comment-body">
        <div class="forum-comment-name">${c.author}</div>
        <div class="forum-comment-text">${c.replyTo?`<span style="color:var(--accent);font-weight:600">回复 ${c.replyTo}：</span>`:''}${c.text}</div>
        <div class="forum-comment-meta">
          <span>${c.time||''}</span>
          <span>❤️ ${c.likes||0}</span>
        </div>
      </div>
    </div>`).join('');

  document.getElementById('forumPostBody').innerHTML=`
    <div style="padding:18px 16px 14px;border-bottom:1px solid rgba(0,0,0,.06)">
      ${p.tag?`<div class="forum-post-tag" style="background:${col}22;color:${col};margin-bottom:10px">${p.tag}</div>`:''}
      <div style="font-size:18px;font-weight:700;color:var(--text);line-height:1.4;margin-bottom:12px">${p.title}</div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
        <div style="width:32px;height:32px;border-radius:50%;background:${col}33;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:${col}">${p.author.slice(0,1)}</div>
        <div>
          <div style="font-size:13px;font-weight:600;color:var(--accent)">${p.author}</div>
          <div style="font-size:11px;color:var(--text2)">${p.time}</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:12px;font-size:12px;color:var(--text2)">
          <span>👁 ${p.views||0}</span><span>❤️ ${p.likes||0}</span>
        </div>
      </div>
      <div style="font-size:14px;color:var(--text);line-height:1.8">${p.content}</div>
    </div>
    <div style="padding:12px 16px 8px;font-size:12px;font-weight:600;color:var(--text2);letter-spacing:1px">全部评论 · ${p.comments?.length||0}</div>
    ${commentsHtml||'<div style="padding:30px 0;text-align:center;font-size:13px;color:var(--text2)">暂无评论</div>'}
    <div style="height:70px"></div>
  `;

  document.getElementById('pageForumPost').classList.add('open');
}

function closeForumPost(){
  document.getElementById('pageForumPost').classList.remove('open');
  renderForumPosts(); // 刷新列表中的浏览数
}

// ===== 论坛刷新选角色
let forumRefreshSelected=new Set();

function openForumRefreshPanel(){
  const f=forums[currentForumIdx];
  const memberContacts=contacts.filter(c=>f.members?.includes(c.id));
  forumRefreshSelected=new Set(memberContacts.map(c=>c.id)); // 默认全选
  renderForumRefreshList();
  document.getElementById('panelForumRefresh').classList.add('open');
}
function closeForumRefreshPanel(){document.getElementById('panelForumRefresh').classList.remove('open');}

function renderForumRefreshList(){
  const f=forums[currentForumIdx];
  const memberContacts=contacts.filter(c=>f.members?.includes(c.id));
  const box=document.getElementById('forumRefreshMemberList');
  if(!memberContacts.length){box.innerHTML='<p style="font-size:12px;color:var(--text2)">该论坛暂无成员</p>';return;}
  box.innerHTML=memberContacts.map(c=>{
    const sel=forumRefreshSelected.has(c.id);
    return `<div class="visible-opt${sel?' selected':''}" onclick="toggleForumRefreshMember(${c.id},this)">
      <div class="visible-opt-avatar">${c.avatar?`<img src="${c.avatar}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`}</div>
      <span>${c.name}</span>
      <div class="visible-check"></div>
    </div>`;
  }).join('');
}
function toggleForumRefreshMember(id,el){
  if(forumRefreshSelected.has(id))forumRefreshSelected.delete(id);
  else forumRefreshSelected.add(id);
  el.classList.toggle('selected',forumRefreshSelected.has(id));
}

// ===== 论坛发帖
let myPostTag='';
function openMyForumPost(){
  myPostTag='';
  document.getElementById('myPostTitle').value='';
  document.getElementById('myPostContent').value='';
  const tags=POST_TAGS;
  document.getElementById('myPostTagList').innerHTML=tags.map(t=>`<div class="photo-tag" onclick="selectMyPostTag(this,'${t}')">${t}</div>`).join('');
  document.getElementById('panelMyForumPost').classList.add('open');
}
function closeMyForumPost(){document.getElementById('panelMyForumPost').classList.remove('open');}
function selectMyPostTag(el,tag){
  myPostTag=el.classList.contains('active')?'':tag;
  document.querySelectorAll('#myPostTagList .photo-tag').forEach(t=>t.classList.remove('active'));
  if(myPostTag)el.classList.add('active');
}
function submitMyForumPost(){
  const title=document.getElementById('myPostTitle').value.trim();
  const content=document.getElementById('myPostContent').value.trim();
  if(!title){showToast('请输入标题');return;}
  if(!content){showToast('请输入正文');return;}
  const f=forums[currentForumIdx];
  const me=f.mePresetIndex!=null?mePresets[f.mePresetIndex]:null;
  const now=new Date();
  const ts=`${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
  const post={title,tag:myPostTag||'日常',author:me?.name||'我',time:'刚刚',content,views:1,likes:0,comments:[],isMyPost:true};
  if(!f.posts)f.posts=[];
  f.posts.unshift(post);
  LS.setItem('forums',JSON.stringify(forums));
  closeMyForumPost();
  renderForumPosts();
  showToast('已发布 ✓');
  generateRepliesForMyPost(0);
}

async function generateRepliesForMyPost(postIdx){
  const p=presets[activePreset]||{};
  if(!p.key)return;
  const f=forums[currentForumIdx];
  const post=f.posts[postIdx];
  const me=f.mePresetIndex!=null?mePresets[f.mePresetIndex]:null;
  const myName=me?.name||'我';
  const myPersona=me?.persona||'';
  const memberContacts=contacts.filter(c=>f.members?.includes(c.id));
  
  const sysPrompt=`你是论坛回复生成器。只输出JSON数组，禁止任何其他文字。`;
  const userPrompt=`论坛：${f.name}
世界观：${f.world||'普通论坛'}
发帖人：${myName}（人设：${myPersona||'普通用户'}）

帖子标题：${post.title}
帖子标签：${post.tag}
帖子正文：${post.content}

论坛中的角色成员（他们认识发帖人${myName}）：
${membersDesc||'无'}

请生成回复评论，要求：
1. 必须有3-5条来自随机网友（网名有网感）的回复，网友一定会回复
2. 对于角色成员，根据以下规则判断是否回复：
   - 如果角色和发帖人关系亲近（朋友、同学、恋人等），大概率会回复
   - 如果角色是公众人物/明星/有特殊身份，一般不会随便在论坛回复普通帖子（明星账号通常由助理管理，不会随意互动）
   - 如果帖子内容和角色直接相关，角色可能会回复
   - 角色回复时要体现他们认识${myName}，语气符合他们的关系
3. 每条回复包含author、text、time、likes字段
4. 回复要自然真实，有网感

输出JSON数组，格式：[{"author":"网名","text":"回复内容","time":"X分钟前","likes":数字}]`;

  try{
    const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
      body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[{role:'system',content:sysPrompt},{role:'user',content:userPrompt}],max_tokens:1000})
    });
    const data=await res.json();
    const raw=data.choices?.[0]?.message?.content||'';
    const replies=parseForumJSON(raw);
    if(replies.length){
      f.posts[postIdx].comments=replies.map(c=>({
        author:c.author||c.name||'匿名',
        text:c.text||c.content||'',
        time:c.time||'',
        likes:c.likes||0
      }));
      f.posts[postIdx].views=(f.posts[postIdx].views||1)+Math.floor(Math.random()*50+10);
      f.posts[postIdx].likes=Math.floor(Math.random()*15+2);
      LS.setItem('forums',JSON.stringify(forums));
      renderForumPosts();
      showToast('有人回复了你的帖子');
    }
  }catch(e){}
}

// ===== 论坛评论回复
let forumReplyTarget=null;

function setForumReplyTarget(commentIdx){
  const f=forums[currentForumIdx];
  const p=f.posts[currentPostIdx];
  const c=p.comments[commentIdx];
  forumReplyTarget={idx:commentIdx,author:c.author};
  document.getElementById('forumReplyHint').style.display='inline';
  document.getElementById('forumReplyName').textContent=c.author;
  document.getElementById('forumCommentInput').placeholder=`回复 ${c.author}…`;
  document.getElementById('forumCommentInput').focus();
}
function clearForumReplyTarget(){
  forumReplyTarget=null;
  document.getElementById('forumReplyHint').style.display='none';
  document.getElementById('forumCommentInput').placeholder='写评论…';
}

function submitForumComment(){
  const text=document.getElementById('forumCommentInput').value.trim();
  if(!text){showToast('请输入评论内容');return;}
  const f=forums[currentForumIdx];
  const post=f.posts[currentPostIdx];
  const me=f.mePresetIndex!=null?mePresets[f.mePresetIndex]:null;
  const myName=me?.name||'我';
  if(!post.comments)post.comments=[];
  const comment={author:myName,text,time:'刚刚',likes:0};
  if(forumReplyTarget)comment.replyTo=forumReplyTarget.author;
  post.comments.push(comment);
  LS.setItem('forums',JSON.stringify(forums));
  document.getElementById('forumCommentInput').value='';
  clearForumReplyTarget();
  openForumPost(currentPostIdx);
  showToast('评论成功');
  generateForumCommentReply(currentPostIdx,post.comments.length-1);
}

async function generateForumCommentReply(postIdx,myCommentIdx){
  const p=presets[activePreset]||{};
  if(!p.key)return;
  const f=forums[currentForumIdx];
  const post=f.posts[postIdx];
  const me=f.mePresetIndex!=null?mePresets[f.mePresetIndex]:null;
  const myName=me?.name||'我';
  const myComment=post.comments[myCommentIdx];
  const replyingTo=myComment.replyTo||post.author;

  // 判断被回复者是否是角色成员
  const targetContact=contacts.find(c=>c.name===replyingTo&&f.members?.includes(c.id));
  const memberContacts=contacts.filter(c=>f.members?.includes(c.id));

  const existingComments=post.comments.map(c=>`${c.author}${c.replyTo?'回复'+c.replyTo:''}：${c.text}`).join('\n');

  const sysPrompt=`你是论坛回复生成器。只输出JSON数组，禁止任何其他文字。`;
  const userPrompt=`论坛：${f.name}，世界观：${f.world||'普通论坛'}
帖子标题：${post.title}
帖子正文：${post.content}
已有评论：
${existingComments}

${myName}刚刚发了新评论：${myComment.replyTo?'回复'+myComment.replyTo+'：':''}${myComment.text}

角色成员信息：
${memberContacts.map(c=>`${c.name}（${c.gender==='male'?'男':'女'}，人设：${c.persona||'无'}）`).join('\n')||'无'}

请生成对${myName}这条评论的回复，要求：
1. 生成1-3条回复
2. ${targetContact?`被回复的${replyingTo}是角色成员，根据人设判断是否回复（明星/公众人物一般不会随便回复）`:'被回复的是网友，可以由该网友或其他网友回复'}
3. 其他网友也可能参与讨论
4. 每条包含author、text、time、likes、replyTo字段，replyTo填被回复者名字
5. 回复自然真实有网感

输出JSON数组`;

  try{
    const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
      body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[{role:'system',content:sysPrompt},{role:'user',content:userPrompt}],max_tokens:500})
    });
    const data=await res.json();
    const raw=data.choices?.[0]?.message?.content||'';
    const replies=parseForumJSON(raw);
    if(replies.length){
      replies.forEach(c=>{
        post.comments.push({author:c.author||'匿名',text:c.text||c.content||'',time:c.time||'',likes:c.likes||0,replyTo:c.replyTo||myName});
      });
      LS.setItem('forums',JSON.stringify(forums));
      openForumPost(currentPostIdx);
    }
  }catch(e){}
}
// ===== 搜索聊天记录
function openSearchChat(){
  closePanelConvSettings();
  document.getElementById('searchChatInput').value='';
  document.getElementById('searchChatResults').innerHTML='<p style="font-size:13px;color:var(--text2);text-align:center;padding:20px 0">输入关键词开始搜索</p>';
  _openPanelInConv('panelSearchChat');
  setTimeout(function(){document.getElementById('searchChatInput').focus();},100);
}
function closeSearchChat(){document.getElementById('panelSearchChat').classList.remove('open');}

function jumpToMsg(idx){
  closeSearchChat();
  var allMsgs=conversations[currentContact.id]||[];
  msgDisplayCount=Math.max(msgDisplayCount,allMsgs.length-idx+5);
  renderMessages();
  setTimeout(function(){
    var el=document.querySelector('[data-msg-idx="'+idx+'"]');
    if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.background='rgba(255,200,0,.15)';setTimeout(function(){el.style.background='';},2000);}
  },100);
}

function doSearchChat(){
  var kw=document.getElementById('searchChatInput').value.trim().toLowerCase();
  var box=document.getElementById('searchChatResults');
  if(!kw){box.innerHTML='<p style="font-size:13px;color:var(--text2);text-align:center;padding:20px 0">输入关键词开始搜索</p>';return;}
  var msgs=conversations[currentContact.id]||[];
  var results=[];
  msgs.forEach(function(m,i){
    var text=m.content||m.displayDesc||'';
    if(text.toLowerCase().indexOf(kw)!==-1)results.push({msg:m,idx:i});
  });
  if(!results.length){box.innerHTML='<p style="font-size:13px;color:var(--text2);text-align:center;padding:20px 0">没有找到相关消息</p>';return;}
  var escaped=kw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  var re=new RegExp('('+escaped+')','gi');
  box.innerHTML=results.map(function(r){
    var m=r.msg;
    var text=m.content||m.displayDesc||'';
    var hl=text.replace(re,'<mark style="background:rgba(255,200,0,.4);border-radius:2px;padding:0 1px">$1</mark>');
    var who=m.role==='user'?'我':currentContact.name;
    return '<div onclick="jumpToMsg('+r.idx+')" style="padding:10px 12px;border-radius:12px;background:var(--card2);cursor:pointer">'
      +'<div style="display:flex;justify-content:space-between;margin-bottom:4px">'
      +'<span style="font-size:12px;font-weight:600;color:var(--accent)">'+who+'</span>'
      +'<span style="font-size:11px;color:var(--text2)">'+(m.time||'')+'</span>'
      +'</div>'
      +'<div style="font-size:13px;color:var(--text);line-height:1.5;word-break:break-all">'+hl+'</div>'
      +'</div>';
  }).join('');
}

// ===== 收藏消息
let favMessages=[];
(async()=>{await IDB.open();const d=await IDB.get('favMessages');if(d)try{favMessages=JSON.parse(d);}catch(e){}else{const old=localStorage.getItem('favMessages');if(old){try{favMessages=JSON.parse(old);}catch(e){}localStorage.removeItem('favMessages');}}})();
function saveFavMessages(){IDB.set('favMessages',JSON.stringify(favMessages));}

function favMsg(idx){
  closeActionMenu();
  const id=currentContact.id;
  const m=(conversations[id]||[])[idx];
  if(!m){showToast('消息不存在');return;}
  const fav={contactId:id,contactName:currentContact.name,contactAvatar:currentContact.avatar||'',role:m.role,content:m.content||'',type:m.type||'text',displayDesc:m.displayDesc||'',displayMood:m.displayMood||'',imageData:m.imageData||'',time:m.time||'',favTime:Date.now()};
  favMessages.unshift(fav);
  saveFavMessages();
  showToast('已收藏');
}

function openFavList(){
  closePanelConvSettings();
  _showFavPanel(currentContact?currentContact.id:null);
}
function openGroupFavList(){
  closeGroupSettings();
  _showFavPanel(currentGroup?'g_'+currentGroup.id:null);
}
function _showFavPanel(filterKey){
  const box=document.getElementById('favListBody');
  const list=filterKey?favMessages.filter(f=>f.contactId===filterKey):favMessages;
  if(!list.length){box.innerHTML='<p style="font-size:13px;color:var(--text2);text-align:center;padding:30px 0">暂无收藏</p>';document.getElementById('panelFavList').classList.add('open');return;}
  box.dataset.filterKey=filterKey||'';
  box.innerHTML=list.map((f,i)=>{
    const who=f.role==='user'?'我':(f.authorName||f.contactName);
    let preview=f.content||'';
    if(f.type==='image')preview='[图片]';
    else if(f.type==='photo')preview='[照片] '+f.displayDesc;
    if(preview.length>60)preview=preview.slice(0,60)+'...';
    const d=new Date(f.favTime);
    const ts=`${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
    return `<div style="padding:10px 12px;border-radius:12px;background:var(--card2);position:relative">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <span style="font-size:12px;font-weight:600;color:var(--accent)">${who}</span>
        <span style="font-size:10px;color:var(--text2)">收藏于 ${ts}</span>
      </div>
      <div style="font-size:13px;color:var(--text);line-height:1.5;word-break:break-all">${preview}</div>
      <div style="display:flex;justify-content:flex-end;margin-top:6px"><button onclick="removeFav(${i})" style="background:rgba(0,0,0,.06);border:none;cursor:pointer;color:var(--text2);font-size:11px;padding:3px 10px;border-radius:8px;font-family:inherit">取消收藏</button></div>
    </div>`;
  }).join('');
  _openPanelInConv('panelFavList');
}
function closeFavList(){document.getElementById('panelFavList').classList.remove('open');}
function removeFav(i){
  const box=document.getElementById('favListBody');
  const filterKey=box.dataset.filterKey||'';
  const list=filterKey?favMessages.filter(f=>f.contactId===filterKey):favMessages;
  const target=list[i];
  const realIdx=favMessages.indexOf(target);
  if(realIdx>-1)favMessages.splice(realIdx,1);
  saveFavMessages();
  _showFavPanel(filterKey||null);
  showToast('已取消收藏');
}

// 酒馆角色卡导入
function importTavernCard(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const buf=new Uint8Array(ev.target.result);
      const cardJson=extractPngText(buf);
      if(!cardJson){showToast('未找到角色卡数据');return;}
      let card;
      try{card=JSON.parse(cardJson);}catch(e2){showToast('角色卡数据格式错误');return;}
      // 兼容v1和v2格式
      const d=card.data||card;
      const name=d.name||card.name||'';
      const desc=d.description||card.description||'';
      const persona=d.personality||card.personality||'';
      const scenario=d.scenario||card.scenario||'';
      const firstMsg=d.first_mes||card.first_mes||'';
      // 组合人设
      let fullPersona=desc;
      if(persona)fullPersona+='\n性格：'+persona;
      if(scenario)fullPersona+='\n场景：'+scenario;
      document.getElementById('cName').value=name;
      document.getElementById('cPersona').value=fullPersona.trim();
      // 用PNG本身作头像
      const blob=new Blob([buf],{type:'image/png'});
      const imgUrl=URL.createObjectURL(blob);
      compressAvatar(imgUrl,200,compressed=>{
        contactAvatarData=compressed;
        document.getElementById('contactAvatarPreview').innerHTML=`<img src="${compressed}" style="width:100%;height:100%;object-fit:cover"/>`;
        URL.revokeObjectURL(imgUrl);
      });
      showToast('角色卡已导入 ✓');
    }catch(err){showToast('导入失败：'+err.message);}
  };
  r.readAsArrayBuffer(file);
}

function extractPngText(buf){
  // PNG: 8-byte sig, then chunks: 4len+4type+data+4crc
  if(buf[0]!==0x89||buf[1]!==0x50)return null;
  let pos=8;
  while(pos<buf.length-8){
    const len=(buf[pos]<<24|buf[pos+1]<<16|buf[pos+2]<<8|buf[pos+3])>>>0;
    const type=String.fromCharCode(buf[pos+4],buf[pos+5],buf[pos+6],buf[pos+7]);
    const dataStart=pos+8;
    if(type==='tEXt'){
      // keyword\0value
      let nul=dataStart;
      while(nul<dataStart+len&&buf[nul]!==0)nul++;
      const key=new TextDecoder().decode(buf.slice(dataStart,nul));
      const val=new TextDecoder().decode(buf.slice(nul+1,dataStart+len));
      if(key==='chara'){
        try{
          const bin=atob(val);
          const bytes=new Uint8Array(bin.length);
          for(let i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);
          return new TextDecoder('utf-8').decode(bytes);
        }catch(e){return val;}
      }
    }
    pos=dataStart+len+4;
    if(pos>buf.length)break;
  }
  return null;
}

// ===== 一起看书 =====
let bookPages=[];
let bookPage=0;
let bookName='';
const BOOK_CHARS_PER_PAGE=350;

function openBookReader(){
  document.getElementById('extraMenu').style.display='none';
  document.getElementById('extraBtn').style.background='var(--card2)';
  renderBookList();
  document.getElementById('bookPanel').classList.add('open');
}
function closeBookReader(){document.getElementById('bookPanel').classList.remove('open');}

// 书架数据
function onBookFile(e){
  const file=e.target.files[0];if(!file)return;
  e.target.value='';
  const name=file.name.replace(/\.txt$/i,'');
  const r=new FileReader();
  r.onload=ev=>{
    const text=ev.target.result.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
    const pages=splitBookPages(text,BOOK_CHARS_PER_PAGE);
    bookShelf.push({name,pages,currentPage:0});
    LS.setItem('bookShelf',JSON.stringify(bookShelf));
    renderBookList();
    showToast('已导入：'+name);
  };
  r.readAsText(file);
}
function getActiveBook(){return bookShelf.length?bookShelf[bookShelf.length-1]:null;}
function renderBookList(){
  const box=document.getElementById('bookListBody');
  const empty=document.getElementById('bookListEmpty');
  empty.style.display=bookShelf.length?'none':'flex';
  box.innerHTML=bookShelf.map((b,i)=>`<div style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--card);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.05)">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
    <div style="flex:1;min-width:0">
      <div style="font-size:14px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${b.name}</div>
      <div style="font-size:11px;color:var(--text2);margin-top:2px">第${b.currentPage+1}/${b.pages.length}页</div>
    </div>
    <button onclick="event.stopPropagation();readBook(${i})" style="padding:6px 14px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">阅读</button>
    <button onclick="event.stopPropagation();deleteBook(${i})" style="background:none;border:none;cursor:pointer;color:var(--text2);padding:4px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
  </div>`).join('');
}
function readBook(i){
  const b=bookShelf[i];if(!b)return;
  closeBookReader();
  openBookFloat(b,i);
}
function deleteBook(i){
  bookShelf.splice(i,1);
  LS.setItem('bookShelf',JSON.stringify(bookShelf));
  renderBookList();
}

function splitBookPages(text,maxChars){
  const pages=[];
  const paragraphs=text.split('\n').filter(p=>p.trim());
  let current='';
  for(const p of paragraphs){
    if(current.length+p.length+1>maxChars&&current.length>0){pages.push(current.trim());current=p;}
    else current+=(current?'\n':'')+p;
  }
  if(current.trim())pages.push(current.trim());
  return pages.length?pages:[''];
}

let activeBookIdx=-1;
function openBookFloat(b,idx){
  activeBookIdx=idx;
  let fl=document.getElementById('bookFloat');
  if(fl)fl.remove();
  fl=document.createElement('div');
  fl.className='book-float';fl.id='bookFloat';
  fl.innerHTML=`<div class="bf-header">
    <div class="bf-title">${b.name}</div>
    <button class="bf-btn" onclick="toggleBookMinimize()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
    <button class="bf-btn" onclick="closeBookFloat()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
  </div>
  <div class="bf-body"><div class="bf-content" id="bfContent"></div></div>
  <div class="bf-footer">
    <button onclick="bfPrev()">上一页</button>
    <span id="bfPageInfo" style="font-size:11px;color:var(--text2)"></span>
    <button onclick="bfNext()">下一页</button>
    <button class="primary" onclick="discussBook()">讨论</button>
  </div>`;
  document.querySelector('.phone').appendChild(fl);
  setupBookFloatDrag(fl);
  renderBookFloat();
}
function renderBookFloat(){
  const b=bookShelf[activeBookIdx];if(!b)return;
  document.getElementById('bfContent').innerHTML=b.pages[b.currentPage].replace(/\n/g,'<br>');
  document.getElementById('bfPageInfo').textContent=(b.currentPage+1)+'/'+b.pages.length;
}
function bfPrev(){const b=bookShelf[activeBookIdx];if(b&&b.currentPage>0){b.currentPage--;LS.setItem('bookShelf',JSON.stringify(bookShelf));renderBookFloat();}}
function bfNext(){const b=bookShelf[activeBookIdx];if(b&&b.currentPage<b.pages.length-1){b.currentPage++;LS.setItem('bookShelf',JSON.stringify(bookShelf));renderBookFloat();}}
function toggleBookMinimize(){document.getElementById('bookFloat')?.classList.toggle('minimized');}
function closeBookFloat(){document.getElementById('bookFloat')?.remove();activeBookIdx=-1;}
function setupBookFloatDrag(fl){
  const header=fl.querySelector('.bf-header');
  let startX,startY,origL,origT,moving=false;
  function onStart(cx,cy){startX=cx;startY=cy;origL=fl.offsetLeft;origT=fl.offsetTop;moving=true;}
  function onMove(cx,cy){if(!moving)return;const phone=document.querySelector('.phone');fl.style.left=Math.max(0,Math.min(phone.offsetWidth-fl.offsetWidth,origL+(cx-startX)))+'px';fl.style.top=Math.max(0,Math.min(phone.offsetHeight-60,origT+(cy-startY)))+'px';}
  function onEnd(){moving=false;}
  header.addEventListener('touchstart',e=>{onStart(e.touches[0].clientX,e.touches[0].clientY);},{passive:true});
  header.addEventListener('touchmove',e=>{onMove(e.touches[0].clientX,e.touches[0].clientY);},{passive:true});
  header.addEventListener('touchend',onEnd);
  header.addEventListener('mousedown',e=>{onStart(e.clientX,e.clientY);const mm=ev=>onMove(ev.clientX,ev.clientY);const mu=()=>{onEnd();document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);};document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu);});
}

function renderPageToImage(text){
  const canvas=document.createElement('canvas');
  const W=480,PAD=24,FONT=15,LH=24;
  const ctx=canvas.getContext('2d');
  canvas.width=W;
  ctx.font=FONT+'px sans-serif';
  const maxW=W-PAD*2;
  const lines=[];
  text.split('\n').forEach(para=>{
    if(!para.trim()){lines.push('');return;}
    let line='';
    for(const ch of para){if(ctx.measureText(line+ch).width>maxW){lines.push(line);line=ch;}else line+=ch;}
    if(line)lines.push(line);
  });
  canvas.height=Math.max(200,PAD*2+lines.length*LH);
  ctx.fillStyle='#FAFAFA';ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#222';ctx.font=FONT+'px sans-serif';ctx.textBaseline='top';
  lines.forEach((l,i)=>ctx.fillText(l,PAD,PAD+i*LH));
  return canvas.toDataURL('image/jpeg',.65);
}

async function discussBook(){
  const b=bookShelf[activeBookIdx];
  if(!b||(!currentContact&&!currentGroup))return;
  const p=presets[activePreset]||{};
  if(!p.key){showToast('请先配置API');return;}
  closeBookReader();
  const pageText=b.pages[b.currentPage]||'';
  const pageImg=renderPageToImage(pageText);
  const now=new Date();
  const ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')+':'+now.getSeconds().toString().padStart(2,'0');
  const bookMsg={role:'user',type:'book',content:'[一起看书] '+b.name+' 第'+(b.currentPage+1)+'页',bookImg:pageImg,bookTitle:b.name,bookPageNum:b.currentPage+1,time:ts};
  if(currentGroup){
    const gid=currentGroup.id;
    if(!groupConversations[gid])groupConversations[gid]=[];
    groupConversations[gid].push(bookMsg);
    LS.setItem('groupConvs',JSON.stringify(groupConversations));
    renderGroupMessages();
  } else if(currentContact){
    const id=currentContact.id;
    if(!conversations[id])conversations[id]=[];
    conversations[id].push(bookMsg);
    LS.setItem('conversations',JSON.stringify(conversations));
    renderMessages();
  }
  renderMsgList();
  showToast('角色正在阅读...');
  const c=currentContact;
  const me=c&&c.mePresetIndex!=null?mePresets[c.mePresetIndex]:null;
  const mePart=me?`对方（用户）是${me.name}，${me.gender==='male'?'男':'女'}。${me.persona||''}`:'';
  const persona=c?'你是'+c.name+'，'+(c.gender==='male'?'男':'女')+'性。'+(c.persona||''):'你是群聊中的角色。';
  // 构建聊天上下文
  const id=currentContact?currentContact.id:null;
  const memCount=id?parseInt(localStorage.getItem('memoryCount_'+id)||'20'):20;
  const recentMsgs=id?(conversations[id]||[]).slice(-memCount):[];
  const chatContext=recentMsgs.map(m=>{
    if(m.type==='image')return {role:m.role,content:'[图片]'};
    if(m.type==='photo')return {role:m.role,content:'[照片：'+m.displayDesc+']'};
    if(m.type==='book')return {role:m.role,content:m.content};
    return {role:m.role,content:m.content||''};
  });
  const extraPrompt=id?LS.getItem('extraPrompt_'+id)||'':'';
  const extraPart=extraPrompt?'\n\n【补充设定（必须严格遵守）】\n'+extraPrompt:'';
  let longMemPart='';
  if(id){const memText=getMemoryText(id);if(memText)longMemPart='\n\n【长期记忆】\n'+memText;}

  const bookSysPrompt=persona+'\n'+mePart+longMemPart+extraPart+`

你们正在一起看小说"${b.name}"，现在看到第${b.currentPage+1}页。图片是这一页的内容。

【最重要：角色一致性】
你就是${c?c.name:'这个角色'}，你的性格、说话方式、情绪表达必须完全符合你的人设。
- 如果你人设是冷淡的，就冷淡地评价，不要突然变得热情活泼
- 如果你人设是话少的，就少说几个字，不要长篇大论
- 如果你人设是毒舌的，就毒舌地吐槽，不要温柔体贴
- 你的反应取决于你是什么样的人，不是取决于剧情是否精彩
- 记住你和对方的关系，用符合你们关系的方式聊天

【对话规则】
你在用手机和对方发消息讨论这本书，模拟真实微信聊天风格。
- 禁止任何旁白、动作描写、神态描写，直接发消息
- 语气必须和你平时聊天一模一样
- 可以联系你们之前的聊天内容来讨论
- 不要复述原文，用自己的话
- 有自己的立场和偏好，不要什么都附和

请根据以上最近${chatContext.length}条聊天记忆，结合角色人设作出自然回复。用JSON数组格式回复，每个元素是一条消息字符串，条数由你根据真实感自由决定，可以1条也可以多条。格式示例：["消息1","消息2"]，只输出JSON数组，不要任何其他内容。`;

  try{
    const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
      body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[
        {role:'system',content:bookSysPrompt},
        ...chatContext,
        {role:'user',content:[{type:'text',text:'我们一起看这页~'},{type:'image_url',image_url:{url:pageImg,detail:'low'}}]}
      ],max_tokens:300})
    });
    const data=await res.json();
    const raw=data.choices&&data.choices[0]&&data.choices[0].message?data.choices[0].message.content.trim():'...';
    const msgs_out=parseMultiMsg(raw);
    for(let k=0;k<msgs_out.length;k++){
      if(k>0)await new Promise(r=>setTimeout(r,800));
      const msg=msgs_out[k];
      const now2=new Date();
      const ts2=now2.getHours().toString().padStart(2,'0')+':'+now2.getMinutes().toString().padStart(2,'0')+':'+now2.getSeconds().toString().padStart(2,'0');
      msgAnimFlag=true;
      if(currentContact){
        if(msg.type==='photo'){
          conversations[currentContact.id].push({role:'assistant',type:'photo',content:msg.content,displayDesc:msg.displayDesc,displayMood:msg.displayMood,time:ts2});
          showChatNotify(currentContact,'[照片] '+msg.displayDesc);
        } else {
          conversations[currentContact.id].push({role:'assistant',content:msg.content,time:ts2});
        showChatNotify(currentContact,msg.content);
        }
        LS.setItem('conversations',JSON.stringify(conversations));
        renderMessages();
      }
      renderMsgList();
      setTimeout(function(){msgAnimFlag=false;},420);
      playMsgSound();
    }
  }catch(e){showToast('请求失败');}
}

// ===== 群聊 =====
let groups=[];
let groupConversations={};
let groupMemberSet=new Set();

function openCreateGroup(){
  groupMemberSet=new Set();
  document.getElementById('groupName').value='';
  document.getElementById('groupNotice').value='';
  document.getElementById('createGroupTitle').textContent='创建群聊';
  const sel=document.getElementById('groupMePreset');
  sel.innerHTML='<option value="">（不绑定）</option>'+mePresets.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('');
  renderGroupMemberList();
  document.getElementById('panelCreateGroup').classList.add('open');
}
function closeCreateGroup(){document.getElementById('panelCreateGroup').classList.remove('open');}

function renderGroupMemberList(){
  const box=document.getElementById('groupMemberList');
  const empty=document.getElementById('groupNoContacts');
  if(!contacts.length){box.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  box.innerHTML=contacts.map(c=>{
    const sel=groupMemberSet.has(c.id);
    const avUrl=c.avatar?getAvatarURL('c_'+c.id,c.avatar):'';
    return `<div class="visible-opt${sel?' selected':''}" onclick="toggleGroupMember(${c.id},this)">
      <div class="visible-opt-avatar">${avUrl?`<img src="${avUrl}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`}</div>
      <span>${c.name}</span>
      <div class="visible-check"></div>
    </div>`;
  }).join('');
}
function toggleGroupMember(id,el){
  if(groupMemberSet.has(id))groupMemberSet.delete(id);
  else groupMemberSet.add(id);
  el.classList.toggle('selected',groupMemberSet.has(id));
}

function saveGroup(){
  const name=document.getElementById('groupName').value.trim();
  if(!name){showToast('请输入群聊名称');return;}
  if(groupMemberSet.size<2){showToast('至少选择2位成员');return;}
  const meVal=document.getElementById('groupMePreset').value;
  const g={
    id:Date.now(),
    name,
    notice:document.getElementById('groupNotice').value.trim(),
    members:[...groupMemberSet],
    mePresetIndex:meVal===''?null:parseInt(meVal),
    createdAt:Date.now(),
    owner:'me',
    admins:[],
    mutedMembers:{}
  };
  groups.push(g);
  LS.setItem('groups',JSON.stringify(groups));
  closeCreateGroup();
  renderMsgList();
  renderContacts();
  showToast('群聊已创建 ✓');
}

function buildGroupAvatar(g){
  const memberContacts=contacts.filter(c=>g.members.includes(c.id)).slice(0,9);
  const n=memberContacts.length;
  const cls=n<=2?'m2':n<=4?'m4':'m'+Math.min(n,9);
  const cells=memberContacts.map(c=>{
    const avUrl=c.avatar?getAvatarURL('c_'+c.id,c.avatar):'';
    return avUrl?`<img src="${avUrl}"/>`:`<div class="ga-placeholder"><svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>`;
  }).join('');
  return `<div class="group-avatar ${cls}">${cells}</div>`;
}

let currentGroup=null;
let groupMsgDisplayCount=30;

function openGroupConv(g){
  currentGroup=g;
  groupMsgDisplayCount=30;
  document.getElementById('convTitle').textContent=g.name;
  const avEl=document.getElementById('convHeaderAvatar');
  const subEl=document.getElementById('convSubTitle');
  avEl.innerHTML=buildGroupAvatar(g).replace('width:46px;height:46px','width:34px;height:34px');
  avEl.style.display='block';
  subEl.textContent=g.members.length+'人 · '+(g.notice||'群聊');
  subEl.style.display='block';
  const box2=document.getElementById('convMessages');
  box2.style.backgroundImage='';
  IDB.get('convBg_g_'+g.id).then(gBg=>{if(gBg){box2.style.backgroundImage=`url(${gBg})`;box2.style.backgroundSize='cover';box2.style.backgroundPosition='center';}});
  if(!groupConversations[g.id])groupConversations[g.id]=[];
  enterSendOn=LS.getItem('enterSend_g_'+g.id)==='1';
  renderGroupMessages();
  document.getElementById('pageConv').classList.add('open');
}

let groupMultiSelect=false;
let groupSelectedIdxs=new Set();

function renderGroupMessages(){
  if(!currentGroup)return;
  bubbleColors=getBubbleColors();
  const box=document.getElementById('convMessages');
  const allMsgs=groupConversations[currentGroup.id]||[];
  const total=allMsgs.length;
  const startIdx=Math.max(0,total-groupMsgDisplayCount);
  const msgs=allMsgs.slice(startIdx);
  const me=currentGroup.mePresetIndex!=null?mePresets[currentGroup.mePresetIndex]:null;
  const meAvUrl=me?.avatar?getAvatarURL('me_'+(currentGroup.mePresetIndex||0),me.avatar):'';
  const meAvatar=meAvUrl?`<img src="${meAvUrl}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
  const gAvR=(LS.getItem('avatarStyle_g_'+currentGroup.id)||'circle')==='rounded'?'10px':'50%';

  if(!allMsgs.length){box.innerHTML='<p style="color:var(--text2);font-size:14px;text-align:center;padding:60px 0">群聊已创建，开始聊天吧</p>';return;}

  const loadMoreHtml=startIdx>0?`<div style="text-align:center;padding:10px 0 14px"><button onclick="loadMoreGroupMsgs()" style="padding:7px 20px;border-radius:20px;border:1.5px solid var(--accent2);background:var(--card2);font-size:12px;color:var(--text2);cursor:pointer;font-family:inherit">查看更早的消息 (${startIdx}条)</button></div>`:'';

  box.innerHTML=loadMoreHtml+msgs.map((m,mi)=>{
    const i=startIdx+mi;
    if(m.role==='system'&&m.type==='notice'){
      return `<div style="text-align:center;padding:6px 0"><span style="font-size:11px;color:var(--text2);background:var(--card2);padding:4px 14px;border-radius:10px;display:inline-block">${m.content}</span></div>`;
    }

    const isUser=m.role==='user';
    const time=m.time||'';
    const isSel=groupSelectedIdxs.has(i);
    const checkbox=groupMultiSelect?`<div class="msg-checkbox${isSel?' checked':''}" onclick="toggleGroupMsgSelect(${i})"></div>`:'';

    const gIsLast=(mi===msgs.length-1);
    if(isUser){
      const gAnimCls=gIsLast&&msgAnimFlag?' anim-send':'';
      const bubble=m.type==='vote'?renderVoteCard(m,true):m.type==='song'?`<div class="tg-bubble media" data-gidx="${i}"><div class="song-card-bubble"><div class="song-card-top">${m.songCover?`<img src="${m.songCover}"/>`:`<div style="width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#2c2c3e,#16213e);display:flex;align-items:center;justify-content:center"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="1.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div>`}<div class="sct-info"><div class="sct-name">${m.songName||'未知歌曲'}</div><div class="sct-artist">${m.songArtist||''}</div></div></div><div class="song-card-bottom"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg><span>一起听歌</span></div></div></div>`:`<div class="tg-bubble${gAnimCls}" data-gidx="${i}" style="background:${bubbleColors.my};color:${getTextColor(bubbleColors.my)};${isSel?'opacity:.6':''}">${m.content}</div>`;
      return `<div style="display:flex;align-items:flex-end;gap:8px;justify-content:flex-end;padding:2px 0" data-msg-idx="${i}">
        ${groupMultiSelect?checkbox:''}
        ${bubble}
        <div style="display:flex;flex-direction:column;align-items:center;gap:3px;flex-shrink:0">
          <div style="width:34px;height:34px;border-radius:${gAvR};background:var(--accent2);overflow:hidden;display:flex;align-items:center;justify-content:center">${meAvatar}</div>
          ${time?`<span style="font-size:9px;color:var(--text2)">${time}</span>`:''}
        </div>
      </div>`;
    }

    const c=contacts.find(x=>x.id===m.authorId);
    const avUrl=c?.avatar?getAvatarURL('c_'+c.id,c.avatar):'';
    const av=avUrl?`<img src="${avUrl}" style="width:100%;height:100%;object-fit:cover"/>`:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
    const name=m.authorName||c?.name||'未知';

    return `<div style="display:flex;align-items:flex-end;gap:8px;justify-content:flex-start;padding:2px 0" data-msg-idx="${i}">
      ${!isUser&&groupMultiSelect?checkbox:''}
      <div style="display:flex;flex-direction:column;align-items:center;gap:3px;flex-shrink:0">
        <div style="width:34px;height:34px;border-radius:${gAvR};background:var(--accent2);overflow:hidden;display:flex;align-items:center;justify-content:center">${av}</div>
        ${time?`<span style="font-size:9px;color:var(--text2)">${time}</span>`:''}
      </div>
      <div style="max-width:72%">
        <div style="font-size:10px;color:var(--accent);font-weight:600;margin-bottom:3px;margin-left:4px">${name}</div>
        ${m.type==='vote'?renderVoteCard(m,false):m.type==='song'?`<div class="tg-bubble media" data-gidx="${i}"><div class="song-card-bubble"><div class="song-card-top">${m.songCover?`<img src="${m.songCover}"/>`:`<div style="width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#2c2c3e,#16213e);display:flex;align-items:center;justify-content:center"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="1.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div>`}<div class="sct-info"><div class="sct-name">${m.songName||'未知歌曲'}</div><div class="sct-artist">${m.songArtist||''}</div></div></div><div class="song-card-bottom"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg><span>一起听歌</span></div></div></div>`:`<div class="tg-bubble${gIsLast&&msgAnimFlag?' anim-recv':''}" data-gidx="${i}" style="background:${bubbleColors.their};color:${getTextColor(bubbleColors.their)};max-width:none;${isSel?'opacity:.6':''}">${m.content}</div>`}
      </div>
      ${!isUser&&groupMultiSelect?'':groupMultiSelect?checkbox:''}
    </div>`;
  }).join('');

  // 长按菜单
  if(!groupMultiSelect){
    box.querySelectorAll('[data-gidx]').forEach(el=>{
      let timer;
      el.addEventListener('touchstart',e=>{timer=setTimeout(()=>showGroupMsgMenu(e.touches[0],+el.dataset.gidx),500);},{passive:true});
      el.addEventListener('touchend',()=>clearTimeout(timer),{passive:true});
      el.addEventListener('touchmove',()=>clearTimeout(timer),{passive:true});
      el.addEventListener('contextmenu',e=>{e.preventDefault();showGroupMsgMenu(e,+el.dataset.gidx);});
    });
  }

  // 多选底栏
  const old=document.getElementById('groupMultiBar');
  if(old)old.remove();
  if(groupMultiSelect){
    const bar=document.createElement('div');
    bar.id='groupMultiBar';
    bar.className='msg-select-bar';
    bar.innerHTML=`<span style="font-size:13px;color:var(--text2)">已选 ${groupSelectedIdxs.size} 条</span><div style="display:flex;gap:10px"><button onclick="exitGroupMultiSelect()" style="padding:8px 16px;border-radius:10px;border:1.5px solid var(--accent2);background:none;font-size:13px;color:var(--text);cursor:pointer;font-family:inherit">取消</button><button onclick="deleteGroupSelectedMsgs()" style="padding:8px 16px;border-radius:10px;border:none;background:#FF3B30;font-size:13px;color:#fff;font-weight:600;cursor:pointer;font-family:inherit">删除</button></div>`;
    document.getElementById('pageConv').appendChild(bar);
  }

  if(!groupMultiSelect){box.scrollTop=box.scrollHeight;}
}

function showGroupMsgMenu(e,idx){
  closeActionMenu();
  const menu=document.createElement('div');
  menu.className='msg-action-menu';
  menu.innerHTML=`
    <div class="msg-action-item" onclick="favGroupMsg(${idx})">收藏</div>
    <div class="msg-action-item" onclick="deleteGroupMsg(${idx})">删除</div>
    <div class="msg-action-item" onclick="enterGroupMultiSelect(${idx})">多选</div>`;
  const phone=document.querySelector('.phone').getBoundingClientRect();
  let x=e.clientX-phone.left,y=e.clientY-phone.top;
  x=Math.min(x,phone.width-140);
  y=Math.min(y,phone.height-100);
  menu.style.cssText+=`left:${x}px;top:${y}px;`;
  document.querySelector('.phone').appendChild(menu);
  actionMenuEl=menu;
  setTimeout(()=>document.addEventListener('click',closeActionMenu,{once:true}),10);
}

function favGroupMsg(idx){
  closeActionMenu();
  const gid=currentGroup.id;
  const m=(groupConversations[gid]||[])[idx];
  if(!m)return;
  const fav={contactId:'g_'+gid,contactName:currentGroup.name,authorName:m.authorName||'',contactAvatar:'',role:m.role,content:m.content||'',type:'text',displayDesc:'',displayMood:'',imageData:'',time:m.time||'',favTime:Date.now()};
  favMessages.unshift(fav);
  saveFavMessages();
  showToast('已收藏');
}

function deleteGroupMsg(idx){
  closeActionMenu();
  const gid=currentGroup.id;
  groupConversations[gid].splice(idx,1);
  LS.setItem('groupConvs',JSON.stringify(groupConversations));
  renderGroupMessages();renderMsgList();
  showToast('消息已删除');
}

function enterGroupMultiSelect(first){
  closeActionMenu();
  groupMultiSelect=true;
  groupSelectedIdxs=new Set([first]);
  renderGroupMessages();
}

function exitGroupMultiSelect(){
  groupMultiSelect=false;
  groupSelectedIdxs=new Set();
  const old=document.getElementById('groupMultiBar');
  if(old)old.remove();
  renderGroupMessages();
}

function toggleGroupMsgSelect(idx){
  if(groupSelectedIdxs.has(idx))groupSelectedIdxs.delete(idx);
  else groupSelectedIdxs.add(idx);
  renderGroupMessages();
}

// ===== 群投票 =====
let voteOptions=['',''];

function openGroupVote(){
  if(!currentGroup){showToast('仅群聊可用');return;}
  document.getElementById('extraMenu').style.display='none';
  document.getElementById('extraBtn').style.background='var(--card2)';
  voteOptions=['',''];
  document.getElementById('voteTitle').value='';
  document.getElementById('voteMultiple').checked=false;
  renderVoteOptions();
  document.getElementById('panelGroupVote').classList.add('open');
}
function closeGroupVote(){document.getElementById('panelGroupVote').classList.remove('open');}

function renderVoteOptions(){
  const box=document.getElementById('voteOptionList');
  box.innerHTML=voteOptions.map((v,i)=>`
    <div style="display:flex;gap:8px;align-items:center">
      <input class="set-input" style="flex:1;margin:0" placeholder="选项${i+1}" value="${v.replace(/"/g,'&quot;')}" oninput="voteOptions[${i}]=this.value"/>
      ${voteOptions.length>2?`<button onclick="removeVoteOption(${i})" style="background:none;border:none;cursor:pointer;color:var(--text2);padding:4px"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`:''}
    </div>`).join('');
}

function addVoteOption(){
  if(voteOptions.length>=10){showToast('最多10个选项');return;}
  voteOptions.push('');
  renderVoteOptions();
}

function removeVoteOption(i){
  voteOptions.splice(i,1);
  renderVoteOptions();
}

function submitGroupVote(){
  const title=document.getElementById('voteTitle').value.trim();
  if(!title){showToast('请输入投票主题');return;}
  const opts=voteOptions.map(v=>v.trim()).filter(v=>v);
  if(opts.length<2){showToast('至少需要2个选项');return;}
  const multiple=document.getElementById('voteMultiple').checked;
  const gid=currentGroup.id;
  const now=new Date();
  const ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  const vote={
    id:Date.now(),
    title,
    options:opts.map(o=>({text:o,voters:[]})),
    multiple,
    createdAt:Date.now()
  };
  if(!groupConversations[gid])groupConversations[gid]=[];
  groupConversations[gid].push({role:'user',type:'vote',vote,time:ts});
  LS.setItem('groupConvs',JSON.stringify(groupConversations));
  closeGroupVote();
  renderGroupMessages();
  renderMsgList();
  showToast('投票已发起');
}

function renderVoteCard(m,isUser){
  const v=m.vote;
  const totalVoters=new Set();
  v.options.forEach(o=>(o.voters||[]).forEach(n=>totalVoters.add(n)));
  const total=totalVoters.size;
  const me=currentGroup.mePresetIndex!=null?mePresets[currentGroup.mePresetIndex]:null;
  const myName=me?.name||'我';
  const iVoted=v.options.some(o=>(o.voters||[]).includes(myName));
  const initiator=v.initiator||m.authorName||(isUser?myName:'');

  let optionsHtml=v.options.map((o,oi)=>{
    const cnt=(o.voters||[]).length;
    const pct=total?Math.round(cnt/total*100):0;
    const voted=(o.voters||[]).includes(myName);
    return `<div onclick="${!iVoted?`castVote('${v.id}',${oi})`:'void(0)'}" style="padding:10px 12px;border-radius:10px;background:var(--card2);cursor:${iVoted?'default':'pointer'};position:relative;overflow:hidden;border:1.5px solid ${voted?'var(--accent)':'transparent'}">
      <div style="position:absolute;left:0;top:0;bottom:0;width:${pct}%;background:${voted?'var(--accent)':'var(--accent2)'};opacity:.2;transition:width .3s"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;position:relative">
        <span style="font-size:13px;color:var(--text);font-weight:${voted?'600':'400'}">${o.text}</span>
        <span style="font-size:12px;color:var(--text2)">${cnt}票 ${pct}%</span>
      </div>
      ${(o.voters||[]).length?`<div style="font-size:10px;color:var(--text2);margin-top:4px;position:relative">${(o.voters||[]).join('、')}</div>`:''}
    </div>`;
  }).join('');

  return `<div style="width:240px;background:var(--bg);border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.1);overflow:hidden">
    <div style="padding:14px 14px 10px;border-bottom:1px solid rgba(0,0,0,.05)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        <span style="font-size:11px;color:var(--accent);font-weight:600">群投票</span>
        ${v.multiple?'<span style="font-size:10px;color:var(--text2);background:var(--card2);padding:2px 6px;border-radius:4px">多选</span>':''}
        ${initiator?`<span style="font-size:10px;color:var(--text2)">by ${initiator}</span>`:''}
      </div>
      <div style="font-size:14px;font-weight:700;color:var(--text)">${v.title}</div>
    </div>
    <div style="padding:10px 14px 14px;display:flex;flex-direction:column;gap:8px">
      ${optionsHtml}
      <div style="font-size:11px;color:var(--text2);text-align:center;margin-top:4px">${total}人参与投票</div>
    </div>
  </div>`;
}

function castVote(voteId,optIdx){
  const gid=currentGroup.id;
  const msgs=groupConversations[gid]||[];
  const msgIdx=msgs.findIndex(m=>m.type==='vote'&&m.vote.id==voteId);
  if(msgIdx<0)return;
  const v=msgs[msgIdx].vote;
  const me=currentGroup.mePresetIndex!=null?mePresets[currentGroup.mePresetIndex]:null;
  const myName=me?.name||'我';
  // 检查是否已投票
  if(v.options.some(o=>(o.voters||[]).includes(myName))){
    if(!v.multiple){showToast('你已投过票了');return;}
  }
  if(!v.options[optIdx].voters)v.options[optIdx].voters=[];
  if(!v.options[optIdx].voters.includes(myName)){
    v.options[optIdx].voters.push(myName);
  }
  LS.setItem('groupConvs',JSON.stringify(groupConversations));
  renderGroupMessages();
  showToast('投票成功');
}

function deleteGroupSelectedMsgs(){
  const gid=currentGroup.id;
  const arr=groupConversations[gid];
  const sorted=[...groupSelectedIdxs].sort((a,b)=>b-a);
  sorted.forEach(i=>arr.splice(i,1));
  LS.setItem('groupConvs',JSON.stringify(groupConversations));
  const count=sorted.length;
  exitGroupMultiSelect();
  renderMsgList();
  showToast('已删除 '+count+' 条消息');
}

function setGroupAvatarStyle(style){
  document.getElementById('gavs-circle').classList.toggle('active',style==='circle');
  document.getElementById('gavs-rounded').classList.toggle('active',style==='rounded');
  if(currentGroup)LS.setItem('avatarStyle_g_'+currentGroup.id,style);
  renderGroupMessages();
}

function loadMoreGroupMsgs(){
  groupMsgDisplayCount+=20;
  const box=document.getElementById('convMessages');
  const prevH=box.scrollHeight;
  renderGroupMessages();
  box.scrollTop=box.scrollHeight-prevH;
}

// ===== 保存歌曲数据开关
function toggleSaveMusicData(){
  const on=LS.getItem('saveMusicData')==='1';
  if(on){
    LS.setItem('saveMusicData','0');
    // 清除IDB中的音频数据
    musicTracks.forEach(t=>{if(t.id)IDB.del(t.id);});
    LS.removeItem('musicTracks');
  } else {
    LS.setItem('saveMusicData','1');
    // 立即保存当前所有歌曲到IDB
    saveMusicTracks();
    musicTracks.forEach(t=>{
      if(t.id&&t.url){
        fetch(t.url).then(r=>r.arrayBuffer()).then(ab=>IDB.set(t.id,ab)).catch(()=>{});
      }
    });
  }
  syncSaveMusicToggle();
  showToast(on?'歌曲数据将不再保存':'歌曲数据将被保存');
}
function syncSaveMusicToggle(){
  const on=LS.getItem('saveMusicData')==='1';
  document.getElementById('saveMusicToggle').style.background=on?'var(--accent)':'var(--accent2)';
  document.getElementById('saveMusicKnob').style.left=on?'21px':'3px';
}

// ===== 音乐小组件开关
function toggleMusicWidgetSetting(){
  const on=LS.getItem('musicWidgetOn')==='1';
  if(on){
    // 关闭
    LS.setItem('musicWidgetOn','0');
    if(musicWidgetEl){musicWidgetEl.remove();musicWidgetEl=null;}
    musicAudio.pause();musicPlaying=false;
    clearInterval(musicProgressTimer);
    updateNowPlayingBar();
  } else {
    // 开启
    LS.setItem('musicWidgetOn','1');
    if(!musicWidgetEl)addMusicWidget();
  }
  syncMusicWidgetToggle();
  syncSaveMusicToggle();
}
function syncMusicWidgetToggle(){
  const on=LS.getItem('musicWidgetOn')==='1';
  document.getElementById('musicWidgetToggle').style.background=on?'var(--accent)':'var(--accent2)';
  document.getElementById('musicWidgetKnob').style.left=on?'21px':'3px';
}

// ===== 锁按钮显示开关
let lockBtnVisible=true;
function toggleLockBtnVisible(){
  lockBtnVisible=!lockBtnVisible;
  LS.setItem('lockBtnVisible',lockBtnVisible?'1':'0');
  document.getElementById('lockBtnToggle').style.background=lockBtnVisible?'var(--accent)':'var(--accent2)';
  document.getElementById('lockBtnKnob').style.left=lockBtnVisible?'21px':'3px';
  document.querySelector('.phone').classList.toggle('hide-locks',!lockBtnVisible);
}

// ===== 屏幕模式
let fullscreenOn=false;
function toggleFullscreen(){
  fullscreenOn=!fullscreenOn;
  document.getElementById('sm-full')?.classList.toggle('active',fullscreenOn);
  
  if(fullscreenOn){
    // 请求浏览器全屏
    const el=document.documentElement;
    if(el.requestFullscreen)el.requestFullscreen();
    else if(el.webkitRequestFullscreen)el.webkitRequestFullscreen();
    else if(el.msRequestFullscreen)el.msRequestFullscreen();
  }else{
    // 退出全屏
    if(document.exitFullscreen)document.exitFullscreen();
    else if(document.webkitExitFullscreen)document.webkitExitFullscreen();
    else if(document.msExitFullscreen)document.msExitFullscreen();
  }
  LS.setItem('fullscreenOn',fullscreenOn?'1':'0');
}

// 监听全屏状态变化（用户按ESC退出时同步状态）
document.addEventListener('fullscreenchange',()=>{
  const isFs=!!document.fullscreenElement;
  fullscreenOn=isFs;
  document.getElementById('sm-full')?.classList.toggle('active',isFs);
  LS.setItem('fullscreenOn',isFs?'1':'0');
});
document.addEventListener('webkitfullscreenchange',()=>{
  const isFs=!!document.webkitFullscreenElement;
  fullscreenOn=isFs;
  document.getElementById('sm-full')?.classList.toggle('active',isFs);
  LS.setItem('fullscreenOn',isFs?'1':'0');
});

// ===== 记忆系统 =====
let memoryStore={}; // {contactId_or_gId: [{day:'2025-01-15', summary:'...', ts:timestamp}]}
let memConfig={enabled:false,dmInterval:15,grpInterval:20,retainDays:7,useSameApi:true,apiBase:'',apiKey:'',apiModel:''};
let memSummarizedIdx={}; // 记录每个对话已总结到的消息索引

(async()=>{
  await IDB.open();
  const d=await IDB.get('memoryStore');if(d)try{memoryStore=JSON.parse(d);}catch(e){}
  const c=await IDB.get('memConfig');if(c)try{memConfig=JSON.parse(c);}catch(e){}
  const s=await IDB.get('memSummarizedIdx');if(s)try{memSummarizedIdx=JSON.parse(s);}catch(e){}
})();

function saveMemStore(){IDB.set('memoryStore',JSON.stringify(memoryStore));}
function saveMemConfig(){IDB.set('memConfig',JSON.stringify(memConfig));}
function saveMemIdx(){IDB.set('memSummarizedIdx',JSON.stringify(memSummarizedIdx));}

function openMemoryApp(){
  document.getElementById('memUseSameApi').checked=memConfig.useSameApi;
  document.getElementById('memApiFields').style.display=memConfig.useSameApi?'none':'block';
  document.getElementById('memApiBase').value=memConfig.apiBase||'';
  document.getElementById('memApiKey').value=memConfig.apiKey||'';
  document.getElementById('memApiModel').value=memConfig.apiModel||'';
  document.getElementById('memDmInterval').value=memConfig.dmInterval||15;
  document.getElementById('memDmIntervalVal').textContent=memConfig.dmInterval||15;
  document.getElementById('memGrpInterval').value=memConfig.grpInterval||20;
  document.getElementById('memGrpIntervalVal').textContent=memConfig.grpInterval||20;
  document.getElementById('memRetainDays').value=memConfig.retainDays||7;
  document.getElementById('memRetainVal').textContent=memConfig.retainDays||7;
  document.getElementById('memSysToggle').style.background=memConfig.enabled?'var(--accent)':'var(--accent2)';
  document.getElementById('memSysKnob').style.left=memConfig.enabled?'21px':'3px';
  renderMemoryList();
  document.getElementById('pageMemory').classList.add('open');
}
function closeMemoryApp(){document.getElementById('pageMemory').classList.remove('open');}

function toggleMemApi(){
  const same=document.getElementById('memUseSameApi').checked;
  document.getElementById('memApiFields').style.display=same?'none':'block';
}
function toggleMemorySystem(){
  memConfig.enabled=!memConfig.enabled;
  document.getElementById('memSysToggle').style.background=memConfig.enabled?'var(--accent)':'var(--accent2)';
  document.getElementById('memSysKnob').style.left=memConfig.enabled?'21px':'3px';
  saveMemConfig();
  showToast(memConfig.enabled?'记忆系统已启用':'记忆系统已关闭');
}
function saveMemApiConfig(){
  memConfig.useSameApi=document.getElementById('memUseSameApi').checked;
  memConfig.apiBase=document.getElementById('memApiBase').value.trim();
  memConfig.apiKey=document.getElementById('memApiKey').value.trim();
  memConfig.apiModel=document.getElementById('memApiModel').value.trim();
  saveMemConfig();
  showToast('总结API已保存 ✓');
}
function saveMemSettings(){
  memConfig.dmInterval=parseInt(document.getElementById('memDmInterval').value)||15;
  memConfig.grpInterval=parseInt(document.getElementById('memGrpInterval').value)||20;
  memConfig.retainDays=parseInt(document.getElementById('memRetainDays').value)||7;
  saveMemConfig();
  showToast('设置已保存 ✓');
}

function getMemApi(){
  if(memConfig.useSameApi){
    const p=presets[activePreset]||{};
    return {base:p.base||'https://api.openai.com/v1',key:p.key||'',model:p.model||'gpt-4o-mini'};
  }
  return {base:memConfig.apiBase||'https://api.openai.com/v1',key:memConfig.apiKey||'',model:memConfig.apiModel||'gpt-4o-mini'};
}

function getTodayStr(){return new Date().toISOString().slice(0,10);}

function pruneMemories(key){
  if(!memoryStore[key])return;
  const cutoff=Date.now()-(memConfig.retainDays||7)*86400000;
  memoryStore[key]=memoryStore[key].filter(m=>m.ts>=cutoff);
  if(!memoryStore[key].length)delete memoryStore[key];
}

// 获取某个对话的有效记忆文本（用于注入prompt）
function getMemoryText(key){
  if(!memConfig.enabled||!memoryStore[key])return '';
  pruneMemories(key);
  const mems=memoryStore[key];
  if(!mems||!mems.length)return '';
  // 按天分组，每天一条摘要
  const byDay={};
  mems.forEach(m=>{if(!byDay[m.day])byDay[m.day]=[];byDay[m.day].push(m.summary);});
  const lines=Object.entries(byDay).sort((a,b)=>a[0].localeCompare(b[0])).map(([day,sums])=>{
    return `[${day}] ${sums.join(' | ')}`;
  });
  return lines.join('\n');
}

async function summarizeMessages(key,msgs,contextName,isGroup){
  const api=getMemApi();
  if(!api.key)return null;
  // 压缩消息为紧凑文本
  const text=msgs.map(m=>{
    if(m.type==='vote')return '[投票]';
    const who=m.role==='user'?'用户':(m.authorName||contextName||'对方');
    return who+'：'+(m.content||m.displayDesc||'[媒体]');
  }).join('\n');

  const sysPrompt=`你是对话记忆总结器。将以下聊天记录提炼为简洁的记忆摘要。
要求：
- 只保留重要信息：关键事件、情感变化、承诺约定、新了解的信息、话题转折
- 忽略寒暄、重复、无意义闲聊
- 用第三人称简述，每条记忆一句话
- 总共不超过3-5句话，越精炼越好
- 只输出摘要文本，不要任何格式标记`;

  try{
    const res=await fetch(api.base+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.key},
      body:JSON.stringify({model:api.model,messages:[
        {role:'system',content:sysPrompt},
        {role:'user',content:`${isGroup?'群聊':'私聊'}记录（${contextName}）：\n${text}`}
      ],max_tokens:200})
    });
    const data=await res.json();
    return data.choices?.[0]?.message?.content?.trim()||null;
  }catch(e){return null;}
}

async function checkAndSummarize(key,allMsgs,contextName,isGroup){
  if(!memConfig.enabled)return;
  const interval=isGroup?(memConfig.grpInterval||20):(memConfig.dmInterval||15);
  const lastIdx=memSummarizedIdx[key]||0;
  const newCount=allMsgs.length-lastIdx;
  if(newCount<interval)return;

  // 取未总结的消息
  const batch=allMsgs.slice(lastIdx,lastIdx+interval);
  const summary=await summarizeMessages(key,batch,contextName,isGroup);
  if(!summary)return;

  if(!memoryStore[key])memoryStore[key]=[];
  memoryStore[key].push({day:getTodayStr(),summary,ts:Date.now()});
  memSummarizedIdx[key]=lastIdx+interval;
  pruneMemories(key);
  saveMemStore();
  saveMemIdx();
}

function renderMemoryList(){
  const box=document.getElementById('memoryListBody');
  const keys=Object.keys(memoryStore);
  if(!keys.length){box.innerHTML='<p style="font-size:13px;color:var(--text2);text-align:center;padding:30px 0">暂无记忆数据</p>';return;}
  box.innerHTML=keys.map(key=>{
    pruneMemories(key);
    const mems=memoryStore[key]||[];
    if(!mems.length)return '';
    // 识别名称
    let name=key;
    if(key.startsWith('g_')){
      const gid=parseInt(key.slice(2));
      const g=groups.find(x=>x.id===gid);
      name=g?'群：'+g.name:'群聊'+gid;
    } else {
      const cid=parseInt(key);
      const c=contacts.find(x=>x.id===cid);
      name=c?c.name:'联系人'+cid;
    }
    return `<div style="background:var(--card);border-radius:16px;padding:14px 16px;margin-bottom:10px;box-shadow:0 2px 10px rgba(0,0,0,.05)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-size:14px;font-weight:600;color:var(--text)">${name}</span>
        <span style="font-size:11px;color:var(--text2)">${mems.length}条记忆</span>
      </div>
      ${mems.slice(-3).map(m=>`<div style="font-size:12px;color:var(--text2);line-height:1.6;padding:4px 0;border-top:1px solid rgba(0,0,0,.04)"><span style="font-size:10px;color:var(--accent);margin-right:6px">${m.day}</span>${m.summary}</div>`).join('')}
      <div style="display:flex;gap:8px;margin-top:8px">
        <button onclick="clearMemory('${key}')" style="padding:5px 12px;border-radius:8px;border:1px solid var(--accent2);background:none;font-size:11px;color:var(--text2);cursor:pointer;font-family:inherit">清除</button>
      </div>
    </div>`;
  }).filter(s=>s).join('')||'<p style="font-size:13px;color:var(--text2);text-align:center;padding:30px 0">暂无有效记忆</p>';
}

function clearMemory(key){
  delete memoryStore[key];
  delete memSummarizedIdx[key];
  saveMemStore();saveMemIdx();
  renderMemoryList();
  showToast('已清除');
}

// ===== 应用初始化 =====
async function initApp(){
  await LS.init();
  // 从LS恢复数据
  try{contacts=JSON.parse(LS.getItem('contacts')||'[]');}catch(e){contacts=[];}
  try{conversations=JSON.parse(LS.getItem('conversations')||'{}');}catch(e){conversations={};}
  try{presets=JSON.parse(LS.getItem('apiPresets')||'[]');}catch(e){presets=[];}
  activePreset=parseInt(LS.getItem('activePreset')||'0');
  try{mePresets=JSON.parse(LS.getItem('mePresets')||'[]');}catch(e){mePresets=[];}
  try{groups=JSON.parse(LS.getItem('groups')||'[]');}catch(e){groups=[];}
  try{groupConversations=JSON.parse(LS.getItem('groupConvs')||'{}');}catch(e){groupConversations={};}
  try{forums=JSON.parse(LS.getItem('forums')||'[]');}catch(e){forums=[];}
  try{bookShelf=JSON.parse(LS.getItem('bookShelf')||'[]');}catch(e){bookShelf=[];}
  layoutCols=parseInt(LS.getItem('layoutCols')||'4');
  // 恢复头像到内存
  for(let i=0;i<mePresets.length;i++){const av=await IDB.get('meAvatar_'+i);if(av)mePresets[i].avatar=av;}
  for(const c of contacts){const av=await IDB.get('cAvatar_'+c.id);if(av)c.avatar=av;}
  // 恢复momentsMap
  try{const mm=await IDB.get('momentsMap');if(mm)momentsMap=JSON.parse(mm);}catch(e){}
  // 恢复favMessages
  try{const fm=await IDB.get('favMessages');if(fm)favMessages=JSON.parse(fm);}catch(e){}
  // 恢复记忆系统
  try{const ms=await IDB.get('memoryStore');if(ms)memoryStore=JSON.parse(ms);}catch(e){}
  try{const mc=await IDB.get('memConfig');if(mc)memConfig=JSON.parse(mc);}catch(e){}
  try{const si=await IDB.get('memSummarizedIdx');if(si)memSummarizedIdx=JSON.parse(si);}catch(e){}
  // 恢复名片缓存
  try{profileCardCache=JSON.parse(LS.getItem('profileCards')||'{}');}catch(e){}
  // 恢复锁按钮开关
  lockBtnVisible=LS.getItem('lockBtnVisible')!=='0';
  document.getElementById('lockBtnToggle').style.background=lockBtnVisible?'var(--accent)':'var(--accent2)';
  document.getElementById('lockBtnKnob').style.left=lockBtnVisible?'21px':'3px';
  if(!lockBtnVisible)document.querySelector('.phone').classList.add('hide-locks');
  // 恢复音乐数据
  try{
    if(LS.getItem('saveMusicData')==='1'){
      const mt=JSON.parse(LS.getItem('musicTracks')||'[]');
      let restored=0;
      for(const m of mt){
        if(!m.id)continue;
        const ab=await IDB.get(m.id);
        if(ab){
          const blob=new Blob([ab],{type:'audio/mpeg'});
          const url=URL.createObjectURL(blob);
          musicTracks.push({id:m.id,name:m.name,artist:m.artist,cover:m.cover||'',url,duration:0});
          restored++;
        }
      }
      if(restored){for(let i=0;i<musicTracks.length;i++)getDuration(i);if(musicTracks.length)loadTrack(0);}
    }
    // 恢复音乐小组件
    if(LS.getItem('musicWidgetOn')==='1'){
      const mw=LS.getItem('musicWidget');
      let rd={};
      if(mw)try{rd=JSON.parse(mw);}catch(e){}
      addMusicWidget(rd);
    }
  }catch(e){console.error('恢复音乐失败',e);}
  // 恢复字体
  restoreFont();
  // 恢复"我"页面背景
  IDB.get('meHeroBg').then(bg=>{if(bg)applyMeHeroBg(bg);});
  // 渲染UI
  restoreIconsAndTheme();
  if(presets.length){loadPreset(activePreset);}else{renderPresets();}
  renderMePresets();
  renderContacts();
  renderMsgList();
  syncMusicWidgetToggle();
  initDesktopPages();
}
initApp();

// ===== 多页桌面系统 =====
let currentPage=0;
let totalPages=1;
let swipeStartX=0,swipeStartY=0,swipeDX=0,swiping=false,swipeDir=null;

function initDesktopPages(){
  totalPages=parseInt(LS.getItem('totalPages')||'1');
  currentPage=parseInt(LS.getItem('currentPage')||'0');
  if(currentPage>=totalPages)currentPage=0;
  const container=document.getElementById('desktopContainer');
  // 确保有足够的页面DOM
  while(container.children.length<totalPages){
    const pg=document.createElement('div');
    pg.className='desktop';
    pg.dataset.page=container.children.length;
    pg.id='desktopPage'+container.children.length;
    container.appendChild(pg);
  }
  // 恢复图标所在页面
  try{
    const iconPages=JSON.parse(LS.getItem('iconPages')||'{}');
    Object.entries(iconPages).forEach(([key,page])=>{
      if(page>0&&page<totalPages){
        const icon=document.querySelector(`.app-icon[data-icon-key="${key}"]:not(.free)`);
        if(icon){
          const targetPage=document.getElementById('desktopPage'+page);
          if(targetPage)targetPage.appendChild(icon);
        }
      }
    });
  }catch(e){}
  updatePageTransform();
  renderPageDots();
  updatePageCountLabel();
  setupDesktopSwipe();
  // 给每个desktop绑定编辑模式事件
  container.querySelectorAll('.desktop').forEach(pg=>{
    pg.classList.add('editing');
    pg.classList.remove('editing');
  });
}

function updatePageTransform(){
  const container=document.getElementById('desktopContainer');
  container.style.transform=`translateX(${-currentPage*100}%)`;
}

function renderPageDots(){
  const dots=document.getElementById('pageDots');
  if(totalPages<=1){dots.style.display='none';return;}
  dots.style.display='flex';
  dots.innerHTML=Array.from({length:totalPages},(_,i)=>`<div class="page-dot${i===currentPage?' active':''}" onclick="goToPage(${i})"></div>`).join('');
}

function goToPage(p){
  if(p<0||p>=totalPages)return;
  currentPage=p;
  LS.setItem('currentPage',currentPage);
  updatePageTransform();
  renderPageDots();
}

function updatePageCountLabel(){
  const el=document.getElementById('pageCountLabel');
  if(el)el.textContent='当前 '+totalPages+' 页';
}

function addDesktopPage(){
  if(totalPages>=5){showToast('最多5页');return;}
  totalPages++;
  const container=document.getElementById('desktopContainer');
  const pg=document.createElement('div');
  pg.className='desktop';
  pg.dataset.page=totalPages-1;
  pg.id='desktopPage'+(totalPages-1);
  container.appendChild(pg);
  LS.setItem('totalPages',totalPages);
  applyLayout();
  renderPageDots();
  updatePageCountLabel();
  showToast('已添加第'+totalPages+'页');
}

function removeLastPage(){
  if(totalPages<=1){showToast('至少保留1页');return;}
  const lastIdx=totalPages-1;
  const lastPage=document.getElementById('desktopPage'+lastIdx);
  if(lastPage){
    // 把末页图标移到第���页
    const icons=[...lastPage.querySelectorAll('.app-icon')];
    const page0=document.getElementById('desktopPage0');
    icons.forEach(ic=>page0.appendChild(ic));
    lastPage.remove();
  }
  totalPages--;
  if(currentPage>=totalPages)currentPage=totalPages-1;
  LS.setItem('totalPages',totalPages);
  LS.setItem('currentPage',currentPage);
  updatePageTransform();
  renderPageDots();
  updatePageCountLabel();
  saveIconPages();
  showToast('已删除末页');
}

function saveIconPages(){
  const data={};
  document.querySelectorAll('.desktop-container .desktop').forEach(pg=>{
    const pageIdx=parseInt(pg.dataset.page)||0;
    pg.querySelectorAll('.app-icon[data-icon-key]:not(.free)').forEach(ic=>{
      data[ic.dataset.iconKey]=pageIdx;
    });
  });
  LS.setItem('iconPages',JSON.stringify(data));
}

function setupDesktopSwipe(){
  const container=document.getElementById('desktopContainer');
  const phone=document.querySelector('.phone');

  phone.addEventListener('touchstart',e=>{
    // 只在桌面区域响应（排除全屏页面、面板等）
    if(e.target.closest('.fullpage')||e.target.closest('.panel')||e.target.closest('.crop-panel')||e.target.closest('.photo-panel')||e.target.closest('.now-playing-bar')||e.target.closest('.chat-tabs'))return;
    swipeStartX=e.touches[0].clientX;
    swipeStartY=e.touches[0].clientY;
    swipeDX=0;swiping=false;swipeDir=null;
  },{passive:true});

  phone.addEventListener('touchmove',e=>{
    if(swipeDir==='v'||swipeDir===null&&!swipeStartX)return;
    const dx=e.touches[0].clientX-swipeStartX;
    const dy=e.touches[0].clientY-swipeStartY;
    if(!swipeDir){
      if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>12)swipeDir='h';
      else if(Math.abs(dy)>8)swipeDir='v';
      if(swipeDir!=='h')return;
    }
    if(totalPages<=1)return;
    // 第1页禁止右滑，最后一页禁止左滑
    if(dx>0&&currentPage===0)return;
    if(dx<0&&currentPage>=totalPages-1)return;
    if(!swiping){swiping=true;container.classList.add('dragging');}
    swipeDX=dx;
    const pw=phone.offsetWidth;
    const offset=-currentPage*pw+dx;
    container.style.transform=`translateX(${offset}px)`;
  },{passive:true});

  phone.addEventListener('touchend',e=>{
    container.classList.remove('dragging');
    if(!swiping||swipeDir!=='h'){
      swiping=false;swipeDir=null;swipeStartX=0;
      return;
    }
    const pw=phone.offsetWidth;
    const threshold=pw*0.15;
    if(swipeDX<-threshold&&currentPage<totalPages-1)currentPage++;
    else if(swipeDX>threshold&&currentPage>0)currentPage--;
    LS.setItem('currentPage',currentPage);
    updatePageTransform();
    renderPageDots();
    swiping=false;swipeDir=null;swipeStartX=0;
  },{passive:true});
}

// 图标跨页拖动
function setupIconPageDrag(icon){
  let ghost=null,startX,startY,dragging=false,dragTimer=null;
  let edgeTimer=null,origPage=null;

  function createGhost(cx,cy){
    ghost=icon.cloneNode(true);
    ghost.className='app-icon drag-ghost';
    ghost.style.width=icon.offsetWidth+'px';
    const pr=document.querySelector('.phone').getBoundingClientRect();
    ghost.style.left=(cx-pr.left-icon.offsetWidth/2)+'px';
    ghost.style.top=(cy-pr.top-icon.offsetHeight/2)+'px';
    document.querySelector('.phone').appendChild(ghost);
    icon.style.opacity='.3';
    origPage=icon.closest('.desktop')?.dataset.page||'0';
  }

  function moveGhost(cx,cy){
    if(!ghost)return;
    const pr=document.querySelector('.phone').getBoundingClientRect();
    ghost.style.left=(cx-pr.left-icon.offsetWidth/2)+'px';
    ghost.style.top=(cy-pr.top-icon.offsetHeight/2)+'px';
    // 靠近边缘自动翻页
    const rx=cx-pr.left;
    clearTimeout(edgeTimer);
    if(rx<40&&currentPage>0){
      document.getElementById('edgeLeft').classList.add('show');
      edgeTimer=setTimeout(()=>{goToPage(currentPage-1);},600);
    } else if(rx>pr.width-40&&currentPage<totalPages-1){
      document.getElementById('edgeRight').classList.add('show');
      edgeTimer=setTimeout(()=>{goToPage(currentPage+1);},600);
    } else {
      document.getElementById('edgeLeft').classList.remove('show');
      document.getElementById('edgeRight').classList.remove('show');
    }
  }

  function endDrag(){
    clearTimeout(edgeTimer);
    document.getElementById('edgeLeft').classList.remove('show');
    document.getElementById('edgeRight').classList.remove('show');
    if(ghost){
      ghost.remove();ghost=null;
      icon.style.opacity='';
      // 移到当前页
      const targetPage=document.getElementById('desktopPage'+currentPage);
      if(targetPage&&icon.closest('.desktop')!==targetPage){
        targetPage.appendChild(icon);
        saveIconPages();
      }
    }
    dragging=false;
  }

  icon.addEventListener('touchstart',e=>{
    if(icon.classList.contains('free'))return;
    startX=e.touches[0].clientX;startY=e.touches[0].clientY;
    dragging=false;
    dragTimer=setTimeout(()=>{
      if(totalPages>1){
        dragging=true;
        createGhost(startX,startY);
        if(!editMode)enterEditMode();
      }
    },500);
  },{passive:true});

  icon.addEventListener('touchmove',e=>{
    if(dragging&&ghost){
      moveGhost(e.touches[0].clientX,e.touches[0].clientY);
    } else {
      const dx=Math.abs(e.touches[0].clientX-startX);
      const dy=Math.abs(e.touches[0].clientY-startY);
      if(dx>8||dy>8)clearTimeout(dragTimer);
    }
  },{passive:true});

  icon.addEventListener('touchend',()=>{
    clearTimeout(dragTimer);
    if(dragging)endDrag();
  },{passive:true});
}

// 给所有图标绑定跨页拖动
document.querySelectorAll('.app-icon').forEach(ic=>setupIconPageDrag(ic));

// ===== 陪伴模式 =====
let companionActive=false;
let companionTimer=null;
let companionContact=null;
let companionLogs={}; // {contactId: [{text,time,ts}]}
let companionFloatEl=null;

function getCompanionLogs(cid){return companionLogs[cid]||[];}
function saveCompanionLogs(){IDB.set('companionLogs',JSON.stringify(companionLogs));}
function saveCompanionMemCount(v){
  const n=Math.max(5,parseInt(v)||10);
  document.getElementById('companionMemCount').value=n;
  if(currentContact)LS.setItem('companionMemCount_'+currentContact.id,n);
}
function getCompanionMemoryText(cid){
  const logs=getCompanionLogs(cid);
  if(!logs.length)return '';
  const count=parseInt(LS.getItem('companionMemCount_'+cid)||'10');
  const recent=logs.slice(-count);
  return recent.map(l=>`[${l.time}] ${companionContact?.name||'角色'}内心独白：${l.text}`).join('\n');
}

function toggleCompanionMode(){
  document.getElementById('extraMenu').style.display='none';
  document.getElementById('extraBtn').style.background='var(--card2)';
  if(!currentContact&&!currentGroup){showToast('仅单聊可用');return;}
  if(currentGroup){showToast('陪伴模式仅支持单聊');return;}
  if(companionActive){
    stopCompanion();
    showToast('陪伴模式已关闭');
  } else {
    startCompanion();
    showToast(currentContact.name+' 开始陪伴你');
  }
}

function startCompanion(){
  if(!currentContact)return;
  companionActive=true;
  companionContact=currentContact;
  document.getElementById('companionBtnLabel').textContent='关闭陪伴';
  createCompanionFloat();
  const interval=parseInt(LS.getItem('companionInterval_'+currentContact.id)||'45')*1000;
  companionTimer=setInterval(()=>generateCompanionMsg(),interval);
  // 首次延迟5秒发
  setTimeout(()=>{if(companionActive)generateCompanionMsg();},5000);
}

function stopCompanion(){
  companionActive=false;
  companionContact=null;
  clearInterval(companionTimer);companionTimer=null;
  document.getElementById('companionBtnLabel').textContent='陪伴';
  if(companionFloatEl){companionFloatEl.remove();companionFloatEl=null;}
}

function createCompanionFloat(){
  if(companionFloatEl)companionFloatEl.remove();
  const c=companionContact;
  const avUrl=c.avatar?getAvatarURL('c_'+c.id,c.avatar):'';
  const avHtml=avUrl?`<img src="${avUrl}"/>`:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
  const el=document.createElement('div');
  el.className='companion-float active';
  el.id='companionFloat';
  el.style.cssText='left:16px;top:100px';
  el.innerHTML=`
    <div class="cf-header">
      <div class="cf-avatar"><div class="cf-avatar-ring"></div>${avHtml}</div>
      <div class="cf-info">
        <div class="cf-name">${c.name}</div>
        <div class="cf-status"><span class="cf-status-dot"></span>陪伴中</div>
      </div>
      <div class="cf-wave">
        <div class="cf-wave-bar"></div><div class="cf-wave-bar"></div><div class="cf-wave-bar"></div><div class="cf-wave-bar"></div><div class="cf-wave-bar"></div>
      </div>
      <button class="cf-close" onclick="stopCompanion()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="cf-bubble" id="cfBubble"><div class="cf-bubble-text" id="cfBubbleText"></div></div>
    <div class="cf-actions" id="cfActions" style="display:none">
      <button class="cf-action-btn" onclick="openCompanionLog()">记录</button>
      <button class="cf-action-btn primary" onclick="openConversation(companionContact)">去聊天</button>
    </div>`;
  document.querySelector('.phone').appendChild(el);
  companionFloatEl=el;
  setupCompanionDrag(el);
}

function setupCompanionDrag(el){
  const header=el.querySelector('.cf-header');
  let startX,startY,origL,origT,moving=false;
  function onStart(cx,cy){startX=cx;startY=cy;origL=el.offsetLeft;origT=el.offsetTop;moving=true;}
  function onMove(cx,cy){
    if(!moving)return;
    const phone=document.querySelector('.phone');
    el.style.left=Math.max(0,Math.min(phone.offsetWidth-el.offsetWidth,origL+(cx-startX)))+'px';
    el.style.top=Math.max(0,Math.min(phone.offsetHeight-60,origT+(cy-startY)))+'px';
  }
  function onEnd(){moving=false;}
  header.addEventListener('touchstart',e=>{if(e.target.closest('.cf-close'))return;onStart(e.touches[0].clientX,e.touches[0].clientY);},{passive:true});
  header.addEventListener('touchmove',e=>{onMove(e.touches[0].clientX,e.touches[0].clientY);},{passive:true});
  header.addEventListener('touchend',onEnd);
  header.addEventListener('mousedown',e=>{if(e.target.closest('.cf-close'))return;onStart(e.clientX,e.clientY);const mm=ev=>onMove(ev.clientX,ev.clientY);const mu=()=>{onEnd();document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);};document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu);});
}

function showCompanionBubble(text){
  if(!companionFloatEl)return;
  const bubble=document.getElementById('cfBubble');
  const textEl=document.getElementById('cfBubbleText');
  const actions=document.getElementById('cfActions');
  companionFloatEl.classList.add('speaking');
  // 逐字动画
  textEl.innerHTML='';
  bubble.classList.add('show');
  actions.style.display='flex';
  let i=0;
  const chars=[...text];
  function typeNext(){
    if(i>=chars.length||!companionActive)return;
    const span=document.createElement('span');
    span.className='cf-char';
    span.textContent=chars[i];
    span.style.animationDelay=(i*30)+'ms';
    textEl.appendChild(span);
    i++;
    if(i<chars.length)setTimeout(typeNext,30);
  }
  typeNext();
  // 15秒后收起
  setTimeout(()=>{
    if(!companionFloatEl)return;
    bubble.classList.remove('show');
    actions.style.display='none';
    companionFloatEl.classList.remove('speaking');
  },15000);
}

async function generateCompanionMsg(){
  if(!companionActive||!companionContact)return;
  const c=companionContact;
  const p=presets[activePreset]||{};
  if(!p.key)return;
  const me=c.mePresetIndex!=null?mePresets[c.mePresetIndex]:null;
  const myName=me?.name||'我';
  const msgs=(conversations[c.id]||[]).slice(-10);
  const chatCtx=msgs.map(m=>`${m.role==='user'?myName:c.name}：${m.content||'[媒体]'}`).join('\n');
  const recentLogs=getCompanionLogs(c.id).slice(-5).map(l=>l.text).join('\n');
  const now=new Date();
  const h=now.getHours(),period=h<6?'凌晨':h<9?'早上':h<12?'上午':h<14?'中午':h<18?'下午':h<21?'晚上':'深夜';
  const timeStr=`${period}${h}:${String(now.getMinutes()).padStart(2,'0')}`;

  const sysPrompt=`你是${c.name}，${c.gender==='male'?'男':'女'}性。${c.persona||''}
${me?`你在意的人是${myName}，${me.gender==='male'?'男':'女'}性。${me.persona||''}`:''}

现在是${timeStr}。你正处于"陪伴模式"——你在${myName}的手机上默默陪着ta，但${myName}现在没有在跟你聊天（可能在忙别的事、跟别人聊天、或者只是没看手机）。

你要输出一段内心独白/碎碎念，就像真实的人在脑海里想的那些话，偶尔忍不住想说出来给${myName}听。

【核心要求——真实感】
- 这是你真实的内心活动，不是表演，不是小说旁白
- 要贴近三次元现实生活：你会饿、会困、会无聊、会想ta、会吃醋、会担心
- 语气完全符合你的人设性格，傲娇的就傲娇，温柔的就温柔，毒舌的就毒舌
- 可以带emoji、颜文字、语气词，像真人发消息
- 长度15-60字，不要太长，碎碎念就是短短的
- 不要重复之前说过的内容
- 根据当前时间段说合适的话（深夜关心ta睡了没、早上问吃早饭没、下午说无聊等）
- 可以偶尔吃醋（${myName}是不是在跟别人聊天不理我）、偶尔撒娇、偶尔分享日常
- 禁止任何旁白描写、动作描写，直接输出独白文字

${recentLogs?'【你之前说过的（不要重复）】\n'+recentLogs:''}
${chatCtx?'【你们最近的聊天】\n'+chatCtx:''}

只输出独白内容，不要任何前缀、引号、解释。`;

  try{
    const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
      body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[{role:'system',content:sysPrompt},{role:'user',content:'输出一条内心独白：'}],max_tokens:100})
    });
    const data=await res.json();
    let text=data.choices?.[0]?.message?.content?.trim()||'';
    text=text.replace(/^["「『""]/,'').replace(/["」』""]$/,'').trim();
    if(!text)return;
    // 保存记录
    const ts=now.getTime();
    const timeLog=`${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    if(!companionLogs[c.id])companionLogs[c.id]=[];
    companionLogs[c.id].push({text,time:timeLog,ts});
    // 限制最多保存100条
    if(companionLogs[c.id].length>100)companionLogs[c.id]=companionLogs[c.id].slice(-100);
    saveCompanionLogs();
    showCompanionBubble(text);
    playMsgSoundByKey('bubble');
  }catch(e){}
}

function openCompanionLog(){
  const cid=currentContact?currentContact.id:(companionContact?companionContact.id:null);
  if(!cid){showToast('请先打开联系人');return;}
  const logs=getCompanionLogs(cid);
  const box=document.getElementById('companionLogBody');
  if(!logs.length){
    box.innerHTML='<p style="font-size:13px;color:var(--text2);text-align:center;padding:30px 0">暂无陪伴记录</p>';
  } else {
    box.innerHTML=logs.slice().reverse().map(l=>`
      <div class="companion-log-item">
        <div class="companion-log-time">${l.time}</div>
        <div class="companion-log-text">${l.text}</div>
      </div>`).join('');
  }
  _openPanelInConv('panelCompanionLog');
}
function closeCompanionLog(){document.getElementById('panelCompanionLog').classList.remove('open');}

// 初始化加载陪伴记录
(async()=>{try{const d=await IDB.get('companionLogs');if(d)companionLogs=JSON.parse(d);}catch(e){}})();

// ===== 一起听歌 =====
let listenTogetherActive=false;
let listenTogetherTrackIdx=-1;
let listenTogetherContact=null;

function openListenTogether(){
  document.getElementById('extraMenu').style.display='none';
  document.getElementById('extraBtn').style.background='var(--card2)';
  if(!currentContact&&!currentGroup){showToast('请先打开聊天');return;}
  if(currentGroup){showToast('一起听歌仅支持单聊');return;}
  document.getElementById('listenSongInput').value='';
  renderListenTrackList();
  document.getElementById('panelListenTogether').classList.add('open');
}
function closeListenTogether(){document.getElementById('panelListenTogether').classList.remove('open');}

function renderListenTrackList(){
  const box=document.getElementById('listenTrackList');
  const empty=document.getElementById('listenNoTracks');
  if(!musicTracks.length){box.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  box.innerHTML=musicTracks.map((t,i)=>`
    <div class="music-list-item" onclick="startListenTogether(${i})" style="cursor:pointer">
      <div class="mli-idx">${i+1}</div>
      <div class="mli-info">
        <div class="mli-name">${t.name}</div>
        <div class="mli-artist">${t.artist}</div>
      </div>
      <div class="mli-dur">${fmtTime(t.duration)}</div>
    </div>`).join('');
}

function startListenTogether(trackIdx){
  document.getElementById('panelListenTogether').classList.remove('open');
  const t=musicTracks[trackIdx];
  if(!t){showToast('歌曲不存在');return;}
  listenTogetherActive=true;
  listenTogetherTrackIdx=trackIdx;
  listenTogetherContact=currentContact;

  // 播放歌曲
  loadTrack(trackIdx);
  if(!musicPlaying)toggleMusicPlay();

  // 在聊天区域顶部显示共享播放条
  showListenTogetherBar(t);

  // 发送歌曲卡片到聊天
  sendSongCardMsg(t,'我');

  // 角色自动评论
  setTimeout(()=>generateSongReaction(t),2000+Math.random()*3000);
}

function showListenTogetherBar(t){
  removeListenTogetherBar();
  const box=document.getElementById('convMessages');
  const bar=document.createElement('div');
  bar.className='listen-together-bar';
  bar.id='listenTogetherBar';
  const coverHtml=t.cover?`<img src="${t.cover}"/>`:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="1.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>`;
  bar.innerHTML=`
    <div class="ltb-disc${musicPlaying?' spinning':''}">${coverHtml}</div>
    <div class="ltb-info">
      <div class="ltb-label"><span class="ltb-dot"></span>正在和${listenTogetherContact?.name||'ta'}一起听</div>
      <div class="ltb-song">${t.name}</div>
      <div class="ltb-artist">${t.artist}</div>
    </div>
    <button class="ltb-btn" onclick="event.stopPropagation();toggleMusicPlay();updateListenBar()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="var(--text)" stroke="none">${musicPlaying?'<rect x="5" y="3" width="5" height="18" rx="1"/><rect x="14" y="3" width="5" height="18" rx="1"/>':'<polygon points="5,3 19,12 5,21"/>'}</svg>
    </button>
    <button class="ltb-btn" onclick="event.stopPropagation();listenNextSong()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text)" stroke-width="2"><polygon points="5,4 15,12 5,20" fill="var(--text)"/><line x1="19" y1="5" x2="19" y2="19"/></svg>
    </button>
    <button class="ltb-close" onclick="event.stopPropagation();stopListenTogether()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>`;
  box.insertBefore(bar,box.firstChild);
  // 进入氛围模式
  enterListenAmbient(t);
}

function updateListenBar(){
  const bar=document.getElementById('listenTogetherBar');
  if(!bar)return;
  const disc=bar.querySelector('.ltb-disc');
  if(disc)disc.classList.toggle('spinning',musicPlaying);
  const btn=bar.querySelector('.ltb-btn');
  if(btn)btn.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="var(--text)" stroke="none">${musicPlaying?'<rect x="5" y="3" width="5" height="18" rx="1"/><rect x="14" y="3" width="5" height="18" rx="1"/>':'<polygon points="5,3 19,12 5,21"/>'}</svg>`;
}

function removeListenTogetherBar(){
  document.getElementById('listenTogetherBar')?.remove();
  exitListenAmbient();
}

function stopListenTogether(){
  listenTogetherActive=false;
  exitListenAmbient();
  removeListenTogetherBar();
  if(listenTogetherContact&&currentContact?.id===listenTogetherContact.id){
    generateSongEndReaction();
  }
  listenTogetherContact=null;
  listenTogetherTrackIdx=-1;
}

function listenNextSong(){
  musicNext();
  setTimeout(()=>{
    if(!listenTogetherActive)return;
    const t=musicTracks[musicIdx];
    if(!t)return;
    listenTogetherTrackIdx=musicIdx;
    showListenTogetherBar(t);
    updateAmbientCover(t);
    sendSongCardMsg(t,'我');
    setTimeout(()=>generateSongReaction(t),2000+Math.random()*3000);
  },300);
}

// ===== 听歌氛围模式 =====
let ambientDanmakuTimer=null;

function enterListenAmbient(t){
  const conv=document.getElementById('pageConv');
  if(!conv||conv.classList.contains('listen-ambient'))return;
  conv.classList.add('listen-ambient');
  // 创建背景层
  let bg=conv.querySelector('.listen-ambient-bg');
  if(!bg){
    bg=document.createElement('div');
    bg.className='listen-ambient-bg';
    bg.innerHTML=`<div class="lab-img" id="labImg"></div><div class="lab-overlay"></div>`;
    conv.insertBefore(bg,conv.firstChild);
  }
  // 创建封面唱片
  let cover=conv.querySelector('.listen-ambient-cover');
  if(!cover){
    cover=document.createElement('div');
    cover.className='listen-ambient-cover';
    cover.id='ambientCover';
    cover.innerHTML=`<div class="lac-disc"><div class="lac-hole"></div></div><div class="lac-info"><div class="lac-title" id="lacTitle"></div><div class="lac-artist" id="lacArtist"></div></div>`;
    conv.insertBefore(cover,conv.querySelector('.fp-body'));
  }
  // 创建弹幕层
  let danmaku=conv.querySelector('.listen-danmaku-layer');
  if(!danmaku){
    danmaku=document.createElement('div');
    danmaku.className='listen-danmaku-layer';
    danmaku.id='danmakuLayer';
    conv.insertBefore(danmaku,conv.querySelector('.fp-body'));
  }
  // 底栏氛围化
  const bottom=conv.querySelector('[style*="padding:10px 14px 16px"]');
  if(bottom)bottom.classList.add('listen-ambient-bottom');
  updateAmbientCover(t);
  requestAnimationFrame(()=>{
    bg.classList.add('show');
    cover.classList.add('show');
    if(musicPlaying)cover.classList.add('playing');
  });
}

function exitListenAmbient(){
  const conv=document.getElementById('pageConv');
  if(!conv)return;
  conv.classList.remove('listen-ambient');
  const bg=conv.querySelector('.listen-ambient-bg');
  if(bg){bg.classList.remove('show');setTimeout(()=>bg.remove(),800);}
  const cover=conv.querySelector('.listen-ambient-cover');
  if(cover){cover.classList.remove('show');setTimeout(()=>cover.remove(),600);}
  const danmaku=conv.querySelector('.listen-danmaku-layer');
  if(danmaku)danmaku.remove();
  const bottom=conv.querySelector('.listen-ambient-bottom');
  if(bottom)bottom.classList.remove('listen-ambient-bottom');
  clearInterval(ambientDanmakuTimer);ambientDanmakuTimer=null;
}

function updateAmbientCover(t){
  const labImg=document.getElementById('labImg');
  const disc=document.querySelector('.listen-ambient-cover .lac-disc');
  const title=document.getElementById('lacTitle');
  const artist=document.getElementById('lacArtist');
  if(!labImg)return;
  if(t.cover){
    labImg.style.cssText=`width:100%;height:100%;background:url(${t.cover}) center/cover;filter:blur(30px) brightness(.35) saturate(1.4);transform:scale(1.2)`;
    const existImg=disc?.querySelector('img');
    if(existImg)existImg.src=t.cover;
    else if(disc){
      const img=document.createElement('img');
      img.src=t.cover;img.style.cssText='width:100%;height:100%;object-fit:cover;position:absolute;inset:0';
      disc.insertBefore(img,disc.firstChild);
    }
  } else {
    labImg.style.cssText='width:100%;height:100%;background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);filter:blur(30px) brightness(.35);transform:scale(1.2)';
    const existImg=disc?.querySelector('img');
    if(existImg)existImg.remove();
  }
  if(title)title.textContent=t.name;
  if(artist)artist.textContent=t.artist;
}

// 同步播放状态到氛围封面
musicAudio.addEventListener('play',()=>{
  document.querySelector('.listen-ambient-cover')?.classList.add('playing');
});
musicAudio.addEventListener('pause',()=>{
  document.querySelector('.listen-ambient-cover')?.classList.remove('playing');
});

function spawnDanmaku(text,isMe){
  const layer=document.getElementById('danmakuLayer');
  if(!layer)return;
  const el=document.createElement('div');
  el.className='listen-danmaku';
  el.textContent=text;
  if(isMe)el.style.background='rgba(var(--accent-rgb,100,100,100),.25)';
  // 随机垂直位置（避开顶部和底部）
  const top=15+Math.random()*55;
  el.style.top=top+'%';
  // 随机速度8-14秒
  const dur=8+Math.random()*6;
  el.style.animationDuration=dur+'s';
  layer.appendChild(el);
  el.addEventListener('animationend',()=>el.remove());
}

function sendSongCardMsg(t,sender){
  const c=listenTogetherContact||currentContact;
  if(!c)return;
  const id=c.id;
  if(!conversations[id])conversations[id]=[];
  const now=new Date();
  const ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')+':'+now.getSeconds().toString().padStart(2,'0');
  const role=sender==='我'?'user':'assistant';
  conversations[id].push({
    role,type:'song',
    content:`[一起听歌] ${t.name} - ${t.artist}`,
    songName:t.name,songArtist:t.artist,songCover:t.cover||'',
    time:ts
  });
  LS.setItem('conversations',JSON.stringify(conversations));
  renderMessages();renderMsgList();
}

// 点歌功能（输入歌名）
async function sendSongRequest(){
  const input=document.getElementById('listenSongInput');
  const songName=input.value.trim();
  if(!songName){showToast('请输入歌名');return;}
  closeListenTogether();
  // 检查歌单里有没有
  const matchIdx=musicTracks.findIndex(t=>t.name.includes(songName)||songName.includes(t.name));
  if(matchIdx>=0){
    startListenTogether(matchIdx);
  } else {
    // 歌单没有，发送点歌卡片
    const c=currentContact;if(!c)return;
    const id=c.id;
    if(!conversations[id])conversations[id]=[];
    const now=new Date();
    const ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')+':'+now.getSeconds().toString().padStart(2,'0');
    conversations[id].push({role:'user',type:'song',content:`[点歌] ${songName}`,songName,songArtist:'',songCover:'',time:ts});
    LS.setItem('conversations',JSON.stringify(conversations));
    renderMessages();renderMsgList();
    setTimeout(()=>generateSongReaction({name:songName,artist:'',cover:''}),2000+Math.random()*2000);
  }
}

async function generateSongReaction(t){
  const c=listenTogetherContact||currentContact;
  if(!c)return;
  const p=presets[activePreset]||{};
  if(!p.key)return;
  const me=c.mePresetIndex!=null?mePresets[c.mePresetIndex]:null;
  const mePart=me?`对方是${me.name}。`:'';

  const sysPrompt=`你是${c.name}，${c.gender==='male'?'男':'女'}性。${c.persona||''}${mePart}
对方正在和你一起听歌：《${t.name}》${t.artist?' - '+t.artist:''}。

你要对这首歌发表感想，像真人在微信聊天里分享听歌感受：
- 可以说喜不喜欢、有什么回忆、歌词哪句触动你
- 语气符合你的人设性格
- 禁止旁白描写，直接发消息
- 用JSON数组格式，1-3条消息，如["消息1","消息2"]`;

  try{
    const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
      body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[{role:'system',content:sysPrompt},{role:'user',content:'我们一起听这���歌吧~'}],max_tokens:200})
    });
    const data=await res.json();
    const raw=data.choices?.[0]?.message?.content||'';
    const msgs=parseMultiMsg(raw);
    for(let k=0;k<msgs.length;k++){
      if(k>0)await new Promise(r=>setTimeout(r,800+Math.random()*1000));
      const now=new Date();
      const ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')+':'+now.getSeconds().toString().padStart(2,'0');
      msgAnimFlag=true;
      conversations[c.id].push({role:'assistant',content:msgs[k].content,time:ts});
      LS.setItem('conversations',JSON.stringify(conversations));
      renderMessages();renderMsgList();
      setTimeout(()=>{msgAnimFlag=false;},420);
      playMsgSound();
      showChatNotify(c,msgs[k].content);
    }
  }catch(e){}
}

async function generateSongEndReaction(){
  const c=listenTogetherContact||currentContact;
  if(!c)return;
  const p=presets[activePreset]||{};
  if(!p.key)return;
  const t=musicTracks[listenTogetherTrackIdx];
  const songInfo=t?`刚才一起听了《${t.name}》`:'刚才一起听歌结束了';

  try{
    const res=await fetch((p.base||'https://api.openai.com/v1')+'/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+p.key},
      body:JSON.stringify({model:p.model||'gpt-4o-mini',messages:[
        {role:'system',content:`你是${c.name}，${c.gender==='male'?'男':'女'}性。${c.persona||''}${songInfo}。对方关闭了一起听歌。发一条简短的感受或不舍，像真人发微信，不要旁白，只输出消息文字。`},
        {role:'user',content:'一起听歌结束了'}
      ],max_tokens:80})
    });
    const data=await res.json();
    const text=data.choices?.[0]?.message?.content?.trim();
    if(text){
      const now=new Date();
      const ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')+':'+now.getSeconds().toString().padStart(2,'0');
      msgAnimFlag=true;
      conversations[c.id].push({role:'assistant',content:text,time:ts});
      LS.setItem('conversations',JSON.stringify(conversations));
      renderMessages();renderMsgList();
      setTimeout(()=>{msgAnimFlag=false;},420);
      playMsgSound();
    }
  }catch(e){}
}

async function manualSummarizeAll(){
  if(!getMemApi().key){showToast('请先配置总结API');return;}
  showToast('正在总结所有对话…');
  let count=0;
  // 单聊
  for(const c of contacts){
    const msgs=conversations[c.id]||[];
    if(msgs.length>3){
      const lastIdx=memSummarizedIdx[c.id]||0;
      if(msgs.length-lastIdx>=3){
        const batch=msgs.slice(lastIdx);
        const summary=await summarizeMessages(c.id,batch,c.name,false);
        if(summary){
          if(!memoryStore[c.id])memoryStore[c.id]=[];
          memoryStore[c.id].push({day:getTodayStr(),summary,ts:Date.now()});
          memSummarizedIdx[c.id]=msgs.length;
          count++;
        }
      }
    }
  }
  // 群聊
  for(const g of groups){
    const key='g_'+g.id;
    const msgs=groupConversations[g.id]||[];
    if(msgs.length>3){
      const lastIdx=memSummarizedIdx[key]||0;
      if(msgs.length-lastIdx>=3){
        const batch=msgs.slice(lastIdx);
        const summary=await summarizeMessages(key,batch,g.name,true);
        if(summary){
          if(!memoryStore[key])memoryStore[key]=[];
          memoryStore[key].push({day:getTodayStr(),summary,ts:Date.now()});
          memSummarizedIdx[key]=msgs.length;
          count++;
        }
      }
    }
  }
  saveMemStore();saveMemIdx();
  renderMemoryList();
  showToast(count?`已总结 ${count} 个对话 ✓`:'没有需要总结的对话');
}

// ===== 真人好友系统 =====
let realMyUid = null;
let realMyNick = '';
let realFriends = []; // [{uid, nick, chatId}]
let realCurrentChat = null; // 当前真人聊天的chatId
let realMsgUnsub = null; // firestore listener unsubscribe

// 等Firebase初始化
// 等Firebase初始化（增加超时检测）
let waitFBTries = 0;
function waitFB(cb) {
  if (window.FB) {
    cb();
  } else if (waitFBTries > 50) { // 等待超过10秒
    document.getElementById('realMyId').textContent = '网络连接失败';
    document.getElementById('realMyId').style.color = '#FF3B30';
    showToast('无法连接到服务器，请检查网络环境');
  } else {
    waitFBTries++;
    setTimeout(() => waitFB(cb), 200);
  }
}

waitFB(() => {
  const { fbAuth, signInAnonymously, onAuthStateChanged } = window.FB;
  
  // 增加登录失败的错误提示
  signInAnonymously(fbAuth).catch(e => {
    console.error('Firebase登录失败:', e);
    document.getElementById('realMyId').textContent = '获取失败';
    document.getElementById('realMyId').style.color = '#FF3B30';
    
    // 翻译常见的错误
    if (e.code === 'auth/operation-not-allowed') {
      showToast('错误：Firebase后台未开启"匿名登录"');
    } else if (e.code === 'auth/network-request-failed') {
      showToast('错误：网络请求失败，请检查代理');
    } else {
      showToast('获取好友码失败: ' + e.message);
    }
  });

  onAuthStateChanged(fbAuth, async user => {
    if (!user) return;
    realMyUid = user.uid;
    document.getElementById('realMyId').textContent = realMyUid;
    document.getElementById('realMyId').style.color = 'var(--accent)'; // 恢复正常颜色
    
    // 加载/创建用户文档
    try {
      const { fbDb, doc, getDoc, setDoc } = window.FB;
      const userRef = doc(fbDb, 'users', realMyUid);
      const snap = await getDoc(userRef);
      if (snap.exists()) {
        realMyNick = snap.data().nick || '';
        document.getElementById('realNickInput').value = realMyNick;
      } else {
        await setDoc(userRef, { nick: '', createdAt: Date.now() });
      }
      loadRealFriends();
    } catch (dbError) {
      console.error('数据库读取失败:', dbError);
      showToast('数据库连接失败，请检查 Firestore 权限');
    }
  });
});

async function saveRealNick() {
  const nick = document.getElementById('realNickInput').value.trim();
  if (!nick) { showToast('请输入昵称'); return; }
  realMyNick = nick;
  const { fbDb, doc, updateDoc } = window.FB;
  await updateDoc(doc(fbDb, 'users', realMyUid), { nick });
  showToast('昵称已保存 ✓');
}

function copyMyRealId() {
  if (!realMyUid) return;
  navigator.clipboard.writeText(realMyUid).then(() => showToast('已复制好友码')).catch(() => {
    // fallback
    const t = document.createElement('textarea');
    t.value = realMyUid; document.body.appendChild(t); t.select();
    document.execCommand('copy'); document.body.removeChild(t);
    showToast('已复制好友码');
  });
}

function getChatId(uid1, uid2) {
  return [uid1, uid2].sort().join('_');
}

async function addRealFriend() {
  const targetUid = document.getElementById('realAddInput').value.trim();
  if (!targetUid) { showToast('请粘贴对方好友码'); return; }
  if (targetUid === realMyUid) { showToast('不能添加自己'); return; }
  if (realFriends.some(f => f.uid === targetUid)) { showToast('已经是好友了'); return; }

  const { fbDb, doc, getDoc, setDoc, collection } = window.FB;
  // 检查对方是否存在
  const targetSnap = await getDoc(doc(fbDb, 'users', targetUid));
  if (!targetSnap.exists()) { showToast('好友码无效'); return; }

  const chatId = getChatId(realMyUid, targetUid);
  const targetNick = targetSnap.data().nick || '未命名';

  // 双方都写好友记录
  await setDoc(doc(fbDb, 'friends', realMyUid + '_' + targetUid), {
    owner: realMyUid, friend: targetUid, chatId, createdAt: Date.now()
  });
  await setDoc(doc(fbDb, 'friends', targetUid + '_' + realMyUid), {
    owner: targetUid, friend: realMyUid, chatId, createdAt: Date.now()
  });

  document.getElementById('realAddInput').value = '';
  showToast('好友添加成功 ✓');
  loadRealFriends();
}

async function loadRealFriends() {
  if (!realMyUid) return;
  const { fbDb, collection, query, where, getDocs, doc, getDoc } = window.FB;
  const q = query(collection(fbDb, 'friends'), where('owner', '==', realMyUid));
  const snap = await getDocs(q);
  realFriends = [];
  for (const d of snap.docs) {
    const data = d.data();
    // 获取对方昵称
    let nick = '未命名';
    try {
      const uSnap = await getDoc(doc(fbDb, 'users', data.friend));
      if (uSnap.exists()) nick = uSnap.data().nick || '未命名';
    } catch (e) {}
    realFriends.push({ uid: data.friend, nick, chatId: data.chatId });
  }
  renderRealFriends();
}

function renderRealFriends() {
  const list = document.getElementById('realFriendList');
  const empty = document.getElementById('realFriendEmpty');
  if (!realFriends.length) { list.innerHTML = ''; empty.style.display = 'flex'; return; }
  empty.style.display = 'none';
  list.innerHTML = realFriends.map(f => `
    <div onclick="openRealChat('${f.uid}','${f.chatId}','${f.nick.replace(/'/g, "\\'")}')" style="display:flex;align-items:center;gap:12px;padding:12px 4px;border-bottom:1px solid rgba(0,0,0,.05);cursor:pointer">
      <div style="width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;flex-shrink:0">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
      </div>
      <div style="flex:1">
        <div style="font-size:15px;font-weight:600;color:var(--text)">${f.nick}</div>
        <div style="font-size:12px;color:var(--text2);margin-top:2px">真人好友</div>
      </div>
      <button onclick="event.stopPropagation();deleteRealFriend('${f.uid}')" style="background:none;border:none;cursor:pointer;color:var(--text2);padding:4px">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>`).join('');
}

async function deleteRealFriend(targetUid) {
  const { fbDb, doc, deleteDoc } = window.FB;
  await deleteDoc(doc(fbDb, 'friends', realMyUid + '_' + targetUid));
  // 不删对方的记录（对方那边还能看到）
  showToast('已删除');
  loadRealFriends();
}

// ===== 真人聊天 =====
function openRealChat(uid, chatId, nick) {
  // 复用现有的 pageConv 界面
  currentContact = null;
  currentGroup = null;
  realCurrentChat = { uid, chatId, nick };

  document.getElementById('convTitle').textContent = nick;
  const avEl = document.getElementById('convHeaderAvatar');
  avEl.innerHTML = '<div style="width:100%;height:100%;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/></svg></div>';
  avEl.style.display = 'block';
  const subEl = document.getElementById('convSubTitle');
  subEl.textContent = '真人好友';
  subEl.style.display = 'block';

  document.getElementById('convMessages').style.backgroundImage = '';
  document.getElementById('convMessages').innerHTML = '<p style="color:var(--text2);font-size:14px;text-align:center;padding:60px 0">加载中…</p>';
  document.getElementById('pageConv').classList.add('open');

  // 监听消息
  listenRealMessages(chatId);
}

function listenRealMessages(chatId) {
  if (realMsgUnsub) { realMsgUnsub(); realMsgUnsub = null; }
  const { fbDb, collection, query, orderBy, onSnapshot } = window.FB;
  const msgRef = collection(fbDb, 'chats', chatId, 'messages');
  const q = query(msgRef, orderBy('ts', 'asc'));
  realMsgUnsub = onSnapshot(q, snap => {
    const box = document.getElementById('convMessages');
    if (snap.empty) {
      box.innerHTML = '<p style="color:var(--text2);font-size:14px;text-align:center;padding:60px 0">开始聊天吧</p>';
      return;
    }
    const myNick = realMyNick || '我';
    const friendNick = realCurrentChat?.nick || '对方';
    box.innerHTML = snap.docs.map(d => {
      const m = d.data();
      const isMe = m.sender === realMyUid;
      const name = isMe ? myNick : friendNick;
      const bg = isMe ? 'var(--accent)' : 'var(--card2)';
      const color = isMe ? '#fff' : 'var(--text)';
      const time = m.ts ? new Date(m.ts.seconds * 1000) : new Date();
      const timeStr = time.getHours().toString().padStart(2, '0') + ':' + time.getMinutes().toString().padStart(2, '0');
      return `<div style="display:flex;align-items:flex-end;gap:8px;justify-content:${isMe ? 'flex-end' : 'flex-start'};padding:2px 0">
        ${!isMe ? `<div style="display:flex;flex-direction:column;align-items:center;gap:3px"><div style="width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.5"><circle cx="12" cy="12" r="8"/></svg></div><span style="font-size:9px;color:var(--text2)">${timeStr}</span></div>` : ''}
        <div style="border-radius:18px;padding:9px 13px;max-width:72%;font-size:13.5px;line-height:1.65;background:${bg};color:${color};box-shadow:0 1px 4px rgba(0,0,0,.06);word-break:break-word">${m.text || ''}</div>
        ${isMe ? `<div style="display:flex;flex-direction:column;align-items:center;gap:3px"><div style="width:34px;height:34px;border-radius:50%;background:var(--accent2);display:flex;align-items:center;justify-content:center"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><circle cx="12" cy="12" r="8"/></svg></div><span style="font-size:9px;color:var(--text2)">${timeStr}</span></div>` : ''}
      </div>`;
    }).join('');
    box.scrollTop = box.scrollHeight;
  });
}

// 拦截发送按钮 — 如果是真人聊天就走Firebase
const _origSendMessage = sendMessage;
sendMessage = function() {
  if (!realCurrentChat) { _origSendMessage(); return; }
  const input = document.getElementById('convInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = ''; input.style.height = 'auto';
  const { fbDb, collection, addDoc, serverTimestamp } = window.FB;
  addDoc(collection(fbDb, 'chats', realCurrentChat.chatId, 'messages'), {
    sender: realMyUid,
    text,
    ts: serverTimestamp()
  }).catch(e => showToast('发送失败'));
};

// 拦截关闭对话
const _origCloseConv = closeConversation;
closeConversation = function() {
  if (realMsgUnsub) { realMsgUnsub(); realMsgUnsub = null; }
  realCurrentChat = null;
  _origCloseConv();
};

// 拦截接收按钮（真人聊天不需要）
const _origReceiveMsg = receiveMessage;
receiveMessage = function() {
  if (realCurrentChat) { showToast('真人聊天不需要手动接收'); return; }
  _origReceiveMsg();
};

// 扩展 switchChatTab 支持 real tab
const _origSwitchTab = switchChatTab;
switchChatTab = function(tab) {
  if (tab === 'real') {
    ['msg', 'contacts', 'moments', 'me', 'real'].forEach(t => {
      const el = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
      if (el) el.style.display = t === tab ? 'flex' : 'none';
    });
    ['msg', 'contacts', 'moments', 'me', 'real'].forEach(t => {
      document.getElementById('ctab-' + t)?.classList.toggle('active', t === tab);
    });document.getElementById('chatTitle').textContent = '真人好友';
    document.getElementById('addContactBtn').style.display = 'none';
    document.getElementById('addGroupBtn').style.display = 'none';
    loadRealFriends();
    return;
  }
  // 隐藏real tab内容
  const realEl = document.getElementById('tabReal');
  if (realEl) realEl.style.display = 'none';
  document.getElementById('ctab-real')?.classList.remove('active');
  _origSwitchTab(tab);
};

// chatTitles 扩展
chatTitles.real = '真人好友';
</script>

<!-- Firebase SDK (这里是HTML区域，可以用HTML注释，并且开启了 module) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDoc, getDocs, onSnapshot, addDoc, query, where, orderBy, serverTimestamp, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAYgYmcpI3Rf8CZQFkW8qsA6PyHtaZvRiM",
    authDomain: "orangephone-504f4.firebaseapp.com",
    projectId: "orangephone-504f4",
    storageBucket: "orangephone-504f4.firebasestorage.app",
    messagingSenderId: "578897808754",
    appId: "1:578897808754:web:ee401f6908ba3f2d54a1eb"
  };

  const fbApp = initializeApp(firebaseConfig);
  const fbAuth = getAuth(fbApp);
  const fbDb = getFirestore(fbApp);

  // 全局暴露给非module脚本使用
  window.FB = { fbAuth, fbDb, signInAnonymously, onAuthStateChanged, collection, doc, setDoc, getDoc, getDocs, onSnapshot, addDoc, query, where, orderBy, serverTimestamp, updateDoc, deleteDoc };
</script>
</body>
</html>
